const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BRMfimfo.js","assets/index-B0A_lKTD.css","assets/index-ClJqDSFp.js"])))=>i.map(i=>d[i]);
import{u as M,a as u,p as $,s as y,j as e,q as z,_ as v,L as j}from"./index-BRMfimfo.js";function V(){const{user:l,signOut:C,session:b}=M(),[o,L]=u.useState(null),[A,O]=u.useState(!0),[N,P]=u.useState(!1),[g,d]=u.useState(null),[S,k]=u.useState(!1),[r,T]=u.useState(null),[f,D]=u.useState(null),[w,F]=u.useState(null),[_,R]=u.useState($()),U=l?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||l?.id==="36f31625-6d6c-4aa4-815a-1493a812841b";u.useEffect(()=>{let s=0;const t=40,i=()=>{const n=[globalThis?.despia,typeof window<"u"?window?.despia:null,globalThis?.Despia,typeof window<"u"?window?.Despia:null,globalThis?.DESPIA,typeof window<"u"?window?.DESPIA:null,globalThis?.OneSignal,typeof window<"u"?window?.OneSignal:null,globalThis?.webkit?.messageHandlers?.despia,typeof window<"u"?window?.webkit?.messageHandlers?.despia:null].find(c=>c!=null)||null;let p=null;try{const c=typeof window<"u"?window:globalThis;for(const m in c)if(m.toLowerCase().includes("despia")||m.toLowerCase().includes("onesignal")){p={key:m,value:c[m]};break}}catch{}const x=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null)||globalThis?.oneSignalPlayerId||(typeof window<"u"?window?.oneSignalPlayerId:null);if(n||p||x){console.log("[Profile] Native API detected:",{despia:!!n,foundInGlobals:p,directPlayerId:x?String(x).slice(0,12)+"‚Ä¶":null,despiaKeys:n?Object.keys(n):[],hasOneSignalRequestPermission:n&&typeof n.oneSignalRequestPermission=="function",hasRequestPermission:n&&typeof n.requestPermission=="function",playerId:n?n.onesignalplayerid||n.oneSignalPlayerId:x}),D(!0);const c=n?n.onesignalplayerid||n.oneSignalPlayerId:x;return c&&F(String(c)),!0}return s++,s<t?setTimeout(i,500):(console.warn("[Profile] Native API not detected after",t,"attempts"),D(!1)),!1};i()},[]),u.useEffect(()=>{q()},[l]);async function q(){if(l)try{const{data:s,error:t}=await y.from("picks").select("*").eq("user_id",l.id);t&&console.error("Error fetching picks:",t);const{data:i,error:a}=await y.from("v_ocp_overall").select("user_id, name, ocp").order("ocp",{ascending:!1});a&&console.error("Error fetching standings:",a);const n=i?i.findIndex(h=>h.user_id===l.id)+1:0,p=i?.find(h=>h.user_id===l.id),{data:x,error:c}=await y.from("gw_results").select("gw, fixture_index, result");c&&console.error("Error fetching results:",c);let m=0;s&&x&&s.forEach(h=>{const E=x.find(I=>I.gw===h.gw&&I.fixture_index===h.fixture_index);E&&E.result===h.pick&&m++}),L({totalPredictions:s?.length||0,correctPredictions:m,totalPoints:p?.ocp||0,globalRank:n,totalUsers:i?.length||0})}catch(s){console.error("Error fetching user stats:",s)}finally{O(!1)}}return l?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",children:e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsx("div",{className:"bg-white rounded-2xl shadow-lg p-6 sm:p-8 mb-6",children:e.jsxs("div",{className:"flex items-start gap-4 sm:gap-6",children:[e.jsx("div",{className:"w-14 h-14 sm:w-16 sm:h-16 bg-[#1C8376] rounded-full flex items-center justify-center text-white text-xl sm:text-2xl font-bold flex-shrink-0",children:(l.user_metadata?.display_name||l.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-slate-800 mb-2 truncate",children:l.user_metadata?.display_name||"User"}),e.jsx("p",{className:"text-slate-600 break-all text-sm sm:text-base",children:l.email}),e.jsxs("p",{className:"text-sm text-slate-500 mt-2",children:["Member since ",new Date(l.created_at||"").toLocaleDateString("en-GB",{month:"long",year:"numeric"})]})]})]})}),A?e.jsx("div",{className:"text-center py-12 text-slate-600",children:"Loading stats..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6 flex flex-col items-center justify-center",children:[e.jsx("div",{className:"text-4xl font-bold text-[#1C8376] mb-2",children:o?.totalPoints||0}),e.jsx("div",{className:"text-sm text-slate-600 font-medium",children:"OCP"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6 text-center",children:[e.jsx("div",{className:"text-4xl font-bold text-blue-600 mb-2",children:o?.globalRank||0}),e.jsx("div",{className:"text-sm text-slate-600 font-medium",children:"Global Rank"}),e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["of ",o?.totalUsers||0,o&&o.globalRank>0&&o.totalUsers>0&&e.jsxs("span",{className:"block mt-1 text-[#1C8376] font-semibold",children:["Top ",Math.round(o.globalRank/o.totalUsers*100),"%"]})]})]})]}),o&&o.totalPredictions>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800 mb-4",children:"Prediction Accuracy"}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"text-slate-600",children:[e.jsx("span",{className:"text-3xl font-bold text-[#1C8376]",children:o.correctPredictions}),e.jsxs("span",{className:"text-slate-500",children:[" / ",o.totalPredictions]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-3xl font-bold text-[#1C8376]",children:[(o.correctPredictions/o.totalPredictions*100).toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-slate-500",children:"accuracy rate"})]})]}),e.jsx("div",{className:"overflow-hidden h-4 text-xs flex rounded-full bg-[#1C8376]/20",children:e.jsx("div",{style:{width:`${o.correctPredictions/o.totalPredictions*100}%`},className:"shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-[#1C8376] transition-all duration-500"})})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800 mb-4",children:"Account Settings"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between py-3 border-b border-slate-200",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-800",children:"Display Name"}),e.jsx("div",{className:"text-sm text-slate-600",children:l.user_metadata?.display_name||"Not set"})]})}),e.jsx("div",{className:"flex items-center justify-between py-3 border-b border-slate-200",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-slate-800",children:"Email"}),e.jsx("div",{className:"text-sm text-slate-600 break-all",children:l.email})]})}),e.jsx("div",{className:"flex items-center justify-between py-3 border-b border-slate-200",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-800",children:"User ID"}),e.jsx("div",{className:"text-xs text-slate-500 font-mono",children:l.id})]})})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-slate-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-3",children:"Data Loading"}),e.jsxs("div",{className:"flex items-center justify-between py-3 border-b border-slate-200",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-slate-800",children:"Load Everything First"}),e.jsx("div",{className:"text-sm text-slate-600 mt-1",children:_?"All data loads before app opens (slower start, no stale data)":"Data loads as you navigate (faster start, may show cached data)"})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer ml-4",children:[e.jsx("input",{type:"checkbox",checked:_,onChange:s=>{const t=s.target.checked;R(t),z(t),alert(t?'"Load Everything First" mode enabled. The app will reload on next visit to apply the change.':'"Load Everything First" mode disabled. The app will reload on next visit to apply the change.')},className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#1C8376]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#1C8376]"})]})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-slate-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-3",children:"Advanced"}),e.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"Check and fix your notification settings to receive chat notifications in mini-leagues."}),e.jsx("div",{className:"mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-600 mb-1",children:"OS Permission:"}),e.jsx("div",{className:"font-semibold text-slate-800",children:f===null?"‚è≥ Checking...":f===!1?"‚ùì Unknown (not native app)":globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null)||w?'‚úÖ Native app (use "Enable Notifications" to check status)':"‚ùì Unknown (not native app)"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-600 mb-1",children:"OneSignal Status:"}),e.jsx("div",{className:"font-semibold text-slate-800",children:(()=>{if(f===null)return"‚è≥ Checking...";if(f===!1)return"‚ùå Not initialized";const s=globalThis?.despia||(typeof window<"u"?window?.despia:null),t=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null);return s?.onesignalplayerid||s?.oneSignalPlayerId||t||w?"‚úÖ Player ID found":"‚ùå Not initialized"})()})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-slate-600 mb-1",children:"Player ID:"}),e.jsx("div",{className:"font-mono text-xs text-slate-700 break-all",children:(()=>{if(f===null)return"Checking...";const s=globalThis?.despia||(typeof window<"u"?window?.despia:null),t=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null),i=s?.onesignalplayerid||s?.oneSignalPlayerId||t||w;if(!i)return"Not available";const a=String(i);return a.slice(0,8)+"‚Ä¶"+a.slice(-4)})()})]})]})}),e.jsxs("div",{className:"mb-4 p-3 bg-slate-100 rounded-lg border border-slate-300 text-xs",children:[e.jsx("div",{className:"font-semibold text-slate-700 mb-2",children:"üîç Debug Info:"}),e.jsxs("div",{className:"space-y-1 text-slate-600 font-mono break-all",children:[e.jsxs("div",{children:["User Agent: ",typeof navigator<"u"?navigator.userAgent.slice(0,50)+"‚Ä¶":"N/A"]}),e.jsxs("div",{children:["globalThis.despia: ",globalThis?.despia?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["window.despia: ",typeof window<"u"&&window?.despia?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["globalThis.Despia: ",globalThis?.Despia?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["window.Despia: ",typeof window<"u"&&window?.Despia?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["globalThis.OneSignal: ",globalThis?.OneSignal?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["window.OneSignal: ",typeof window<"u"&&window?.OneSignal?"‚úÖ Found":"‚ùå Not found"]}),(()=>{const t=[globalThis?.despia,typeof window<"u"?window?.despia:null,globalThis?.Despia,typeof window<"u"?window?.Despia:null,globalThis?.DESPIA,typeof window<"u"?window?.DESPIA:null].find(a=>a!=null)||null;let i=[];try{const a=typeof window<"u"?window:globalThis;for(const n in a)(n.toLowerCase().includes("despia")||n.toLowerCase().includes("onesignal"))&&i.push(n)}catch{}return i.length>0?e.jsxs("div",{className:"mt-2 text-green-600",children:["‚úÖ Found global properties: ",i.join(", ")]}):t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-2 font-semibold",children:"Despia Object Found:"}),e.jsxs("div",{children:["Keys: ",Object.keys(t).slice(0,10).join(", "),Object.keys(t).length>10?"‚Ä¶":""]}),e.jsxs("div",{children:["oneSignalRequestPermission: ",typeof t.oneSignalRequestPermission=="function"?"‚úÖ Function":"‚ùå Not a function"]}),e.jsxs("div",{children:["requestPermission: ",typeof t.requestPermission=="function"?"‚úÖ Function":"‚ùå Not a function"]}),e.jsxs("div",{children:["onesignalplayerid: ",t.onesignalplayerid?"‚úÖ "+String(t.onesignalplayerid).slice(0,12)+"‚Ä¶":"‚ùå"]}),e.jsxs("div",{children:["oneSignalPlayerId: ",t.oneSignalPlayerId?"‚úÖ "+String(t.oneSignalPlayerId).slice(0,12)+"‚Ä¶":"‚ùå"]})]}):e.jsx("div",{className:"mt-2 text-red-600",children:"‚ùå No Despia object found in any location"})})(),e.jsxs("div",{className:"mt-2 text-xs text-slate-500",children:["Polling: ",f===null?"‚è≥ Checking...":f?"‚úÖ Detected":"‚ùå Not detected"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:async()=>{if(!b?.access_token){d("Error: Not signed in");return}P(!0),d(null);try{const{ensurePushSubscribed:s}=await v(async()=>{const{ensurePushSubscribed:i}=await import("./index-BRMfimfo.js").then(a=>a.v);return{ensurePushSubscribed:i}},__vite__mapDeps([0,1])),t=await s(b);t.ok?(d(`‚úÖ Successfully enabled notifications! Player ID: ${t.playerId?.slice(0,8)}‚Ä¶`),setTimeout(()=>d(null),5e3)):d(`‚ö†Ô∏è ${{"permission-denied":"Permission denied. Please enable notifications in iOS Settings.","no-player-id":"OneSignal not initialized. Please wait a few seconds and try again.","api-not-available":"Not available in browser. Please use the native app.","no-session":"Not signed in. Please sign in and try again.",unknown:"Unknown error. Please try again or contact support."}[t.reason||"unknown"]||"Failed to enable notifications"}`)}catch(s){d(`‚ùå Error: ${s.message||"Failed to enable notifications"}`)}finally{P(!1)}},disabled:N||!b?.access_token,className:"w-full py-3 bg-white border border-slate-300 hover:bg-slate-50 disabled:bg-gray-100 disabled:opacity-50 text-slate-600 hover:text-slate-800 font-medium rounded-xl transition-colors",children:N?"Enabling...":"Enable Notifications"}),e.jsx("button",{onClick:async()=>{let s=null;try{s=(await v(()=>import("./index-ClJqDSFp.js").then(i=>i.i),__vite__mapDeps([2,0,1]))).default}catch{s=globalThis?.despia||(typeof window<"u"?window?.despia:null)}if(s&&typeof s=="function")try{s("settingsapp://")}catch{alert("Please go to iOS Settings ‚Üí TotL ‚Üí Notifications and enable notifications")}else alert("Please go to iOS Settings ‚Üí TotL ‚Üí Notifications and enable notifications")},className:"w-full py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-medium rounded-xl transition-colors text-sm hidden",children:"‚öôÔ∏è Open OS Settings"}),e.jsx("button",{onClick:async()=>{if(!b?.access_token){d("Error: Not signed in");return}k(!0),d(null),T(null);try{const t=await(await fetch("/.netlify/functions/checkMySubscription",{headers:{Authorization:`Bearer ${b.access_token}`}})).json();if(T(t),t.subscribed)d("‚úÖ Device is subscribed! Notifications should work.");else{const i=t.reasons||[],a=t.suggestion||"Enable notifications in iOS Settings";d(`‚ö†Ô∏è Not subscribed: ${i.join("; ")}. ${a}`)}}catch(s){d(`‚ùå Error checking subscription: ${s.message}`)}finally{k(!1)}},disabled:S||!b?.access_token,className:"w-full py-3 bg-white border border-slate-300 hover:bg-slate-50 disabled:bg-gray-100 disabled:opacity-50 text-slate-600 hover:text-slate-800 font-medium rounded-xl transition-colors",children:S?"Checking...":"Check Subscription Status"}),e.jsx("button",{onClick:async()=>{let s=null;try{const i=(await v(()=>import("./index-ClJqDSFp.js").then(a=>a.i),__vite__mapDeps([2,0,1]))).default;s=i?.onesignalplayerid||i?.oneSignalPlayerId||null}catch{s=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null)}s=s||w,s?(await navigator.clipboard.writeText(String(s)),d("‚úÖ Player ID copied to clipboard"),setTimeout(()=>d(null),2e3)):d("‚ö†Ô∏è Player ID not available")},className:"w-full py-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 hover:text-slate-800 font-medium rounded-xl transition-colors",children:"Copy Player ID"})]}),g&&e.jsx("div",{className:`mt-3 p-3 rounded-lg text-sm ${g.includes("‚úÖ")?"bg-green-50 text-green-800 border border-green-200":g.includes("‚ö†Ô∏è")?"bg-amber-50 text-amber-800 border border-amber-200":"bg-red-50 text-red-800 border border-red-200"}`,children:g}),r&&r.details&&e.jsxs("div",{className:"mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200 text-xs",children:[e.jsx("div",{className:"font-semibold text-slate-700 mb-2",children:"üìä OneSignal Status Details:"}),e.jsxs("div",{className:"space-y-1 text-slate-600 font-mono",children:[e.jsxs("div",{children:["Has Token: ",r.details.hasToken?"‚úÖ Yes":"‚ùå No"]}),e.jsxs("div",{children:["Invalid: ",r.details.invalid?"‚ùå Yes":"‚úÖ No"]}),e.jsxs("div",{children:["Notification Types: ",r.details.notificationTypes??"null"]}),e.jsxs("div",{children:["Device Type: ",r.details.deviceType||"N/A"]}),e.jsxs("div",{children:["Last Active: ",r.details.lastActive?new Date(r.details.lastActive).toLocaleString():"Never"]}),r.reasons&&r.reasons.length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-slate-300",children:[e.jsx("div",{className:"font-semibold text-red-600",children:"Issues Found:"}),r.reasons.map((s,t)=>e.jsxs("div",{className:"text-red-600",children:["‚Ä¢ ",s]},t))]})]})]})]}),U&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-slate-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-3",children:"Admin"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{to:"/api-admin",className:"block w-full py-3 bg-[#1C8376] hover:bg-[#1C8376]/90 text-white font-semibold rounded-xl transition-colors text-center",children:"API Admin - Premier League"}),e.jsx(j,{to:"/test-fixtures",className:"block w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition-colors text-center",children:"Test Fixtures (Non-PL)"}),e.jsx(j,{to:"/admin",className:"block w-full py-3 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-xl transition-colors text-center",children:"Admin Panel (Web)"})]})]}),e.jsx("button",{onClick:async()=>{await C()},className:"w-full mt-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-colors",children:"Sign Out"})]})]})}):e.jsx("div",{className:"p-6",children:"Please sign in to view your profile."})}export{V as default};
