import{r as v,s as E}from"./index-CKJVCyNd.js";function T(u,n){const[y,w]=v.useState(new Map),[L,d]=v.useState(!0),[b,g]=v.useState(null);return v.useEffect(()=>{let h=null,o=!0,a=null,S=Date.now();async function m(){try{let r=E.from("live_scores").select("*");u!==void 0&&(r=r.eq("gw",u)),n&&n.length>0&&(r=r.in("api_match_id",n));const{data:p,error:s}=await r;if(s){console.error("[useLiveScores] Error fetching scores:",s),o&&(g(s.message),d(!1));return}const _=new Map;(p||[]).forEach(t=>{_.set(t.api_match_id,t)}),o&&(w(t=>{let l=!1;const f=new Map(t);return _.forEach((e,i)=>{const c=t.get(i);(!c||c.home_score!==e.home_score||c.away_score!==e.away_score||c.status!==e.status||c.minute!==e.minute||JSON.stringify(c.goals)!==JSON.stringify(e.goals)||JSON.stringify(c.red_cards)!==JSON.stringify(e.red_cards))&&(f.set(i,e),l=!0)}),t.forEach((e,i)=>{_.has(i)||(f.delete(i),l=!0)}),l?new Map(f):t}),d(!1),S=Date.now())}catch(r){console.error("[useLiveScores] Error fetching scores:",r),o&&(g(r?.message||"Failed to fetch live scores"),d(!1))}}async function N(){try{await m();const r=`live_scores_${u||"all"}_${n?.join("-")||"all"}_${Date.now()}`;h=E.channel(r).on("postgres_changes",{event:"*",schema:"public",table:"live_scores"},s=>{if(!o)return;const _=t=>!(!t||u!==void 0&&t.gw!==u||n&&n.length>0&&!n.includes(t.api_match_id));w(t=>{const l=new Map(t);let f=!1;if(s.eventType==="INSERT"||s.eventType==="UPDATE"){const e=s.new;if(console.log("[useLiveScores] Real-time update received:",s.eventType,e?.api_match_id),_(e)){const i=t.get(e.api_match_id);(!i||i.home_score!==e.home_score||i.away_score!==e.away_score||i.status!==e.status||i.minute!==e.minute||JSON.stringify(i.goals)!==JSON.stringify(e.goals)||JSON.stringify(i.red_cards)!==JSON.stringify(e.red_cards))&&(l.set(e.api_match_id,e),f=!0,S=Date.now(),console.log("[useLiveScores] Updated score for match",e.api_match_id,"minute:",e.minute))}}else if(s.eventType==="DELETE"){const e=s.old;_(e)&&(l.delete(e.api_match_id),f=!0)}return f?new Map(l):new Map(t)})}).subscribe(s=>{console.log("[useLiveScores] Subscription status:",s),s==="SUBSCRIBED"?console.log("[useLiveScores] Successfully subscribed to real-time updates"):(s==="CHANNEL_ERROR"||s==="TIMED_OUT")&&(console.error("[useLiveScores] Channel error:",s),o&&(g("Real-time subscription failed, using polling fallback"),a||(a=window.setInterval(()=>{o&&m()},5e3))))});const p=setInterval(()=>{Date.now()-S>3e4&&!a&&(console.warn("[useLiveScores] No real-time updates for 30s, starting polling fallback"),a=window.setInterval(()=>{o&&m()},5e3))},1e4);return()=>{clearInterval(p)}}catch(r){console.error("[useLiveScores] Error setting up subscription:",r),o&&(g(r?.message||"Failed to set up live scores subscription"),d(!1),a||(a=window.setInterval(()=>{o&&m()},5e3)))}}return N(),()=>{o=!1,h&&E.removeChannel(h),a&&clearInterval(a)}},[u,n?n.join(","):void 0]),{liveScores:y,loading:L,error:b}}export{T as u};
