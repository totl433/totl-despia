import{u as N,r as d,a as m,j as e,L as P,P as j}from"./index-obwd5zJk.js";import{N as v}from"./NotificationSection-UzDcNjuu.js";function T(){const{user:t}=N(),[u,c]=d.useState([{id:"new-gameweek",label:"New Gameweek Published",description:"Email me when new fixtures are ready.",enabled:!1},{id:"results-published",label:"Results Published",description:"Email me when results and league tables are updated.",enabled:!1},{id:"news-updates",label:"TOTL News & Updates",description:"Occasional emails about new features and announcements.",enabled:!1}]),[x,f]=d.useState(!0),[g,p]=d.useState(!1),w={"new-gameweek":"new_gameweek","results-published":"results_published","news-updates":"news_updates"};d.useEffect(()=>{if(!t){f(!1);return}k()},[t]);async function b(s){if(t)try{const{data:{session:r}}=await m.auth.getSession();if(!r?.access_token){console.warn("[EmailPreferences] No session token, skipping MailerLite sync");return}const n=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"https://totl-staging.netlify.app/.netlify/functions/syncEmailPreferences":"/.netlify/functions/syncEmailPreferences",a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`}});if(!a.ok){const i=await a.text();throw new Error(`MailerLite sync failed: ${a.status} ${i}`)}console.log("[EmailPreferences] Successfully synced preferences to MailerLite")}catch(r){console.error("[EmailPreferences] Error syncing to MailerLite:",r)}}async function k(){if(t)try{const{data:s,error:r}=await m.from("email_preferences").select("new_gameweek, results_published, news_updates").eq("user_id",t.id).maybeSingle();r&&r.code!=="PGRST116"&&console.error("Error fetching email preferences:",r),s&&c([{id:"new-gameweek",label:"New Gameweek Published",description:"Email me when new fixtures are ready.",enabled:s.new_gameweek??!1},{id:"results-published",label:"Results Published",description:"Email me when results and league tables are updated.",enabled:s.results_published??!1},{id:"news-updates",label:"TOTL News & Updates",description:"Occasional emails about new features and announcements.",enabled:s.news_updates??!1}])}catch(s){console.error("Error fetching email preferences:",s)}finally{f(!1)}}async function y(s,r){if(!t)return;if(c(n=>n.map(a=>a.id===s?{...a,enabled:r}:a)),!w[s]){console.error("Unknown preference ID:",s);return}p(!0);try{const n=u.reduce((o,l)=>{const h=w[l.id];return h&&(o[h]=l.id===s?r:l.enabled),o},{}),a={user_id:t.id,...n},{error:i}=await m.from("email_preferences").upsert(a,{onConflict:"user_id"});if(i){console.error("Error saving email preference:",i),c(o=>o.map(l=>l.id===s?{...l,enabled:!r}:l));return}b(n).catch(o=>{console.error("Error syncing to MailerLite:",o)})}catch(n){console.error("Error saving email preference:",n),c(a=>a.map(i=>i.id===s?{...i,enabled:!r}:i))}finally{p(!1)}}return t?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800",children:e.jsxs("div",{className:"max-w-4xl lg:max-w-[1024px] mx-auto px-4 lg:px-6 py-6",children:[e.jsxs(P,{to:"/profile",className:"inline-flex items-center gap-2 text-slate-600 dark:text-slate-400 mb-4",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),e.jsx("span",{children:"Back to Profile"})]}),e.jsx(j,{title:"Email Preferences",as:"h1",className:"mb-6"}),e.jsxs("div",{className:"space-y-6",children:[x?e.jsx("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 text-center",children:e.jsx("p",{className:"text-slate-600 dark:text-slate-300",children:"Loading preferences..."})}):e.jsx(v,{title:"Email Preferences",description:"Choose which emails you'd like to receive from TOTL",options:u,onToggle:y}),g&&e.jsx("div",{className:"text-sm text-slate-500 dark:text-slate-400 text-center",children:"Saving preferences..."})]})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6",children:e.jsx("div",{className:"max-w-4xl lg:max-w-[1024px] mx-auto px-4 lg:px-6",children:e.jsx("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 text-center",children:e.jsx("p",{className:"text-slate-600 dark:text-slate-300",children:"Please sign in to view your email preferences."})})})})}export{T as default};
