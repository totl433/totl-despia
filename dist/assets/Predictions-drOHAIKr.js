import{j as e,u as ee,r as d,s as v,i as te}from"./index-CpwqYQVG.js";import{a as se}from"./teamNames-lueGeFt9.js";function ie(...t){return t.filter(Boolean).join(" ")}function G({label:t,active:c,disabled:a,onClick:w}){return e.jsx("button",{type:"button",disabled:a,onClick:w,className:ie("h-16 rounded-xl border text-sm font-medium transition-colors","flex items-center justify-center",c?"bg-emerald-600 text-white border-emerald-600":"bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100",a&&"opacity-60 cursor-not-allowed"),children:t})}function I(t,c){const a=t?.[`${c}_name`],w=t?.[`${c}_team`],j=t?.[`${c}_code`]||a||w||"";return se(j)||(c==="home"?"Home":"Away")}function K(...t){return t.filter(Boolean).join(" ")}function ne(t){return t?t.result==="H"||t.result==="D"||t.result==="A"?t.result:typeof t.home_goals=="number"&&typeof t.away_goals=="number"?t.home_goals>t.away_goals?"H":t.home_goals<t.away_goals?"A":"D":null:null}function H({label:t,correct:c,isCorrectResult:a}){const w="h-16 rounded-xl border text-sm font-medium transition-colors flex items-center justify-center select-none",l=c===!0?"bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 text-white !border-0 !border-none shadow-2xl shadow-yellow-400/40 transform scale-110 rotate-1 relative overflow-hidden before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/70 before:to-transparent before:animate-[shimmer_1.2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/50 after:to-transparent after:animate-[shimmer_1.8s_ease-in-out_infinite_0.4s]":a?"bg-emerald-600 text-white border-emerald-600":c===!1?"bg-rose-100 text-rose-700 border-rose-200":"bg-slate-50 text-slate-600 border-slate-200";return e.jsx("div",{className:[w,l].join(" "),children:e.jsx("span",{className:c===!0?"font-bold":"",children:t})})}function de(){const{user:t}=ee(),[c]=d.useState(()=>{const s=localStorage.getItem("oldSchoolMode");return s?JSON.parse(s):!1});d.useEffect(()=>{localStorage.setItem("oldSchoolMode",JSON.stringify(c))},[c]);const[a,w]=d.useState(null),[l,j]=d.useState([]),[b,N]=d.useState({}),[q,z]=d.useState([]),[u,D]=d.useState(!1),[E,W]=d.useState(!1),[U,L]=d.useState(!1),[J,C]=d.useState(!0),[P,x]=d.useState(""),[Y,T]=d.useState(!1),[_,B]=d.useState(!1);d.useEffect(()=>{u&&window.scrollTo({top:0,behavior:"smooth"})},[u]),d.useEffect(()=>{let s=!0;(async()=>{const i=await R();s&&w(i)})();const n=async()=>{const i=await R();w(i)};return window.addEventListener("focus",n),()=>{s=!1,window.removeEventListener("focus",n)}},[t?.id]),d.useEffect(()=>{let s=!0;return(async()=>{if(C(!0),x(""),a==null){j([]),N({}),D(!1),C(!1);return}const{data:n,error:i}=await v.from("fixtures").select("gw, fixture_index, home_name, away_name, home_team, away_team, home_code, away_code, kickoff_time").eq("gw",a).order("fixture_index",{ascending:!0});if(i){s&&(x(i.message),j([]),N({}),D(!1),C(!1));return}const o=n??[];if(!s)return;if(j(o),o.length>0&&o[0].kickoff_time){const p=new Date(o[0].kickoff_time),Z=new Date(p.getTime()-4500*1e3);B(new Date>Z)}else B(!1);const{data:r,error:m}=await v.from("picks").select("gw, fixture_index, pick").eq("gw",a).eq("user_id",t?.id);m&&s&&x(m.message);const h={};if(o.forEach(p=>h[p.fixture_index]=null),r?.forEach(p=>{h[p.fixture_index]=p.pick}),!s)return;N(h);const{data:g,error:f}=await v.from("gw_submissions").select("gw, submitted_at").eq("gw",a).eq("user_id",t?.id).maybeSingle();if(f&&s&&x(f.message),!s)return;D(!!g?.submitted_at);const{data:y,error:k}=await v.from("gw_results").select("gw, fixture_index, result").eq("gw",a);k&&s&&x(k.message),s&&z(y??[]),C(!1)})(),()=>{s=!1}},[a,t?.id]);const F=d.useMemo(()=>{const s=new Map;return l.forEach(i=>{const o=i.kickoff_time?new Date(i.kickoff_time):null,r=o?o.toISOString().slice(0,10):"unknown",m=o?re(o):"TBC";s.has(r)||s.set(r,{label:m,items:[]}),s.get(r).items.push(i)}),[...s.entries()].sort((i,o)=>{const r=i[1].items[0]?.fixture_index??0,m=o[1].items[0]?.fixture_index??0;return r-m}).map(([,i])=>i)},[l]);function A(s,n){u||N(i=>({...i,[s]:n}))}async function M(){if(!(u||!t?.id)){W(!0),x("");try{const s=Object.entries(b).filter(([,n])=>n).map(([n,i])=>({user_id:t.id,gw:a,fixture_index:Number(n),pick:i}));if(s.length){const{error:n}=await v.from("picks").upsert(s,{onConflict:"user_id,gw,fixture_index"});if(n)throw n}L(!0),window.setTimeout(()=>L(!1),2500)}catch(s){x(s?.message??"Failed to save picks.")}finally{W(!1)}}}async function Q(){if(!u){if(l.length>0&&l[0].kickoff_time){const s=new Date(l[0].kickoff_time),n=new Date(s.getTime()-4500*1e3);if(new Date>n){const o=n.toLocaleDateString(void 0,{weekday:"short"}),r=n.toLocaleDateString(void 0,{month:"short"}),m=n.toLocaleDateString(void 0,{day:"numeric"}),h=String(n.getUTCHours()).padStart(2,"0"),g=String(n.getUTCMinutes()).padStart(2,"0"),f=`${o}, ${r} ${m}, ${h}:${g}`;x(`⚠️ Too late! Submissions closed at ${f}. The deadline was 75 minutes before the first kickoff.`);return}}T(!0)}}async function V(){if(u)return;if(l.length>0&&l[0].kickoff_time){const o=new Date(l[0].kickoff_time),r=new Date(o.getTime()-4500*1e3);if(new Date>r){const h=r.toLocaleDateString(void 0,{weekday:"short"}),g=r.toLocaleDateString(void 0,{month:"short"}),f=r.toLocaleDateString(void 0,{day:"numeric"}),y=String(r.getUTCHours()).padStart(2,"0"),k=String(r.getUTCMinutes()).padStart(2,"0"),p=`${h}, ${g} ${f}, ${y}:${k}`;x(`⚠️ Too late! Submissions closed at ${p}. The deadline was 75 minutes before the first kickoff.`),T(!1);return}}await M();const s=l.length,n=Object.values(b).filter(Boolean).length;if(n!==s){x(`Please make predictions for all ${s} fixtures before submitting. You have ${n}/${s} completed.`);return}const{error:i}=await v.from("gw_submissions").upsert([{user_id:t?.id,gw:a,submitted_at:new Date().toISOString()}],{onConflict:"user_id,gw"});if(i)x(i.message);else{D(!0),t?.id&&te(t.id),window.dispatchEvent(new CustomEvent("predictionsSubmitted"));const{data:o}=await v.from("league_members").select("league_id").eq("user_id",t?.id);o&&o.length>0&&o.forEach(({league_id:r})=>{fetch("/.netlify/functions/notifyFinalSubmission",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({leagueId:r,matchday:a,isTestApi:!1})}).catch(m=>{console.error("[Predictions] Failed to check final submission:",m)})})}T(!1)}const S=new Map;q.forEach(s=>{const n=ne(s);n&&S.set(s.fixture_index,n)});const $=l.length>0&&S.size>0&&S.size===l.length,X=Object.entries(b).reduce((s,[n,i])=>{const o=Number(n),r=S.get(o);return!r||!i?s:s+(i===r?1:0)},0);return J?e.jsx("div",{className:"max-w-2xl mx-auto px-4 py-8",children:e.jsx("div",{className:"text-slate-500",children:"Loading…"})}):e.jsx("div",{className:`min-h-screen bg-slate-50 ${c?"oldschool-theme":""}`,children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-4",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900",children:"Predictions Center"}),e.jsx("p",{className:"mt-2 mb-6 text-sm text-slate-600 w-full",children:"Call every game, lock in your results, and climb the table."}),e.jsxs("div",{className:"text-slate-600 text-lg font-semibold mt-1",children:["Game Week ",O(a)]}),e.jsx("div",{className:"mt-3",children:$?e.jsx("div",{className:"rounded-xl border bg-gradient-to-r from-emerald-50 to-blue-50 border-emerald-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-emerald-900 font-semibold text-lg",children:["GW ",O(a)," Complete"]}),e.jsx("div",{className:"text-emerald-900 text-sm font-bold mt-1",children:"Your Score"})]}),e.jsx("div",{className:"text-emerald-900 text-5xl font-extrabold",children:X})]})}):null}),P&&e.jsx("div",{className:"mt-4 rounded border border-rose-200 bg-rose-50 text-rose-700 px-3 py-2 text-sm",children:P}),!u&&l.length>0&&l[0].kickoff_time&&!_&&(()=>{const s=new Date(l[0].kickoff_time),n=new Date(s.getTime()-4500*1e3),i=new Date,r=(n.getTime()-i.getTime())/(1e3*60*60);if(r<=2&&r>0){const m=n.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"mt-4 rounded border border-amber-200 bg-amber-50 text-amber-800 px-3 py-2 text-sm",children:["⏰ ",e.jsx("strong",{children:"Deadline approaching!"})," Submissions close at ",m," (75 minutes before first kickoff)."]})}return null})(),F.length===0?e.jsxs("div",{className:"mt-6 rounded border bg-white p-4 text-slate-600",children:["No fixtures found for GW ",O(a),". Add fixtures on the Admin page, then come back."]}):e.jsxs("div",{className:"mt-6 space-y-6",children:[!$&&u&&e.jsxs("div",{className:"bg-gradient-to-r from-emerald-500 via-green-500 to-emerald-600 rounded-2xl p-6 text-center shadow-2xl shadow-emerald-500/30 transform scale-105 relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-[shimmer_2s_ease-in-out_infinite]"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:"text-white font-bold text-2xl mb-1",children:"Predictions Submitted!"}),e.jsxs("div",{className:"text-emerald-100 text-lg",children:["Your picks are locked in for GW ",a]}),e.jsx("div",{className:"text-emerald-200 text-sm mt-2",children:"Good luck!"})]})]}),F.map((s,n)=>e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 mb-3",children:s.label}),e.jsx("div",{className:"space-y-4",children:s.items.map(i=>{const o=I(i,"home"),r=I(i,"away"),m=i.kickoff_time?oe(new Date(i.kickoff_time)):"—",h=b[i.fixture_index]??null,g=S.get(i.fixture_index)??null;return e.jsxs("div",{className:"rounded-2xl border bg-white p-3 shadow-sm",children:[e.jsxs("div",{className:"flex items-center px-2 pt-1 pb-3",children:[e.jsxs("div",{className:"flex items-center gap-1 flex-1 justify-end",children:[e.jsx("div",{className:"truncate font-medium",children:o}),e.jsx("img",{src:`/assets/badges/${i.home_code?.toUpperCase()||"UNK"}.png`,alt:o,className:"w-5 h-5",onError:f=>{f.currentTarget.style.display="none"}})]}),e.jsx("div",{className:"text-slate-500 text-sm px-4",children:m}),e.jsxs("div",{className:"flex items-center gap-1 flex-1 justify-start",children:[e.jsx("img",{src:`/assets/badges/${i.away_code?.toUpperCase()||"UNK"}.png`,alt:r,className:"w-5 h-5",onError:f=>{f.currentTarget.style.display="none"}}),e.jsx("div",{className:"truncate font-medium",children:r})]})]}),(o==="Home"||r==="Away")&&e.jsxs("div",{className:"px-2 pb-2 text-[11px] text-slate-400",children:[o==="Home"?"[no home name/code]":""," ",r==="Away"?"[no away name/code]":""]}),$?e.jsx("div",{className:"grid grid-cols-3 gap-3",children:(()=>{const f=b[i.fixture_index]??null,y=k=>f!==k||!g?null:g===k;return e.jsxs(e.Fragment,{children:[e.jsx(H,{label:"Home Win",correct:y("H"),isCorrectResult:g==="H"}),e.jsx(H,{label:"Draw",correct:y("D"),isCorrectResult:g==="D"}),e.jsx(H,{label:"Away Win",correct:y("A"),isCorrectResult:g==="A"})]})})()}):e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(G,{label:"Home Win",active:h==="H",onClick:()=>A(i.fixture_index,"H"),disabled:u}),e.jsx(G,{label:"Draw",active:h==="D",onClick:()=>A(i.fixture_index,"D"),disabled:u}),e.jsx(G,{label:"Away Win",active:h==="A",onClick:()=>A(i.fixture_index,"A"),disabled:u})]})]},i.fixture_index)})})]},n))]}),!$&&!u&&l.length>0&&e.jsxs("div",{className:"mt-6",children:[U&&e.jsx("div",{className:"mb-3 text-center",children:e.jsx("span",{"aria-live":"polite",className:"text-sm rounded border border-emerald-200 bg-emerald-50 text-emerald-900 px-3 py-2 inline-block",children:"Saved — don't forget to submit before the deadline."})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:M,disabled:E,className:K("flex-1 px-4 py-3 rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors",E&&"opacity-50 cursor-not-allowed"),children:E?"Saving…":U?"Saved":"Save GW"}),e.jsx("button",{onClick:Q,disabled:_||Object.values(b).filter(Boolean).length!==l.length,className:K("flex-1 px-4 py-3 rounded-md text-white font-semibold transition-colors",_?"bg-red-500 cursor-not-allowed":Object.values(b).filter(Boolean).length===l.length?"bg-emerald-600 hover:bg-emerald-700":"bg-gray-400 cursor-not-allowed"),title:_?"⚠️ Submissions closed - deadline has passed":Object.values(b).filter(Boolean).length===l.length?"Submitting locks your picks for this GW.":`Complete all ${l.length} predictions before submitting`,children:_?"⚠️ Deadline Passed":"Submit GW"})]}),e.jsx("div",{className:"mt-2 text-center",children:e.jsx("span",{className:"text-xs text-slate-500",children:"Submitting locks your picks for this GW."})})]}),Y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-3",children:"Confirm Submission"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Are you sure you want to submit your predictions? Once submitted, they'll be locked for this Gameweek."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>T(!1),className:"flex-1 px-4 py-2 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:V,className:"flex-1 px-4 py-2 rounded-md bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition-colors",children:"Submit GW"})]})]})})]})})}async function R(){const{data:t}=await v.from("meta").select("current_gw").eq("id",1).single();return t?.current_gw??null}function O(t,c=1){return typeof t=="number"&&t>0?t:c}function re(t){return t.toLocaleDateString(void 0,{weekday:"short",day:"numeric",month:"short"})}function oe(t){const c=String(t.getUTCHours()).padStart(2,"0"),a=String(t.getUTCMinutes()).padStart(2,"0");return`${c}:${a}`}export{de as default};
