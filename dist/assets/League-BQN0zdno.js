import{r as a,s as zt,C as Gt,a as P,g as ve,j as e,V as Qs,U as st,b as js,u as _s,i as ea,c as cs,T as ds,D as ta,d as sa,e as aa,f as na,h as ra,k as ia,l as Ut,m as us,n as $t,o as tt,p as oa,q as la,L as ms,t as Ft,v as fs,I as hs,w as gs,x as ps}from"./index-NKiev1v8.js";import{C as ca}from"./index.module-VIxakuXK.js";const _e=[];for(let t=0;t<256;++t)_e.push((t+256).toString(16).slice(1));function da(t,c=0){return(_e[t[c+0]]+_e[t[c+1]]+_e[t[c+2]]+_e[t[c+3]]+"-"+_e[t[c+4]]+_e[t[c+5]]+"-"+_e[t[c+6]]+_e[t[c+7]]+"-"+_e[t[c+8]]+_e[t[c+9]]+"-"+_e[t[c+10]]+_e[t[c+11]]+_e[t[c+12]]+_e[t[c+13]]+_e[t[c+14]]+_e[t[c+15]]).toLowerCase()}let Ht;const ua=new Uint8Array(16);function ma(){if(!Ht){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ht=crypto.getRandomValues.bind(crypto)}return Ht(ua)}const fa=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),xs={randomUUID:fa};function ha(t,c,w){t=t||{};const f=t.random??t.rng?.()??ma();if(f.length<16)throw new Error("Random bytes length must be >= 16");return f[6]=f[6]&15|64,f[8]=f[8]&63|128,da(f)}function ga(t,c,w){return xs.randomUUID&&!t?xs.randomUUID():ha(t)}const Te=(t,c,w,f)=>{fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:t,message:c,data:w,timestamp:Date.now(),sessionId:"debug-session",hypothesisId:f||"ALL"})}).catch(()=>{})},bs=50,Ye=t=>{let c=null;if(t.reply_to){const w=Array.isArray(t.reply_to)?t.reply_to[0]:t.reply_to;t.reply_to_message_id&&(console.log("[normalizeMessage] Message has reply_to_message_id:",t.reply_to_message_id,"reply_to:",t.reply_to,"replyToData:",w),w&&console.log("[normalizeMessage] replyToData.id:",w.id,"replyToData.user_id:",w.user_id,"replyToData.content:",w.content)),w&&w.id&&w.user_id?c={id:w.id,content:w.content||"",user_id:w.user_id,author_name:w.author_name}:t.reply_to_message_id&&w&&console.warn("[normalizeMessage] Cannot create reply_to object - missing required fields. replyToData:",w,"has id:",!!w?.id,"has user_id:",!!w?.user_id)}return{id:t.id,league_id:t.league_id,user_id:t.user_id,content:t.content,created_at:t.created_at??new Date().toISOString(),status:"sent",reply_to_message_id:t.reply_to_message_id??null,reply_to:c}},Re=t=>{const c=new Map;for(const w of t)if(w.id.startsWith("optimistic-")&&w.client_msg_id)t.some(o=>!o.id.startsWith("optimistic-")&&o.client_msg_id===w.client_msg_id)||c.set(w.id,w);else{if(w.client_msg_id){const f=Array.from(c.keys()).find(o=>{const L=c.get(o);return L?.id.startsWith("optimistic-")&&L.client_msg_id===w.client_msg_id});f&&c.delete(f)}c.set(w.id,w)}return Array.from(c.values()).sort((w,f)=>new Date(w.created_at).getTime()-new Date(f.created_at).getTime())};function pa(t,c={}){const{userId:w,enabled:f=!0,autoSubscribe:o=!0}=c,L=()=>!t||!f?[]:ve(`chat:messages:${t}`)||[],[S,K]=a.useState(L),[n,z]=a.useState(!1),[$,V]=a.useState(!1),[ie,_]=a.useState(!0),[M,Y]=a.useState(null),X=a.useRef(null),G=a.useRef(null),y=a.useRef(!1),Z=a.useRef(null),he=a.useRef(0),F=a.useRef(S),Q=a.useCallback(oe=>{K(ee=>{const j=oe(ee);if(F.current=j,X.current=j.length?j[0].created_at:null,Z.current=j.length?j[j.length-1].created_at:null,t&&j.length>0){const O=j.filter(i=>!i.id.startsWith("optimistic-"));if(O.length>0){const i=Date.now();if(i-he.current>2e3){he.current=i;const b=`chat:messages:${t}`;zt(b,O,Gt.HOME)}}}return j})},[t]),de=a.useRef(null),ke=a.useRef(null);a.useEffect(()=>{F.current=S},[S]);const me=a.useCallback(async({before:oe,append:ee})=>{if(!t||!f)return;console.log("[fetchPage] Starting fetch for league:",t,"append:",ee,"before:",oe);const j=P.from("league_messages").select(`
          id, 
          league_id, 
          user_id, 
          content, 
          created_at,
          reply_to_message_id
        `).eq("league_id",t).order("created_at",{ascending:!1}).limit(bs);oe&&j.lt("created_at",oe);const{data:O,error:i}=await j;if(i)throw console.error("[useMiniLeagueChat] Error fetching messages:",i),i;console.log("[fetchPage] Fetched",O?.length||0,"messages from database"),Te("useMiniLeagueChat.ts:fetchPage:fetched","Fetched messages from database",{messageCount:O?.length||0,before:oe,append:ee,latestMessageId:O?.[0]?.id,latestMessageContent:O?.[0]?.content?.slice(0,50),latestMessageCreatedAt:O?.[0]?.created_at},"H7");const b=(O??[]).filter(p=>p.reply_to_message_id),x=[...new Set(b.map(p=>p.reply_to_message_id))];console.log("[fetchPage] Found",b.length,"messages with reply_to_message_id, unique reply IDs:",x.length);let R=new Map;if(x.length>0){const{data:p,error:g}=await P.from("league_messages").select("id, content, user_id").in("id",x);g&&console.error("[useMiniLeagueChat] Error fetching reply messages:",g),!g&&p&&p.forEach(B=>{R.set(B.id,B)})}if(O&&O.length>0){const p=O.filter(g=>g.reply_to_message_id);p.length>0&&(console.log("[fetchPage] Found",p.length,"messages with reply_to_message_id"),p.slice(0,3).forEach(g=>{const B=R.get(g.reply_to_message_id);console.log("[fetchPage] Message",g.id,"reply_to_message_id:",g.reply_to_message_id,"replyData:",B)}))}const m=(O??[]).map(p=>{if(p.reply_to_message_id){const g=R.get(p.reply_to_message_id);g?p.reply_to=g:p.reply_to=null}else p.reply_to=null;return Ye(p)}).reverse();Q(p=>{Te("useMiniLeagueChat.ts:fetchPage:before-merge","Before merging fetched messages",{prevCount:p.length,normalizedCount:m.length,append:ee,prevLatestId:p[p.length-1]?.id,prevLatestCreatedAt:p[p.length-1]?.created_at,normalizedLatestId:m[m.length-1]?.id,normalizedLatestCreatedAt:m[m.length-1]?.created_at,normalizedFirstId:m[0]?.id,normalizedFirstCreatedAt:m[0]?.created_at},"H7");let g;return ee?g=Re([...m,...p]):g=Re([...p,...m]),Te("useMiniLeagueChat.ts:fetchPage:after-merge","After merging fetched messages",{resultCount:g.length,resultLatestId:g[g.length-1]?.id,resultLatestCreatedAt:g[g.length-1]?.created_at,addedCount:g.length-p.length,removedCount:p.length+m.length-g.length},"H7"),g}),(O??[]).length<bs?_(!1):ee||_(!0)},[t,f,Q]),Me=a.useCallback(async()=>{if(!t||!f){K([]),_(!0);return}if(y.current){console.log("[useMiniLeagueChat] Refresh already in progress, skipping");return}y.current=!0;const oe=F.current,ee=oe.length>0;ee||z(!0),Y(null);try{const j=oe.filter(i=>i.id.startsWith("optimistic-")&&i.status==="sending"),O=ve(`chat:messages:${t}`);if(O&&O.length>0&&!ee){const i=[...O,...j];Q(()=>Re(i)),O.length>0&&(X.current=O[0].created_at,Z.current=O[O.length-1].created_at),_(O.length>=50),z(!1)}console.log("[useMiniLeagueChat] Refreshing messages from database"),await me({append:!1}),j.length>0&&Q(i=>{const b=new Set(i.filter(R=>R.id.startsWith("optimistic-")).map(R=>R.id)),x=j.filter(R=>!b.has(R.id));return x.length>0?Re([...i,...x]):i}),!ee&&O&&O.length>0}catch(j){console.error("[useMiniLeagueChat] Error in refresh:",j),Y(j?.message??"Failed to load chat")}finally{y.current=!1,ee||z(!1)}},[t,f,me,Q]);a.useEffect(()=>{de.current=Me,ke.current=Q},[Me,Q]);const De=a.useRef({});a.useEffect(()=>{const oe={miniLeagueId:t,enabled:f,autoSubscribe:o},ee=De.current,j=Object.keys(oe).filter(k=>oe[k]!==ee[k]);if(j.length>0&&Te("useMiniLeagueChat.ts:useEffect:deps-changed","Subscription effect dependencies changed",{changed:j,prevMiniLeagueId:ee.miniLeagueId,currentMiniLeagueId:oe.miniLeagueId,prevEnabled:ee.enabled,currentEnabled:oe.enabled,prevAutoSubscribe:ee.autoSubscribe,currentAutoSubscribe:oe.autoSubscribe,stackTrace:new Error().stack?.split(`
`).slice(0,8).join("|")},"DEPS"),De.current=oe,Te("useMiniLeagueChat.ts:useEffect:entry","Subscription effect running",{miniLeagueId:t,enabled:f,autoSubscribe:o,hasMiniLeagueId:!!t,stackTrace:new Error().stack?.split(`
`).slice(0,5).join("|")},"EFFECT"),!t||!f){K([]),_(!0),G.current=null;return}if(G.current===t)return;G.current=t;const O=S.length>0,i=ve(`chat:messages:${t}`);if(Te("useMiniLeagueChat.ts:useEffect:cache-check","Checking cache on mount",{hasInitialMessages:O,initialMessageCount:S.length,cachedMessageCount:i?.length||0,cachedLatestMessageId:i?.[i.length-1]?.id,cachedLatestMessageContent:i?.[i.length-1]?.content?.slice(0,50),cachedLatestMessageCreatedAt:i?.[i.length-1]?.created_at,cacheKey:`chat:messages:${t}`},"H7"),O||i&&i.length>0?(!O&&i?(Q(()=>i),i.length>0&&(X.current=i[0].created_at,Z.current=i[i.length-1].created_at),_(i.length>=50)):O&&S.length>0&&(X.current=S[0].created_at,Z.current=S[S.length-1].created_at,_(S.length>=50)),G.current=null,typeof window<"u"&&new URLSearchParams(window.location.search).get("tab")==="chat"&&setTimeout(()=>{t===G.current&&de.current?.().catch(()=>{})},200)):de.current?.().finally(()=>{G.current===t&&(G.current=null)}),!o)return()=>{};let b=!0;de.current=Me,ke.current=Q;let x=null,R=Date.now();const m=3e4,p=()=>{x||(x=setInterval(()=>{if(!b)return;const k=Date.now();if(k-R>=m&&!y.current){R=k;const H=Z.current;H?(async()=>{try{const{data:ue,error:ce}=await P.from("league_messages").select("id, league_id, user_id, content, created_at, reply_to_message_id").eq("league_id",t).gt("created_at",H).order("created_at",{ascending:!0});if(!b||ce||!ue||ue.length===0)return;const ge=ue.filter(xe=>xe.reply_to_message_id),Ie=[...new Set(ge.map(xe=>xe.reply_to_message_id))];if(Ie.length>0){const{data:xe}=await P.from("league_messages").select("id, content, user_id").in("id",Ie);if(!b||!xe)return;const fe=new Map;xe.forEach(Le=>{fe.set(Le.id,Le)});const Ne=ue.map(Le=>(Le.reply_to_message_id&&fe.has(Le.reply_to_message_id)&&(Le.reply_to=fe.get(Le.reply_to_message_id)),Ye(Le)));ke.current?.(Le=>Re([...Le,...Ne]))}else{const xe=ue.map(fe=>Ye(fe));ke.current?.(fe=>Re([...fe,...xe]))}}catch(ue){console.warn("[useMiniLeagueChat] Periodic refresh failed:",ue)}})():de.current?.().catch(ue=>{console.warn("[useMiniLeagueChat] Periodic refresh failed:",ue)})}},m))},g=P.channel(`league-messages:${t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"league_messages",filter:`league_id=eq.${t}`},async k=>{if(b){console.log("[useMiniLeagueChat] Received real-time message:",k.new.id),Te("useMiniLeagueChat.ts:realtime:received","Real-time message received",{messageId:k.new.id,content:k.new.content?.slice(0,50),createdAt:k.new.created_at,refreshInProgress:y.current,currentMessageCount:S.length},"H8"),y.current&&console.log("[useMiniLeagueChat] Refresh in progress, will add message after refresh completes");try{const{data:H,error:ue}=await P.from("league_messages").select(`
                id, 
                league_id, 
                user_id, 
                content, 
                created_at,
                reply_to_message_id
              `).eq("id",k.new.id).single();if(ue&&console.error("[useMiniLeagueChat] Error fetching full message:",ue),H){if(H.reply_to_message_id){const{data:ge}=await P.from("league_messages").select("id, content, user_id").eq("id",H.reply_to_message_id).single();ge&&(H.reply_to=ge)}const ce=Ye(H);Te("useMiniLeagueChat.ts:realtime:adding","Adding real-time message",{messageId:ce.id,content:ce.content?.slice(0,50),createdAt:ce.created_at,currentMessageCount:S.length},"H8"),ke.current?.(ge=>{if(ge.some(xe=>xe.id===ce.id||xe.client_msg_id&&xe.client_msg_id===ce.client_msg_id)){console.log("[useMiniLeagueChat] Message already exists, skipping:",ce.id);const xe=ge.findIndex(fe=>fe.client_msg_id&&fe.client_msg_id===ce.client_msg_id&&fe.id.startsWith("optimistic-"));if(xe>=0){const fe=[...ge];return fe[xe]=ce,Re(fe)}return ge}return console.log("[useMiniLeagueChat] Adding new message:",ce.id),Re([...ge,ce])})}else{console.warn("[useMiniLeagueChat] Failed to fetch full message, using payload data:",k.new.id);const ce=Ye(k.new);ke.current?.(ge=>ge.some(xe=>xe.id===ce.id)?ge:Re([...ge,ce]))}}catch(H){console.error("[useMiniLeagueChat] Error processing real-time message:",H);try{const ue=Ye(k.new);ke.current?.(ce=>ce.some(Ie=>Ie.id===ue.id)?ce:Re([...ce,ue]))}catch(ue){console.error("[useMiniLeagueChat] Fallback also failed:",ue)}}}}).subscribe(k=>{console.log("[useMiniLeagueChat] Subscription status:",k),Te("useMiniLeagueChat.ts:subscription:status","Subscription status changed",{status:k,miniLeagueId:t,currentMessageCount:S.length},"H8"),k==="SUBSCRIBED"?(console.log("[useMiniLeagueChat] Successfully subscribed to real-time updates"),p()):k==="CHANNEL_ERROR"?(console.error("[useMiniLeagueChat] Channel subscription error - will rely on periodic refresh"),p(),setTimeout(()=>{b&&t&&(console.log("[useMiniLeagueChat] Attempting to resubscribe after error"),g.unsubscribe(),g.subscribe())},5e3)):k==="TIMED_OUT"?(console.warn("[useMiniLeagueChat] Subscription timed out - will rely on periodic refresh"),p(),setTimeout(()=>{b&&t&&(console.log("[useMiniLeagueChat] Attempting to resubscribe after timeout"),g.unsubscribe(),g.subscribe())},5e3)):k==="CLOSED"&&(Te("useMiniLeagueChat.ts:subscription:CLOSED","Subscription closed",{miniLeagueId:t,active:b,isInitializing:G.current,channelName:`league-messages:${t}`,stackTrace:new Error().stack?.split(`
`).slice(0,8).join("|")},"SUBSCRIPTION"),b?(console.warn("[useMiniLeagueChat] Subscription closed unexpectedly - will rely on periodic refresh"),p()):console.log("[useMiniLeagueChat] Subscription closed during cleanup (expected)"))}),B=()=>{b&&document.visibilityState==="visible"&&!y.current&&(R=Date.now(),de.current?.())};return document.addEventListener("visibilitychange",B),p(),()=>{Te("useMiniLeagueChat.ts:cleanup","Cleanup function called",{miniLeagueId:t,enabled:f,active:b,hasChannel:!!g,stackTrace:new Error().stack?.split(`
`).slice(0,8).join("|")},"CLEANUP"),b=!1,document.removeEventListener("visibilitychange",B),x&&(clearInterval(x),x=null),g&&(Te("useMiniLeagueChat.ts:cleanup:removeChannel","Removing channel",{miniLeagueId:t,channelName:`league-messages:${t}`,stackTrace:new Error().stack?.split(`
`).slice(0,8).join("|")},"CLEANUP"),P.removeChannel(g))}},[t,f,o]);const He=a.useCallback(async()=>{if(!t||!f||!ie||$)return;const oe=X.current??S[0]?.created_at;if(oe){V(!0);try{await me({before:oe,append:!0})}catch(ee){console.error("[useMiniLeagueChat] Error loading more messages:",ee),Y(ee?.message??"Failed to load more messages")}finally{V(!1)}}},[t,f,ie,$,me,S]),je=a.useCallback(async(oe,ee)=>{if(!t||!w)throw new Error("Missing league or user");const j=oe.trim();if(!j)return;const O=ga(),i=`optimistic-${O}`,b={id:i,client_msg_id:O,league_id:t,user_id:w,content:j,created_at:new Date().toISOString(),status:"sending",reply_to_message_id:ee??null};Q(m=>Re([...m,b]));const{data:x,error:R}=await P.from("league_messages").insert({league_id:t,user_id:w,content:j,reply_to_message_id:ee??null}).select(`
          id, 
          league_id, 
          user_id, 
          content, 
          created_at,
          reply_to_message_id
        `).single();if(x&&x.reply_to_message_id){const{data:m}=await P.from("league_messages").select("id, content, user_id").eq("id",x.reply_to_message_id).single();m&&(x.reply_to=m)}if(R)throw console.error("[useMiniLeagueChat] Error sending message:",R),Q(m=>m.map(p=>p.id===i?{...p,status:"error"}:p)),R;if(x){if(x.reply_to_message_id){const{data:p}=await P.from("league_messages").select("id, content, user_id").eq("id",x.reply_to_message_id).single();p&&(x.reply_to=p)}const m=Ye(x);m.client_msg_id=O,m.status="sent",Te("useMiniLeagueChat.ts:sendMessage:success","Message sent successfully",{messageId:m.id,clientMsgId:O,contentLength:m.content.length,contentPreview:m.content.slice(0,50),createdAt:m.created_at,hasReply:!!m.reply_to_message_id},"H11"),Q(p=>{const g=p.findIndex(k=>k.id===i||k.client_msg_id===O&&k.id.startsWith("optimistic-"));let B;if(g>=0){const k=[...p];k[g]=m,B=Re(k)}else p.some(H=>H.id===m.id||H.client_msg_id===O&&!H.id.startsWith("optimistic-"))?B=p:B=Re([...p,m]);if(t&&B.length>0){const k=B.filter(H=>!H.id.startsWith("optimistic-"));if(k.length>0){const H=`chat:messages:${t}`;he.current=Date.now(),zt(H,k,Gt.HOME)}}return B})}},[t,w,Q]),Be=a.useMemo(()=>S.slice(-5),[S]);return{messages:S,previewMessages:Be,loading:n,loadingMore:$,hasMore:ie,error:M,refresh:Me,loadMore:He,sendMessage:je}}const xa={single:"rounded-tl-[12px] rounded-tr-[12px] rounded-br-[12px] rounded-bl-[12px]",top:"rounded-tl-[12px] rounded-tr-[12px] rounded-br-[12px] rounded-bl-[4px]",middle:"rounded-tl-[4px] rounded-tr-[12px] rounded-br-[12px] rounded-bl-[4px]",bottom:"rounded-tl-[4px] rounded-tr-[12px] rounded-br-[12px] rounded-bl-[12px]"},ba={single:"rounded-tl-[12px] rounded-tr-[12px] rounded-br-[12px] rounded-bl-[12px]",top:"rounded-tl-[12px] rounded-tr-[12px] rounded-br-[4px] rounded-bl-[12px]",middle:"rounded-tl-[12px] rounded-tr-[4px] rounded-br-[4px] rounded-bl-[12px]",bottom:"rounded-tl-[12px] rounded-tr-[4px] rounded-br-[12px] rounded-bl-[12px]"},wa=["ðŸ‘","â¤ï¸","ðŸ˜‚"],ya=["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Œ","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜","ðŸ˜œ","ðŸ¤ª","ðŸ¤¨","ðŸ§","ðŸ¤“","ðŸ˜Ž","ðŸ¤©","ðŸ¥³","ðŸ˜","ðŸ˜’","ðŸ˜ž","ðŸ˜”","ðŸ˜Ÿ","ðŸ˜•","ðŸ™","â˜¹ï¸","ðŸ˜£","ðŸ˜–","ðŸ˜«","ðŸ˜©","ðŸ¥º","ðŸ˜¢","ðŸ˜­","ðŸ˜¤","ðŸ˜ ","ðŸ˜¡","ðŸ¤¬","ðŸ¤¯","ðŸ˜³","ðŸ¥µ","ðŸ¥¶","ðŸ˜±","ðŸ˜¨","ðŸ˜°","ðŸ˜¥","ðŸ˜“","ðŸ¤—","ðŸ¤”","ðŸ¤­","ðŸ¤«","ðŸ¤¥","ðŸ˜¶","ðŸ˜","ðŸ˜‘","ðŸ˜¬","ðŸ™„","ðŸ˜¯","ðŸ˜¦","ðŸ˜§","ðŸ˜®","ðŸ˜²","ðŸ¥±","ðŸ˜´","ðŸ¤¤","ðŸ˜ª","ðŸ˜µ","ðŸ¤","ðŸ¥´","ðŸ¤¢","ðŸ¤®","ðŸ¤§","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤‘","ðŸ¤ ","ðŸ˜ˆ","ðŸ‘¿","ðŸ‘¹","ðŸ‘º","ðŸ¤¡","ðŸ’©","ðŸ‘»","ðŸ’€","â˜ ï¸","ðŸ‘½","ðŸ‘¾","ðŸ¤–","ðŸŽƒ","ðŸ˜º","ðŸ˜¸","ðŸ˜¹","ðŸ˜»","ðŸ˜¼","ðŸ˜½","ðŸ™€","ðŸ˜¿","ðŸ˜¾"];function va({author:t,text:c,time:w,isOwnMessage:f,shape:o="single",messageId:L,reactions:S=[],onReactionClick:K,replyTo:n,onMessageClick:z}){const $="text-left",V=f?"bg-[#1C8376] text-white":"bg-white text-slate-900",ie=f?ba:xa,_="max-w-[85%]",[M,Y]=a.useState(!1),[X,G]=a.useState(!1),y=a.useRef(null);a.useEffect(()=>{if(!M)return;const F=de=>{y.current&&!y.current.contains(de.target)&&Y(!1)},Q=setTimeout(()=>{document.addEventListener("mousedown",F)},100);return()=>{clearTimeout(Q),document.removeEventListener("mousedown",F)}},[M]);const Z=F=>{L&&K&&K(L,F),Y(!1),G(!1)},he=F=>{const Q=F.target;Q.closest("button")||Q.closest("[data-reaction]")||z&&z()};return e.jsxs("div",{className:`inline-block ${_} min-w-0 relative`,style:{width:"fit-content",maxWidth:"85%"},children:[e.jsxs("div",{className:`px-2.5 py-1.5 text-sm leading-relaxed shadow-sm whitespace-pre-wrap break-words ${$} ${V} ${ie[o]} ${z?"cursor-pointer":""}`,onClick:he,style:{wordBreak:"break-word",overflowWrap:"anywhere",display:"inline-block",width:"fit-content",maxWidth:"100%",overflow:"hidden"},children:[t&&!f&&e.jsx("div",{className:"text-xs font-semibold text-slate-600 mb-1 break-words",style:{wordBreak:"break-word",overflowWrap:"anywhere"},children:t}),n&&e.jsxs("div",{className:`mb-2 pb-2 border-l-2 ${f?"border-white/30 text-white/90":"border-[#1C8376] text-slate-600"} pl-2 text-xs`,style:{wordBreak:"break-word",overflowWrap:"anywhere",overflow:"hidden",maxWidth:"100%"},children:[e.jsx("div",{className:"font-medium text-[10px] mb-0.5 break-words",style:{wordBreak:"break-word",overflowWrap:"anywhere",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:n.authorName||"Unknown"}),e.jsx("div",{className:"text-[10px] break-words",style:{wordBreak:"break-word",overflowWrap:"anywhere",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:"1.3",maxHeight:"2.6em"},children:n.content})]}),e.jsxs("div",{style:{wordBreak:"break-word",overflowWrap:"anywhere",position:"relative"},children:[e.jsx("span",{style:{wordBreak:"break-word",overflowWrap:"anywhere",display:"inline"},children:c}),e.jsx("span",{className:`text-xs relative top-1 ${f?"text-[#DCDCDD]":"text-slate-400"}`,style:{whiteSpace:"nowrap",float:"right",clear:"right",marginLeft:"12px"},children:w})]})]}),L&&!f&&e.jsxs("div",{className:"absolute top-0 right-0 -translate-y-1/2 translate-x-1/2 flex items-center gap-1",children:[M&&e.jsxs("div",{ref:y,className:"flex items-center gap-1 bg-white rounded-full px-1 py-1 shadow-lg border border-slate-200 z-50",children:[wa.map(F=>e.jsx("button",{onClick:()=>Z(F),className:"w-7 h-7 rounded-full flex items-center justify-center text-base",title:`React with ${F}`,children:F},F)),z&&e.jsx("button",{onClick:()=>{Y(!1),z()},className:"w-7 h-7 rounded-full flex items-center justify-center text-slate-500",title:"Reply to message",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})})}),e.jsx("button",{onClick:()=>{Y(!1),G(!0)},className:"w-7 h-7 rounded-full flex items-center justify-center text-slate-500 font-semibold",title:"More reactions",children:e.jsx("span",{className:"text-sm",children:"+"})})]}),e.jsx("button",{onClick:()=>Y(!M),className:"w-7 h-7 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center shadow-sm",title:"Add reaction",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})})]}),X&&L&&!f&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/20 z-40",onClick:()=>G(!1)}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-50 bg-white rounded-t-2xl shadow-2xl border-t border-slate-200 overflow-x-hidden",style:{animation:"slideUp 0.3s ease-out"},children:e.jsxs("div",{className:"px-4 pt-3 pb-4 overflow-x-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"w-12 h-1 bg-slate-300 rounded-full"}),e.jsx("button",{onClick:()=>G(!1),className:"px-4 py-1.5 text-sm font-medium text-slate-600 rounded-lg",children:"Close"}),e.jsx("div",{className:"w-12"})]}),e.jsx("div",{className:"grid grid-cols-8 gap-2 max-h-64 overflow-y-auto overflow-x-hidden",children:ya.map(F=>e.jsx("button",{onClick:()=>{L&&K&&K(L,F),G(!1)},className:"w-10 h-10 rounded-lg active:bg-slate-200 flex items-center justify-center text-2xl",title:F,children:F},F))})]})})]}),S.length>0&&e.jsx("div",{className:`mt-1 flex items-center gap-1 flex-wrap ${f?"justify-end":"justify-start"}`,children:S.map(F=>e.jsxs("button",{onClick:()=>Z(F.emoji),className:`px-2 py-0.5 rounded-full text-sm flex items-center gap-1 ${F.hasUserReacted?"bg-[#1C8376] text-white":"bg-slate-100 text-slate-700"}`,children:[e.jsx("span",{className:"text-base",children:F.emoji}),e.jsx("span",{children:F.count})]},F.emoji))})]})}function ja({author:t,messages:c,isOwnMessage:w,avatarInitials:f,userId:o,reactions:L,onReactionClick:S,onMessageClick:K}){t==="Unknown"&&console.error('[MessageStack] Received "Unknown" as author prop!',"isOwnMessage:",w,"messages:",c.length);const n=w?"justify-end":"justify-start",z=o===js;return e.jsxs("div",{className:`flex items-end gap-2 w-full ${n}`,children:[w?e.jsx("div",{className:"w-8 flex-shrink-0"}):z?e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 border border-slate-200 flex items-center justify-center flex-shrink-0 overflow-hidden",children:e.jsx("img",{src:Qs,alt:"Volley",className:"w-8 h-8 rounded-full object-cover"})}):o?e.jsx("div",{className:"flex-shrink-0",children:e.jsx(st,{userId:o,name:t,size:32,className:"border border-slate-200",fallbackToInitials:!0})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs font-semibold text-slate-500 flex-shrink-0",children:(f||t.charAt(0)).toUpperCase()}),e.jsx("div",{className:"flex flex-col gap-1 flex-1 min-w-0",children:c.map(($,V)=>{const ie=c.length===1?"single":V===0?"top":V===c.length-1?"bottom":"middle",_=$.messageId||$.id;let M="";if(typeof $.text=="string")M=$.text;else if(typeof $.text=="object"&&$.text!==null){const Y=$.text?.props?.children||String($.text);M=typeof Y=="string"?Y:String(Y)}else M=String($.text);return e.jsx("div",{className:`flex flex-col w-full min-w-0 ${w?"items-end":"items-start"}`,children:e.jsxs("div",{className:`flex w-full min-w-0 ${w?"justify-end":"justify-start"}`,children:[e.jsx(va,{author:!w&&V===0?t:void 0,text:$.text,time:$.time,isOwnMessage:w,shape:ie,messageId:_,reactions:L?.[_]||[],onReactionClick:S,replyTo:$.replyTo,onMessageClick:K?()=>K(_,M,!w&&V===0?t:void 0):void 0}),$.status&&e.jsx("div",{className:`text-xs ml-2 ${$.status==="error"?"text-red-500":"text-slate-400"}`,children:$.status==="error"?"Failed":"Sendingâ€¦"})]})},$.id)})})]})}function _a({groups:t,reactions:c,onReactionClick:w,onMessageClick:f}){const o=t.filter(L=>L.author==="Unknown");return o.length>0&&(console.error("[ChatThread] RENDERING with",o.length,'groups with "Unknown" author!'),o.forEach((L,S)=>{console.error(`[ChatThread] Group ${S}: id="${L.id}", author="${L.author}", messages=${L.messages.length}`)})),e.jsx("div",{className:"flex flex-col gap-5",children:t.map((L,S)=>e.jsxs("div",{className:"flex flex-col gap-3",children:[L.dayLabel&&e.jsx("div",{className:"text-center text-xs uppercase tracking-wide text-slate-400",children:L.dayLabel}),e.jsx(ja,{author:L.author,avatarInitials:L.avatarInitials,isOwnMessage:L.isOwnMessage,userId:L.userId,messages:L.messages,reactions:c,onReactionClick:w,onMessageClick:f},`${L.id}-${L.author}-${S}`)]},`${L.id}-${L.author}-${S}`))})}const ka=t=>new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),Na=t=>new Date(t).toLocaleDateString([],{weekday:"short",month:"short",day:"numeric"}),ws=t=>{if(!t)return"?";const c=t.trim().split(/\s+/);return c.length===1?c[0][0]?.toUpperCase()??"?":`${c[0][0]?.toUpperCase()??""}${c[c.length-1][0]?.toUpperCase()??""}`},dt=(t,c)=>c?c instanceof Map?c.get(t)??"":c[t]??"":"";function Ca({miniLeagueId:t,memberNames:c,deepLinkError:w}){const{user:f}=_s(),{messages:o,error:L,sendMessage:S}=pa(t,{userId:f?.id,enabled:!!t}),[K,n]=a.useState(""),[z,$]=a.useState(!1),[V,ie]=a.useState({}),[_,M]=a.useState(null),[Y,X]=a.useState([]),G=a.useRef(null),y=a.useRef(null),Z=a.useRef(null),he=a.useRef(!1),[F,Q]=a.useState(0);a.useEffect(()=>{he.current=!1},[t]);const de=a.useCallback(()=>{if(G.current){const i=G.current.scrollHeight-G.current.clientHeight;G.current.scrollTop=i}},[]);a.useEffect(()=>{if(o.length===0||!f?.id)return;const i=o.map(x=>x.id).filter(x=>!x.startsWith("optimistic-"));if(i.length===0)return;(async()=>{try{const{data:x,error:R}=await P.from("league_message_reactions").select("message_id, emoji, user_id").in("message_id",i);if(R){X(g=>[...g,{id:`reactions-${Date.now()}`,message:`Failed to load reactions: ${R.message}`,timestamp:Date.now()}]);return}const m={};(x||[]).forEach(g=>{m[g.message_id]||(m[g.message_id]={}),m[g.message_id][g.emoji]||(m[g.message_id][g.emoji]={count:0,hasUserReacted:!1}),m[g.message_id][g.emoji].count++,g.user_id===f.id&&(m[g.message_id][g.emoji].hasUserReacted=!0)});const p={};Object.keys(m).forEach(g=>{p[g]=Object.entries(m[g]).map(([B,k])=>({emoji:B,count:k.count,hasUserReacted:k.hasUserReacted}))}),ie(p)}catch(x){X(R=>[...R,{id:`reactions-load-${Date.now()}`,message:`Error loading reactions: ${x?.message||String(x)}`,timestamp:Date.now()}])}})()},[o,f?.id]),a.useEffect(()=>{if(o.length===0||!f?.id)return;const i=o.map(x=>x.id).filter(x=>!x.startsWith("optimistic-"));if(i.length===0)return;const b=P.channel("message-reactions-mlcb").on("postgres_changes",{event:"*",schema:"public",table:"league_message_reactions"},async()=>{try{const{data:x,error:R}=await P.from("league_message_reactions").select("message_id, emoji, user_id").in("message_id",i);if(R)return;const m={};(x||[]).forEach(g=>{m[g.message_id]||(m[g.message_id]={}),m[g.message_id][g.emoji]||(m[g.message_id][g.emoji]={count:0,hasUserReacted:!1}),m[g.message_id][g.emoji].count++,g.user_id===f.id&&(m[g.message_id][g.emoji].hasUserReacted=!0)});const p={};Object.keys(m).forEach(g=>{p[g]=Object.entries(m[g]).map(([B,k])=>({emoji:B,count:k.count,hasUserReacted:k.hasUserReacted}))}),ie(p)}catch{}}).subscribe();return()=>{P.removeChannel(b)}},[o,f?.id]);const ke=a.useCallback(async(i,b)=>{if(!f?.id)return;const R=(V[i]||[]).find(m=>m.emoji===b&&m.hasUserReacted);if(ie(m=>{const p={...m},g=p[i]||[];if(R){const B=g.map(k=>k.emoji===b?{...k,count:Math.max(0,k.count-1),hasUserReacted:!1}:k).filter(k=>k.count>0||k.emoji!==b);B.length===0?delete p[i]:p[i]=B}else g.find(k=>k.emoji===b)?p[i]=g.map(k=>k.emoji===b?{...k,count:k.count+1,hasUserReacted:!0}:k):p[i]=[...g,{emoji:b,count:1,hasUserReacted:!0}];return p}),R){const{error:m}=await P.from("league_message_reactions").delete().eq("message_id",i).eq("user_id",f.id).eq("emoji",b);m&&ie(p=>{const g={...p},B=g[i]||[];return B.find(H=>H.emoji===b)?g[i]=B.map(H=>H.emoji===b?{...H,count:H.count+1,hasUserReacted:!0}:H):g[i]=[...B,{emoji:b,count:1,hasUserReacted:!0}],g})}else{const{error:m}=await P.from("league_message_reactions").upsert({message_id:i,user_id:f.id,emoji:b});m&&ie(p=>{const g={...p},k=(g[i]||[]).map(H=>H.emoji===b?{...H,count:Math.max(0,H.count-1),hasUserReacted:!1}:H).filter(H=>H.count>0||H.emoji!==b);return k.length===0?delete g[i]:g[i]=k,g})}},[f?.id,V]);a.useEffect(()=>{!K&&y.current&&(y.current.style.height="auto",y.current.style.height="42px")},[K]);const me=a.useCallback(i=>{const b=Z.current?.offsetHeight||72;if(i>0){const x=i+b;if(Q(i),G.current){const R=`${x+8}px`;G.current.style.paddingBottom=R,requestAnimationFrame(()=>{requestAnimationFrame(()=>{de()})})}}else if(Q(0),G.current){const x=`${b+8}px`;G.current.style.paddingBottom=x}},[de]);a.useEffect(()=>{const i=window.visualViewport;if(!i)return;let b=null,x=0,R=!1;setTimeout(()=>{R=!0},200);const m=()=>{const H=window.innerHeight,ue=i.height,ce=i.offsetTop+ue;return Math.max(0,H-ce)},p=()=>{b&&clearTimeout(b),b=setTimeout(()=>{const H=m();R&&Math.abs(H-x)>10&&(x=H,me(H))},50)};i.addEventListener("resize",p),i.addEventListener("scroll",p),window.addEventListener("resize",p);const g=()=>{setTimeout(p,50)},B=()=>{setTimeout(p,100)},k=setTimeout(()=>{y.current&&(y.current.addEventListener("focus",g),y.current.addEventListener("blur",B))},100);return p(),()=>{b&&clearTimeout(b),clearTimeout(k),i.removeEventListener("resize",p),i.removeEventListener("scroll",p),window.removeEventListener("resize",p),y.current&&(y.current.removeEventListener("focus",g),y.current.removeEventListener("blur",B))}},[me]),a.useEffect(()=>{if(G.current&&Z.current){const b=`${(Z.current.offsetHeight||72)+8}px`;G.current.style.paddingBottom=b}},[]);const Me=()=>{y.current&&y.current.removeAttribute("readonly");const i=()=>{const b=window.visualViewport;if(b){const x=window.innerHeight,R=b.height,m=b.offsetTop+R,p=Math.max(0,x-m);me(p)}};setTimeout(i,50),setTimeout(i,150),de()},De=i=>{const b=i.target;!(b.tagName==="A"||b.tagName==="BUTTON"||b.closest("a, button"))&&y.current&&document.activeElement===y.current&&y.current.blur()},He=a.useMemo(()=>{if(!f)return"";const i=f.user_metadata??{};return i.display_name||i.full_name||f.email||""},[f]),je=a.useMemo(()=>{if(!o.length)return[];if(!(c instanceof Map?c.size>0:c?Object.keys(c).length>0:!1))return[];let b=null;return o.reduce((R,m)=>{const p=m.user_id===f?.id,k=dt(m.user_id,c)||(p?He:null)||(p?"You":null);if(!k&&!p)return R;const H=k||"Unknown",ue=p?void 0:ws(H),ge=new Date(m.created_at).toDateString(),Ie=ge!==b;Ie&&(b=ge);const xe=m.reply_to?dt(m.reply_to.user_id,c)||"Unknown":null,fe={id:m.id,text:m.content,time:ka(m.created_at),status:m.status&&m.status!=="sent"?m.status:void 0,messageId:m.id,replyTo:m.reply_to?{id:m.reply_to.id,content:m.reply_to.content,authorName:xe||void 0}:null},Ne=R[R.length-1],Le=Ne?.messages.length>0&&Ne.messages[0].messageId?o.find(Xe=>Xe.id===Ne.messages[0].messageId)?.user_id:null;if(Ne&&!Ie&&Ne.isOwnMessage===p&&Le===m.user_id){const Xe=Ne.id.includes("-")?Ne.id.split("-")[0]:Ne.id,vt=Ne.messages.map(Ge=>{const Oe=Ge.messageId?o.find($e=>$e.id===Ge.messageId):null;if(Oe?.reply_to){const $e=dt(Oe.reply_to.user_id,c)||"Unknown";return{...Ge,replyTo:Ge.replyTo?{...Ge.replyTo,authorName:$e}:null}}return Ge}),ut={...Ne,id:`${Xe}-${H}`,author:H,avatarInitials:ue,userId:m.user_id,messages:[...vt,fe]};return[...R.slice(0,-1),ut]}else return[...R,{id:`${m.id}-${H}`,author:H,avatarInitials:ue,isOwnMessage:p,userId:m.user_id,dayLabel:Ie?Na(m.created_at):void 0,messages:[fe]}]},[]).map(R=>{const m={...R},p=m.messages.map(g=>{const B=g.messageId?o.find(k=>k.id===g.messageId):null;if(B?.reply_to&&g.replyTo){const k=dt(B.reply_to.user_id,c)||"Unknown";if(k!==g.replyTo.authorName)return{...g,replyTo:{...g.replyTo,authorName:k}}}return g});if(m.author==="Unknown"&&m.messages.length>0&&m.messages[0].messageId){const g=o.find(B=>B.id===m.messages[0].messageId);if(g){const B=dt(g.user_id,c);if(B&&B!=="Unknown"){const k=m.id.includes("-")?m.id.split("-")[0]:m.id;return{...m,id:`${k}-${B}`,author:B,avatarInitials:ws(B),userId:g.user_id,messages:p}}}}return{...m,messages:p}})},[He,c,o,f?.id]),Be=a.useMemo(()=>{const i=je.map(x=>x.author).join(","),b=je.some(x=>x.author==="Unknown");return`chat-${je.length}-${b?"unknown":"resolved"}-${i.slice(0,50)}`},[je]),oe=a.useCallback(i=>{if(G.current=i,i){if(Z.current){const x=`${(Z.current.offsetHeight||72)+8}px`;i.style.paddingBottom=x}else i.style.paddingBottom="91px";requestAnimationFrame(()=>{requestAnimationFrame(()=>{i&&o.length>0&&je.length>0})})}},[o.length,je.length]);a.useEffect(()=>{he.current=!1},[t]),a.useEffect(()=>{o.length>0&&G.current&&(he.current||(he.current=!0),requestAnimationFrame(()=>{if(G.current){const i=G.current.scrollHeight,b=G.current.clientHeight,x=i-b;i>b&&(G.current.scrollTop=x)}}))},[o.length,o]);const ee=a.useCallback(async i=>{if(!t||!f?.id){fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"MiniLeagueChatBeta.tsx:notifyRecipients:early-return",message:"notifyRecipients skipped - missing miniLeagueId or userId",data:{hasMiniLeagueId:!!t,hasUserId:!!f?.id},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H11"})}).catch(()=>{});return}const b=typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1");if(fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"MiniLeagueChatBeta.tsx:notifyRecipients:localhost-check",message:"Checking if running locally",data:{isLocal:b,hostname:typeof window<"u"?window.location.hostname:"unknown",willSkip:b},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H11"})}).catch(()=>{}),b){console.log("[Chat] Notifications skipped: running on localhost. Notifications only work on staging/production.");return}const x=f.user_metadata?.display_name||f.user_metadata?.full_name||f.email||"User";fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"MiniLeagueChatBeta.tsx:notifyRecipients:before-fetch",message:"Calling notifyLeagueMessage function",data:{leagueId:t,senderId:f.id,senderName:x,contentLength:i.length,contentPreview:i.slice(0,50)},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H11"})}).catch(()=>{});try{const R=await fetch("/.netlify/functions/notifyLeagueMessage",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({leagueId:t,senderId:f.id,senderName:x,content:i,activeUserIds:[f.id]})}),m=await R.json().catch(()=>({}));fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"MiniLeagueChatBeta.tsx:notifyRecipients:after-fetch",message:"notifyLeagueMessage function response",data:{status:R.status,ok:R.ok,result:m,hasError:!!m.error,recipients:m.recipients,sent:m.sent},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H11"})}).catch(()=>{})}catch(R){fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"MiniLeagueChatBeta.tsx:notifyRecipients:error",message:"Error calling notifyLeagueMessage",data:{error:R?.message||String(R),errorType:R?.constructor?.name},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H11"})}).catch(()=>{})}},[t,f?.id]),j=a.useCallback(async()=>{const i=K.trim();if(!(!t||!i||z))try{$(!0),n(""),y.current&&(y.current.style.height="auto",y.current.style.height="42px"),fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"MiniLeagueChatBeta.tsx:handleSend:before-send",message:"About to send message",data:{textLength:i.length,textPreview:i.slice(0,50),hasReply:!!_,miniLeagueId:t},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H11"})}).catch(()=>{}),await S(i,_?.id||null),fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"MiniLeagueChatBeta.tsx:handleSend:after-send",message:"Message sent, about to notify recipients",data:{textLength:i.length,miniLeagueId:t},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H11"})}).catch(()=>{}),await ee(i),M(null),de()}catch(b){X(x=>[...x,{id:`send-${Date.now()}`,message:`Failed to send message: ${b?.message||String(b)}`,timestamp:Date.now()}]),n(i)}finally{$(!1)}},[K,t,ee,de,S,z,_]);a.useEffect(()=>{w&&X(i=>i.some(b=>b.message.includes("Deep Link"))?i:[...i,{id:`deeplink-${Date.now()}`,message:`Deep Link Error: ${w}`,timestamp:Date.now()}])},[w]),a.useEffect(()=>{if(Y.length===0)return;const i=setTimeout(()=>{X(b=>b.filter(x=>Date.now()-x.timestamp<5e3))},5e3);return()=>clearTimeout(i)},[Y]);const O=o.length>0&&je.length>0;return e.jsxs("div",{className:"flex flex-col h-full w-full",style:{position:"relative",zIndex:1,overflowX:"hidden"},children:[Y.length>0&&e.jsx("div",{className:"px-4 pt-2 space-y-2",children:Y.map(i=>e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-800 text-xs px-3 py-2 rounded-lg flex items-start justify-between gap-2",children:[e.jsx("span",{className:"flex-1",children:i.message}),e.jsx("button",{onClick:()=>X(b=>b.filter(x=>x.id!==i.id)),className:"text-red-600 flex-shrink-0",children:"Ã—"})]},i.id))}),e.jsx("div",{ref:oe,className:"flex-1 overflow-y-auto px-4 py-5",onClick:De,style:{WebkitOverflowScrolling:"touch",overscrollBehavior:"contain",backgroundColor:"transparent",cursor:"pointer",overflowX:"hidden",maxWidth:"100%",display:"flex",flexDirection:"column",alignItems:"flex-start",justifyContent:"flex-start",paddingBottom:"91px"},children:O?e.jsx(e.Fragment,{children:e.jsx(_a,{groups:je,reactions:V,onReactionClick:ke,onMessageClick:(i,b,x)=>{const R=o.find(m=>m.id===i);if(R){let m="";if(typeof b=="string")m=b;else if(typeof b=="object"&&b!==null){const p=b?.props?.children||String(b);m=typeof p=="string"?p:String(p)}else m=String(b);M({id:i,content:m||R.content,authorName:x}),setTimeout(()=>{y.current?.focus()},100)}}},Be)}):null}),e.jsxs("div",{ref:Z,className:"flex-shrink-0 border-t border-slate-200 bg-white px-4 py-3",style:{paddingBottom:"calc(0.75rem + env(safe-area-inset-bottom, 0px))",position:F>0?"fixed":"relative",bottom:F>0?`${F}px`:"0",left:F>0?0:"auto",right:F>0?0:"auto",width:"100%",maxWidth:F>0?"440px":"100%",marginLeft:F>0?"auto":void 0,marginRight:F>0?"auto":void 0,zIndex:F>0?100:"auto",boxShadow:F>0?"0 -2px 8px rgba(0, 0, 0, 0.1)":"none",overflowX:"hidden",pointerEvents:"auto"},children:[_&&e.jsxs("div",{className:"mb-2 px-3 py-2 bg-slate-50 border-l-2 border-[#1C8376] rounded-lg flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"text-xs font-medium text-[#1C8376] mb-0.5",children:["Replying to ",_.authorName||"Unknown"]}),e.jsx("div",{className:"text-xs text-slate-600 line-clamp-2 truncate",children:_.content})]}),e.jsx("button",{onClick:()=>M(null),className:"flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-slate-500",title:"Cancel reply",children:e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"flex items-end gap-3 bg-slate-100 rounded-2xl px-3 py-2 relative",children:[e.jsx("textarea",{ref:y,className:"flex-1 bg-transparent resize-none focus:outline-none text-sm text-slate-800 placeholder:text-slate-400",rows:1,value:K,disabled:!t||z,placeholder:t?"Start typing a messageâ€¦":"Join this league to chat",autoComplete:"off",autoCorrect:"on",autoCapitalize:"sentences",spellCheck:!0,inputMode:"text",enterKeyHint:"send","data-1p-ignore":"true",onKeyDown:i=>{if(i.key==="Escape"&&_){M(null),i.preventDefault();return}i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),j())},onChange:i=>{n(i.target.value),y.current&&(y.current.style.height="auto",y.current.style.height=`${Math.min(y.current.scrollHeight,120)}px`),requestAnimationFrame(()=>{const b=window.visualViewport;if(b){const x=window.innerHeight,R=b.height,m=b.offsetTop+R,p=x-m;me(p)}})},onFocus:Me,style:{minHeight:"42px",maxHeight:"120px",lineHeight:"1.5"}}),e.jsx("button",{type:"button",onClick:j,disabled:!t||z||!K.trim(),className:"w-10 h-10 rounded-full bg-[#1C8376] text-white flex items-center justify-center disabled:opacity-40",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 12h14M12 5l7 7-7 7"})})})]}),L&&e.jsxs("div",{className:"text-xs text-red-500 mt-2 text-center",children:[L," â€” try again or switch to the classic chat tab."]})]})]})}function Sa({winnerName:t,isDraw:c}){return e.jsx("div",{className:"mt-4 mb-4 py-6 px-6 rounded-xl bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 shadow-2xl shadow-slate-600/50 relative overflow-hidden before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/40 before:to-transparent before:animate-[shimmer_2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/30 after:to-transparent after:animate-[shimmer_2.5s_ease-in-out_infinite_0.6s]",children:e.jsx("div",{className:"text-center relative z-10",children:c?e.jsx("div",{className:"text-lg font-bold text-white break-words whitespace-normal px-2 leading-normal",children:"It's a Draw!"}):e.jsxs("div",{className:"text-lg font-bold text-white break-words whitespace-normal px-2 leading-normal",children:[t," Wins!"]})})})}function La({availableGws:t,selectedGw:c,onChange:w,className:f=""}){return t.length<=1?null:e.jsx("div",{className:`flex-1 ${f}`,children:e.jsx("select",{value:c||void 0,onChange:o=>{const L=parseInt(o.target.value,10);w(L)},className:"gw-selector w-full bg-white rounded-full border-2 border-slate-300 px-3 py-2 text-xs font-normal text-slate-600 text-center focus:outline-none focus:ring-2 focus:ring-[#1C8376] focus:border-[#1C8376] active:bg-slate-50 transition-colors",style:{minHeight:"40px",WebkitAppearance:"none",MozAppearance:"none",appearance:"none",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='2.5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 0.75rem center",backgroundSize:"1em 1em",paddingRight:"2.5rem"},children:t.map(o=>e.jsxs("option",{value:o,className:"text-xs",style:{padding:"0.5rem",fontWeight:"normal",color:"#64748b"},children:["Gameweek ",o]},o))})})}function Ea({showForm:t,onToggle:c}){return e.jsxs("div",{className:"inline-flex rounded-full bg-slate-100 p-0.5 shadow-sm border border-slate-200",children:[e.jsx("button",{onClick:()=>c(!1),className:`px-3 py-1.5 text-xs font-semibold rounded-full ${t?"text-slate-600":"bg-[#1C8376] text-white shadow-sm"}`,children:"Points"}),e.jsx("button",{onClick:()=>c(!0),className:`px-3 py-1.5 text-xs font-semibold rounded-full ${t?"bg-[#1C8376] text-white shadow-sm":"text-slate-600"}`,children:"Form"})]})}function Ma({form:t}){const c=t.slice(-5),w=5-c.length;return e.jsxs("div",{className:"flex items-center justify-between w-full",children:[Array.from({length:w}).map((f,o)=>e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-slate-200"},`dot-${o}`)),c.map((f,o)=>e.jsx("div",{className:`w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${f==="W"?"bg-emerald-100 text-emerald-700":f==="D"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:f},o))]})}function Ta({rows:t,members:c,showForm:w,currentUserId:f,loading:o,isLateStartingLeague:L}){return e.jsxs("div",{className:"pt-4",children:[e.jsx("style",{children:`
        .mlt-table tbody tr:last-child {
          border-bottom: none !important;
          border: none !important;
        }
        .mlt-table tbody tr:last-child td {
          border-bottom: none !important;
          border: none !important;
        }
        .mlt-table tbody tr:last-child th {
          border-bottom: none !important;
          border: none !important;
        }
        .mlt-table {
          border-bottom: none !important;
        }
        .mlt-table tbody {
          border-bottom: none !important;
        }
        .mlt-table-container {
          border-bottom: none !important;
        }
        .mlt-table-container table {
          border-bottom: none !important;
        }
        .mlt-table-container tbody {
          border-bottom: none !important;
        }
        .mlt-table-container tbody tr:last-child {
          border-bottom: none !important;
          border: none !important;
        }
        .mlt-table-container tbody tr:last-child td {
          border-bottom: none !important;
          border: none !important;
        }
      `}),e.jsx("div",{className:"mlt-table-container overflow-y-auto overflow-x-hidden -mx-4 sm:mx-0 rounded-none sm:rounded-2xl border-x-0 sm:border-x bg-slate-50",style:{backgroundColor:"#f8fafc",borderBottom:"none",boxShadow:"none"},children:e.jsxs("table",{className:"mlt-table w-full text-sm border-collapse",style:{tableLayout:"fixed",backgroundColor:"#f8fafc",border:"none",borderBottom:"none"},children:[e.jsx("thead",{className:"sticky top-0",style:{position:"sticky",top:0,zIndex:25,backgroundColor:"#f8fafc",display:"table-header-group"},children:e.jsxs("tr",{style:{backgroundColor:"#f8fafc",borderBottom:"none"},children:[e.jsx("th",{className:"py-3 text-left font-normal",style:{backgroundColor:"#f8fafc",width:"35px",paddingLeft:"0.5rem",paddingRight:"0.25rem",color:"#94a3b8"},children:"#"}),e.jsx("th",{className:"py-3 text-left font-normal text-xs",style:{backgroundColor:"#f8fafc",color:"#94a3b8",paddingLeft:"0.5rem",paddingRight:"1rem",width:"auto"},children:"Player"}),w?e.jsx("th",{className:"px-4 py-3 text-left font-normal text-xs",style:{backgroundColor:"#f8fafc",color:"#94a3b8"},children:"Form"}):e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"py-3 text-center font-normal text-xs",style:{backgroundColor:"#f8fafc",width:"35px",paddingLeft:"0.25rem",paddingRight:"0.25rem",color:"#94a3b8"},children:"W"}),e.jsx("th",{className:"py-3 text-center font-normal text-xs",style:{backgroundColor:"#f8fafc",width:"35px",paddingLeft:"0.25rem",paddingRight:"0.25rem",color:"#94a3b8"},children:"D"}),e.jsx("th",{className:"py-3 text-center font-normal text-xs",style:{backgroundColor:"#f8fafc",width:"40px",paddingLeft:"0.25rem",paddingRight:"0.25rem",color:"#94a3b8"},children:L?"CP":"OCP"}),c.length>=3&&e.jsx("th",{className:"py-3 text-center font-normal text-base",style:{backgroundColor:"#f8fafc",width:"35px",paddingLeft:"0.25rem",paddingRight:"0.25rem",color:"#94a3b8"},children:"ðŸ¦„"}),e.jsx("th",{className:"py-3 text-center font-normal text-xs",style:{backgroundColor:"#f8fafc",width:"40px",paddingLeft:"0.25rem",paddingRight:"0.25rem",color:"#94a3b8"},children:"PTS"})]})]})}),e.jsxs("tbody",{children:[t.map((S,K)=>{const n=S.user_id===f,z=K===t.length-1;return e.jsxs("tr",{className:n?"flash-user-row":"",style:{position:"relative",backgroundColor:"#f8fafc",...z?{}:{borderBottom:"1px solid #e2e8f0"}},children:[e.jsx("td",{className:"py-4 text-left tabular-nums whitespace-nowrap relative",style:{paddingLeft:"0.5rem",paddingRight:"0.25rem",backgroundColor:"#f8fafc",width:"35px"},children:K+1}),e.jsx("td",{className:"py-4 bg-slate-50 pl-0 pr-4",style:{backgroundColor:"#f8fafc"},children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(st,{userId:S.user_id,name:S.name,size:24,className:"border border-slate-200",fallbackToInitials:!0})}),e.jsx("span",{className:"text-xs truncate min-w-0 whitespace-nowrap font-normal",style:{overflow:"hidden",textOverflow:"ellipsis"},children:S.name})]})}),w?e.jsx("td",{className:"px-4 py-4 bg-slate-50",children:e.jsx(Ma,{form:S.form})}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-4 text-center tabular-nums bg-slate-50 w-[35px] pl-1 pr-1",children:S.wins}),e.jsx("td",{className:"py-4 text-center tabular-nums bg-slate-50 w-[35px] pl-1 pr-1",children:S.draws}),e.jsx("td",{className:"py-4 text-center tabular-nums bg-slate-50 w-10 pl-1 pr-1",children:S.ocp}),c.length>=3&&e.jsx("td",{className:"py-4 text-center tabular-nums bg-slate-50 w-[35px] pl-1 pr-1",children:S.unicorns}),e.jsx("td",{className:"py-4 text-center tabular-nums font-bold text-[#1C8376] bg-slate-50 w-10 pl-1 pr-1",children:S.mltPts})]})]},S.user_id)}),o&&e.jsx("tr",{style:{backgroundColor:"#f8fafc"},children:e.jsx("td",{className:"px-4 py-6 text-slate-500 text-center",colSpan:w?3:c.length>=3?7:6,style:{backgroundColor:"#f8fafc"},children:"Calculatingâ€¦"})}),!o&&!t.length&&e.jsx("tr",{style:{backgroundColor:"#f8fafc"},children:e.jsx("td",{className:"px-4 py-6 text-slate-500 text-center",colSpan:w?3:c.length>=3?7:6,style:{backgroundColor:"#f8fafc"},children:"No gameweeks completed yet â€” this will populate after the first results are saved."})})]})]})})]})}function Ra({rows:t,members:c,currentUserId:w,positionChangeKeys:f,isApiTestLeague:o,hasLiveFixtures:L,hasStartingSoonFixtures:S,hasStartedFixtures:K,allFixturesFinished:n,resGw:z}){return e.jsxs("div",{children:[e.jsx("style",{children:`
        @keyframes flash {
          0%, 100% {
            background-color: rgb(209, 250, 229);
          }
          25% {
            background-color: rgb(167, 243, 208);
          }
          50% {
            background-color: rgb(209, 250, 229);
          }
          75% {
            background-color: rgb(167, 243, 208);
          }
        }
        @keyframes pulse-score {
          0%, 100% {
            opacity: 1;
          }
          50% {
            opacity: 0.7;
          }
        }
        @keyframes position-change {
          0% {
            background-color: rgb(254, 243, 199);
          }
          50% {
            background-color: rgb(253, 230, 138);
          }
          100% {
            background-color: transparent;
          }
        }
        .flash-user-row {
          animation: flash 1.5s ease-in-out 3;
        }
        .pulse-live-score {
          animation: pulse-score 2s ease-in-out infinite;
        }
        .position-changed {
          animation: position-change 1.5s ease-out;
        }
        .full-width-header-border::after {
          content: '';
          position: absolute;
          left: -1rem;
          right: -1rem;
          bottom: 0;
          height: 1px;
          background-color: #cbd5e1;
          z-index: 1;
        }
      `}),e.jsx("div",{className:"overflow-y-auto overflow-x-hidden -mx-4 sm:mx-0 rounded-none sm:rounded-2xl border-x-0 sm:border-x border-b border-slate-200 bg-slate-50 shadow-sm",style:{backgroundColor:"#f8fafc"},children:e.jsxs("table",{className:"w-full text-sm border-collapse",style:{tableLayout:"fixed",backgroundColor:"#f8fafc"},children:[e.jsx("thead",{className:"sticky top-0",style:{position:"sticky",top:0,zIndex:25,backgroundColor:"#f8fafc",display:"table-header-group"},children:e.jsxs("tr",{style:{backgroundColor:"#f8fafc",borderBottom:"none"},children:[e.jsx("th",{className:"py-4 text-left font-normal",style:{backgroundColor:"#f8fafc",width:"35px",paddingLeft:"0.5rem",paddingRight:"0.25rem",color:"#94a3b8"},children:"#"}),e.jsx("th",{className:"py-4 text-left font-normal text-xs",style:{backgroundColor:"#f8fafc",color:"#94a3b8",paddingLeft:"0.5rem",paddingRight:"1rem",width:"auto"},children:e.jsxs("div",{className:"flex items-center gap-2",children:["Player",o&&L&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-600 text-white shadow-md shadow-red-500/30",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-white rounded-full animate-pulse"}),e.jsx("span",{className:"text-[10px] font-medium",children:"LIVE"})]}),o&&!n&&S&&!L&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-500 text-white shadow-md shadow-amber-500/30",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"text-[10px] font-medium",children:K?"Next Game Starting Soon":"Starting soon"})]})]})}),e.jsx("th",{className:"py-4 text-center font-normal",style:{backgroundColor:"#f8fafc",width:"50px",paddingLeft:"0.25rem",paddingRight:"0.25rem",color:"#94a3b8"},children:"Score"}),c.length>=3&&e.jsx("th",{className:"py-4 text-center font-normal text-base",style:{backgroundColor:"#f8fafc",width:"35px",paddingLeft:"0.25rem",paddingRight:"0.25rem",color:"#94a3b8"},children:"ðŸ¦„"})]})}),e.jsxs("tbody",{children:[t.map(($,V)=>{const ie=$.user_id===w,_=V===t.length-1,M=f.has($.user_id);return e.jsxs("tr",{className:`${ie?"flash-user-row":""} ${M?"position-changed":""}`,style:{position:"relative",backgroundColor:"#f8fafc",..._?{}:{borderBottom:"1px solid #e2e8f0"}},children:[e.jsx("td",{className:"py-4 text-left tabular-nums whitespace-nowrap relative",style:{paddingLeft:"0.5rem",paddingRight:"0.25rem",backgroundColor:"#f8fafc",width:"35px"},children:V+1}),e.jsx("td",{className:"py-4",style:{backgroundColor:"#f8fafc",paddingLeft:"0.5rem",paddingRight:"1rem"},children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[o&&L&&e.jsx("div",{className:"w-2 h-2 bg-red-600 rounded-full animate-pulse flex-shrink-0",style:{minWidth:"8px",minHeight:"8px"}}),o&&!L&&S&&e.jsx("svg",{className:"w-3 h-3 text-amber-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(st,{userId:$.user_id,name:$.name,size:24,className:"border border-slate-200",fallbackToInitials:!0})}),e.jsx("span",{className:"text-xs truncate min-w-0 whitespace-nowrap font-normal",style:{overflow:"hidden",textOverflow:"ellipsis"},children:$.name})]})}),e.jsx("td",{className:`py-4 text-center tabular-nums font-bold text-[#1C8376] bg-slate-50 w-[50px] pl-1 pr-1 ${o&&L?"pulse-live-score":""}`,children:$.score}),c.length>=3&&e.jsx("td",{className:`py-4 text-center tabular-nums bg-slate-50 w-[35px] pl-1 pr-1 ${o&&L?"pulse-live-score":""}`,children:$.unicorns})]},$.user_id)}),!t.length&&e.jsx("tr",{className:"bg-slate-50",children:e.jsxs("td",{className:"px-4 py-6 text-slate-500 text-center bg-slate-50",colSpan:c.length>=3?4:3,children:["No results recorded for GW ",z," yet."]})})]})]})})]})}function Ia(t){const c=ea(),w=encodeURIComponent(t);if(c){const f=`whatsapp://send?text=${w}`;let o=!1,L=!1;try{const S=document.createElement("a");S.href=f,S.style.display="none",document.body.appendChild(S),S.click(),o=!0,setTimeout(()=>{document.body.contains(S)&&document.body.removeChild(S)},100)}catch{}if(!o)try{window.open(f),L=!0}catch{}if(!o&&!L)try{window.location.href=f}catch{window.open(`https://wa.me/?text=${w}`,"_blank")}}else{const f=`https://wa.me/?text=${w}`;try{window.open(f,"_blank")}catch{navigator.clipboard.writeText(t).then(()=>{alert("Message copied to clipboard! You can now paste it in WhatsApp or Messages.")}).catch(()=>{alert(`Unable to open WhatsApp. Please copy this message manually:

`+t)})}}}function Aa(t,c){const w=new Date(c.find(V=>V.gw===t)?.kickoff_time||""),f=new Date(w.getTime()-4500*1e3),o=["SUNDAY","MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY"],L=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"],S=o[f.getUTCDay()],K=f.getUTCDate(),n=L[f.getUTCMonth()],z=f.getUTCHours().toString().padStart(2,"0"),$=f.getUTCMinutes().toString().padStart(2,"0");return`Gameweek ${t} Predictions Reminder!

DEADLINE: THIS ${S} ${K} ${n}, ${z}:${$} BST

Don't forget!
playtotl.com`}function Da(t,c){console.log("[SubmissionStatusTable] handleShareReminder called, picksGw:",t);try{const w=Aa(t,c);console.log("[SubmissionStatusTable] Generated message:",w),Ia(w)}catch(w){console.error("[SubmissionStatusTable] Error in handleShareReminder:",w),alert("Error sharing reminder. Please try again.")}}function ys({members:t,submittedMap:c,picksGw:w,allSubmitted:f,remaining:o,fixtures:L,onShareReminder:S,variant:K="full"}){const n=S||(()=>Da(w,L)),z=L.map(M=>M.kickoff_time).filter(M=>!!M).map(M=>new Date(M)).filter(M=>!isNaN(M.getTime())),$=z.length>0?new Date(Math.min(...z.map(M=>M.getTime()))):null,V=$?new Date($.getTime()-4500*1e3):null,ie=V?new Date>=V:!1;let _="";if(V){const M=K==="compact"?["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],Y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],X=M[V.getUTCDay()],G=V.getUTCDate(),y=Y[V.getUTCMonth()],Z=V.getUTCHours().toString().padStart(2,"0"),he=V.getUTCMinutes().toString().padStart(2,"0");_=`${X} ${G} ${y}, ${Z}:${he} BST`}return K==="compact"?e.jsxs("div",{className:"mt-2 pt-2",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium text-slate-700",children:e.jsxs(e.Fragment,{children:["Waiting for ",e.jsx("span",{className:"font-semibold",children:o})," of ",t.length," to submit."]})}),!f&&e.jsxs("button",{type:"button",onClick:M=>{M.preventDefault(),M.stopPropagation(),console.log("[SubmissionStatusTable] Button clicked (compact variant)"),n()},className:"flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium",children:[e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"})}),"Share Reminder"]})]}),_&&e.jsxs("div",{className:`mb-3 text-xs font-medium ${ie?"text-orange-600":"text-slate-600"} flex items-center gap-1.5`,children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),ie?"Deadline Passed:":"Deadline:",_]}),e.jsx("div",{className:"overflow-hidden rounded-lg border border-slate-200 bg-white",children:e.jsxs("table",{className:"w-full text-sm",style:{tableLayout:"fixed"},children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-4 py-3 w-2/3 font-semibold text-slate-600",children:"Player"}),e.jsx("th",{className:"text-left px-4 py-3 font-semibold text-slate-600",children:"Status"})]})}),e.jsx("tbody",{children:t.slice().sort((M,Y)=>M.name.localeCompare(Y.name)).map(M=>{const Y=`${M.id}:${w}`,X=!!c.get(Y);return e.jsxs("tr",{className:"border-t border-slate-200",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(st,{userId:M.id,name:M.name,size:24,className:"flex-shrink-0",fallbackToInitials:!0}),e.jsx("span",{className:"font-bold text-slate-900 truncate whitespace-nowrap",style:{overflow:"hidden",textOverflow:"ellipsis"},children:M.name})]})}),e.jsx("td",{className:"px-4 py-3",children:X?e.jsxs("span",{className:"inline-flex items-center gap-1.5 justify-center rounded-full bg-[#1C8376]/10 text-[#1C8376]/90 text-xs px-2.5 py-1 border border-emerald-300 font-bold shadow-sm whitespace-nowrap w-24",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),"Submitted"]}):e.jsxs("span",{className:"inline-flex items-center gap-1.5 justify-center rounded-full bg-amber-50 text-amber-700 text-xs px-2.5 py-1 border border-amber-200 font-semibold whitespace-nowrap w-24",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Not yet"]})})]},M.id)})})]})})]}):e.jsxs("div",{className:"mt-3 rounded-2xl border bg-white shadow-sm p-4 text-slate-700",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("div",{children:f?e.jsxs(e.Fragment,{children:["All ",t.length," members have submitted."]}):e.jsxs(e.Fragment,{children:["Waiting for ",e.jsx("span",{className:"font-semibold",children:o})," of ",t.length," to submit."]})}),!f&&e.jsxs("button",{type:"button",onClick:M=>{M.preventDefault(),M.stopPropagation(),console.log("[SubmissionStatusTable] Button clicked (full variant)"),n()},className:"flex items-center gap-2 px-3 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium",children:[e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"})}),"Share Reminder"]})]}),_&&e.jsxs("div",{className:`mb-3 text-sm ${ie?"text-orange-600 font-semibold":"text-slate-600"}`,children:[ie?"â° Deadline Passed:":"â° Deadline:",_]}),e.jsx("div",{className:"overflow-hidden rounded-lg border",children:e.jsxs("table",{className:"w-full text-sm",style:{tableLayout:"fixed"},children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-4 py-3 w-2/3 font-semibold text-slate-600",children:"Player"}),e.jsx("th",{className:"text-left px-4 py-3 font-semibold text-slate-600",children:"Status"})]})}),e.jsx("tbody",{children:t.slice().sort((M,Y)=>M.name.localeCompare(Y.name)).map(M=>{const Y=`${M.id}:${w}`,X=!!c.get(Y);return e.jsxs("tr",{className:"border-t border-slate-200",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(st,{userId:M.id,name:M.name,size:24,className:"flex-shrink-0",fallbackToInitials:!0}),e.jsx("span",{className:"font-bold text-slate-900 truncate whitespace-nowrap",style:{overflow:"hidden",textOverflow:"ellipsis"},children:M.name})]})}),e.jsx("td",{className:"px-4 py-3",children:X?e.jsx("span",{className:"inline-flex items-center justify-center rounded-full bg-[#1C8376]/10 text-[#1C8376]/90 text-xs px-2 py-1 border border-emerald-300 font-bold shadow-sm whitespace-nowrap w-24",children:"âœ… Submitted"}):e.jsx("span",{className:"inline-flex items-center justify-center rounded-full bg-amber-50 text-amber-700 text-xs px-2 py-1 border border-amber-200 font-semibold whitespace-nowrap w-24",children:"â³ Not yet"})})]},M.id)})})]})})]})}function Pa({letter:t,userId:c,userName:w,correct:f,unicorn:o,hasSubmitted:L,isLive:S,isOngoing:K,isFinished:n}){let z;f===!0?S||K?z="bg-emerald-600 text-white border-emerald-600 animate-pulse shadow-lg shadow-emerald-500/50":n?z="bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 text-white relative overflow-hidden before:absolute before:inset-0 before:z-10 before:pointer-events-none before:w-[200%] before:bg-gradient-to-r before:from-transparent before:via-white/40 before:via-white/50 before:via-white/40 before:to-transparent before:animate-[shimmer_2.5s_ease-in-out_infinite] after:absolute after:inset-0 after:z-10 after:pointer-events-none after:w-[200%] after:bg-gradient-to-r after:from-transparent after:via-yellow-200/30 after:via-yellow-200/40 after:via-yellow-200/30 after:to-transparent after:animate-[shimmer_3s_ease-in-out_infinite_0.5s]":z="bg-emerald-600 text-white border-emerald-600":L?z="bg-emerald-600 text-white border-emerald-600":z="bg-slate-100 text-slate-600 border-slate-200";const $=!!c,V=$?z.replace(/\bborder-\S+/g,"").trim():z;return e.jsx("span",{className:["inline-flex items-center justify-center",$?"h-9 w-9 min-w-[36px]":"h-5 min-w-[18px]",$?"rounded-full mb-0.5":"rounded-full border mb-0.5","align-middle overflow-hidden",$?"p-0":"px-1.5 text-xs font-semibold",V].join(" "),title:o?"Correct!":w||void 0,children:$?e.jsx(st,{userId:c,name:w,size:36,className:"border-0 relative z-0",fallbackToInitials:!0}):t})}function Ua(t,c){return t==="FINISHED"?"FT":t==="PAUSED"?"HT":t==="IN_PLAY"?c==null?"LIVE":`${c}'`:"LIVE"}function $a(t){const c=(t||"?").trim().split(/\s+/);return c.length?c.length===1?c[0].slice(0,1).toUpperCase():(c[0][0]+c[c.length-1][0]).toUpperCase():"?"}function Fa({fixture:t,picks:c,members:w,outcome:f,liveScore:o,submittedMap:L,picksGw:S,isApiTestLeague:K=!1}){const n=t.home_code||t.home_team||t.home_name||"",z=t.away_code||t.away_team||t.away_name||"",$=cs(n)||t.home_name||t.home_team||"Home",V=cs(z)||t.away_name||t.away_team||"Away",_=(he=>{if(!he)return"";const F=new Date(he);if(isNaN(F.getTime()))return"";const Q=String(F.getUTCHours()).padStart(2,"0"),de=String(F.getUTCMinutes()).padStart(2,"0");return`${Q}:${de}`})(t.kickoff_time),M=!!(o&&o.status==="IN_PLAY"),Y=!!(o&&(o.status==="PAUSED"||o.status==="HALF_TIME"||o.status==="HT")),X=!!(o&&o.status==="FINISHED"),G=M||Y;let y=null;K&&o?o.homeScore>o.awayScore?y="H":o.awayScore>o.homeScore?y="A":o.homeScore===o.awayScore&&(y="D"):y=f;const Z=he=>{const F=c.filter(me=>me.pick===he),Q=4,de=[];for(let me=0;me<F.length;me+=Q){const Me=F.slice(me,me+Q);de.push(Me)}const ke=12;return e.jsx("div",{className:"flex flex-col gap-1",children:de.map((me,Me)=>e.jsx("div",{className:"flex items-center justify-center",children:me.map((De,He)=>{const je=w.find(j=>j.id===De.user_id),Be=$a(je?.name??"?"),oe=L.has(`${De.user_id}:${S}`),ee=y&&y===he?!0:null;return e.jsx("span",{className:"inline-block",style:{marginLeft:He>0?`-${ke}px`:"0",position:"relative",zIndex:He},children:e.jsx(Pa,{letter:Be,userId:De.user_id,userName:je?.name,correct:ee,unicorn:ee===!0,hasSubmitted:oe,isLive:M,isOngoing:G,isFinished:X})},De.user_id)})},Me))})};return e.jsx("li",{className:"border-t first:border-t-0",children:e.jsxs("div",{className:"p-4 bg-white relative",children:[(M||Y)&&e.jsxs("div",{className:"absolute top-3 left-3 flex items-center gap-2 z-10 pb-6",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs font-bold text-red-600",children:"LIVE"})]}),X&&!M&&!Y&&e.jsx("div",{className:"absolute top-3 left-3 flex items-center gap-2 z-10 pb-6",children:e.jsx("span",{className:"text-xs font-semibold text-slate-500",children:"FT"})}),e.jsxs("div",{className:`grid grid-cols-3 items-center ${G?"pt-4":""}`,children:[e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("span",{className:"text-sm sm:text-base font-medium text-slate-900 truncate",children:$})}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(ds,{code:t.home_code||void 0,crest:t.home_crest||void 0,size:24,className:"h-6 w-6"}),e.jsx("div",{className:"text-[15px] sm:text-base font-semibold text-slate-600",children:o&&(M||Y||X)?e.jsxs("span",{className:"font-bold text-base text-slate-900",children:[o.homeScore," - ",o.awayScore]}):e.jsx("span",{children:_})}),e.jsx(ds,{code:t.away_code||void 0,crest:t.away_crest||void 0,size:24,className:"h-6 w-6"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("span",{className:"text-sm sm:text-base font-medium text-slate-900 truncate",children:V})})]}),o&&(G||X)&&e.jsx("div",{className:"flex justify-center mt-1",children:e.jsx("span",{className:`text-[10px] font-semibold ${G?"text-red-600":"text-slate-500"}`,children:Ua(o.status,o.minute)})}),e.jsxs("div",{className:"mt-2 grid grid-cols-3",children:[e.jsx("div",{className:"relative min-h-[48px]",children:e.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2",children:Z("H")})}),e.jsx("div",{className:"relative min-h-[48px]",children:e.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2",children:Z("D")})}),e.jsx("div",{className:"relative min-h-[48px]",children:e.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2",children:Z("A")})})]})]})})}function vs({label:t,fixtures:c,picksByFixture:w,members:f,outcomes:o,liveScores:L,submittedMap:S,picksGw:K,isApiTestLeague:n=!1,isFirstSection:z=!1,hasLiveGames:$=!1,allGamesFinished:V=!1,allSubmitted:ie=!1,resultsPublished:_=!1,deadlinePassed:M=!1,whoDidntSubmit:Y=[],liveFixturesCount:X,hasStarted:G=!1}){return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx(ta,{date:t,className:"text-lg font-normal"}),z&&e.jsxs(e.Fragment,{children:[n&&$&&X!==void 0&&e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-red-600 text-white text-sm font-bold border border-red-700 shadow-sm",style:{marginTop:"-2px"},children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-white rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs sm:text-sm font-medium opacity-90",children:"Live"}),e.jsxs("span",{className:"flex items-baseline gap-0.5",children:[e.jsx("span",{className:"text-base sm:text-lg font-extrabold",children:X}),e.jsx("span",{className:"text-xs sm:text-sm font-medium opacity-90",children:"/"}),e.jsx("span",{className:"text-sm sm:text-base font-semibold opacity-80",children:c.length})]})]}),n&&V&&e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full bg-[#1C8376]/10 text-[#1C8376]/90 text-sm font-bold border border-emerald-300 shadow-sm",style:{marginTop:"-2px"},children:"Round Complete!"}),n&&!G&&e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-sm font-bold border border-blue-300 shadow-sm",style:{marginTop:"-2px"},children:"All Submitted"}),!n&&(fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"LeagueFixtureSection.tsx:79",message:"Checking Round Complete conditions",data:{isApiTestLeague:n,allSubmitted:ie,resultsPublished:_,allGamesFinished:V,shouldShow:ie&&_&&V},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H3"})}).catch(()=>{}),ie&&_&&V)&&e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full bg-[#1C8376]/10 text-[#1C8376]/90 text-sm font-bold border border-emerald-300 shadow-sm",style:{marginTop:"-2px"},children:"Round Complete!"}),!n&&ie&&!_&&e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-sm font-bold border border-blue-300 shadow-sm",style:{marginTop:"-2px"},children:"All Submitted"}),!n&&M&&!ie&&e.jsxs("span",{className:"inline-flex items-center px-3 py-1 rounded-full bg-orange-100 text-orange-800 text-sm font-bold border border-orange-300 shadow-sm",style:{marginTop:"-2px"},children:["Deadline Passed ",Y.length>0&&`(${Y.join(", ")} didn't submit)`]})]})]}),e.jsx("div",{className:"rounded-2xl border bg-slate-50 overflow-hidden",children:e.jsxs("ul",{children:[c.map(y=>{try{const Z=w.get(y.fixture_index)??[],he=o.get(y.fixture_index)||null,F=L[y.fixture_index]||null;return e.jsx(Fa,{fixture:y,picks:Z,members:f,outcome:he,liveScore:F,submittedMap:S,picksGw:K,isApiTestLeague:n},`${y.gw}-${y.fixture_index}`)}catch(Z){return console.error("Error rendering fixture:",Z,y),e.jsxs("li",{className:"p-4 text-red-500",children:["Error loading fixture: ",y.fixture_index]},`${y.gw}-${y.fixture_index}`)}}),!c.length&&e.jsx("li",{className:"p-4 text-slate-500",children:"No fixtures."})]})})]})}const Bt=8;function Wt(t){return t.result==="H"||t.result==="D"||t.result==="A"?t.result:typeof t.home_goals=="number"&&typeof t.away_goals=="number"?t.home_goals>t.away_goals?"H":t.home_goals<t.away_goals?"A":"D":null}function Wa(){const t=a.useRef(0);t.current=0;const{code:c=""}=sa();t.current++;const[w,f]=aa();t.current++;const{user:o}=_s();t.current++;const{currentGw:L}=na();t.current++,a.useEffect(()=>{fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"League.tsx:after-all-hooks",message:"All hooks called",data:{code:c,hasCode:!!c,hasUser:!!o,hookCurrentGw:L,hookCallCount:t.current,timestamp:Date.now()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H3"})}).catch(()=>{})},[c,o,L]);const[S]=a.useState(()=>{const s=localStorage.getItem("oldSchoolMode");return s?JSON.parse(s):!1});t.current++,a.useEffect(()=>{localStorage.setItem("oldSchoolMode",JSON.stringify(S))},[S]),t.current++,a.useEffect(()=>{document.body.classList.add("league-page-active"),document.documentElement.classList.add("league-page-active");const s=()=>{const u=document.querySelector(".league-header-fixed");if(u){const T=u.style.top||window.getComputedStyle(u).top;T!=="0px"&&T!=="0"&&(u.style.top="0",u.style.transform="translate3d(0, 0, 0)")}},r=()=>{s(),(window.scrollY!==0||window.pageYOffset!==0)&&window.scrollTo(0,0)},l=u=>{const T=u.target;T.closest(".league-content-wrapper")||T.closest(".league-header-fixed")||T.closest(".chat-tab-wrapper")||u.preventDefault()};window.addEventListener("scroll",r,{passive:!0}),document.addEventListener("touchmove",l,{passive:!1});const d=setInterval(s,100);return s(),()=>{document.body.classList.remove("league-page-active"),document.documentElement.classList.remove("league-page-active"),window.removeEventListener("scroll",r),document.removeEventListener("touchmove",l),clearInterval(d)}},[]),a.useEffect(()=>{const s=l=>{const d=l.target;(d.tagName==="INPUT"||d.tagName==="TEXTAREA")&&setTimeout(()=>{window.scrollTo(0,0);const u=document.querySelector(".league-header-fixed");u&&(u.style.top="0")},100)},r=()=>{const l=document.querySelector(".league-header-fixed");l&&(l.style.top="0")};return document.addEventListener("focusin",s),window.addEventListener("resize",r),window.addEventListener("orientationchange",r),()=>{document.removeEventListener("focusin",s),window.removeEventListener("resize",r),window.removeEventListener("orientationchange",r)}},[]),a.useEffect(()=>{if(typeof window>"u")return;const s=window.visualViewport;if(!s)return;let r=null;const l=()=>{const u=me.current;if(!u)return;const T=s.offsetTop??0;u.style.setProperty("transform",`translate3d(0, ${T}px, 0)`,"important")},d=()=>{r&&cancelAnimationFrame(r),r=window.requestAnimationFrame(l)};return d(),s.addEventListener("resize",d),s.addEventListener("scroll",d),()=>{r&&cancelAnimationFrame(r),s.removeEventListener("resize",d),s.removeEventListener("scroll",d),me.current&&me.current.style.removeProperty("transform")}},[]);const K=()=>{if(!c)return null;try{const s=ve(`leagues:${o?.id||""}`);if(s){const r=s.find(l=>l.code.toUpperCase()===c.toUpperCase());if(r)return r}}catch{}return null},[n,z]=a.useState(()=>K());t.current++;const[$,V]=a.useState(!1);t.current++;const ie=()=>{const s=K();if(!s?.id)return[];try{const r=ve(`league:members:${s.id}`);if(r&&r.length>0)return r.map(([l,d])=>({id:l,name:d||"(no name)"}))}catch{}return[]},[_,M]=a.useState(ie);t.current++;const[Y,X]=a.useState(()=>!K());t.current++;const G="chat",[y,Z]=a.useState(G);t.current++;const[he,F]=a.useState(null);t.current++;const Q=a.useRef(y);t.current++,a.useEffect(()=>{Q.current=y},[y]),t.current++;const de=a.useRef(!1);t.current++;const ke=a.useRef(!1);t.current++,a.useEffect(()=>{const s=w.get("tab"),r=w.get("leagueCode");if(F(null),s==="chat"||s==="gw"||r){if(r&&c!==r){F(`Deep link mismatch: URL has leagueCode=${r} but we're on league ${c}. Current URL: ${window.location.href}`);return}if(s==="chat"){y!=="chat"&&(Z(d=>d!=="chat"?"chat":d),setTimeout(()=>{Q.current!=="chat"&&F(`Failed to open chat tab. Current tab: ${Q.current}, Expected: chat. URL: ${window.location.href}`)},300));const l=setTimeout(()=>{f({},{replace:!0})},200);return()=>clearTimeout(l)}if(s==="gw"){y!=="gw"&&(Z(d=>d!=="gw"?"gw":d),setTimeout(()=>{Q.current!=="gw"&&F(`Failed to open predictions tab. Current tab: ${Q.current}, Expected: gw. URL: ${window.location.href}`)},300));const l=setTimeout(()=>{f({},{replace:!0})},200);return()=>clearTimeout(l)}}},[w,f,y,c]);const me=a.useRef(null),[Me,De]=a.useState(!1),[He,je]=a.useState(!1),[Be,oe]=a.useState(!1),ee=()=>{try{return ve("app_meta:current_gw")?.current_gw??null}catch{return null}},[j,O]=a.useState(ee),[i,b]=a.useState(null),[x,R]=a.useState(ee),m=()=>{try{return ve("app:available_gws")??[]}catch{return[]}},[p,g]=a.useState(()=>m()),B=a.useRef({}),k=a.useRef({}),H=a.useRef(new Map),[ue,ce]=a.useState(new Set),[ge,Ie]=a.useState(!1),[xe,fe]=a.useState(!1),[Ne,Le]=a.useState(0),[Ot,Xe]=a.useState(!1),[vt,ut]=a.useState(!1),[Ge,Oe]=a.useState(!1),[$e,mt]=a.useState(!1),[ft,Pe]=a.useState(null),[ks,Ke]=a.useState(!1),[qe,Ze]=a.useState(null),[Ns,qt]=a.useState({x:0,y:0}),[jt,_t]=a.useState(1),[ht,Jt]=a.useState(null),[Fe,at]=a.useState(null),[nt,Qe]=a.useState(!1);t.current++;const[rt,gt]=a.useState(!1);t.current++;const[Cs,it]=a.useState(!1);t.current++;const[kt,pt]=a.useState(!1);t.current++,a.useEffect(()=>{fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"League.tsx:final-hook-count",message:"Final hook count logged",data:{finalHookCount:t.current},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H5"})}).catch(()=>{})},[]);const[xt,et]=a.useState(!1),[Ss,Nt]=a.useState(!1),[Ls,Ct]=a.useState(!1),[bt,Vt]=a.useState(null),[St,Kt]=a.useState(!1),[Lt,Yt]=a.useState(!1),[ot,Es]=a.useState(null),We=a.useMemo(()=>!!o?.id&&_.some(s=>s.id===o.id),[o?.id,_]),Xt=a.useMemo(()=>!!o?.id&&!!ot&&ot.id===o.id,[o?.id,ot]),Ms=a.useMemo(()=>ot?.name??"League admin",[ot]),Ts=a.useMemo(()=>{const s=new Map;return _.forEach(r=>s.set(r.id,r.name)),s.set(js,ra),s},[_]),Rs=a.useCallback(()=>{if(!n?.code||typeof window>"u"||typeof navigator>"u")return;const s=`Join my mini league "${n.name}" on TotL!`,r=`${window.location.origin}/league/${n.code}`,l=navigator;if(typeof l.share=="function"){l.share({title:`Join ${n.name}`,text:s,url:r}).catch(()=>{});return}const d=`${s}
${r}`;navigator.clipboard?.writeText?navigator.clipboard.writeText(d).then(()=>window.alert?.("League link copied to clipboard!")).catch(()=>{window.prompt?.("Share this league code:",n.code)}):window.prompt?.("Share this league code:",n.code)},[n]),Is=a.useCallback(async()=>{if(!(!n?.id||!o?.id)){oe(!0);try{const{error:s}=await P.from("league_members").delete().eq("league_id",n.id).eq("user_id",o.id);if(s)throw s;typeof window<"u"&&(window.location.href="/leagues")}catch(s){typeof window<"u"&&window.alert?.(s?.message??"Failed to leave league. Please try again.")}finally{oe(!1),je(!1)}}},[n?.id,o?.id]),As=a.useCallback(async()=>{if(!(!n?.id||!o?.id)){pt(!0);try{if((await ia(o.id)).length>=20){typeof window<"u"&&window.alert?.("You're already in 20 mini-leagues, which is the maximum. Leave a league before joining another."),it(!1),pt(!1);return}const r=L;if(r!==null){const u=await Ut({id:n.id,name:n.name,created_at:n.created_at},r);if(r-u>=4){typeof window<"u"&&window.alert?.("This league has been running for more than 4 gameweeks. New members can only be added during the first 4 gameweeks."),it(!1),pt(!1);return}}if(_.length>=Bt){typeof window<"u"&&window.alert?.("League is full (max 8 members)."),it(!1);return}const{error:l}=await P.from("league_members").insert({league_id:n.id,user_id:o.id});if(l)throw l;const d=o.user_metadata?.display_name||o.email||"Someone";try{const u=await fetch("/.netlify/functions/notifyLeagueMemberJoin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({leagueId:n.id,userId:o.id,userName:d})}),T=await u.text();try{T&&JSON.parse(T)}catch{}u.ok}catch{}typeof window<"u"&&window.location.reload()}catch(s){typeof window<"u"&&window.alert?.(s?.message??"Failed to join league.")}finally{pt(!1)}}},[n?.id,n?.name,n?.created_at,o?.id,_.length,L]),Ds=a.useCallback(async()=>{if(!(!bt||!n?.id||!o?.id)){Kt(!0);try{const{error:s}=await P.from("league_members").delete().eq("league_id",n.id).eq("user_id",bt.id);if(s)throw s;typeof window<"u"&&window.location.reload()}catch(s){typeof window<"u"&&window.alert?.(s?.message??"Failed to remove member.")}finally{Kt(!1),Nt(!1),Vt(null)}}},[n?.id,bt,o?.id]),Ps=a.useCallback(async()=>{if(!(!n?.id||!o?.id)){Yt(!0);try{const{error:s}=await P.from("league_members").delete().eq("league_id",n.id);if(s)throw s;const{error:r}=await P.from("leagues").delete().eq("id",n.id);if(r)throw r;typeof window<"u"&&(window.location.href="/leagues")}catch(s){typeof window<"u"&&window.alert?.(s?.message??"Failed to end league.")}finally{Yt(!1),Ct(!1)}}},[n?.id,o?.id]),Us=s=>new Promise((r,l)=>{const d=new Image;d.addEventListener("load",()=>r(d)),d.addEventListener("error",u=>l(u)),d.src=s}),Zt=async(s,r)=>{const l=await Us(s),d=document.createElement("canvas"),u=d.getContext("2d");if(!u)throw new Error("No 2d context");return d.width=r.width,d.height=r.height,u.drawImage(l,r.x,r.y,r.width,r.height,0,0,r.width,r.height),new Promise((T,U)=>{d.toBlob(E=>{if(!E){U(new Error("Canvas is empty"));return}T(E)},"image/jpeg",.9)})},$s=a.useCallback(s=>{if(!n?.id||!We){Pe("You must be a member of the league to upload badges.");return}if(!new Set(["image/png","image/jpeg","image/jpg","image/webp"]).has(s.type)){Pe("Please upload a PNG, JPG, or WebP image.");return}const l=20*1024*1024;if(s.size>l){Pe("Please choose an image smaller than 20MB.");return}if(Pe(null),Ke(!1),s.size>5*1024*1024)us(s,{maxSizeMB:2,maxWidthOrHeight:1024,useWebWorker:!0,initialQuality:.7}).then(d=>{const u=new FileReader;u.onload=()=>{Ze(u.result)},u.readAsDataURL(d)}).catch(()=>{Pe("Failed to process image. Please try a smaller file.")});else{const d=new FileReader;d.onload=()=>{Ze(d.result)},d.readAsDataURL(s)}},[We,n?.id]),Fs=a.useCallback(async(s,r)=>{if(Jt(r),qe)try{const l=await Zt(qe,r),d=URL.createObjectURL(l);at(d)}catch{}},[qe]),Hs=a.useCallback(async()=>{if(!(!qe||!ht||!n?.id||!We)){Pe(null),Ke(!1),mt(!0);try{const s=await Zt(qe,ht),r=new File([s],"badge.jpg",{type:"image/jpeg"}),l=await us(r,{maxSizeMB:.02,maxWidthOrHeight:256,useWebWorker:!0,initialQuality:.8});if(l.size>20*1024)throw new Error("Compressed image is still larger than 20KB. Try a smaller image.");const d=`${n.id}-${Date.now()}.jpg`,{error:u}=await P.storage.from("league-avatars").upload(d,l,{cacheControl:"3600",upsert:!0,contentType:l.type});if(u)throw u;const{data:T}=P.storage.from("league-avatars").getPublicUrl(d),U=T?.publicUrl;if(!U)throw new Error("Unable to get public URL for badge.");const{error:E}=await P.from("leagues").update({avatar:U}).eq("id",n.id);if(E)throw E;z(te=>te&&{...te,avatar:U}),Ke(!0),Fe&&URL.revokeObjectURL(Fe),Ze(null),at(null),Oe(!1),o?.id&&($t(o.id),window.dispatchEvent(new CustomEvent("leagueBadgeUpdated",{detail:{leagueId:n.id,avatar:U}})))}catch(s){Pe(s?.message??"Failed to upload badge. Please try again.")}finally{mt(!1)}}},[qe,ht,We,n?.id,o?.id]),Bs=a.useCallback(async()=>{if(!(!n?.id||!We)){Pe(null),Ke(!1),mt(!0);try{const{error:s}=await P.from("leagues").update({avatar:null}).eq("id",n.id);if(s)throw s;z(r=>r&&{...r,avatar:null}),Ke(!0),o?.id&&($t(o.id),window.dispatchEvent(new CustomEvent("leagueBadgeUpdated",{detail:{leagueId:n.id,avatar:null}})))}catch(s){Pe(s?.message??"Failed to remove badge. Please try again.")}finally{mt(!1)}}},[We,n?.id]),[Qt,Ws]=a.useState(new Map);a.useEffect(()=>{(async()=>{const s=new Map,{data:r}=await P.from("app_fixtures").select("gw, kickoff_time").order("gw",{ascending:!0}),{data:l}=await P.from("app_fixtures").select("gw, kickoff_time").eq("gw",1).order("fixture_index",{ascending:!0}),d=new Map;if(r&&r.forEach(u=>{(!d.has(u.gw)||u.kickoff_time&&new Date(u.kickoff_time)<new Date(d.get(u.gw)))&&u.kickoff_time&&d.set(u.gw,u.kickoff_time)}),l&&l.length>0){const u=l.find(T=>T.kickoff_time)?.kickoff_time;if(u){const T=d.get(1);(!T||new Date(u)<new Date(T))&&d.set(1,u)}}d.forEach((u,T)=>{const U=new Date(u),E=new Date(U.getTime()-4500*1e3);s.set(T,E)}),Ws(s)})()},[]),a.useEffect(()=>{const s=r=>{const l=r.target;ge&&!l.closest(".gw-dropdown-container")&&Ie(!1)};return ge&&document.addEventListener("click",s),()=>document.removeEventListener("click",s)},[ge]),a.useEffect(()=>{let s=!0;return(async()=>{const{data:r}=await P.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(!s)return;O(r?.current_gw??null);const{data:l}=await P.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1);if(!s)return;b(l&&l.length?l[0].gw:null);const{data:d}=await P.from("app_gw_results").select("gw").order("gw",{ascending:!1});if(!s)return;const u=d?[...new Set(d.map(U=>U.gw))].sort((U,E)=>E-U):[],T=r?.current_gw;T&&!u.includes(T)&&u.unshift(T),g(u),(u.length>0&&!x||u.length>0&&x&&!u.includes(x))&&R(u[0])})(),()=>{s=!1}},[Ne]);const zs=a.useMemo(()=>_.map(s=>s.id).sort().join(","),[_]),Je=a.useMemo(()=>_.map(s=>s.id),[zs]),[ye,es]=a.useState([]);t.current++;const[ts,Et]=a.useState([]);t.current++;const[ss,Mt]=a.useState([]);t.current++;const[lt,Tt]=a.useState([]);t.current++,a.useEffect(()=>{typeof window<"u"&&window.scrollTo({top:0,behavior:"auto"})},[y]),t.current++;const{state:Rt}=tt(j);t.current++;const wt=a.useMemo(()=>n?.name==="API Test",[n?.name]),[Ae,as]=a.useState(null);t.current++;const It=a.useMemo(()=>n?n.name==="API Test"?Ae??1:ke.current&&x||!j?x:Rt==="LIVE"||Rt==="RESULTS_PRE_GW"?j:i&&i<j?i:j>1?j-1:j:j||x||null,[n?.name,Ae,x,j,Rt,i]);t.current++;const{state:Gs}=tt(It??null);t.current++;const ct=a.useRef(""),ns=a.useRef(0),rs=a.useMemo(()=>{const s=ye?.length||0;if(s===ns.current&&ct.current&&(ye?.map(d=>d.api_match_id).filter(d=>d!=null).sort().join(",")||"")===ct.current)return ct.current;if(ns.current=s,!ye||ye.length===0)return ct.current="","";const r=ye.map(l=>l.api_match_id).filter(l=>l!=null).sort().join(",");return ct.current=r,r},[ye]);a.useEffect(()=>{if(!wt){as(null);return}let s=!0;return(async()=>{const{data:r}=await P.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle();let l=r?.current_test_gw??1;if(l&&l!==1){const{data:d}=await P.from("app_fixtures").select("gw").eq("gw",l).limit(1).maybeSingle();if(!d){const{data:u}=await P.from("app_fixtures").select("gw").eq("gw",1).limit(1).maybeSingle();u&&(l=1)}}s&&as(l)})(),()=>{s=!1}},[wt]);const Os=a.useMemo(()=>wt&&Ae!==null?Ae:j||x||void 0,[wt,Ae,j,x]),At=a.useRef({key:"",array:void 0}),qs=a.useMemo(()=>{const s=rs||"";if(At.current.key===s)return At.current.array;const r=s?s.split(",").map(l=>parseInt(l,10)).filter(l=>!isNaN(l)):void 0;return At.current={key:s,array:r},r},[rs]),{liveScores:is}=oa(Os,qs),Ce=a.useMemo(()=>{const s={};if(!ye||ye.length===0)return Object.keys(k.current).length===0?k.current:(k.current=s,s);ye.forEach(T=>{const U=T.api_match_id;if(U){const E=is.get(U);E&&(s[T.fixture_index]={homeScore:E.home_score??0,awayScore:E.away_score??0,status:E.status||"SCHEDULED",minute:E.minute??null})}});const r=k.current,l=Object.keys(s).map(Number),d=Object.keys(r).map(Number);if(l.length!==d.length)return k.current=s,s;let u=!1;for(const T of l){const U=s[T],E=r[T];if(!E||U.homeScore!==E.homeScore||U.awayScore!==E.awayScore||U.status!==E.status||U.minute!==E.minute){u=!0;break}}return u?(k.current=s,s):r},[is,ye]),Js=()=>{try{if(console.log("[League] getInitialMltRows called",{code:c,userId:o?.id}),c&&o?.id){const r=ve(`leagues:${o.id}`);if(console.log("[League] getInitialMltRows - cachedLeagues",{hasCached:!!r,length:r?.length}),r&&Array.isArray(r)){const l=r.find(d=>d.code.toUpperCase()===c.toUpperCase());if(console.log("[League] getInitialMltRows - found league",{found:!!l,leagueId:l?.id}),l?.id){const d=`league:mltRows:${l.id}`,u=ve(d);if(console.log("[League] getInitialMltRows - cached mltRows",{hasCached:!!u,length:u?.length,cacheKey:d,cachedType:typeof u,isArray:Array.isArray(u),rawCache:u}),u&&Array.isArray(u)&&u.length>0)return console.log("[League] âœ… getInitialMltRows returning cached rows",u.length),u;console.log("[League] âŒ Cache check failed",{cached:!!u,isArray:Array.isArray(u),length:u?.length,cacheKey:d})}}}const s=K();if(console.log("[League] getInitialMltRows - initialLeague",{hasLeague:!!s,leagueId:s?.id}),s?.id){const r=ve(`league:mltRows:${s.id}`);if(console.log("[League] getInitialMltRows - cached from initialLeague",{hasCached:!!r,length:r?.length}),r&&Array.isArray(r)&&r.length>0)return console.log("[League] âœ… getInitialMltRows returning cached rows from initialLeague",r.length),r}if(c&&o?.id){const r=ve(`leagues:${o.id}`);if(r&&Array.isArray(r)){for(const l of r)if(l.code?.toUpperCase()===c.toUpperCase()&&l.id){const d=ve(`league:mltRows:${l.id}`);if(d&&Array.isArray(d)&&d.length>0)return console.log("[League] âœ… getInitialMltRows returning cached rows from strategy 3",d.length),d}}}console.log("[League] âš ï¸ getInitialMltRows returning empty array - cache miss")}catch(s){console.error("[League] âŒ getInitialMltRows error",s)}return[]},[Se,ze]=a.useState(Js);a.useEffect(()=>{console.log("[League] Tab changed to:",y,"mltRows.length:",Se.length)},[y,Se.length]),a.useEffect(()=>{if(n?.id){const s=`league:mltRows:${n.id}`,r=ve(s);if(console.log("[League] useEffect loading mltRows from cache",{leagueId:n.id,cacheKey:s,hasCached:!!r,cachedLength:r?.length,currentMltRowsLength:Se.length}),r&&r.length>0)Se.length===0?(console.log("[League] âœ… Setting mltRows from cache",r.length),ze(r)):console.log("[League] mltRows already populated, skipping");else{console.log("[League] âš ï¸ No cached mltRows found - will retry multiple times");let l=0;const d=10,u=[50,100,150,200,250,300,400,500,600,800],T=()=>{if(l>=d){console.log("[League] âŒ Max retries reached, giving up on cache");return}const E=setTimeout(()=>{l++;const te=ve(s);te&&te.length>0&&Se.length===0?(console.log(`[League] âœ… Retry ${l} successful - Setting mltRows from cache`,te.length),ze(te)):l<d&&T()},u[l]||800);return()=>clearTimeout(E)};return T()}}else console.log("[League] âš ï¸ No league.id available yet")},[n?.id,Se.length]),a.useEffect(()=>{let s=!0;return(async()=>{let l=n;if(!l){const{data:E}=await P.from("leagues").select("id,name,code,created_at,avatar").eq("code",c).maybeSingle();if(!s)return;if(!E){z(null),M([]),X(!1);return}l=E,z(l)}const d=ve(`league:members:${l.id}`);let u=[];if(d&&d.length>0)u=d.map(([E,te])=>({id:E,name:te||"(no name)"})),X(!1);else{const{data:E}=await P.from("league_members").select("users(id,name),created_at").eq("league_id",l.id).order("created_at",{ascending:!0});u=E?.map(te=>({id:te.users.id,name:te.users.name??"(no name)"}))??[],X(!1)}const T=[...u].sort((E,te)=>E.name.localeCompare(te.name));M(T);const U=u[0];Es(U),o?.id&&!u.some(E=>E.id===o.id)&&it(!0),X(!1)})(),()=>{s=!1}},[c]),a.useEffect(()=>{},[n,y]),a.useEffect(()=>{if(y!=="chat"||!n?.id||!o?.id)return;(async()=>{await P.from("league_message_reads").upsert({league_id:n.id,user_id:o.id,last_read_at:new Date().toISOString()},{onConflict:"league_id,user_id"}),$t(o.id),window.dispatchEvent(new CustomEvent("leagueMessagesRead",{detail:{leagueId:n.id,userId:o.id}}))})()},[y,n?.id,o?.id]),a.useEffect(()=>{let s=!0;return(async()=>{const r=n?.name==="API Test";let l=Ae??1;if(r){const{data:C}=await P.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle();if(l=C?.current_test_gw??1,l&&l!==1){const{data:I}=await P.from("app_fixtures").select("gw").eq("gw",l).limit(1).maybeSingle();if(!I){const{data:q}=await P.from("app_fixtures").select("gw").eq("gw",1).limit(1).maybeSingle();q&&(l=1)}}}const d=r&&(y==="gw"||y==="gwr");let u=null;if(y==="gwr")if(ke.current&&x)u=x;else if(j)try{const C=await la(j);C==="LIVE"||C==="RESULTS_PRE_GW"?u=j:i&&i<j?u=i:u=j>1?j-1:j}catch(C){console.error("[League] Error checking game state for fixtures loading:",C),i&&i<j?u=i:u=j>1?j-1:j}else u=x;else u=j;if(r&&(y==="gw"||y==="gwr")&&(u=l),y==="gw"&&!r&&Je.length>0){const{data:C}=await P.from("app_gw_submissions").select("gw").in("user_id",Je).not("submitted_at","is",null).order("gw",{ascending:!1}).limit(10);if(C&&C.length>0){const I=[...new Set(C.map(q=>q.gw))].sort((q,ne)=>(ne||0)-(q||0));for(const q of I)if(q){const{data:ne}=await P.from("app_fixtures").select("gw").eq("gw",q).limit(1);if(ne&&ne.length>0){u=q;break}}}!u&&j&&(u=j)}if(!u&&!d){es([]),Et([]),Mt([]),Tt([]);return}let T;if(d){const{data:C}=await P.from("app_fixtures").select("id,test_gw,fixture_index,home_team,away_team,home_code,away_code,home_name,away_name,home_crest,away_crest,kickoff_time,api_match_id").eq("test_gw",l).order("fixture_index",{ascending:!0});T=C?.map(I=>({...I,gw:I.test_gw}))||null}else{const{data:C}=await P.from("app_fixtures").select("id,gw,fixture_index,home_team,away_team,home_code,away_code,home_name,away_name,kickoff_time,api_match_id").eq("gw",u).order("fixture_index",{ascending:!0});T=C||null}if(!s)return;if(es(C=>{const I=T??[];return C.length!==I.length?I:C.length===0&&I.length===0?C:C.some((ne,N)=>!I[N]||ne.id!==I[N].id||ne.fixture_index!==I[N].fixture_index)||I.some((ne,N)=>!C[N]||ne.id!==C[N].id||ne.fixture_index!==C[N].fixture_index)?I:C}),!Je.length){Et([]),Mt([]),Tt([]);return}let U=null,E;if(d){const{data:C}=await P.from("app_picks").select("user_id,matchday,fixture_index,pick").eq("matchday",l).in("user_id",Je);U=C?.map(A=>({...A,gw:A.matchday}))||null;const{data:I,error:q}=await P.from("app_gw_submissions").select("user_id,matchday,submitted_at").eq("matchday",l).not("submitted_at","is",null).in("user_id",Je),{data:ne}=await P.from("app_fixtures").select("fixture_index,home_team,away_team,home_code,away_code,kickoff_time").eq("test_gw",l).order("fixture_index",{ascending:!0}),N=new Set((ne||[]).map(A=>A.fixture_index)),h=[];if(I&&U&&ne){const A=N.size,D=new Date("2025-11-18T00:00:00Z");I.forEach(W=>{const J=(U||[]).filter(we=>we.user_id===W.user_id&&we.matchday===l).filter(we=>N.has(we.fixture_index)),be=J.length===A&&A>0,v=new Set(J.map(we=>we.fixture_index)).size===A,ae=W.submitted_at?new Date(W.submitted_at):null,pe=ae&&ae>=D;be&&v&&pe&&h.push(W)})}E=h.map(A=>({...A,gw:A.matchday}))||null}else{const{data:C}=await P.from("app_picks").select("user_id,gw,fixture_index,pick").eq("gw",u).in("user_id",Je);U=C;const{data:I}=await P.from("app_gw_submissions").select("user_id,gw,submitted_at").eq("gw",u).in("user_id",Je);E=I}if(!s)return;Et(C=>{const I=U??[];if(C.length!==I.length)return I;if(C.length===0&&I.length===0)return C;const q=JSON.stringify(C.sort((N,h)=>N.fixture_index-h.fixture_index)),ne=JSON.stringify(I.sort((N,h)=>N.fixture_index-h.fixture_index));return q===ne?C:I}),Mt(C=>{const I=E??[];if(C.length!==I.length)return I;if(C.length===0&&I.length===0)return C;const q=JSON.stringify(C),ne=JSON.stringify(I);return q===ne?C:I});const{data:te}=await P.from("app_gw_results").select("gw,fixture_index,result").eq("gw",d?1:u||0);s&&Tt(C=>{const I=te??[];if(C.length!==I.length)return I;if(C.length===0&&I.length===0)return C;const q=JSON.stringify(C.sort((N,h)=>N.fixture_index-h.fixture_index)),ne=JSON.stringify(I.sort((N,h)=>N.fixture_index-h.fixture_index));return q===ne?C:I})})(),()=>{s=!1}},[y,j,i,x,Je]),a.useEffect(()=>{B.current=Ce},[Ce]);const Ve=a.useMemo(()=>{const s=new Map;return ss.forEach(r=>{if(r.submitted_at){const l=`${r.user_id}:${r.gw}`;s.set(l,!0)}}),s},[ss]),yt=a.useCallback(s=>s.map(r=>({user_id:r.id,name:r.name,mltPts:0,ocp:0,unicorns:0,wins:0,draws:0,form:[]})),[]);a.useEffect(()=>{const s=P.channel("app-gw-results-changes").on("postgres_changes",{event:"*",schema:"public",table:"app_gw_results"},()=>{Le(r=>r+1)}).subscribe();return()=>{P.removeChannel(s)}},[]),a.useEffect(()=>{let s=!0;return(async()=>{const r=Ne>0,l=Se.length>0&&Se.every(v=>v.wins===0&&v.draws===0),d=r||l;if(!d&&Se.length>0)return;if(!d&&n?.id){const v=ve(`league:mltRows:${n.id}`);if(v&&v.length>0){ze(v);return}}if(!_.length){ve(`league:mltRows:${n?.id||""}`)||ze([]);return}if(n?.name==="API Test"){ze(yt(_));return}if(!d){const v=n?.id&&ve(`league:mltRows:${n.id}`);if(v&&v.length>0){ze(v);return}}if(j===null)return;const{data:u}=await P.from("app_gw_results").select("gw,fixture_index,result"),T=u??[],U=new Map;if(T.forEach(v=>{const ae=Wt(v);ae&&U.set(`${v.gw}:${v.fixture_index}`,ae)}),U.size===0){ze(yt(_));return}const E=[...new Set(Array.from(U.keys()).map(v=>parseInt(v.split(":")[0],10)))].sort((v,ae)=>v-ae),te=["Prem Predictions","FC Football","Easy League"],C=["The Bird league"],I=await Ut(n,j);let q=E.filter(v=>v>=I);if(j!==null&&q.includes(j)){const{data:v}=await P.from("app_fixtures").select("fixture_index").eq("gw",j),ae=v?.length??0,pe=Array.from(U.keys()).filter(we=>parseInt(we.split(":")[0],10)===j).length;ae>0&&pe<ae&&(q=q.filter(we=>we<j))}else j!==null&&(q=q.filter(v=>v<j));if(!te.includes(n?.name||"")&&!C.includes(n?.name||"")&&q.length===0){ze(yt(_));return}const{data:ne}=await P.from("app_picks").select("user_id,gw,fixture_index,pick").in("user_id",_.map(v=>v.id)).in("gw",q),N=ne??[],h=new Map;q.forEach(v=>{const ae=new Map;_.forEach(pe=>ae.set(pe.id,{user_id:pe.id,score:0,unicorns:0})),h.set(v,ae)}),q.forEach(v=>{Array.from(U.entries()).filter(([pe])=>parseInt(pe.split(":")[0],10)===v).map(([pe,we])=>({idx:parseInt(pe.split(":")[1],10),out:we})).forEach(({idx:pe,out:we})=>{const se=N.filter(Ue=>Ue.gw===v&&Ue.fixture_index===pe),Ee=se.filter(Ue=>Ue.pick===we).map(Ue=>Ue.user_id),ls=h.get(v);if(se.forEach(Ue=>{if(Ue.pick===we){const Pt=ls.get(Ue.user_id);Pt.score+=1}}),Ee.length===1&&_.length>=3){const Ue=Ee[0],Pt=ls.get(Ue);Pt.unicorns+=1}})});const A=new Map,D=new Map,W=new Map,re=new Map,J=new Map,be=new Map;_.forEach(v=>{A.set(v.id,0),D.set(v.id,0),W.set(v.id,0),re.set(v.id,0),J.set(v.id,0),be.set(v.id,[])}),q.forEach(v=>{const ae=Array.from(h.get(v).values());if(ae.forEach(se=>{D.set(se.user_id,(D.get(se.user_id)??0)+se.score),W.set(se.user_id,(W.get(se.user_id)??0)+se.unicorns)}),ae.sort((se,Ee)=>Ee.score-se.score||Ee.unicorns-se.unicorns),!ae.length)return;const pe=ae[0],we=ae.filter(se=>se.score===pe.score&&se.unicorns===pe.unicorns);we.length===1?(A.set(pe.user_id,(A.get(pe.user_id)??0)+3),re.set(pe.user_id,(re.get(pe.user_id)??0)+1),be.get(pe.user_id).push("W"),ae.slice(1).forEach(se=>be.get(se.user_id).push("L"))):(we.forEach(se=>{A.set(se.user_id,(A.get(se.user_id)??0)+1),J.set(se.user_id,(J.get(se.user_id)??0)+1),be.get(se.user_id).push("D")}),ae.filter(se=>!we.find(Ee=>Ee.user_id===se.user_id)).forEach(se=>be.get(se.user_id).push("L")))});const le=_.map(v=>({user_id:v.id,name:v.name,mltPts:A.get(v.id)??0,ocp:D.get(v.id)??0,unicorns:W.get(v.id)??0,wins:re.get(v.id)??0,draws:J.get(v.id)??0,form:be.get(v.id)??[]}));le.sort((v,ae)=>ae.mltPts-v.mltPts||ae.unicorns-v.unicorns||ae.ocp-v.ocp||v.name.localeCompare(ae.name)),s&&(ze(le),n?.id&&zt(`league:mltRows:${n.id}`,le,Gt.LEAGUES))})(),()=>{s=!1}},[_,n,j,yt,Ne]);const os=a.useCallback(async()=>{if(!n||!L){Qe(!0);return}try{const s=await Ut({id:n.id,name:n.name,created_at:n.created_at},L);if(L-s>=4){gt(!0);return}Qe(!0)}catch(s){console.error("[League] Error checking league lock status:",s),Qe(!0)}},[n,L]);function Dt(){return e.jsxs("div",{className:"text-center p-8 bg-white rounded-xl border border-slate-200 shadow-sm",children:[e.jsx("img",{src:"/assets/Volley/volley-with-ball.png",alt:"Volley",className:"w-24 h-24 mx-auto mb-4 object-contain"}),e.jsx("p",{className:"text-slate-600 mb-4 font-bold",children:"Share your league code with friends to kick things off."}),e.jsx("button",{onClick:os,className:"px-4 py-2 bg-[#1C8376] text-white font-semibold rounded-lg",children:"Share League Code"})]})}function Vs(){const s=a.useRef(null);if(a.useEffect(()=>{if(!rt)return;const l=d=>{d.key==="Escape"&&gt(!1)};return document.addEventListener("keydown",l),()=>document.removeEventListener("keydown",l)},[rt]),a.useEffect(()=>(rt?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[rt]),!rt)return null;const r=l=>{l.target===l.currentTarget&&gt(!1)};return gs.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:s,className:"fixed inset-0 bg-black/50 backdrop-blur-sm",onClick:r,"aria-hidden":"true",style:{animation:"fadeIn 200ms ease-out",zIndex:999999}}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center p-4",role:"dialog","aria-modal":"true","aria-labelledby":"league-locked-error-title",onClick:r,style:{zIndex:1e6},children:e.jsxs("div",{className:"relative overflow-hidden rounded-3xl bg-white px-8 py-8 text-center shadow-2xl max-w-sm w-full",children:[e.jsx("div",{className:"absolute -top-16 -left-10 h-32 w-32 rounded-full bg-red-200/40 blur-2xl"}),e.jsx("div",{className:"absolute -bottom-14 -right-12 h-32 w-32 rounded-full bg-amber-200/40 blur-2xl"}),e.jsxs("div",{className:"relative z-10 space-y-4",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto text-amber-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),e.jsx("h2",{id:"league-locked-error-title",className:"text-2xl font-extrabold text-amber-600",children:"League Locked"}),e.jsx("p",{className:"text-sm text-slate-600 leading-relaxed",children:"This league has been running for more than 4 gameweeks. New members can only be added during the first 4 gameweeks."}),e.jsx("button",{onClick:()=>gt(!1),className:"mt-4 px-6 py-2.5 bg-[#1C8376] text-white rounded-lg font-semibold hover:bg-[#156d63] transition-colors",children:"OK"})]})]})})]}),document.body)}function Ks(){const[s,r]=a.useState(""),l=a.useRef(null),d=a.useRef(null);a.useEffect(()=>{if(!nt)return;const C=I=>{I.key==="Escape"&&Qe(!1)};return document.addEventListener("keydown",C),()=>document.removeEventListener("keydown",C)},[nt]);const u=C=>{C.target===C.currentTarget&&Qe(!1)};if(a.useEffect(()=>(nt?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[nt]),!nt||!n)return null;const T=C=>{r(C),window.clearTimeout(T._t),T._t=window.setTimeout(()=>r(""),1600)},U=async()=>{try{await navigator.clipboard.writeText(n.code),T("Code copied")}catch{try{const I=document.createElement("textarea");I.value=n.code,document.body.appendChild(I),I.select(),document.execCommand("copy"),document.body.removeChild(I),T("Code copied")}catch{T("Couldn't copy")}}},E=async()=>{if(!n?.code||typeof window>"u"||typeof navigator>"u")return;const C=`Join my mini league "${n.name}" on TotL!`,I=`${window.location.origin}/league/${n.code}`,q=navigator;if(typeof q.share=="function")try{await q.share({title:`Join ${n.name}`,text:C,url:I});return}catch{return}const ne=`${C}
${I}`;try{await navigator.clipboard.writeText(ne),T("Share text copied")}catch{T("Couldn't share")}},te=e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:l,className:"fixed inset-0 bg-black/50",onClick:u,"aria-hidden":"true",style:{animation:"fadeIn 200ms ease-out",zIndex:999999,touchAction:"manipulation"}}),e.jsxs("div",{ref:d,className:"fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl",role:"dialog","aria-modal":"true","aria-labelledby":"share-league-code-tray-title",onClick:C=>C.stopPropagation(),style:{animation:"slideUp 300ms ease-out",zIndex:1e6,touchAction:"manipulation"},children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2",children:e.jsx("div",{className:"w-12 h-1 bg-slate-300 rounded-full"})}),e.jsxs("div",{className:"flex items-center justify-between px-6 pb-4",children:[e.jsx("h2",{id:"share-league-code-tray-title",className:"text-lg font-medium text-slate-900 uppercase tracking-wide",style:{fontFamily:'"Gramatika", sans-serif',fontWeight:700},children:"Share League Code"}),e.jsx("button",{onClick:()=>Qe(!1),className:"w-8 h-8 flex items-center justify-center rounded-full","aria-label":"Close",children:e.jsx("svg",{className:"w-5 h-5 text-slate-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"px-6 pb-8 max-h-[70vh] overflow-y-auto",children:e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{children:[e.jsxs("p",{className:"text-slate-600 text-sm mb-3",children:["Share this code (up to ",Bt," members):"]}),e.jsx("div",{className:"flex items-center gap-3 mb-4",children:e.jsx("code",{className:"flex-1 font-mono text-2xl font-bold text-center py-3 px-4 bg-slate-50 rounded-lg border border-slate-200",children:n.code})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:U,className:"flex-1 px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-900 font-semibold hover:bg-slate-50 transition-colors",children:"Copy"}),e.jsx("button",{onClick:E,className:"flex-1 px-4 py-3 rounded-lg bg-[#1C8376] text-white font-semibold hover:bg-[#156b60] transition-colors",children:"Share"})]}),e.jsx("div",{className:`mt-3 text-xs rounded bg-slate-900 text-white px-3 py-2 text-center transition-opacity ${s?"opacity-100":"opacity-0 pointer-events-none"}`,children:s||"â€¦"}),e.jsxs("div",{className:"mt-4 text-xs text-slate-500 text-center",children:[_.length,"/",Bt," members"]})]})})}),e.jsx("div",{className:"flex justify-center pb-3",children:e.jsx("div",{className:"w-12 h-1 bg-slate-300 rounded-full"})})]})]});return typeof document<"u"&&document.body?gs.createPortal(te,document.body):te}function Ys(){const s=performance.now();console.log("[MltTab] âš¡ RENDERING START",{mltRowsLength:Se.length,membersLength:_.length,leagueId:n?.id,timestamp:s});const r=performance.now(),l=a.useMemo(()=>j??null,[j]);tt(l);const d=performance.now();console.log("[MltTab] âš¡ Hooks complete",{duration:d-r});const u=performance.now(),T=Se.length>0?Se:_.length>0?_.map(q=>({user_id:q.id,name:q.name,mltPts:0,ocp:0,unicorns:0,wins:0,draws:0,form:[]})):[],U=performance.now();console.log("[MltTab] âš¡ Rows calculated",{rowsLength:T.length,mltRowsLength:Se.length,duration:U-u});const E=["Prem Predictions","FC Football","Easy League"],te=["The Bird league"],C=["gregVjofVcarl","Let Down"],I=!!(n&&!E.includes(n.name)&&!te.includes(n.name)&&!C.includes(n.name));return _.length===1?e.jsx(Dt,{}):e.jsxs("div",{className:"pt-4",children:[e.jsx(Ta,{rows:T,members:_,showForm:Me,currentUserId:o?.id,loading:!1,isLateStartingLeague:I}),e.jsx("div",{className:"mt-6 flex justify-between items-center",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx(Ea,{showForm:Me,onToggle:De}),e.jsxs("button",{onClick:()=>Xe(!0),className:"flex items-center justify-center gap-1.5 bg-white border-2 border-slate-300 rounded-full text-slate-600 cursor-help flex-shrink-0 px-3 py-2",children:[e.jsx("img",{src:"/assets/Icons/School--Streamline-Outlined-Material-Pr0_White.png",alt:"Rules",className:"w-4 h-4",style:{filter:"invert(40%) sepia(8%) saturate(750%) hue-rotate(180deg) brightness(95%) contrast(88%)"}}),e.jsx("span",{className:"text-sm font-medium",children:"Rules"})]})]})}),n?.name==="API Test"&&e.jsx("div",{className:"mt-4",style:{marginLeft:"-1rem",marginRight:"-1rem",width:"calc(100% + 2rem)",paddingLeft:0,paddingRight:0},children:e.jsx("video",{src:"/assets/Animation/Unicorn_Small.mov",autoPlay:!0,loop:!0,muted:!0,playsInline:!0,style:{width:"100%",height:"auto",display:"block",padding:0,margin:0}})})]})}function Xs(){const s=a.useMemo(()=>n?.name==="API Test"?Ae??1:j??null,[n?.name,Ae,j]),{state:r}=tt(s);if(_.length===1)return e.jsx(Dt,{});if(!s)return e.jsx("div",{className:"mt-3 rounded-2xl border bg-white shadow-sm p-4 text-slate-600",children:"No current gameweek available."});if(!ps(n,s,Qt))return e.jsx("div",{className:"mt-3 rounded-2xl border bg-white shadow-sm p-4 text-slate-600",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold mb-2",children:"No Predictions Available"}),e.jsx("div",{className:"text-sm",children:"This league started from a later gameweek."}),e.jsxs("div",{className:"text-sm",children:["GW",s," predictions are not included in this league."]})]})});const l=new Map;lt.forEach(h=>{if(h.gw!==s)return;const A=Wt(h);A&&l.set(h.fixture_index,A)}),ye.forEach(h=>{if(h.gw!==s)return;const A=Ce[h.fixture_index];A&&(A.status==="IN_PLAY"||A.status==="PAUSED"||A.status==="FINISHED")&&(A.homeScore>A.awayScore?l.set(h.fixture_index,"H"):A.awayScore>A.homeScore?l.set(h.fixture_index,"A"):l.set(h.fixture_index,"D"))});const d=a.useMemo(()=>{const h=W=>{if(!W)return"Fixtures";const re=new Date(W);return isNaN(re.getTime())?"Fixtures":re.toLocaleDateString(void 0,{weekday:"short",day:"numeric",month:"short"})},A=new Map;ye.filter(W=>W.gw===s).forEach(W=>{const re=h(W.kickoff_time),J=W.kickoff_time?new Date(W.kickoff_time).getTime():Number.MAX_SAFE_INTEGER;A.has(re)||A.set(re,{label:re,key:J,items:[]}),A.get(re).items.push(W)});const D=Array.from(A.values());return D.forEach(W=>W.items.sort((re,J)=>re.fixture_index-J.fixture_index)),D.sort((W,re)=>W.key-re.key),D},[ye,s]),u=new Set(ye.filter(h=>h.gw===s).map(h=>h.fixture_index)),T=n?.name==="API Test",U=_.length>0&&_.every(h=>Ve.get(`${h.id}:${s}`)),E=new Map;(!T||U)&&ts.forEach(h=>{if(h.gw!==s||!Ve.get(`${h.user_id}:${s}`)||!u.has(h.fixture_index))return;const D=E.get(h.fixture_index)??[];D.push(h),E.set(h.fixture_index,D)});const te=i!==null&&i>=s;fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"League.tsx:2750",message:"resultsPublished calculated",data:{picksGw:s,latestResultsGw:i,resultsPublished:te},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H2"})}).catch(()=>{});const C=_.filter(h=>!Ve.get(`${h.id}:${s}`)).length,I=_.filter(h=>!Ve.get(`${h.id}:${s}`)).map(h=>h.name),q=r!==null&&(r==="DEADLINE_PASSED"||r==="LIVE"||r==="RESULTS_PRE_GW"),ne=T?!U:!U&&!q;return(T?!U:!U&&!q)?e.jsx(ys,{members:_,submittedMap:Ve,picksGw:s,allSubmitted:U,remaining:C,fixtures:ye.filter(h=>h.gw===s),variant:"compact"}):e.jsxs("div",{className:"mt-2 pt-2",children:[ne?e.jsx(ys,{members:_,submittedMap:Ve,picksGw:s,allSubmitted:U,remaining:C,fixtures:ye.filter(h=>h.gw===s),variant:"full"}):null,n?.name==="API Test"&&U&&d.length>0&&!ne&&(()=>{const h=d.flatMap(le=>le.items),A=new Set(h.map(le=>le.fixture_index)),D={};Object.keys(Ce).forEach(le=>{const v=parseInt(le,10);A.has(v)&&(D[v]=Ce[v])});const W=h.some(le=>{const v=D[le.fixture_index];return v&&(v.status==="IN_PLAY"||v.status==="PAUSED")}),re=h.length>0&&h.every(le=>{const v=D[le.fixture_index];return v&&v.status==="FINISHED"}),J=W||re||h.some(le=>D[le.fixture_index]);let be=0;return o?.id&&h.forEach(le=>{const v=D[le.fixture_index],ae=v&&(v.status==="IN_PLAY"||v.status==="PAUSED"),pe=v&&v.status==="FINISHED";if(v&&(ae||pe)){const se=(E.get(le.fixture_index)??[]).find(Ee=>Ee.user_id===o.id);if(se){let Ee=!1;(se.pick==="H"&&v.homeScore>v.awayScore||se.pick==="A"&&v.awayScore>v.homeScore||se.pick==="D"&&v.homeScore===v.awayScore)&&(Ee=!0),Ee&&be++}}}),e.jsx("div",{className:"mt-3 space-y-6",children:d.map((le,v)=>e.jsx(vs,{label:le.label,fixtures:le.items,picksByFixture:E,members:_,outcomes:l,liveScores:D,submittedMap:Ve,picksGw:s,isApiTestLeague:!0,isFirstSection:v===0,hasLiveGames:W,allGamesFinished:re,hasStarted:J,liveFixturesCount:be},v))})})(),d.length>0&&n?.name!=="API Test"&&(()=>{fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"League.tsx:2877",message:"Calculating allGamesFinished",data:{picksGw:s,resultsLength:lt.length,resultsGwValues:lt.map(J=>({gw:J.gw,fixture_index:J.fixture_index})),sectionsLength:d.length},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H1"})}).catch(()=>{});const h=lt.filter(J=>J.gw===s),A=new Set(h.map(J=>J.fixture_index));fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"League.tsx:2883",message:"fixturesWithResults calculated",data:{picksGw:s,filteredResultsLength:h.length,fixturesWithResultsArray:Array.from(A)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H1"})}).catch(()=>{});const D=d.flatMap(J=>J.items);fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"League.tsx:2888",message:"fixturesToCheck prepared",data:{picksGw:s,fixturesToCheckLength:D.length,fixtureIndices:D.map(J=>J.fixture_index)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H4"})}).catch(()=>{});const W=D.map(J=>{const be=A.has(J.fixture_index),le=Ce[J.fixture_index],v=le?.status,ae=be||le&&le.status==="FINISHED";return{fixture_index:J.fixture_index,hasDbResult:be,liveScoreStatus:v,isFinished:ae}}),re=D.length>0&&D.every(J=>{if(A.has(J.fixture_index))return!0;const be=Ce[J.fixture_index];return be&&be.status==="FINISHED"});return fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"League.tsx:2910",message:"allGamesFinished calculated",data:{picksGw:s,allGamesFinished:re,fixturesToCheckLength:D.length,fixtureStatusChecks:W,resultsPublished:te,allSubmitted:U},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H1"})}).catch(()=>{}),e.jsx("div",{className:"mt-3 space-y-6",children:d.map((J,be)=>e.jsx(vs,{label:J.label,fixtures:J.items,picksByFixture:E,members:_,outcomes:l,liveScores:Ce,submittedMap:Ve,picksGw:s,isApiTestLeague:!1,isFirstSection:be===0,allSubmitted:U,resultsPublished:te,allGamesFinished:re,deadlinePassed:q,whoDidntSubmit:I},be))})})(),!d.length&&!ne&&e.jsxs("div",{className:"mt-3 rounded-2xl border bg-white shadow-sm p-4 text-slate-500",children:["No fixtures for GW ",s,"."]})]})}function Zs(){const{state:s}=tt(j),r=a.useMemo(()=>n?.name==="API Test"?Ae??1:y==="gwr"?ke.current&&x||!j?x:s==="LIVE"||s==="RESULTS_PRE_GW"?j:i&&i<j?i:j>1?j-1:j:x,[n?.name,Ae,y,x,j,s,i]);tt(r);const l=r;if(_.length===1)return e.jsx(Dt,{});if(!l||p.length===0&&n?.name!=="API Test")return e.jsx("div",{className:"mt-3 rounded-2xl border bg-white shadow-sm p-4 text-slate-600",children:"No gameweek selected."});if(!ps(n,l,Qt))return e.jsx("div",{className:"mt-3 rounded-2xl border bg-white shadow-sm p-4 text-slate-600",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold mb-2",children:"No Results Available"}),e.jsx("div",{className:"text-sm",children:"This league started from a later gameweek."}),e.jsxs("div",{className:"text-sm",children:["GW",l," results are not included in this league."]})]})});const d=new Map,u=n?.name==="API Test",T=ye.filter(N=>N.gw===l),U=T.some(N=>{const h=Ce[N.fixture_index];return h&&(h.status==="IN_PLAY"||h.status==="PAUSED"||h.status==="FINISHED")});u&&l===(Ae??1)?T.forEach(N=>{const h=Ce[N.fixture_index];h&&(h.status==="IN_PLAY"||h.status==="PAUSED"||h.status==="FINISHED")&&(h.homeScore>h.awayScore?d.set(N.fixture_index,"H"):h.awayScore>h.homeScore?d.set(N.fixture_index,"A"):d.set(N.fixture_index,"D"))}):U&&l===j?T.forEach(N=>{const h=Ce[N.fixture_index];h&&(h.status==="IN_PLAY"||h.status==="PAUSED"||h.status==="FINISHED")&&(h.homeScore>h.awayScore?d.set(N.fixture_index,"H"):h.awayScore>h.homeScore?d.set(N.fixture_index,"A"):d.set(N.fixture_index,"D"))}):lt.forEach(N=>{if(N.gw!==l)return;const h=Wt(N);h&&d.set(N.fixture_index,h)});const E=_.map(N=>({user_id:N.id,name:N.name,score:0,unicorns:0})),te=new Map;ts.forEach(N=>{if(N.gw!==l)return;const h=te.get(N.fixture_index)??[];h.push(N),te.set(N.fixture_index,h)}),Array.from(d.entries()).forEach(([N,h])=>{const D=(te.get(N)??[]).filter(W=>W.pick===h).map(W=>W.user_id);if(D.forEach(W=>{const re=E.find(J=>J.user_id===W);re.score+=1}),D.length===1&&_.length>=3){const W=E.find(re=>re.user_id===D[0]);W.unicorns+=1}}),E.sort((N,h)=>h.score-N.score||h.unicorns-N.unicorns||N.name.localeCompare(h.name)),a.useEffect(()=>{if(E.length===0)return;const N=new Map;E.forEach((A,D)=>{N.set(A.user_id,D)});const h=new Set;if(N.forEach((A,D)=>{const W=H.current.get(D);W!==void 0&&W!==A&&h.add(D)}),H.current=N,h.size>0){ce(h);const A=setTimeout(()=>{ce(new Set)},2e3);return()=>clearTimeout(A)}},[E.map(N=>`${N.user_id}-${N.score}-${N.unicorns}`).join(",")]);let C=!1,I=!1,q=!1,ne=!1;if(u&&l===(Ae??1)){const N=ye;if(N.length>0&&(C=N.every(A=>{const D=Ce[A.fixture_index];return D&&D.status==="FINISHED"}),I=!!N.find(A=>{const D=Ce[A.fixture_index];return D&&(D.status==="IN_PLAY"||D.status==="PAUSED")}),ne=N.some(A=>{const D=Ce[A.fixture_index];return D&&(D.status==="IN_PLAY"||D.status==="PAUSED"||D.status==="FINISHED")}),!C)){const A=new Date;q=N.some(D=>{if(!D.kickoff_time)return!1;const re=new Date(D.kickoff_time).getTime()-A.getTime(),J=Ce[D.fixture_index];return(!J||J.status!=="IN_PLAY"&&J.status!=="PAUSED"&&J.status!=="FINISHED")&&re>0&&re<=1440*60*1e3})}}else{const N=ye.filter(h=>h.gw===l);if(N.length>0){const h=N.every(D=>d.has(D.fixture_index)),A=N.some(D=>{const W=Ce[D.fixture_index];return W&&(W.status==="IN_PLAY"||W.status==="PAUSED")});C=h&&!A}}return e.jsxs("div",{children:[e.jsx("style",{children:`
          @keyframes flash {
            0%, 100% {
              background-color: rgb(209, 250, 229);
            }
            25% {
              background-color: rgb(167, 243, 208);
            }
            50% {
              background-color: rgb(209, 250, 229);
            }
            75% {
              background-color: rgb(167, 243, 208);
            }
          }
          @keyframes pulse-score {
            0%, 100% {
              opacity: 1;
            }
            50% {
              opacity: 0.7;
            }
          }
          @keyframes position-change {
            0% {
              background-color: rgb(254, 243, 199);
            }
            50% {
              background-color: rgb(253, 230, 138);
            }
            100% {
              background-color: transparent;
            }
          }
          .flash-user-row {
            animation: flash 1.5s ease-in-out 3;
          }
          .pulse-live-score {
            animation: pulse-score 2s ease-in-out infinite;
          }
          .position-changed {
            animation: position-change 1.5s ease-out;
          }
          .full-width-header-border::after {
            content: '';
            position: absolute;
            left: -1rem;
            right: -1rem;
            bottom: 0;
            height: 1px;
            background-color: #cbd5e1;
            z-index: 1;
          }
        `}),E.length>0&&C&&e.jsx(Sa,{winnerName:E[0].name,isDraw:E[0].score===E[1]?.score&&E[0].unicorns===E[1]?.unicorns}),e.jsx(Ra,{rows:E,members:_,currentUserId:o?.id,positionChangeKeys:ue,isApiTestLeague:u,hasLiveFixtures:I,hasStartingSoonFixtures:q,hasStartedFixtures:ne,allFixturesFinished:C,resGw:l}),p.length>1&&e.jsx("div",{className:"mt-6 mb-4 flex flex-col items-center gap-3 px-4",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 w-full max-w-sm",children:[e.jsx(La,{availableGws:p,selectedGw:l,onChange:N=>{ke.current=!0,R(N)}}),e.jsxs("button",{onClick:()=>ut(!0),className:"flex items-center justify-center gap-1.5 bg-white border-2 border-slate-300 rounded-full text-slate-600 cursor-help flex-shrink-0 px-3 py-2",children:[e.jsx("img",{src:"/assets/Icons/School--Streamline-Outlined-Material-Pr0_White.png",alt:"Rules",className:"w-4 h-4",style:{filter:"invert(40%) sepia(8%) saturate(750%) hue-rotate(180deg) brightness(95%) contrast(88%)"}}),e.jsx("span",{className:"text-sm font-medium",children:"Rules"})]})]})}),e.jsx(hs,{isOpen:vt,onClose:()=>ut(!1),title:"Weekly Winner",description:`ðŸ† How to Win the Week

The player with the most correct predictions wins.

ðŸ¦„ Unicorns

In Mini-Leagues with 3 or more players, if you're the only person to correctly predict a fixture, that's a Unicorn. In ties, the player with most Unicorns wins!`})]})}return Y?e.jsx("div",{className:"max-w-5xl mx-auto px-4 py-10",children:e.jsx("div",{className:"text-slate-500",children:"Loadingâ€¦"})}):!n&&!Y?e.jsx("div",{className:"max-w-3xl mx-auto px-4 py-10",children:e.jsxs("div",{className:"rounded border bg-white p-6",children:[e.jsx("div",{className:"font-semibold mb-2",children:"League not found"}),e.jsx(ms,{to:"/leagues",className:"text-slate-600 underline",children:"Back to Mini Leagues"})]})}):n?e.jsxs("div",{className:`${S?"oldschool-theme":"bg-slate-50"}`,style:{position:"fixed",top:0,left:0,right:0,bottom:0,height:"100vh",maxHeight:"100vh",overflow:"hidden",touchAction:"none"},children:[e.jsx("style",{children:`
        /* Prevent body/html scrolling that could affect fixed header */
        body.league-page-active {
          overflow: hidden !important;
          position: fixed !important;
          width: 100% !important;
          height: 100% !important;
        }
        html.league-page-active {
          overflow: hidden !important;
        }
        .league-header-fixed {
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          z-index: 50 !important;
          transform: translate3d(0, 0, 0) !important;
          -webkit-transform: translate3d(0, 0, 0) !important;
          will-change: transform !important;
          contain: layout style paint !important;
          touch-action: none !important;
          user-select: none !important;
          -webkit-user-select: none !important;
          pointer-events: auto !important;
          -webkit-overflow-scrolling: auto !important;
          overflow: visible !important;
        }
        .league-header-fixed a,
        .league-header-fixed button {
          touch-action: manipulation !important;
          user-select: none !important;
          -webkit-user-select: none !important;
        }
        .league-header-fixed .relative {
          position: relative !important;
          z-index: 100 !important;
        }
        @supports (height: 100dvh) {
          .league-header-fixed {
            top: env(safe-area-inset-top, 0px) !important;
          }
        }
        .league-content-wrapper {
          position: fixed;
          top: calc(3.5rem + 3rem + env(safe-area-inset-top, 0px) + 0.5rem);
          left: 0;
          right: 0;
          bottom: 0;
          overflow-y: auto;
          overflow-x: hidden;
          -webkit-overflow-scrolling: touch;
          overscroll-behavior: none;
          overscroll-behavior-y: none;
          overscroll-behavior-x: none;
          touch-action: pan-y;
          padding-bottom: 2rem;
          padding-left: 1rem;
          padding-right: 1rem;
          transition: top 0.3s ease-in-out;
        }
        .league-content-wrapper.has-banner {
          top: calc(3.5rem + 3rem + 3.5rem + env(safe-area-inset-top, 0px) + 0.5rem);
        }
        .league-content-wrapper.menu-open {
          top: calc(3.5rem + 3rem + 12rem + env(safe-area-inset-top, 0px) + 0.5rem);
        }
        .league-content-wrapper.menu-open.has-banner {
          top: calc(3.5rem + 3rem + 3.5rem + 12rem + env(safe-area-inset-top, 0px) + 0.5rem);
        }
        @media (max-width: 768px) {
          .league-content-wrapper {
            top: calc(3.5rem + 3rem + env(safe-area-inset-top, 0px) + 0.5rem);
            padding-bottom: 2rem;
            padding-left: 1rem;
            padding-right: 1rem;
          }
          .league-content-wrapper.has-banner {
            top: calc(3.5rem + 3rem + 3.5rem + env(safe-area-inset-top, 0px) + 0.5rem);
          }
          .league-content-wrapper.menu-open {
            top: calc(3.5rem + 3rem + 12rem + env(safe-area-inset-top, 0px) + 0.5rem);
          }
          .league-content-wrapper.menu-open.has-banner {
            top: calc(3.5rem + 3rem + 3.5rem + 12rem + env(safe-area-inset-top, 0px) + 0.5rem);
          }
        }
        /* Chat tab - full height layout */
        .chat-tab-wrapper {
          position: fixed;
          top: calc(3.5rem + 3rem + env(safe-area-inset-top, 0px));
          left: 0;
          right: 0;
          bottom: 0;
          height: calc(100vh - 3.5rem - 3rem - env(safe-area-inset-top, 0px));
          max-height: calc(100vh - 3.5rem - 3rem - env(safe-area-inset-top, 0px));
          z-index: 10;
          overflow: visible;
          overflow-x: hidden;
          pointer-events: none;
          width: 100%;
          max-width: 100%;
        }
        .chat-tab-wrapper::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-image: url(/assets/Volley/volley-chat-backgroud.png);
          background-repeat: repeat;
          background-size: 110%;
          background-position: top left;
          background-attachment: local;
          opacity: 0.1;
          pointer-events: none;
          z-index: 0;
        }
        .chat-tab-wrapper.has-banner {
          top: calc(3.5rem + 3rem + 3.5rem + env(safe-area-inset-top, 0px));
          height: calc(100vh - 3.5rem - 3rem - 3.5rem - env(safe-area-inset-top, 0px));
          max-height: calc(100vh - 3.5rem - 3rem - 3.5rem - env(safe-area-inset-top, 0px));
        }
        .chat-tab-wrapper > * {
          pointer-events: auto;
        }
        @supports (height: 100dvh) {
          .chat-tab-wrapper {
            height: calc(100dvh - 3.5rem - 3rem - env(safe-area-inset-top, 0px));
            max-height: calc(100dvh - 3.5rem - 3rem - env(safe-area-inset-top, 0px));
          }
          .chat-tab-wrapper.has-banner {
            height: calc(100dvh - 3.5rem - 3rem - 3.5rem - env(safe-area-inset-top, 0px));
            max-height: calc(100dvh - 3.5rem - 3rem - 3.5rem - env(safe-area-inset-top, 0px));
          }
        }
      `}),e.jsx("div",{ref:me,className:"league-header-fixed bg-white border-b border-slate-200 shadow-sm",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4",children:[e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsx(ms,{to:"/leagues",className:"flex items-center text-slate-600 -ml-2 px-2 py-1",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0 px-2",children:[e.jsx("button",{type:"button",onClick:()=>{V(!0)},className:"w-12 h-12 rounded-full overflow-hidden bg-slate-100 border border-slate-200 flex-shrink-0 relative cursor-pointer",children:n?e.jsx("img",{src:Ft(n),alt:"League badge",className:"absolute inset-0 w-full h-full object-cover",loading:"eager",decoding:"async",onError:s=>{const r=s.target,d=`/assets/league-avatars/${fs(n.id)}`;r.src!==d&&(r.src=d)}}):e.jsx("div",{className:"w-full h-full bg-slate-200"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-lg font-semibold text-slate-900 truncate",children:n.name}),x&&e.jsxs("p",{className:"text-sm text-slate-500 truncate",children:["Gameweek ",x]})]})]}),e.jsx("div",{className:"relative",style:{zIndex:100},children:e.jsx("button",{onClick:()=>et(!xt),className:"flex items-center justify-center w-8 h-8 rounded-full -mr-2","aria-label":"Menu",children:e.jsx("svg",{className:"w-5 h-5 text-slate-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})})})})]}),e.jsx("div",{className:`bg-white border-b border-slate-200 transition-all duration-300 ease-in-out overflow-hidden ${xt?"max-h-96 opacity-100":"max-h-0 opacity-0"}`,children:e.jsxs("div",{className:"px-4 py-3",children:[Xt&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3 pb-3 border-b border-slate-200 px-0",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Admin"}),e.jsx("div",{className:"text-sm font-semibold text-slate-800",children:Ms})]}),e.jsx("div",{className:"space-y-1",children:e.jsxs("button",{onClick:()=>{fe(!0),et(!1)},className:"w-full text-left px-0 py-2.5 text-base font-semibold text-slate-700 active:bg-slate-100 rounded-lg flex items-center gap-2 touch-manipulation",children:[e.jsxs("svg",{className:"w-5 h-5 text-slate-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]}),e.jsx("span",{children:"Manage"})]})}),e.jsx("div",{className:"my-3 border-b border-slate-200"})]}),e.jsxs("div",{className:"space-y-1",children:[We&&e.jsxs("button",{onClick:()=>{Oe(!0),et(!1)},className:"w-full text-left px-0 py-2.5 text-base font-semibold text-slate-700 active:bg-slate-100 rounded-lg flex items-center gap-2 touch-manipulation",children:[e.jsx("svg",{className:"w-5 h-5 text-slate-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("span",{children:"Edit League Badge"})]}),e.jsxs("button",{onClick:async()=>{et(!1),await os()},className:"w-full text-left px-0 py-2.5 text-base font-semibold text-slate-700 active:bg-slate-100 rounded-lg flex items-center gap-2 touch-manipulation",children:[e.jsx("svg",{className:"w-5 h-5 text-slate-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),e.jsx("span",{children:"Invite players"})]}),e.jsxs("button",{onClick:()=>{Rs(),et(!1)},className:"w-full text-left px-0 py-2.5 text-base font-semibold text-slate-700 active:bg-slate-100 rounded-lg flex items-center gap-2 touch-manipulation",children:[e.jsx("svg",{className:"w-5 h-5 text-slate-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})}),e.jsx("span",{children:"Share league code"})]}),e.jsxs("button",{onClick:()=>{je(!0),et(!1)},className:"w-full text-left px-0 py-2.5 text-base font-semibold text-red-600 active:bg-red-100 rounded-lg flex items-center gap-2 touch-manipulation",children:[e.jsx("svg",{className:"w-5 h-5 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})}),e.jsx("span",{children:"Leave"})]})]})]})}),e.jsxs("div",{className:`flex border-b border-slate-200 bg-white gap-2 transition-all duration-300 ease-in-out ${xt?"max-h-0 opacity-0 overflow-hidden":"max-h-20 opacity-100"}`,children:[e.jsxs("button",{onClick:()=>{de.current=!0,Z("chat")},className:"flex-1 min-w-0 px-2 sm:px-4 py-3 text-xs font-semibold relative leading-tight "+(y==="chat"?"text-[#1C8376]":"text-slate-400"),children:[e.jsx("span",{className:"hidden sm:inline",children:"Chat"}),e.jsx("span",{className:"sm:hidden whitespace-pre-line text-center",children:"Chat"}),y==="chat"&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-[#1C8376]"})]}),(p.length>0||n?.name==="API Test")&&e.jsxs("button",{onClick:()=>{de.current=!0,Z("gwr")},className:"flex-1 min-w-0 px-2 sm:px-4 py-3 text-xs font-semibold relative leading-tight flex items-center justify-center gap-1.5 "+(y==="gwr"?"text-[#1C8376]":"text-slate-400"),children:[(()=>{const s=It!=null&&Gs==="LIVE";return e.jsxs(e.Fragment,{children:[s&&e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse flex-shrink-0"}),e.jsx("span",{className:"whitespace-nowrap",children:"GW Table"})]})})(),y==="gwr"&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-[#1C8376]"})]}),(j||n?.name==="API Test")&&e.jsxs("button",{onClick:()=>{de.current=!0,Z("gw")},className:"flex-1 min-w-0 px-2 sm:px-4 py-3 text-xs font-semibold relative leading-tight "+(y==="gw"?"text-[#1C8376]":"text-slate-400"),children:[e.jsx("span",{className:"hidden sm:inline",children:"Predictions"}),e.jsx("span",{className:"sm:hidden whitespace-pre-line",children:"Predictions"}),y==="gw"&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-[#1C8376]"})]}),e.jsxs("button",{onClick:()=>{console.log("[League] GW Table tab clicked, setting tab to mlt"),de.current=!0,Z("mlt"),console.log("[League] Tab set to mlt, mltRows.length:",Se.length)},className:"flex-1 min-w-0 px-2 sm:px-4 py-3 text-xs font-semibold relative leading-tight "+(y==="mlt"?"text-[#1C8376]":"text-slate-400"),children:["Season",y==="mlt"&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-[#1C8376]"})]})]})]})}),y==="chat"?e.jsx("div",{className:"chat-tab-wrapper",children:e.jsx(Ca,{miniLeagueId:n?.id??null,memberNames:Ts,deepLinkError:he})}):e.jsx("div",{className:`league-content-wrapper ${xt?"menu-open":""}`,children:e.jsxs("div",{className:"px-1 sm:px-2",children:[y==="mlt"&&(()=>{const s=performance.now();console.log("[League] Rendering MltTab, tab is mlt",{tab:y,mltRowsLength:Se.length,leagueId:n?.id,timestamp:s});const r=e.jsx(Ys,{}),l=performance.now();return console.log("[League] MltTab JSX created",{duration:l-s}),r})(),y==="gw"&&e.jsx(Xs,{}),y==="gwr"&&e.jsx(Zs,{})]})}),Xt&&xe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:()=>fe(!1),children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 relative",onClick:s=>s.stopPropagation(),children:[e.jsx("button",{onClick:()=>fe(!1),className:"absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsxs("div",{className:"p-6 pt-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-slate-900 mb-6",children:"League Management"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm text-slate-600 mb-3 font-semibold",children:"Remove Members:"}),e.jsxs("div",{className:"space-y-2",children:[_.filter(s=>s.id!==o?.id).map(s=>e.jsxs("div",{className:"flex items-center justify-between py-3 px-4 bg-slate-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-slate-800",children:s.name}),e.jsx("button",{onClick:()=>{Vt(s),Nt(!0),fe(!1)},className:"px-3 py-1.5 text-xs bg-red-100 text-red-700 rounded-md font-semibold",children:"Remove"})]},s.id)),_.filter(s=>s.id!==o?.id).length===0&&e.jsx("div",{className:"text-sm text-slate-500 italic py-4 text-center",children:"No other members to remove"})]})]}),e.jsx("div",{className:"pt-4 border-t border-slate-200",children:e.jsx("button",{onClick:()=>{Ct(!0),fe(!1)},className:"w-full px-4 py-3 text-sm bg-red-600 text-white rounded-lg font-semibold flex items-center justify-center gap-2",children:"ðŸ—‘ï¸ End League"})})]})]})]})}),We&&Ge&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:()=>{Oe(!1),Fe&&URL.revokeObjectURL(Fe),Ze(null),Pe(null),Ke(!1),at(null)},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 relative",onClick:s=>s.stopPropagation(),children:[e.jsx("button",{onClick:()=>{Oe(!1),Fe&&URL.revokeObjectURL(Fe),Ze(null),Pe(null),Ke(!1),at(null)},className:"absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 z-10",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsxs("div",{className:"p-4 pt-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-slate-900 mb-1",children:"League Badge"}),e.jsx("p",{className:"text-xs text-slate-600 mb-4",children:"Upload and customize your mini-league badge"}),qe?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-xs text-slate-600",children:[e.jsx("p",{className:"font-medium",children:"Position your image"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Drag to position, use slider to zoom"})]}),e.jsx("div",{className:"relative w-full",style:{height:"280px"},children:e.jsx(ca,{image:qe,crop:Ns,zoom:jt,aspect:1,cropShape:"round",showGrid:!1,onCropChange:qt,onZoomChange:_t,onCropComplete:Fs,style:{containerStyle:{width:"100%",height:"100%",position:"relative"}}})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("label",{className:"block text-xs font-medium text-slate-700",children:["Zoom: ",Math.round(jt*100),"%"]}),e.jsx("input",{type:"range",min:1,max:3,step:.1,value:jt,onChange:s=>_t(Number(s.target.value)),className:"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-[#1C8376] touch-manipulation",style:{WebkitTapHighlightColor:"transparent"}})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700",children:"Preview:"}),e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-slate-100 border-2 border-slate-300 flex items-center justify-center flex-shrink-0",children:Fe?e.jsx("img",{src:Fe,alt:"Preview",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-slate-200"})})]})]}),ft&&e.jsx("div",{className:"p-2 bg-red-50 border border-red-200 rounded-lg text-xs text-red-800",children:ft}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx("button",{onClick:()=>{Fe&&URL.revokeObjectURL(Fe),Ze(null),qt({x:0,y:0}),_t(1),Jt(null),at(null)},disabled:$e,className:"flex-1 px-4 py-3 bg-slate-100 text-slate-700 rounded-lg active:bg-slate-200 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation min-h-[44px]",children:"Cancel"}),e.jsx("button",{onClick:Hs,disabled:$e||!ht,className:"flex-1 px-4 py-3 bg-[#1C8376] text-white rounded-lg active:bg-emerald-700 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation min-h-[44px]",children:$e?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-white"}),"Uploading..."]}):"Upload Badge"})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs text-slate-600 mb-2 font-medium",children:"Current Badge:"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-16 h-16 rounded-full overflow-hidden bg-slate-100 flex items-center justify-center border-2 border-slate-200",children:e.jsx("img",{src:n?Ft(n):"/assets/league-avatars/ML-avatar-1.png",alt:"League badge",className:"w-full h-full object-cover",onError:s=>{const r=s.target;r.src="/assets/league-avatars/ML-avatar-1.png"}})}),n?.avatar&&e.jsx("button",{onClick:Bs,disabled:$e,className:"px-4 py-2 text-xs bg-red-100 text-red-700 active:bg-red-200 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation min-h-[36px]",children:"Remove"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-700 mb-2",children:"Choose Image"}),e.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/jpg,image/webp",onChange:s=>{const r=s.target.files?.[0];r&&$s(r)},disabled:$e,className:"hidden",id:"badge-upload-input"}),e.jsx("label",{htmlFor:"badge-upload-input",className:"block w-full border-2 border-dashed border-slate-300 rounded-lg p-6 text-center active:bg-slate-50 active:border-[#1C8376] touch-manipulation",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("svg",{className:"w-10 h-10 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("div",{className:"text-sm",children:e.jsx("span",{className:"text-[#1C8376] font-semibold",children:"Tap to choose image"})}),e.jsx("p",{className:"text-xs text-slate-500",children:"PNG, JPG, or WebP (up to 20MB - will be optimized automatically)"})]})})]}),$e&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-[#1C8376]"}),e.jsx("span",{children:"Processing and uploading..."})]}),ks&&e.jsx("div",{className:"p-2 bg-emerald-50 border border-emerald-200 rounded-lg text-xs text-emerald-800",children:"âœ“ Badge uploaded successfully!"}),ft&&e.jsx("div",{className:"p-2 bg-red-50 border border-red-200 rounded-lg text-xs text-red-800",children:ft})]})]})]})]})}),e.jsx(hs,{isOpen:Ot,onClose:()=>Xe(!1),title:"League Points",description:`Win the week â€“ 3 points
Draw â€“ 1 point
Lose â€“ 0 points

ðŸ¤ Ties

If two or more players are tied on Points in the table, the player with the most overall Unicorns in the mini league is ranked higher.${n&&(["The Bird league"].includes(n.name)||["gregVjofVcarl","Let Down"].includes(n.name))?`

Note: This mini league started after GW1, so the "CP" column shows correct predictions since this mini league began.`:""}`}),e.jsx(Ks,{}),e.jsx(Vs,{}),He&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Leave League"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:['Are you sure you want to leave "',n?.name,`"? You'll need the league code to rejoin later.`]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>je(!1),className:"flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-md",disabled:Be,children:"Cancel"}),e.jsx("button",{onClick:Is,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-md disabled:opacity-50",disabled:Be,children:Be?"Leaving...":"Leave League"})]})]})}),Cs&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Join Mini League"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["You are about to join ",e.jsxs("strong",{children:['"',n?.name,'"']}),". Are you sure?"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>it(!1),className:"flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-md",disabled:kt,children:"Cancel"}),e.jsx("button",{onClick:As,className:"flex-1 px-4 py-2 bg-[#1C8376] text-white rounded-md disabled:opacity-50",disabled:kt,children:kt?"Joining...":"Join League"})]})]})}),Ss&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Remove Member"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Are you sure you want to remove ",e.jsxs("strong",{children:['"',bt?.name,'"']})," from the league? They will need the league code to rejoin."]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>Nt(!1),className:"flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-md",disabled:St,children:"Cancel"}),e.jsx("button",{onClick:Ds,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-md disabled:opacity-50",disabled:St,children:St?"Removing...":"Remove Member"})]})]})}),Ls&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-red-600 mb-2",children:"âš ï¸ End League"}),e.jsxs("p",{className:"text-slate-600 mb-4",children:["Are you absolutely sure you want to ",e.jsx("strong",{children:"permanently end"})," the league ",e.jsxs("strong",{children:['"',n?.name,'"']}),"?"]}),e.jsx("p",{className:"text-sm text-red-600 mb-6",children:"This will remove all members and delete the league forever. This action cannot be undone!"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>Ct(!1),className:"flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-md",disabled:Lt,children:"Cancel"}),e.jsx("button",{onClick:Ps,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-md disabled:opacity-50",disabled:Lt,children:Lt?"Ending...":"Yes, End League"})]})]})}),n?.name==="API Test"&&e.jsx("div",{className:"mt-6 mb-4 px-4 py-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"âš ï¸ Test League:"})," This league uses test API data and starts from Test GW 1 with zero points. It does not affect your main game scores."]})}),$&&n&&e.jsx("div",{className:"fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center",onClick:()=>V(!1),children:e.jsxs("div",{className:"flex flex-col items-center gap-4 relative",onClick:s=>s.stopPropagation(),children:[e.jsx("div",{className:"w-80 h-80 rounded-full overflow-hidden bg-white shadow-2xl relative",children:e.jsx("img",{src:Ft(n),alt:"League badge",className:"w-full h-full object-cover",onError:s=>{const r=s.target,d=`/assets/league-avatars/${fs(n.id)}`;r.src!==d&&(r.src=d)}})}),We&&e.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),V(!1),Oe(!0)},className:"absolute bottom-[272px] right-1/2 translate-x-[144px] w-16 h-16 rounded-full bg-white shadow-2xl flex items-center justify-center z-20 border-4 border-slate-400",title:"Edit League Badge",children:e.jsx("svg",{className:"w-8 h-8 text-slate-900",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})}),e.jsx("div",{className:"text-white text-xl font-medium",children:n.name})]})})]}):null}export{Wa as default};
