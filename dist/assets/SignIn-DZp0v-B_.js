import{r,d as B,j as e,s as n}from"./index-ByaaQl1E.js";function A(){const[t,o]=r.useState("signup"),[h,S]=r.useState(""),[d,P]=r.useState(""),[g,k]=r.useState(""),[p,C]=r.useState(""),[f,E]=r.useState(""),[x,l]=r.useState(null),[w,m]=r.useState(!1),[R,y]=r.useState(!1),[U,b]=r.useState(!1),[F,q]=r.useState(!1),j=B();r.useEffect(()=>{(async()=>{console.log("SignIn page loaded, checking for password reset..."),console.log("Current URL:",window.location.href),console.log("Search params:",window.location.search),console.log("Hash:",window.location.hash);const a=new URLSearchParams(window.location.search),u=new URLSearchParams(window.location.hash.substring(1)),c=a.get("type")==="recovery"||u.get("type")==="recovery"||window.location.search.includes("type=recovery")||window.location.hash.includes("type=recovery");if(console.log("Is recovery detected:",c),c){console.log("Setting password reset mode"),o("password-reset");return}const{data:{session:i}}=await n.auth.getSession();if(console.log("Session:",i),i?.user){if(window.location.hash.includes("type=recovery")||window.location.search.includes("type=recovery")){console.log("Session-based recovery detected"),o("password-reset");return}if(i.user.app_metadata?.provider==="email"&&(i.user.app_metadata?.providers?.includes("email")||window.location.href.includes("recovery")||window.location.href.includes("reset"))){console.log("Password reset session detected"),o("password-reset");return}}})()},[]);async function T(){if(p!==f){l("Passwords do not match");return}if(p.length<6){l("Password must be at least 6 characters");return}l(null),m(!0);try{const{error:s}=await n.auth.updateUser({password:p});if(s)throw s;q(!0),setTimeout(()=>{j("/")},2e3)}catch(s){l(s.message||"Failed to update password")}finally{m(!1)}}async function v(s,a){s&&(a&&a.trim()?await n.from("users").upsert({id:s,name:a.trim()}):await n.from("users").upsert({id:s}))}async function D(){if(!d.trim()){l("Please enter your email address");return}l(null),m(!0);try{const{error:s}=await n.auth.resetPasswordForEmail(d.trim(),{redirectTo:`${window.location.origin}/auth`});if(s)throw s;b(!0)}catch(s){l(s?.message||"Failed to send reset email")}finally{m(!1)}}async function _(s){s.preventDefault(),l(null),m(!0);try{if(t==="signup"){const{data:a,error:u}=await n.from("users").select("name").eq("name",h.trim()).limit(1);if(u)throw u;if(a&&a.length>0)throw new Error("Username already taken. Please choose a different name.");const{data:c,error:i}=await n.auth.signUp({email:d.trim(),password:g,options:{data:{display_name:h.trim()},emailRedirectTo:window.location.origin}});if(i)throw i;const N=c.user??(await n.auth.getUser()).data.user;N&&await v(N.id,h),y(!0)}else{const{data:a,error:u}=await n.auth.signInWithPassword({email:d.trim(),password:g});if(u)throw u;const c=a.user??(await n.auth.getUser()).data.user;if(c){const i=c.user_metadata?.display_name;await v(c.id,i)}j("/",{replace:!0})}}catch(a){l(a?.message||"Something went wrong")}finally{m(!1)}}return R?e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold text-center",children:"Check Your Email"}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("p",{className:"text-slate-600",children:["We've sent you a confirmation link at ",e.jsx("strong",{children:d})]}),e.jsx("p",{className:"text-sm text-slate-500",children:"Click the link in your email to activate your account and start playing TOTL!"}),e.jsx("button",{onClick:()=>y(!1),className:"mt-4 px-4 py-2 text-sm text-emerald-600 hover:text-emerald-700 underline",children:"Back to signup"})]})]})}):U?e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold text-center",children:"Check Your Email"}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("p",{className:"text-slate-600",children:["We've sent a password reset link to ",e.jsx("strong",{children:d})]}),e.jsx("p",{className:"text-sm text-slate-500",children:"Click the link in your email to reset your password."}),e.jsx("button",{onClick:()=>{b(!1),o("signin")},className:"mt-4 px-4 py-2 text-sm text-emerald-600 hover:text-emerald-700 underline",children:"Back to sign in"})]})]})}):F?e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold text-center text-green-600",children:"Password Updated!"}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-slate-600",children:"Your password has been successfully updated."}),e.jsx("p",{className:"text-sm text-slate-500",children:"Redirecting to home page..."})]})]})}):t==="password-reset"?e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("form",{onSubmit:s=>{s.preventDefault(),T()},className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Set New Password"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"New Password"}),e.jsx("input",{type:"password",className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:p,onChange:s=>C(s.target.value),placeholder:"At least 6 characters",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Confirm Password"}),e.jsx("input",{type:"password",className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:f,onChange:s=>E(s.target.value),placeholder:"Confirm your new password",required:!0})]}),x&&e.jsx("div",{className:"text-sm text-red-600",children:x}),e.jsx("button",{type:"submit",disabled:w,className:"w-full rounded-xl px-4 py-2 font-semibold bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",children:w?"Updating...":"Update Password"})]})}):e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("form",{onSubmit:t==="reset"?s=>{s.preventDefault(),D()}:_,className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold",children:t==="signup"?"Create your account":t==="reset"?"Reset your password":"Sign in"}),t==="signup"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Display name"}),e.jsx("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:h,onChange:s=>S(s.target.value),placeholder:"e.g. Thomas B",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Email"}),e.jsx("input",{type:"email",className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:d,onChange:s=>P(s.target.value),placeholder:"you@example.com",required:!0})]}),t!=="reset"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Password"}),e.jsx("input",{type:"password",className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:g,onChange:s=>k(s.target.value),placeholder:"At least 6 characters",required:!0})]}),x&&e.jsx("div",{className:"text-sm text-red-600",children:x}),e.jsx("button",{type:"submit",disabled:w,className:"w-full rounded-xl px-4 py-2 font-semibold bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",children:w?t==="signup"?"Creating…":t==="reset"?"Sending…":"Signing in…":t==="signup"?"Create account":t==="reset"?"Send reset link":"Sign in"}),e.jsx("div",{className:"text-xs text-slate-500",children:t==="signup"?e.jsxs(e.Fragment,{children:["Already have an account?"," ",e.jsx("button",{type:"button",onClick:()=>o("signin"),className:"underline",children:"Sign in"})]}):t==="reset"?e.jsxs(e.Fragment,{children:["Remember your password?"," ",e.jsx("button",{type:"button",onClick:()=>o("signin"),className:"underline",children:"Sign in"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:["New here?"," ",e.jsx("button",{type:"button",onClick:()=>o("signup"),className:"underline",children:"Create an account"})]}),e.jsxs("div",{children:["Forgot your password?"," ",e.jsx("button",{type:"button",onClick:()=>o("reset"),className:"underline",children:"Reset it"})]})]})})]})})}export{A as default};
