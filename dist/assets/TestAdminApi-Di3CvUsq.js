import{u as J,r as m,s as h,j as e}from"./index-ByaaQl1E.js";const B=()=>{const f=typeof window<"u"?window.location.hostname:"",g=typeof window<"u"?window.location.origin:"";return f.includes("netlify.app")||f.includes("netlify.com")?`${g}/.netlify/functions/fetchFootballData`:f==="localhost"||f==="127.0.0.1"?"https://totl-staging.netlify.app/.netlify/functions/fetchFootballData":"/.netlify/functions/fetchFootballData"};function Y(){const{user:f}=J(),g=f?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||f?.id==="36f31625-6d6c-4aa4-815a-1493a812841b",[A,S]=m.useState([]),[u,w]=m.useState(new Map),[E,C]=m.useState(!1),[T,M]=m.useState(!1),[D,p]=m.useState(""),[F,b]=m.useState(""),[N,R]=m.useState("PL"),[_,o]=m.useState(null),[$,G]=m.useState(!1),[P,L]=m.useState(!1),W=async(t,r)=>{try{const s=new Date,a=new Date(s);a.setDate(s.getDate()+7);const n=s.toISOString().split("T")[0],i=a.toISOString().split("T")[0],d=new URLSearchParams({competition:t,dateFrom:n,dateTo:i}),v=`${B()}?${d.toString()}`;console.log("[TestAdminApi] Fetching upcoming matches from:",v),console.log("[TestAdminApi] Date range:",{dateFrom:n,dateTo:i});const c=await fetch(v,{signal:r}),k=c.headers.get("content-type"),q=k&&k.includes("application/json");let l=null,y=null;if(!c.ok)try{if(l=await c.text(),q||l.trim().startsWith("{")||l.trim().startsWith("["))try{y=JSON.parse(l);const x=y.message||y.error||`API error: ${c.status}`;return c.status===429?(o("Rate limit reached. Please wait a moment."),null):(o(x),null)}catch{}return console.error("[TestAdminApi] Got error response:",l.substring(0,200)),c.status===404?o("Netlify function not found. Make sure 'fetchFootballData' is deployed."):o(`Server error (${c.status}). The function may not be deployed correctly.`),null}catch{return o(`Failed to read error response: ${c.status}`),null}try{l=await c.text(),console.log("[TestAdminApi] Response status:",c.status),console.log("[TestAdminApi] Response content-type:",k),console.log("[TestAdminApi] Response preview:",l.substring(0,100));try{y=JSON.parse(l),console.log("[TestAdminApi] Successfully parsed JSON")}catch(x){return console.error("[TestAdminApi] Failed to parse JSON. Parse error:",x),console.error("[TestAdminApi] Response text:",l.substring(0,500)),l.trim().startsWith("<!")||l.trim().startsWith("<html")?o("Server returned an HTML error page. The function may not be deployed correctly. Check browser console for details."):l.trim().startsWith("{")||l.trim().startsWith("[")?o("Server returned malformed JSON. Check browser console for details."):o("Server returned invalid response (not JSON). Check browser console for details."),null}}catch(x){return console.error("[TestAdminApi] Failed to read response:",x),o("Failed to read response from server."),null}const j=y;return!j.success||!j.data?(o("Invalid API response format. Make sure the function is working correctly."),null):(o(null),j.data.matches||[])}catch(s){if(s instanceof Error&&s.name==="AbortError")return console.log("Fetch aborted"),null;console.error("Error fetching API matches:",s);let a="Failed to fetch matches";return s instanceof TypeError&&s.message.includes("fetch")?a="Network error. Check your connection and make sure the Netlify function is deployed.":s instanceof Error&&(a=s.message),o(a),null}};if(m.useEffect(()=>{if(!g)return;let t=!0;return(async()=>{try{const{error:r}=await h.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle();r&&r.code!=="PGRST116"&&!r.message?.includes("404")&&console.warn("Error loading test_api_meta:",r.message);const{data:s,error:a}=await h.from("test_api_fixtures").select("*").eq("test_gw",1).order("fixture_index",{ascending:!0});if(a)a.code!=="PGRST116"&&!a.message?.includes("404")&&console.warn("Error loading test_api_fixtures:",a.message);else if(t&&s&&s.length>0){const n=new Map;s.forEach(i=>{n.set(i.fixture_index,{...i,selected:!0})}),w(n)}}catch{}})(),()=>{t=!1}},[g]),!g)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:e.jsx("div",{className:"text-red-600",children:"Access denied. Admin only."})});const I=t=>{const r=new Map(u),s=Array.from(r.values()).find(a=>a.api_match_id===t.id);if(s){r.delete(s.fixture_index);const a=Array.from(r.values()).sort((i,d)=>i.fixture_index-d.fixture_index),n=new Map;a.forEach((i,d)=>{n.set(d,{...i,fixture_index:d})}),w(n)}else{const n=(r.size>0?Math.max(...Array.from(r.keys())):-1)+1,i={test_gw:1,fixture_index:n,api_match_id:t.id,home_team:t.homeTeam.shortName,away_team:t.awayTeam.shortName,home_code:t.homeTeam.tla,away_code:t.awayTeam.tla,home_name:t.homeTeam.name,away_name:t.awayTeam.name,home_crest:t.homeTeam.crest||null,away_crest:t.awayTeam.crest||null,kickoff_time:t.utcDate,selected:!0};r.set(n,i),w(r)}},U=async()=>{if(confirm("Clear all picks and submissions for Test GW 1? This will reset all users' predictions.")){L(!0),p(""),b("");try{await h.from("test_api_picks").delete().eq("matchday",1),await h.from("test_api_submissions").delete().eq("matchday",1),b("All picks and submissions cleared! Users can now make fresh predictions.")}catch(t){p(t.message??"Failed to clear picks.")}finally{L(!1)}}},z=async()=>{if(u.size===0){p("Please select at least one fixture");return}C(!0),p(""),b("");try{await h.from("test_api_fixtures").delete().eq("test_gw",1),await h.from("test_api_picks").delete().eq("matchday",1),await h.from("test_api_submissions").delete().eq("matchday",1);const t=Array.from(u.values()).map(s=>({test_gw:s.test_gw,fixture_index:s.fixture_index,api_match_id:s.api_match_id,home_team:s.home_team,away_team:s.away_team,home_code:s.home_code,away_code:s.away_code,home_name:s.home_name,away_name:s.away_name,home_crest:s.home_crest,away_crest:s.away_crest,kickoff_time:s.kickoff_time})),{error:r}=await h.from("test_api_fixtures").insert(t);if(r)throw r;await h.from("test_api_meta").upsert({id:1,current_test_gw:1},{onConflict:"id"}),b(`Test Gameweek 1 saved with ${u.size} fixtures! All picks and submissions have been reset.`)}catch(t){p(t.message??"Failed to save test gameweek.")}finally{C(!1)}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4",style:{pointerEvents:"auto"},children:e.jsxs("div",{className:"max-w-4xl mx-auto",style:{pointerEvents:"auto"},children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900 mb-2",children:"Test API Admin (STAGING ONLY)"}),e.jsx("p",{className:"text-sm text-slate-600 mb-6",children:"Select fixtures from the API to create test gameweeks. This is completely separate from the main game."}),D&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:D}),F&&e.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",children:F}),_&&e.jsx("div",{"data-api-error":!0,className:"mb-4 p-4 bg-amber-50 border-2 border-amber-400 rounded-lg text-amber-800 text-sm font-medium shadow-md",children:_.startsWith("API Error:")?_:`⚠️ ${_}`}),e.jsx("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("label",{className:"font-medium text-slate-700",children:"Test Gameweek:"}),e.jsx("span",{className:"text-lg font-semibold text-slate-900",children:"1"}),e.jsx("span",{className:"text-sm text-slate-500",children:"(API Test league always uses GW 1)"})]}),e.jsx("button",{onClick:U,disabled:P,className:"px-3 py-1.5 text-sm bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors disabled:opacity-50",children:P?"Clearing...":"Clear All Picks"})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:"Upcoming Matches (Next 7 Days)"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Competition:"}),e.jsxs("select",{value:N,onChange:t=>{R(t.target.value),S([]),o(null)},className:"w-full border rounded px-3 py-2",children:[e.jsx("option",{value:"PL",children:"Premier League"}),e.jsx("option",{value:"BSA",children:"Brazilian Serie A"}),e.jsx("option",{value:"BL1",children:"Bundesliga"}),e.jsx("option",{value:"SA",children:"Serie A"}),e.jsx("option",{value:"FL1",children:"Ligue 1"}),e.jsx("option",{value:"PD",children:"La Liga"}),e.jsx("option",{value:"CL",children:"Champions League"})]})]}),$&&e.jsx("div",{className:"text-center py-4 text-slate-600",children:"Loading upcoming matches..."}),e.jsx("button",{onClick:()=>{if(T){console.log("[TestAdminApi] Already fetching, ignoring click");return}console.log("[TestAdminApi] Refreshing upcoming matches",{competition:N});const t=new AbortController;M(!0),o(null),W(N,t.signal).then(r=>{console.log("[TestAdminApi] Matches fetched",r?.length||0),r&&r.length>0?(S(r),o(null)):r&&r.length===0&&o("No upcoming matches found in the next week for this competition.")}).catch(r=>{console.error("[TestAdminApi] Error refreshing matches",r),r instanceof Error&&r.name!=="AbortError"&&o("Failed to fetch matches. Please try again.")}).finally(()=>{M(!1),G(!1)})},disabled:T,className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-transform relative z-10",type:"button",children:T?"Refreshing...":"Refresh Matches"})]}),A.length>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:["Available Matches (",A.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:A.map(t=>{const r=Array.from(u.values()).some(c=>c.api_match_id===t.id),s=new Date(t.utcDate),a=new Date;a.setHours(0,0,0,0);const n=new Date(a);n.setDate(a.getDate()+1);const i=new Date(s);i.setHours(0,0,0,0);let d="";i.getTime()===a.getTime()?d="TODAY":i.getTime()===n.getTime()?d="TOMORROW":d=s.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"});const O=`${String(s.getUTCHours()).padStart(2,"0")}:${String(s.getUTCMinutes()).padStart(2,"0")} UTC`,v=`${d} ${O}`;return e.jsx("div",{className:`p-3 border rounded-lg cursor-pointer transition-colors ${r?"bg-purple-50 border-purple-300":"bg-slate-50 border-slate-200 hover:bg-slate-100"}`,onClick:()=>I(t),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:r,onChange:()=>I(t),className:"w-5 h-5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-slate-800",children:[t.homeTeam.shortName," vs ",t.awayTeam.shortName]}),e.jsxs("div",{className:"text-xs text-slate-500",children:[v," • ",t.status," • Matchday ",t.matchday]})]})]})},t.id)})})]}),u.size>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-slate-800",children:["Selected Fixtures for Test GW 1 (",u.size,")"]}),e.jsx("button",{onClick:()=>{confirm("Clear all selected fixtures?")&&(w(new Map),b(""),p(""))},className:"px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors",children:"Clear All"})]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Array.from(u.values()).sort((t,r)=>t.fixture_index-r.fixture_index).map(t=>e.jsxs("div",{className:"p-2 bg-purple-50 border border-purple-200 rounded text-sm",children:[t.fixture_index+1,". ",t.home_team," vs ",t.away_team]},t.fixture_index))}),e.jsx("button",{onClick:z,disabled:E,className:"mt-4 w-full py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-semibold",children:E?"Saving...":`Save Test Gameweek 1 (${u.size} fixtures)`})]})]})})}export{Y as default};
