import{u as re,a as m,c as ie,s as w,j as e,h as ae}from"./index-BI2SBqUh.js";function O(u,c){const M=u?.[`${c}_name`],b=u?.[`${c}_team`],p=u?.[`${c}_code`]||M||b||"";return ae(p)||(c==="home"?"Home":"Away")}function ne(){const{user:u}=re(),[c,M]=m.useState(null),[b,L]=m.useState([]),[p,N]=m.useState(new Map),[S,Y]=m.useState(new Map),[z,C]=m.useState(!0),[U,D]=m.useState(""),[T,G]=m.useState(!1),[K,$]=m.useState(!1),[R,A]=m.useState(!1),[B,I]=m.useState(!1),[J,H]=m.useState("saved"),[x,V]=m.useState(!1),[F,Q]=m.useState(null),[q,X]=m.useState(null),[Z,ee]=m.useState(!1),W=m.useMemo(()=>b.map(s=>s.api_match_id).filter(s=>s!=null),[b]),{liveScores:te}=ie(c||void 0,W.length>0?W:void 0);return m.useEffect(()=>{console.log("isPastDeadline state changed to:",x)},[x]),m.useEffect(()=>{if(S.size>0&&p.size>0){let s=0;p.forEach(t=>{const r=S.get(t.fixture_index);r&&r===t.pick&&s++}),Q(s),console.log("Calculated score:",s),(async()=>{if(c){const t="app_picks",{data:r}=await w.from(t).select("user_id, fixture_index, pick").eq("gw",c);if(r){const a=new Map;r.forEach(l=>{const d=S.get(l.fixture_index),v=a.get(l.user_id)||0;d&&d===l.pick?a.set(l.user_id,v+1):a.set(l.user_id,v)});const i=Array.from(a.values()).sort((l,d)=>d-l),h=i.filter(l=>l>=s).length,g=i.length,y=Math.round(h/g*100);X(y),console.log("Top percent:",y)}}})()}},[S,p,c]),m.useEffect(()=>{let s=!0;return(async()=>{try{let t=!1;if(u?.id)try{const{data:f,error:n}=await w.from("league_members").select("leagues(id,name)").eq("user_id",u.id);n?(console.warn("[NewPredictionsCentre] Error checking leagues (non-fatal):",n),t=!1):f&&(t=f.some(k=>k.leagues?.name==="API Test"))}catch(f){console.error("[NewPredictionsCentre] Error checking API Test membership:",f),t=!1}s&&ee(t);const{data:r,error:a}=await w.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(a){console.error("[NewPredictionsCentre] Error fetching current GW from app_meta:",a),s&&(D(`Failed to load gameweek: ${a.message||"Unknown error"}`),C(!1));return}const i=r?.current_gw??1;let h,g=i;h=await w.from("app_fixtures").select("id,gw,fixture_index,home_name,away_name,home_team,away_team,home_code,away_code,kickoff_time,api_match_id").eq("gw",i).order("fixture_index",{ascending:!0});const{data:y,error:l}=h;if(l){console.error("Error fetching fixtures:",l),s&&(C(!1),D(`Failed to load fixtures: ${l.message||"Unknown error"}`));return}const d=y??[];if(s&&(L(d),M(g),console.log("Loaded",d.length,"fixtures for GW",g,t&&g===1?"(Test GW 1)":""),d.length>0&&d[0].kickoff_time)){const f=d.reduce((n,k)=>{if(!k.kickoff_time)return n;const j=new Date(k.kickoff_time);return!n||j<n?j:n},null);if(f){const n=new Date(f.getTime()-45e5),k=new Date,j=k.getTime()>n.getTime();console.log("Earliest kickoff:",f.toISOString()),console.log("Deadline time:",n.toISOString()),console.log("Current time:",k.toISOString()),console.log("Is past deadline?",j),V(j)}}const v=i;if(u?.id){const f="app_picks",{data:n,error:k}=await w.from(f).select("gw,fixture_index,pick").eq("gw",v).eq("user_id",u.id);k&&console.error("Error fetching picks:",k);const j=new Map;n?.forEach(E=>{j.set(E.fixture_index,{fixture_index:E.fixture_index,pick:E.pick,gw:E.gw})}),s&&(N(j),console.log("Loaded",j.size,"user picks for GW",i))}if(u?.id){const f="app_gw_submissions",{data:n}=await w.from(f).select("submitted_at").eq("gw",v).eq("user_id",u.id).maybeSingle();s&&(G(!!n?.submitted_at),console.log("Submission status:",n?.submitted_at?"confirmed":"not confirmed"))}const o=i,_="app_gw_results",{data:P,error:se}=await w.from(_).select("gw,fixture_index,result").eq("gw",o);if(!se&&P){const f=new Map;P.forEach(n=>{(n.result==="H"||n.result==="D"||n.result==="A")&&f.set(n.fixture_index,n.result)}),s&&(Y(f),console.log("Loaded",f.size,"results for GW",i))}}catch(t){if(console.error("Error loading GW data:",t),s){C(!1);let r="Unknown error";t?.message?r=t.message:typeof t=="string"?r=t:t?.toString&&(r=t.toString()),(r.includes("Unexpected token")||r.includes("is not valid JSON"))&&(r="Server returned invalid response. Please check your connection and try again."),D(`Failed to load matches: ${r}`)}}finally{s&&C(!1)}})(),()=>{s=!1}},[u?.id]),U?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md mx-auto px-4",children:[e.jsx("div",{className:"text-red-600 font-semibold text-lg mb-2",children:"Failed to Load Matches"}),e.jsx("div",{className:"text-slate-600 text-sm mb-4",children:U}),e.jsx("button",{onClick:()=>{D(""),C(!0),window.location.reload()},className:"px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:"Retry"})]})}):z||!c||b.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading fixtures..."})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-4",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900",children:"Predictions Centre"}),e.jsx("p",{className:"mt-2 mb-6 text-sm text-slate-600 w-full",children:"Call every game, lock in your results, and climb the table."})]}),c&&e.jsx("div",{className:"mt-2 mb-3",children:T?e.jsx("div",{className:"rounded-xl border bg-gradient-to-br from-[#1C8376]/5 to-blue-50/50 shadow-sm px-6 py-5",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"font-bold text-slate-900 text-xl mb-3",children:["Game Week ",c]}),F!==null&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-3",children:[e.jsxs("div",{className:"text-4xl font-extrabold text-[#1C8376]",children:[F,"/",b.length]}),q!==null&&e.jsx("div",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gradient-to-r from-yellow-100 to-orange-100 border border-yellow-300",children:e.jsxs("span",{className:"text-sm font-bold text-orange-700",children:["Top ",q,"%"]})})]}),e.jsx("div",{className:"mb-3 bg-slate-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-[#1C8376] to-blue-500 transition-all duration-500",style:{width:`${F/b.length*100}%`}})})]})]})}):e.jsx("div",{className:"rounded-xl border bg-gradient-to-r from-[#1C8376]/10 to-blue-50 border-[#1C8376]/20 px-6 py-4",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"font-semibold text-[#1C8376] text-lg",children:["Gameweek ",c]}),e.jsx("div",{className:"text-sm text-slate-600",children:"Make your predictions below"})]})})}),e.jsx("div",{className:"space-y-4",children:b.map(s=>{const t=p.get(s.fixture_index),r=S.get(s.fixture_index),a=s.api_match_id,i=a?te.get(a):null,h=s.kickoff_time?(()=>{const o=new Date(s.kickoff_time),_=String(o.getUTCHours()).padStart(2,"0"),P=String(o.getUTCMinutes()).padStart(2,"0");return`${_}:${P}`})():"—",g=i&&(i.status==="IN_PLAY"||i.status==="PAUSED"||i.status==="FINISHED"),y=g?`${i.home_score??0}-${i.away_score??0}`:h,l=i?.status==="IN_PLAY"?i.minute?`${i.minute}'`:"LIVE":i?.status==="PAUSED"?"HT":i?.status==="FINISHED"?"FT":null,d=O(s,"home"),v=O(s,"away");return e.jsxs("div",{className:"rounded-2xl border bg-white p-3 shadow-sm",children:[e.jsxs("div",{className:"flex items-center px-2 pt-1 pb-3",children:[e.jsxs("div",{className:"flex items-center gap-1 flex-1 justify-end",children:[e.jsx("div",{className:"truncate font-medium",children:d}),e.jsx("img",{src:`/assets/badges/${s.home_code?.toUpperCase()||"UNK"}.png`,alt:d,className:"w-5 h-5",onError:o=>{o.currentTarget.style.display="none"}})]}),e.jsx("div",{className:"text-slate-500 text-sm px-4 text-center",children:g?e.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[e.jsx("div",{className:"font-bold text-slate-900 text-base",children:y}),l&&e.jsx("div",{className:"text-xs text-slate-500",children:l})]}):h}),e.jsxs("div",{className:"flex items-center gap-1 flex-1 justify-start",children:[e.jsx("img",{src:`/assets/badges/${s.away_code?.toUpperCase()||"UNK"}.png`,alt:v,className:"w-5 h-5",onError:o=>{o.currentTarget.style.display="none"}}),e.jsx("div",{className:"truncate font-medium",children:v})]})]}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:T?e.jsxs(e.Fragment,{children:[(()=>{const o=r&&t?.pick===r,_=r&&t?.pick!==r;return e.jsx("div",{className:`h-16 rounded-xl border text-sm font-medium flex items-center justify-center relative overflow-hidden ${t?.pick==="H"?o?"bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 text-white border-yellow-300 shadow-xl shadow-gray-400/40 before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/70 before:to-transparent before:animate-[shimmer_1.2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/50 after:to-transparent after:animate-[shimmer_1.8s_ease-in-out_infinite_0.4s] ring-2 ring-yellow-300/60":_&&r==="H"?"bg-red-500 text-white border-red-400":"bg-[#1C8376] text-white border-[#1C8376]":r==="H"?"bg-gray-300 text-slate-700 border-gray-400":"bg-slate-50 text-slate-400 border-slate-200"}`,children:"Home Win"})})(),(()=>{const o=r&&t?.pick===r,_=r&&t?.pick!==r;return e.jsx("div",{className:`h-16 rounded-xl border text-sm font-medium flex items-center justify-center relative overflow-hidden ${t?.pick==="D"?o?"bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 text-white border-yellow-300 shadow-xl shadow-gray-400/40 before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/70 before:to-transparent before:animate-[shimmer_1.2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/50 after:to-transparent after:animate-[shimmer_1.8s_ease-in-out_infinite_0.4s] ring-2 ring-yellow-300/60":_&&r==="D"?"bg-red-500 text-white border-red-400":"bg-[#1C8376] text-white border-[#1C8376]":r==="D"?"bg-gray-300 text-slate-700 border-gray-400":"bg-slate-50 text-slate-400 border-slate-200"}`,children:"Draw"})})(),(()=>{const o=r&&t?.pick===r,_=r&&t?.pick!==r;return e.jsx("div",{className:`h-16 rounded-xl border text-sm font-medium flex items-center justify-center relative overflow-hidden ${t?.pick==="A"?o?"bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 text-white border-yellow-300 shadow-xl shadow-gray-400/40 before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/70 before:to-transparent before:animate-[shimmer_1.2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/50 after:to-transparent after:animate-[shimmer_1.8s_ease-in-out_infinite_0.4s] ring-2 ring-yellow-300/60":_&&r==="A"?"bg-red-500 text-white border-red-400":"bg-[#1C8376] text-white border-[#1C8376]":r==="A"?"bg-gray-300 text-slate-700 border-gray-400":"bg-slate-50 text-slate-400 border-slate-200"}`,children:"Away Win"})})()]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{if(x)return;const o=new Map(p);o.set(s.fixture_index,{fixture_index:s.fixture_index,pick:"H",gw:c}),N(o)},disabled:x,className:`h-16 rounded-xl border text-sm font-medium transition-colors flex items-center justify-center ${t?.pick==="H"?"bg-[#1C8376] text-white border-[#1C8376]":x?"bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed":"bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100"}`,children:"Home Win"}),e.jsx("button",{onClick:()=>{if(x)return;const o=new Map(p);o.set(s.fixture_index,{fixture_index:s.fixture_index,pick:"D",gw:c}),N(o)},disabled:x,className:`h-16 rounded-xl border text-sm font-medium transition-colors flex items-center justify-center ${t?.pick==="D"?"bg-[#1C8376] text-white border-[#1C8376]":x?"bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed":"bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100"}`,children:"Draw"}),e.jsx("button",{onClick:()=>{if(x)return;const o=new Map(p);o.set(s.fixture_index,{fixture_index:s.fixture_index,pick:"A",gw:c}),N(o)},disabled:x,className:`h-16 rounded-xl border text-sm font-medium transition-colors flex items-center justify-center ${t?.pick==="A"?"bg-[#1C8376] text-white border-[#1C8376]":x?"bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed":"bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100"}`,children:"Away Win"})]})})]},s.id)})})]})}),e.jsx("div",{className:"p-6 bg-white shadow-lg",children:e.jsxs("div",{className:"max-w-2xl mx-auto space-y-3",children:[b.length>0&&(()=>{const s=b.reduce((t,r)=>{if(!r.kickoff_time)return t;const a=new Date(r.kickoff_time);return!t||a<t?a:t},null);return s&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Deadline"}),e.jsx("div",{className:"text-sm font-bold text-slate-700",children:(()=>{const t=new Date(s.getTime()-45e5),r=t.toLocaleDateString(void 0,{weekday:"short"}),a=t.toLocaleDateString(void 0,{month:"short"}),i=t.toLocaleDateString(void 0,{day:"numeric"}),h=t.getUTCHours().toString().padStart(2,"0"),g=t.getUTCMinutes().toString().padStart(2,"0");return`${r}, ${a} ${i}, ${h}:${g}`})()}),e.jsx("div",{className:"text-xs text-slate-500 mt-1",children:"(75 minutes before first kickoff)"})]})})(),!T&&!x&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{if(x){alert("⚠️ Too late! Predictions are now closed. The deadline was 75 minutes before the first kickoff.");return}$(!0)},className:"w-full py-4 bg-slate-600 text-white rounded-2xl font-bold hover:bg-slate-700 transition-colors",children:"Save Predictions"}),e.jsx("button",{onClick:()=>{if(x){alert("⚠️ Too late! Predictions are now closed. The deadline was 75 minutes before the first kickoff.");return}b.every(t=>p.has(t.fixture_index))?A(!0):alert("Please make all predictions before confirming")},className:"w-full py-4 bg-green-600 text-white rounded-2xl font-bold hover:bg-green-700 transition-colors",children:"Confirm Predictions"})]}),x&&!T&&e.jsxs("div",{className:"text-center py-6",children:[e.jsx("div",{className:"text-lg font-bold text-red-600 mb-2",children:"⚠️ Deadline Passed"}),e.jsx("div",{className:"text-sm text-slate-600",children:"Predictions are now closed. The deadline was 75 minutes before the first kickoff."})]}),T&&e.jsxs("div",{className:"text-center py-6",children:[e.jsx("div",{className:"text-lg font-bold text-green-600 mb-2",children:"✅ Predictions Submitted!"}),e.jsxs("div",{className:"text-sm text-slate-600",children:["Your predictions for Gameweek ",c," have been confirmed and locked."]})]})]})}),K&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl p-6 max-w-md w-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Save Predictions?"}),e.jsxs("div",{className:"text-slate-600 mb-6",children:["Your predictions will be saved but you can still change them before confirming.",b.length>0&&(()=>{const s=b.reduce((t,r)=>{if(!r.kickoff_time)return t;const a=new Date(r.kickoff_time);return!t||a<t?a:t},null);return s&&e.jsxs("div",{className:"mt-3 p-3 bg-amber-50 rounded-lg border border-amber-200",children:[e.jsx("div",{className:"text-sm font-medium text-amber-800 mb-1",children:"Deadline Reminder"}),e.jsx("div",{className:"text-xs text-amber-700",children:(()=>{const t=new Date(s.getTime()-45e5),r=t.toLocaleDateString(void 0,{weekday:"short"}),a=t.toLocaleDateString(void 0,{month:"short"}),i=t.toLocaleDateString(void 0,{day:"numeric"}),h=t.getUTCHours().toString().padStart(2,"0"),g=t.getUTCMinutes().toString().padStart(2,"0");return`${r}, ${a} ${i}, ${h}:${g}`})()}),e.jsx("div",{className:"text-xs text-amber-600 mt-1",children:"(75 minutes before first kickoff)"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>$(!1),className:"flex-1 py-3 bg-slate-200 text-slate-800 rounded-xl font-bold hover:bg-slate-300 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{try{const s=Array.from(p.values()).map(i=>({user_id:u?.id,gw:i.gw,fixture_index:i.fixture_index,pick:i.pick})),t="app_picks",r="user_id,gw,fixture_index",{error:a}=await w.from(t).upsert(s,{onConflict:r,ignoreDuplicates:!1});if(a){console.error("Error saving picks:",a),alert("Failed to save predictions. Please try again.");return}console.log("Successfully saved picks:",s),$(!1),H("saved"),I(!0)}catch(s){console.error("Error saving picks:",s),alert("Failed to save predictions. Please try again.")}},className:"flex-1 py-3 bg-slate-600 text-white rounded-xl font-bold hover:bg-slate-700 transition-colors",children:"Save"})]})]})})}),R&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl p-6 max-w-md w-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Are You Sure?"}),e.jsx("div",{className:"text-slate-600 mb-6",children:"Once confirmed, you cannot change your predictions. Make sure you're happy with all your picks!"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>A(!1),className:"flex-1 py-3 bg-slate-200 text-slate-800 rounded-xl font-bold hover:bg-slate-300 transition-colors",children:"Go Back"}),e.jsx("button",{onClick:async()=>{try{const s=Array.from(p.values()).map(d=>({user_id:u?.id,gw:d.gw,fixture_index:d.fixture_index,pick:d.pick})),t="app_picks",r="user_id,gw,fixture_index",{error:a}=await w.from(t).upsert(s,{onConflict:r,ignoreDuplicates:!1});if(a){console.error("Error confirming picks:",a),alert("Failed to confirm predictions. Please try again.");return}const i="app_gw_submissions",h={user_id:u?.id,gw:c??1,submitted_at:new Date().toISOString()},g="user_id,gw",{error:y}=await w.from(i).upsert(h,{onConflict:g});if(y){console.error("Error recording submission:",y),alert("Failed to record submission. Please try again.");return}const{data:l}=await w.from("league_members").select("league_id").eq("user_id",u?.id);if(l&&l.length>0){const d=c??1;l.forEach(({league_id:v})=>{fetch("/.netlify/functions/notifyFinalSubmission",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({leagueId:v,gw:d,isAppUser:Z})}).catch(o=>{console.error("[NewPredictionsCentre] Failed to check final submission:",o)})})}console.log("Successfully confirmed picks:",s),G(!0),A(!1),H("confirmed"),I(!0),window.dispatchEvent(new CustomEvent("predictionsSubmitted"))}catch(s){console.error("Error confirming picks:",s),alert("Failed to confirm predictions. Please try again.")}},className:"flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition-colors",children:"Confirm"})]})]})})}),B&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl p-6 max-w-md w-full",children:e.jsxs("div",{className:"text-center",children:[J==="saved"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600 mb-2",children:"Predictions Saved!"}),e.jsx("div",{className:"text-slate-600 mb-4",children:"Your predictions have been saved as a draft. You can still edit them until you confirm."}),e.jsxs("div",{className:"text-sm text-amber-700 bg-amber-50 rounded-lg p-3 mb-6 border border-amber-200",children:["⚠️ ",e.jsx("strong",{children:"Important:"})," Don't forget to come back and publish your predictions before the deadline to make them final!"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600 mb-2",children:"Predictions Confirmed!"}),e.jsx("div",{className:"text-slate-600 mb-6",children:"Your predictions have been published and locked. Good luck!"})]}),e.jsx("button",{onClick:()=>I(!1),className:"w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition-colors",children:"Done"})]})})})]})}export{ne as default};
