import{u as F,a as u,s as p,j as t}from"./index-E0RyNq15.js";const I=()=>{const f=typeof window<"u"?window.location.hostname:"",x=typeof window<"u"?window.location.origin:"";return f.includes("netlify.app")||f.includes("netlify.com")?`${x}/.netlify/functions/fetchFootballData`:f==="localhost"||f==="127.0.0.1"?"https://totl-staging.netlify.app/.netlify/functions/fetchFootballData":"/.netlify/functions/fetchFootballData"};function z(){const{user:f}=F(),x=f?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||f?.id==="36f31625-6d6c-4aa4-815a-1493a812841b",[n,E]=u.useState(null),[_,$]=u.useState([]),[c,y]=u.useState(new Map),[j,k]=u.useState(!1),[b,N]=u.useState(!1),[A,g]=u.useState(""),[T,S]=u.useState(""),[M,m]=u.useState(null),[C,D]=u.useState(!0);u.useEffect(()=>{if(!x)return;let a=!0;return(async()=>{try{const{data:e,error:i}=await p.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(i)throw i;if(a&&e){const o=(e.current_gw||13)+1;E(o);const{data:s}=await p.from("app_fixtures").select("*").eq("gw",o).order("fixture_index",{ascending:!0});if(s&&s.length>0){const d=new Map;s.forEach(l=>{d.set(l.fixture_index,{api_match_id:l.api_match_id||0,home_team:l.home_team||"",away_team:l.away_team||"",home_code:l.home_code||"",away_code:l.away_code||"",home_name:l.home_name||"",away_name:l.away_name||"",home_crest:l.home_crest||null,away_crest:l.away_crest||null,kickoff_time:l.kickoff_time||"",selected:!0})}),y(d)}}}catch(e){console.error("Error loading next GW:",e)}finally{a&&D(!1)}})(),()=>{a=!1}},[x]);const G=async a=>{if(!n)return m("Next GW not loaded yet."),null;try{const e=new Date,i=new Date(e);i.setDate(e.getDate()+7);const r=e.toISOString().split("T")[0],o=i.toISOString().split("T")[0],s=new URLSearchParams({competition:"PL",dateFrom:r,dateTo:o}),l=`${I()}?${s.toString()}`,h=await fetch(l,{signal:a});if(!h.ok){const v=await h.text();return h.status===429?(m("Rate limit reached. Please wait a moment."),null):(m(`Server error (${h.status}). ${v.substring(0,100)}`),null)}const w=await h.json();if(!w.success||!w.data)return m("Invalid API response format."),null;const L=(w.data.matches||[]).filter(v=>v.matchday===n);return m(null),L}catch(e){return e instanceof Error&&e.name==="AbortError"||(console.error("Error fetching matches:",e),m("Failed to fetch matches. Check your connection.")),null}},P=a=>{const e=new Map(c),i=Array.from(e.entries()).find(([r,o])=>o.api_match_id===a.id);if(i){const[r]=i;e.delete(r);const o=Array.from(e.entries()).sort(([d],[l])=>d-l),s=new Map;o.forEach(([d,l],h)=>{s.set(h,l)}),y(s)}else{const o=(e.size>0?Math.max(...Array.from(e.keys())):-1)+1,s={api_match_id:a.id,home_team:a.homeTeam.shortName,away_team:a.awayTeam.shortName,home_code:a.homeTeam.tla,away_code:a.awayTeam.tla,home_name:a.homeTeam.name,away_name:a.awayTeam.name,home_crest:a.homeTeam.crest||null,away_crest:a.awayTeam.crest||null,kickoff_time:a.utcDate,selected:!0};e.set(o,s),y(e)}},W=async()=>{if(!n){g("Next GW not loaded");return}if(c.size===0){g("Please select at least one fixture");return}const a=Array.from(c.values()).filter(e=>!e.api_match_id||e.api_match_id===0);if(a.length>0){g(`Cannot save: ${a.length} fixture${a.length===1?"":"s"} missing api_match_id. Please select fixtures from the API matches list.`);return}if(confirm(`Are you sure you want to save GW ${n} with ${c.size} fixture${c.size===1?"":"s"}? This will replace any existing fixtures for this game week.`)){k(!0),g(""),S("");try{await p.from("app_fixtures").delete().eq("gw",n);const e=Array.from(c.entries()).map(([o,s])=>({gw:n,fixture_index:o,api_match_id:s.api_match_id,home_team:s.home_team,away_team:s.away_team,home_code:s.home_code,away_code:s.away_code,home_name:s.home_name,away_name:s.away_name,home_crest:s.home_crest||null,away_crest:s.away_crest||null,kickoff_time:s.kickoff_time})),{error:i}=await p.from("app_fixtures").insert(e);if(i)throw console.error("[ApiAdmin] Error inserting fixtures:",i),i;const{error:r}=await p.from("app_meta").upsert({id:1,current_gw:n},{onConflict:"id"});r&&console.error("[ApiAdmin] Error updating app_meta:",r);try{const o=await fetch("/.netlify/functions/sendPushAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:`GAME WEEK ${n} - FIXTURES ARE OUT!`,message:"Make your predictions now!",data:{type:"fixtures_published",gw:n}})}),s=await o.json().catch(()=>({}));o.ok&&s.ok?console.log(`[ApiAdmin] Push notification sent to ${s.sentTo||0} users`):console.warn("[ApiAdmin] Push notification failed:",s)}catch(o){console.error("[ApiAdmin] Error sending push notification:",o)}S(`Game Week ${n} saved with ${c.size} Premier League fixtures!`)}catch(e){g(e.message??"Failed to save gameweek.")}finally{k(!1)}}};return x?C?t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-slate-600",children:"Loading..."})}):t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900 mb-2",children:"API Admin - Premier League"}),t.jsxs("p",{className:"text-sm text-slate-600 mb-6",children:["Select Premier League fixtures for Game Week ",n,". Check the feed for any cancelled or postponed games."]}),A&&t.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:A}),T&&t.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",children:T}),M&&t.jsxs("div",{className:"mb-4 p-4 bg-amber-50 border-2 border-amber-400 rounded-lg text-amber-800 text-sm font-medium shadow-md",children:["⚠️ ",M]}),t.jsx("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Next Game Week"}),t.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:["GW ",n]})]}),c.size>0&&t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Selected Fixtures"}),t.jsx("div",{className:"text-2xl font-bold text-[#1C8376]",children:c.size})]})]})}),t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:["Premier League Matches for GW ",n," (Matchday ",n,")"]}),t.jsxs("p",{className:"text-sm text-slate-500 mb-4",children:["Loading matches from the API that are tagged with Matchday ",n," (corresponds to GW ",n,")."]}),t.jsx("button",{onClick:()=>{if(b||!n)return;N(!0),m(null);const a=new AbortController;G(a.signal).then(e=>{if(e&&e.length>0){$(e),m(null);const i=new Map;e.forEach((r,o)=>{i.set(o,{api_match_id:r.id,home_team:r.homeTeam.shortName,away_team:r.awayTeam.shortName,home_code:r.homeTeam.tla,away_code:r.awayTeam.tla,home_name:r.homeTeam.name,away_name:r.awayTeam.name,home_crest:r.homeTeam.crest||null,away_crest:r.awayTeam.crest||null,kickoff_time:r.utcDate,selected:!0})}),y(i)}else e&&e.length===0&&m(`No Premier League matches found for Matchday ${n} (GW ${n}) in the next week.`)}).catch(e=>{e instanceof Error&&e.name!=="AbortError"&&m("Failed to fetch matches. Please try again.")}).finally(()=>{N(!1)})},disabled:b||!n,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",type:"button",children:b?"Loading...":`Load GW ${n} Matches (Matchday ${n})`})]}),_.length>0&&t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800",children:["Available Matches (",_.length,") - All Selected by Default"]}),t.jsx("button",{onClick:W,disabled:j||c.size===0,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 font-semibold",children:j?"Saving...":`Save GW ${n} (${c.size} fixtures)`})]}),t.jsx("div",{className:"space-y-2",children:_.map(a=>{const e=Array.from(c.values()).some(w=>w.api_match_id===a.id),i=new Date(a.utcDate),r=new Date;r.setHours(0,0,0,0);const o=new Date(r);o.setDate(r.getDate()+1);const s=new Date(i);s.setHours(0,0,0,0);let d="";s.getTime()===r.getTime()?d="TODAY":s.getTime()===o.getTime()?d="TOMORROW":d=i.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"});const l=`${String(i.getUTCHours()).padStart(2,"0")}:${String(i.getUTCMinutes()).padStart(2,"0")} UTC`,h=`${d} ${l}`;return t.jsx("div",{className:`p-3 border-2 rounded-lg transition-colors ${e?"bg-[#1C8376]/10 border-[#1C8376]":"bg-slate-50 border-slate-200"}`,children:t.jsxs("label",{className:"flex items-center gap-4 cursor-pointer",children:[t.jsxs("div",{className:"relative flex-shrink-0",children:[t.jsx("input",{type:"checkbox",checked:e,onChange:()=>P(a),className:"w-6 h-6 cursor-pointer appearance-none border-2 rounded transition-all",style:{minWidth:"24px",minHeight:"24px",borderColor:e?"#1C8376":"#94a3b8",backgroundColor:e?"#1C8376":"white"}}),e&&t.jsx("svg",{className:"absolute top-0 left-0 w-6 h-6 pointer-events-none",fill:"none",stroke:"white",strokeWidth:"3",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})]}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"font-medium text-slate-800",children:[a.homeTeam.shortName," vs ",a.awayTeam.shortName]}),t.jsxs("div",{className:"text-xs text-slate-500",children:[h," • ",a.status," • Matchday ",a.matchday]})]})]})},a.id)})})]})]})}):t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-red-600",children:"Access denied. Admin only."})})}export{z as default};
