import{p as I,j as e,T as Z,r as F,I as K,s as M,t as ee,v as z,w as te,x as Y,c as se,g as q,u as ae,L as oe,P as ne}from"./index-BNBZPCDH.js";import{f as re}from"./userLeagues-BOJNJSK-.js";import{S as ie}from"./SwipeCard-CfMV60yb.js";const B=I.memo(function({label:s,value:g,subcopy:l,loading:x=!1,className:b=""}){if(x)return e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${b}`,children:[e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:s}),e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]});const _=typeof g=="object"&&g!==null;return e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${b}`,children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-2",children:s}),e.jsx("div",{className:`mb-1 flex items-baseline ${_?"":"text-2xl font-bold text-slate-800"}`,children:g}),l&&e.jsx("div",{className:"text-sm text-slate-500 mt-2",children:l})]})}),le=I.memo(function({label:s,streakCount:g,gwRange:l,subcopy:x,extraLine:b,loading:_=!1,className:P=""}){return _?e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${P}`,children:[e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:s}),e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]}):e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${P}`,children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-2",children:s}),e.jsxs("div",{className:"text-4xl font-bold text-slate-800 mb-2 flex items-baseline gap-2",children:[e.jsx("span",{children:g}),e.jsxs("span",{className:"text-base font-normal text-slate-600",children:["Top 25% from ",l]})]}),b&&e.jsxs("div",{className:"text-sm text-slate-500 italic mb-2",children:['"',b,'"']}),x&&e.jsxs("div",{className:"text-sm text-slate-500 mt-2 italic",children:['"',x,'"']})]})}),V=I.memo(function({label:s,teamCode:g,teamName:l,percentage:x,isCorrect:b,subcopy:_,loading:P=!1,className:j=""}){if(P)return e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${j}`,children:[e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:s}),e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]});const m=x%1===0?x.toFixed(0):x.toFixed(2);return e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${j}`,children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-3",children:s}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Z,{code:g,size:32}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-lg font-bold text-slate-800 truncate",children:l}),e.jsxs("div",{className:`text-base font-semibold ${b?"text-green-600":"text-red-600"}`,children:[m,"% ",b?"correct":"incorrect"]})]})]}),_&&e.jsxs("div",{className:"text-sm text-slate-500 mt-3 italic",children:['"',_,'"']})]})}),ce=I.memo(function({weeklyData:s,latestGw:g,showInfo:l=!1}){const x=s.flatMap(c=>[c.userPoints,c.averagePoints]),b=x.length>0?Math.max(...x,10):10,_=0,P=b-_||1,j=120,m=48,v=8,k=12,d=4,u=l?48:16,f=Math.max(340,s.length*m+(s.length-1)*v+k*2+d*2+u);return e.jsx("div",{className:"flex-shrink-0 h-[168px] bg-white relative",style:{width:`${f}px`,minWidth:`${f}px`},children:e.jsxs("div",{className:"pt-3 pb-2 h-full flex flex-col",style:{paddingLeft:"0",paddingRight:"12px"},children:[e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"mb-1 relative",style:{height:"120px"},children:e.jsx("div",{className:"relative h-full",children:e.jsx("div",{className:"flex items-end gap-2 h-full",style:{paddingLeft:"0",paddingRight:"4px"},children:s.map(c=>{const{gw:C,userPoints:p,averagePoints:N}=c,G=C===g,R=p-N,T=R>0,t=R<0,r=(p-_)/P*j,n=(N-_)/P*j,h=Math.max(r,n);return e.jsxs("div",{className:"flex flex-col items-center justify-end relative",style:{minWidth:"48px",width:"48px",height:"100%"},children:[e.jsxs("div",{className:"w-full relative",style:{height:`${h}px`},children:[l&&e.jsx("div",{className:"absolute flex items-center justify-center",style:{bottom:`${h+4}px`,left:"0",right:"0",width:"100%",zIndex:10},children:e.jsx("div",{className:`text-xs font-bold leading-none ${G?"text-[#1C8376]":T?"text-green-600":t?"text-red-600":"text-slate-700"}`,children:p})}),T?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute bottom-0 w-full bg-slate-300 opacity-60",style:{height:`${n}px`,minHeight:n>0?"2px":"0",borderTopLeftRadius:"2px",borderTopRightRadius:n===h?"2px":"0"},title:`Par: ${N.toFixed(1)}`}),e.jsx("div",{className:"absolute w-full transition-all bg-green-500",style:{bottom:`${n}px`,height:`${r-n}px`,minHeight:r-n>0?"2px":"0",borderTopLeftRadius:"2px",borderTopRightRadius:"2px"},title:`Your score: ${p}`})]}):t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute bottom-0 w-full transition-all bg-red-500",style:{height:`${r}px`,minHeight:r>0?"2px":"0",borderTopLeftRadius:r===h?"2px":"0",borderTopRightRadius:r===h?"2px":"0"},title:`Your score: ${p}`}),e.jsx("div",{className:"absolute w-full bg-slate-300 opacity-60",style:{bottom:`${r}px`,height:`${n-r}px`,minHeight:n-r>0?"2px":"0",borderTopLeftRadius:"2px",borderTopRightRadius:"2px"},title:`Par: ${N.toFixed(1)}`})]}):e.jsx("div",{className:"absolute bottom-0 w-full rounded-t bg-slate-400 transition-all",style:{height:`${r}px`,minHeight:r>0?"4px":"0",borderRadius:"2px 2px 0 0"},title:`Your score: ${p} (Par: ${N.toFixed(1)})`}),h>15&&e.jsx("div",{className:"absolute bottom-1 left-0 right-0 flex items-center justify-center",style:{height:"16px"},children:e.jsx("div",{className:`text-[13px] leading-none ${T?"text-green-600":"text-white"}`,style:{fontWeight:900},children:T?`+${R.toFixed(1)}`:t?`${R.toFixed(1)}`:"Par"})})]}),e.jsxs("div",{className:"flex flex-col items-center justify-start",style:{height:"28px",marginTop:"4px"},children:[e.jsxs("div",{className:`text-[10px] font-medium leading-tight ${G?"text-[#1C8376] font-bold":"text-slate-700"}`,children:["GW",C]}),e.jsxs("div",{className:"text-[9px] font-medium text-slate-400 leading-none",style:{visibility:l?"visible":"hidden",height:"12px"},children:["av. ",N.toFixed(1)]})]})]},C)})})})})]})})}),de=I.memo(function({lastGw:s,form5:g,form10:l,overall:x,loading:b=!1}){const[_,P]=F.useState(!1),j=[{label:"Gameweek",count:s},{label:"5-Week Form",count:g},{label:"10-Week Form",count:l},{label:"Overall",count:x}],m=s+g+l+x;return b?e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6",children:[e.jsx("div",{className:"text-sm text-slate-500 mb-4",children:"Leaderboard Trophy Cabinet"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[1,2,3,4].map(v=>e.jsx("div",{className:"h-24 bg-slate-200 rounded animate-pulse"},v))})]}):e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[e.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Leaderboard Trophy Cabinet"}),e.jsx("div",{className:"w-4 h-4 rounded-full border border-slate-400 flex items-center justify-center hover:bg-slate-50 transition-colors cursor-pointer",onClick:()=>P(!0),role:"button","aria-label":"Information about Trophy Cabinet",children:e.jsx("span",{className:"text-[10px] text-slate-500 font-bold",children:"i"})})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:j.map((v,k)=>e.jsxs("div",{className:"flex flex-col items-center justify-center p-4 bg-slate-50 rounded-lg border border-slate-200 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:`w-10 h-10 text-yellow-500 ${v.count>0?"sparkle-trophy":"opacity-40"}`,children:e.jsx("g",{children:e.jsx("path",{fill:"currentColor",d:"M16 3c1.1046 0 2 0.89543 2 2h2c1.1046 0 2 0.89543 2 2v1c0 2.695 -2.1323 4.89 -4.8018 4.9941 -0.8777 1.5207 -2.4019 2.6195 -4.1982 2.9209V19h3c0.5523 0 1 0.4477 1 1s-0.4477 1 -1 1H8c-0.55228 0 -1 -0.4477 -1 -1s0.44772 -1 1 -1h3v-3.085c-1.7965 -0.3015 -3.32148 -1.4 -4.19922 -2.9209C4.13175 12.8895 2 10.6947 2 8V7c0 -1.10457 0.89543 -2 2 -2h2c0 -1.10457 0.89543 -2 2 -2zm-8 7c0 2.2091 1.79086 4 4 4 2.2091 0 4 -1.7909 4 -4V5H8zM4 8c0 1.32848 0.86419 2.4532 2.06055 2.8477C6.02137 10.5707 6 10.2878 6 10V7H4zm14 2c0 0.2878 -0.0223 0.5706 -0.0615 0.8477C19.1353 10.4535 20 9.32881 20 8V7h-2z",strokeWidth:"1"})})}),v.count>0&&e.jsx("div",{className:"absolute -top-1 -right-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center border-2 border-white",children:v.count})]}),e.jsx("div",{className:"text-xs font-medium text-slate-600 text-center",children:v.label})]},k))}),m>0&&e.jsxs("div",{className:"mt-4 text-sm font-semibold text-slate-600 text-center",children:["You have ",m," ",m===1?"trophy":"trophies"]}),e.jsx(K,{isOpen:_,onClose:()=>P(!1),title:"Leaderboard Trophy Cabinet",description:`Earn trophies by finishing top (or joint top) of any leaderboard after a gameweek completes.

GAMEWEEK
Finish #1 in the weekly leaderboard for any completed gameweek.

5-WEEK FORM
Finish #1 in the 5-week form leaderboard after any gameweek. Requires 5+ completed gameweeks.

10-WEEK FORM
Finish #1 in the 10-week form leaderboard after any gameweek. Requires 10+ completed gameweeks.

OVERALL
Finish #1 in the overall season leaderboard after any gameweek.`})]})});function H(a,s){if(s.length===0)return 50;const l=s.filter(x=>x<=a).length/s.length*100;return Math.round(l*100)/100}async function me(a){const s={lastCompletedGw:null,lastCompletedGwPercentile:null,overallPercentile:null,correctPredictionRate:null,bestStreak:0,bestStreakGwRange:null,avgPointsPerWeek:null,bestSingleGw:null,lowestSingleGw:null,chaosIndex:null,chaosCorrectCount:null,chaosTotalCount:null,mostCorrectTeam:null,mostIncorrectTeam:null,weeklyParData:null,trophyCabinet:null};try{const{data:g}=await M.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),l=g?.gw||null;if(s.lastCompletedGw=l,!l)return s;if(l){const{data:d}=await M.from("app_v_gw_points").select("user_id, points").eq("gw",l);if(d&&d.length>0){const u=d.map(c=>c.points||0),f=d.find(c=>c.user_id===a)?.points||0;s.lastCompletedGwPercentile=H(f,u)}}const{data:x}=await M.from("v_ocp_overall").select("user_id, ocp").order("ocp",{ascending:!1});if(x&&x.length>0){const d=x.map(f=>f.ocp||0),u=x.find(f=>f.user_id===a)?.ocp||0;s.overallPercentile=H(u,d)}const[b,_]=await Promise.all([M.from("app_picks").select("gw, fixture_index, pick").eq("user_id",a),M.from("picks").select("gw, fixture_index, pick").eq("user_id",a)]),P=new Map;_.data&&_.data.forEach(d=>{const u=`${d.gw}:${d.fixture_index}`;P.set(u,d)}),b.data&&b.data.forEach(d=>{const u=`${d.gw}:${d.fixture_index}`;P.set(u,d)});const j=Array.from(P.values());console.log("[userStats] Picks from app_picks:",b.data?.length||0),console.log("[userStats] Picks from picks table:",_.data?.length||0),console.log("[userStats] Total unique picks (combined):",j.length),b.error&&console.error("[userStats] Error fetching app_picks:",b.error),_.error&&_.error.code!=="PGRST116"&&console.error("[userStats] Error fetching picks:",_.error);const{data:m,error:v}=await M.from("app_gw_results").select("gw, fixture_index, result");if(console.log("[userStats] Total results fetched:",m?.length||0),v&&console.error("[userStats] Error fetching results:",v),j&&m){const d=new Map;m.forEach(c=>{c.result&&d.set(`${c.gw}:${c.fixture_index}`,c.result)});let u=0,f=0;j.forEach(c=>{const C=d.get(`${c.gw}:${c.fixture_index}`);C&&(f++,c.pick===C&&u++)}),f>0&&(s.correctPredictionRate=u/f*100)}const{data:k}=await M.from("app_v_gw_points").select("gw, points").eq("user_id",a).order("gw",{ascending:!0});if(k&&k.length>0){const d=k.reduce((i,o)=>i+(o.points||0),0);s.avgPointsPerWeek=d/k.length;const u=new Set,{data:f}=await M.from("app_gw_results").select("gw").order("gw",{ascending:!0});f?.forEach(i=>{u.add(i.gw)});const{data:c}=await M.from("app_v_gw_points").select("gw, user_id, points").in("gw",Array.from(u)),C=new Map,p=new Map;c&&c.forEach(i=>{const o=i.gw;p.has(o)||p.set(o,[]),p.get(o).push({user_id:i.user_id,points:i.points||0})});for(const i of Array.from(u).sort((o,y)=>o-y)){const o=p.get(i);if(o&&o.length>0){const y=o.map(A=>A.points),$=o.find(A=>A.user_id===a)?.points||0,W=H($,y);C.set(i,W)}}let N=0,G=0,R=0,T=0,t=0;const r=Array.from(u).sort((i,o)=>i-o);console.log("[userStats] Calculating best streak. Completed GWs:",r),console.log("[userStats] User percentiles per GW:",Array.from(C.entries()).map(([i,o])=>({gw:i,percentile:o.toFixed(2),inTop25:o>=75})));for(const i of r){const o=C.get(i);o!==void 0&&o>=75?(N===0&&(t=i),N++,N>G&&(G=N,R=t,T=i)):(N>0&&console.log(`[userStats] Streak broken at GW${i} (percentile: ${o?.toFixed(2)||"N/A"}). Previous streak was ${N} games`),N=0)}s.bestStreak=G,G>0?(s.bestStreakGwRange=`GW${R}–GW${T}`,console.log(`[userStats] Best streak: ${G} games from ${s.bestStreakGwRange}`)):console.log("[userStats] No streak found (user never in top 25%)");let n={points:-1,gw:0},h={points:999,gw:0};k.forEach(i=>{const o=i.points||0;o>n.points&&(n={points:o,gw:i.gw}),o<h.points&&(h={points:o,gw:i.gw})}),n.points>=0&&(s.bestSingleGw=n),h.points<999&&(s.lowestSingleGw=h);const S=[],E=new Map;p.forEach((i,o)=>{const y=i.reduce(($,W)=>$+W.points,0)/i.length;E.set(o,y)}),k.forEach(i=>{const o=i.gw,y=i.points||0,$=E.get(o);$!==void 0&&S.push({gw:o,userPoints:y,averagePoints:$})}),S.sort((i,o)=>i.gw-o.gw),s.weeklyParData=S.length>0?S:null;let w={lastGw:0,form5:0,form10:0,overall:0};if(f&&c){console.log("[userStats] Calculating trophy cabinet...");const i=[...new Set(f.map($=>$.gw))].sort(($,W)=>$-W),{data:o}=await M.from("app_v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0}),{data:y}=await M.from("app_v_ocp_overall").select("user_id, name, ocp");i.forEach($=>{const W=ee(a,$,o||[]);if(W&&W.rank===1&&w.lastGw++,$>=5){const L=z(a,$-4,$,o||[],y||[]);L&&L.rank===1&&w.form5++}if($>=10){const L=z(a,$-9,$,o||[],y||[]);L&&L.rank===1&&w.form10++}const A=new Set;(o||[]).forEach(L=>{L.gw<=$&&A.add(L.user_id)});const U=Array.from(A).map(L=>{const J=(o||[]).filter(D=>D.user_id===L&&D.gw<=$).reduce((D,Q)=>D+(Q.points||0),0),X=(y||[]).find(D=>D.user_id===L);return{user_id:L,name:X?.name||null,ocp:J}}),O=te(a,U);O&&O.rank===1&&w.overall++}),console.log("[userStats] Trophy cabinet calculated:",w)}else console.log("[userStats] Skipping trophy calculation - missing data:",{hasCompletedGwResults:!!f,hasAllGwPoints:!!c});s.trophyCabinet=w}else s.trophyCabinet={lastGw:0,form5:0,form10:0,overall:0};if(j&&j.length>0){const d=new Set;if(j.forEach(u=>{d.add(`${u.gw}:${u.fixture_index}`)}),d.size>0){const u=Array.from(d).map(n=>parseInt(n.split(":")[0])),f=new Set(u),[c,C]=await Promise.all([M.from("app_picks").select("gw, fixture_index, pick").in("gw",Array.from(f)),M.from("picks").select("gw, fixture_index, pick").in("gw",Array.from(f))]),p=new Map;C.data&&C.data.forEach(n=>{const h=`${n.gw}:${n.fixture_index}`;if(d.has(h)){p.has(h)||p.set(h,new Map);const S=p.get(h);S.set(n.pick,(S.get(n.pick)||0)+1)}}),c.data&&c.data.forEach(n=>{const h=`${n.gw}:${n.fixture_index}`;if(d.has(h)){p.has(h)||p.set(h,new Map);const S=p.get(h);S.set(n.pick,(S.get(n.pick)||0)+1)}});let N=0;p.forEach(n=>{N+=Array.from(n.values()).reduce((h,S)=>h+S,0)}),console.log(`[userStats] Chaos Index: Checking ${j.length} user picks across ${d.size} fixtures`),console.log(`[userStats] Chaos Index: Found ${N} total picks from all users across all fixtures`);let G=0,R=0,T=0;const t=new Map;m&&m.forEach(n=>{n.result&&t.set(`${n.gw}:${n.fixture_index}`,n.result)});let r=!1;j.forEach(n=>{const h=`${n.gw}:${n.fixture_index}`,S=p.get(h);if(S){const E=Array.from(S.values()).reduce((o,y)=>o+y,0),w=S.get(n.pick)||0,i=E>0?w/E*100:0;if(!r&&E>0){const o=S.get("H")||0,y=S.get("D")||0,$=S.get("A")||0;console.log(`[userStats] Chaos Index sample: GW${n.gw} fixture ${n.fixture_index}, user picked ${n.pick}, totals: H=${o}, D=${y}, A=${$}, total=${E}, userPickPercentage=${i.toFixed(2)}%`),r=!0}if(T++,i<=25){G++;const o=t.get(h);o&&n.pick===o&&R++}}else console.warn(`[userStats] Chaos Index: No pick counts found for ${h}`)}),T>0&&(s.chaosIndex=G/T*100,s.chaosCorrectCount=R,s.chaosTotalCount=G,console.log(`[userStats] Chaos Index: ${s.chaosIndex.toFixed(2)}% (${G} of ${T} picks, ${R} correct)`),console.log(`[userStats] Chaos Index breakdown: ${T} total picks, ${G} chaos picks`))}}if(j&&m){const d=new Map;m.forEach(f=>{f.result&&d.set(`${f.gw}:${f.fixture_index}`,f.result)});const{data:u}=await M.from("app_fixtures").select("gw, fixture_index, home_code, away_code, home_team, away_team, home_name, away_name");if(u){const f=new Map;u.forEach(t=>{f.set(`${t.gw}:${t.fixture_index}`,t)});const c=new Map,C=new Map;j.forEach(t=>{C.set(`${t.gw}:${t.fixture_index}`,t.pick)});const p=[];if(u.forEach(t=>{const r=d.get(`${t.gw}:${t.fixture_index}`),n=C.get(`${t.gw}:${t.fixture_index}`);if(!r||!n)return;const h=t.home_name||t.home_team||"",S=t.away_name||t.away_team||"",E={code:t.home_code,name:t.home_code?Y(t.home_code):h},w={code:t.away_code,name:t.away_code?Y(t.away_code):S},i=n===r;if(E.code){const o=E.code.toUpperCase(),y=c.get(o)||{correct:0,total:0,code:E.code,name:E.name};y.total++,i&&y.correct++,c.set(o,y),(o==="BUR"||E.code.toUpperCase()==="BUR")&&p.push({gw:t.gw,fixture_index:t.fixture_index,home:E.name,away:w.name,pick:n,result:r,isCorrect:i})}if(w.code){const o=w.code.toUpperCase(),y=c.get(o)||{correct:0,total:0,code:w.code,name:w.name};y.total++,i&&y.correct++,c.set(o,y),(o==="BUR"||w.code.toUpperCase()==="BUR")&&p.push({gw:t.gw,fixture_index:t.fixture_index,home:E.name,away:w.name,pick:n,result:r,isCorrect:i})}}),p.length>0){console.log("[userStats] Burnley picks breakdown:",JSON.stringify(p,null,2));const t=c.get("BUR");t&&console.log("[userStats] Burnley final stats:",{correct:t.correct,total:t.total,percentage:(t.correct/t.total*100).toFixed(2)+"%"})}const N=Array.from(c.entries()).map(([t,r])=>({code:t,name:r.name,correct:r.correct,total:r.total,percentage:(r.correct/r.total*100).toFixed(2)}));console.log("[userStats] All team prediction stats:",JSON.stringify(N,null,2)),console.log("[userStats] Teams with >= 3 picks:",JSON.stringify(N.filter(t=>t.total>=3),null,2));let G=0;c.forEach(t=>{G+=t.total}),console.log("[userStats] Total picks processed for team stats:",G),console.log("[userStats] Total picks with fixtures and results:",j.filter(t=>{const r=f.get(`${t.gw}:${t.fixture_index}`),n=d.get(`${t.gw}:${t.fixture_index}`);return r&&n}).length);let R=null,T=null;c.forEach((t,r)=>{if(t.total>=3){const n=t.correct/t.total*100,h=(t.total-t.correct)/t.total*100;(!R||n>R.percentage)&&(R={code:t.code,name:t.name,percentage:n}),(!T||h>T.percentage)&&(T={code:t.code,name:t.name,percentage:h})}}),s.mostCorrectTeam=R,s.mostIncorrectTeam=T}}}catch(g){console.error("Error fetching user stats:",g)}return s}function ue({value:a,onChange:s,labels:g}){const l=g?.off||"ALL",x=g?.on||"LIVE";return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[10px] font-medium transition-colors ${a?"text-slate-400":"text-slate-700"}`,children:l}),e.jsx("button",{onClick:()=>s(!a),className:"relative inline-flex items-center rounded-full transition-colors focus:outline-none",style:{backgroundColor:a?"#dc2626":"#cbd5e1",width:"48px",height:"24px",border:"none"},"aria-label":a?`Show ${l}`:`Show ${x}`,children:e.jsx("span",{className:`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-200 ease-in-out ${a?"translate-x-6":"translate-x-0.5"}`})}),e.jsx("span",{className:`text-[10px] font-medium transition-colors ${a?"text-slate-700":"text-slate-400"}`,children:x})]})}async function fe(a){if(!a)return[];try{const s=await re(a);if(s.length===0)return[];const g=s.map(t=>t.id),{data:l,error:x}=await M.from("league_members").select("league_id, user_id").in("league_id",g);if(x)throw x;const b=new Map;l?.forEach(t=>{const r=b.get(t.league_id)||[];r.push(t.user_id),b.set(t.league_id,r)});const{data:_,error:P}=await M.from("app_gw_results").select("gw, fixture_index, result").order("gw",{ascending:!1});if(P)throw P;const j=new Map;_?.forEach(t=>{t.result&&j.set(`${t.gw}:${t.fixture_index}`,t.result)});const m=Array.from(new Set(l?.map(t=>t.user_id)||[]));if(m.length===0)return[];const{data:v,error:k}=await M.from("app_picks").select("user_id, gw, fixture_index, pick").in("user_id",m);if(k)throw k;const d=Array.from(new Set(_?.map(t=>t.gw)||[]));if(d.length===0)return[];const{data:u}=await M.from("app_meta").select("current_gw").eq("id",1).maybeSingle(),f=u?.current_gw??Math.max(...d,0),{data:c,error:C}=await M.from("app_fixtures").select("gw, fixture_index, home_team, away_team, home_code, away_code, home_name, away_name, kickoff_time, api_match_id").in("gw",d).order("gw",{ascending:!1}).order("fixture_index",{ascending:!0});if(C)throw C;const p=new Map;c?.forEach(t=>{t.api_match_id||p.set(`${t.gw}:${t.fixture_index}`,t)});const N=[];console.log("[Unicorns] Starting calculation for user:",a),console.log("[Unicorns] User leagues:",s.map(t=>({name:t.name,id:t.id,members:b.get(t.id)?.length||0}))),console.log("[Unicorns] Total results available:",j.size),console.log("[Unicorns] Total picks available:",v?.length||0),console.log("[Unicorns] User picks count:",v?.filter(t=>t.user_id===a).length||0),console.log("[Unicorns] Total fixtures available:",p.size),console.log("[Unicorns] Current GW:",f);for(const t of s){if(t.name==="API Test"){console.log(`[Unicorns] Skipping "${t.name}" - test league`);continue}const r=b.get(t.id)||[];if(r.length<3){console.log(`[Unicorns] Skipping "${t.name}" - only ${r.length} members`);continue}const n=await se(t,f);console.log(`[Unicorns] Processing "${t.name}" with ${r.length} members, start GW: ${n}`);const h=v?.filter(w=>r.includes(w.user_id)&&w.gw>=n)||[];console.log(`[Unicorns] "${t.name}" has ${h.length} picks total (filtered from start GW ${n})`);const S=new Map;h.forEach(w=>{const i=`${w.gw}:${w.fixture_index}`,o=S.get(i)||[];o.push({user_id:w.user_id,pick:w.pick}),S.set(i,o)});let E=0;S.forEach((w,i)=>{const[o,y]=i.split(":").map(Number);if(o<n){a==="f8a1669e-2512-4edf-9c21-b9f87b3efbe2"&&console.log(`[Unicorns] [DEBUG] ${t.name} GW${o} fixture ${y}: Skipped (before league start GW ${n})`);return}const $=j.get(i);if(!$){a==="f8a1669e-2512-4edf-9c21-b9f87b3efbe2"&&console.log(`[Unicorns] [DEBUG] ${t.name} GW${o} fixture ${y}: Skipped (no result)`);return}const W=w.find(U=>U.user_id===a);if(!W){a==="f8a1669e-2512-4edf-9c21-b9f87b3efbe2"&&console.log(`[Unicorns] [DEBUG] ${t.name} GW${o} fixture ${y}: Skipped (user didn't make pick)`);return}const A=w.filter(U=>U.pick===$).map(U=>U.user_id);if(a==="f8a1669e-2512-4edf-9c21-b9f87b3efbe2"){const U=p.get(i),O=U?`${U.home_team} vs ${U.away_team}`:"unknown";console.log(`[Unicorns] [DEBUG] ${t.name} GW${o} fixture ${y} (${O}):`,{result:$,userPick:W.pick,correctUsers:A.length,correctUserIds:A,isUserCorrect:A.includes(a),picksCount:w.length,membersCount:r.length,wouldBeUnicorn:A.length===1&&A[0]===a&&r.length>=3})}if(A.length===1&&A[0]===a&&r.length>=3){const U=p.get(i);U?(E++,N.push({fixture_index:y,gw:o,home_team:U.home_team,away_team:U.away_team,home_code:U.home_code,away_code:U.away_code,home_name:U.home_name,away_name:U.away_name,kickoff_time:U.kickoff_time,pick:W.pick,league_id:t.id,league_name:t.name})):a==="f8a1669e-2512-4edf-9c21-b9f87b3efbe2"&&console.log(`[Unicorns] [DEBUG] ${t.name} GW${o} fixture ${y}: Would be unicorn but fixture not found in fixturesMap`)}}),E>0&&console.log(`[Unicorns] "${t.name}" found ${E} unicorns`)}console.log(`[Unicorns] Found ${N.length} total unicorns before grouping`);const G=new Map;N.forEach(t=>{const r=`${t.gw}:${t.fixture_index}`,n=G.get(r);n?n.league_names.includes(t.league_name)||n.league_names.push(t.league_name):G.set(r,{fixture_index:t.fixture_index,gw:t.gw,home_team:t.home_team,away_team:t.away_team,home_code:t.home_code,away_code:t.away_code,home_name:t.home_name,away_name:t.away_name,kickoff_time:t.kickoff_time,pick:t.pick,league_names:[t.league_name]})});const R=Array.from(G.values()),T=R.filter(t=>t.league_names.includes("Prem Predictions"));return console.log("[Unicorns] Prem Predictions unicorns:",T.map(t=>`GW${t.gw} fixture ${t.fixture_index} (leagues: ${t.league_names.join(", ")})`)),console.log(`[Unicorns] Found ${R.length} unique fixtures after grouping`),R.sort((t,r)=>t.gw!==r.gw?t.gw-r.gw:t.fixture_index-r.fixture_index),R}catch(s){return console.error("[Unicorns] Error fetching unicorns:",s),[]}}function ge({fixture:a,leagueNames:s,isActive:g=!1}){const l=a.home_code||a.home_name||a.home_team||"",x=a.away_code||a.away_name||a.away_team||"",b=q(l)||a.home_name||a.home_team||"Home",_=q(x)||a.away_name||a.away_name||"Away",P=a.pick==="H"?"Home Win":a.pick==="A"?"Away Win":"Draw",j={id:`${a.gw}-${a.fixture_index}`,fixture_index:a.fixture_index,home_team:b,away_team:_,home_code:a.home_code,away_code:a.away_code,home_name:b,away_name:_,kickoff_time:a.kickoff_time},m=g?1:.92,v=g?1:.75;return e.jsxs("div",{className:"flex-shrink-0 relative",style:{scrollSnapAlign:"center",transform:`scale(${m})`,opacity:v,width:"280px",willChange:"transform, opacity",transition:"transform 500ms cubic-bezier(0.4, 0, 0.2, 1), opacity 500ms cubic-bezier(0.4, 0, 0.2, 1)"},children:[e.jsx("style",{children:`
        .unicorn-card-wrapper {
          position: relative;
        }
        .unicorn-card-wrapper > div:first-child {
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
          position: relative;
        }
        .unicorn-card-wrapper > div:first-child > div:first-child {
          padding-top: 1.5rem !important;
        }
        .unicorn-card-wrapper .flex.items-center.gap-1\\.5.mt-3 {
          display: none !important;
        }
        .unicorn-card-wrapper > div.absolute {
          box-shadow: none !important;
        }
        .unicorn-card-wrapper::before {
          content: '';
          position: absolute;
          inset: 0;
          border-radius: 1.5rem;
          padding: 10px;
          background: linear-gradient(135deg, #fbbf24, #f97316, #ec4899, #9333ea, #fbbf24);
          background-size: 300% 300%;
          -webkit-mask: 
            linear-gradient(#fff 0 0) content-box, 
            linear-gradient(#fff 0 0);
          -webkit-mask-composite: xor;
          mask-composite: exclude;
          animation: gradient-shift 3s ease infinite;
          pointer-events: none;
          z-index: 100;
        }
        @keyframes gradient-shift {
          0%, 100% {
            background-position: 0% 50%;
          }
          50% {
            background-position: 100% 50%;
          }
        }
        .shiny-pick-badge {
          background: linear-gradient(135deg, #fbbf24, #f97316, #ec4899, #9333ea, #fbbf24);
          background-size: 300% 300%;
          animation: gradient-shift 3s ease infinite;
          color: white;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
      `}),e.jsxs("div",{className:"relative unicorn-card-wrapper",children:[e.jsx(ie,{fixture:j,showSwipeHint:!1}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 pt-6 px-4 pb-8 rounded-b-3xl",style:{background:"linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.65) 25%, rgba(0, 0, 0, 0.45) 45%, rgba(0, 0, 0, 0.25) 65%, rgba(0, 0, 0, 0.1) 80%, transparent 100%)"},children:[e.jsx("div",{className:"text-white text-sm font-semibold text-center mb-2",children:e.jsx("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full shiny-pick-badge",children:P})}),e.jsx("div",{className:"text-white text-sm font-semibold text-center",children:s.length===1?s[0]:e.jsx("div",{className:"space-y-1",children:e.jsx("div",{children:s.join(", ")})})}),e.jsxs("div",{className:"text-white/80 text-xs text-center mt-1",children:["GW",a.gw]})]})]})]})}function he({userId:a,loading:s}){const[g,l]=F.useState([]),[x,b]=F.useState(!0),[_,P]=F.useState(0),[j,m]=F.useState(!1),v=F.useRef(null),k=F.useRef([]);F.useEffect(()=>{if(!a){b(!1);return}let u=!0;async function f(){b(!0);try{const c=await fe(a);u&&(k.current=[],l(c),P(0))}catch(c){console.error("[UnicornCollection] Error loading unicorns:",c),u&&(l([]),P(0))}finally{u&&b(!1)}}return f(),()=>{u=!1}},[a]),F.useEffect(()=>{if(g.length===0||!v.current)return;const u=v.current;let f=null,c=!1;const C=()=>{if(!v.current)return;const r=v.current.getBoundingClientRect();if(r.width===0){setTimeout(C,50);return}if(!k.current.every((w,i)=>i>=g.length?!0:w!==null)){setTimeout(C,50);return}if(k.current[0]&&k.current[0].getBoundingClientRect().width===0){setTimeout(C,50);return}const h=r.left+r.width/2;let S=0,E=1/0;k.current.forEach((w,i)=>{if(w&&i<g.length){const o=w.getBoundingClientRect(),y=o.left+o.width/2,$=Math.abs(y-h);$<E&&(E=$,S=i)}}),P(S)},p=()=>{c||(f=requestAnimationFrame(()=>{C(),c=!1}),c=!0)};u.addEventListener("scroll",p,{passive:!0});const N=()=>{u.scrollLeft===0&&k.current[0],C()},G=setTimeout(()=>{N()},0),R=setTimeout(()=>{N()},100),T=setTimeout(()=>{N()},300),t=()=>{C()};return window.addEventListener("resize",t,{passive:!0}),()=>{clearTimeout(G),clearTimeout(R),clearTimeout(T),f!==null&&cancelAnimationFrame(f),u.removeEventListener("scroll",p),window.removeEventListener("resize",t)}},[g.length,g]);const d=s||x;return s?null:d?e.jsxs("div",{className:"bg-white rounded-xl p-6",style:{marginRight:"-100vw",paddingRight:"100vw"},children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-4 flex items-center gap-2",children:e.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Your Unicorns"})}),e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]}):g.length===0?e.jsxs("div",{className:"bg-white rounded-xl p-6",children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-2",children:"Your Unicorns"}),e.jsxs("div",{className:"text-slate-500 text-sm",children:["You have ",e.jsx("span",{className:"font-semibold",children:"0 unicorns"})," overall. Keep predicting to earn your first unicorn!"]})]}):e.jsxs("div",{className:"bg-white rounded-xl p-6",style:{marginRight:"-100vw",paddingRight:"100vw"},children:[e.jsxs("div",{className:"text-sm font-medium text-slate-600 mb-4 flex items-center gap-2",style:{paddingLeft:"1.5rem",marginLeft:"-1.5rem"},children:[e.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Your Unicorns"}),e.jsx("div",{className:"w-4 h-4 rounded-full border border-slate-400 flex items-center justify-center hover:bg-slate-50 transition-colors cursor-pointer",onClick:()=>m(!0),role:"button","aria-label":"Information about Unicorns",children:e.jsx("span",{className:"text-[10px] text-slate-500 font-bold",children:"i"})})]}),e.jsxs("div",{ref:v,className:"flex gap-0 overflow-x-auto pb-2 scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch",overscrollBehaviorX:"contain",scrollBehavior:"smooth",scrollSnapType:"x mandatory",marginLeft:"-1.5rem",marginRight:"-1.5rem",paddingLeft:"calc(50vw - 140px + 1.5rem)",paddingRight:"calc(50vw - 140px)",width:"calc(100% + 3rem)"},children:[e.jsx("style",{children:".scrollbar-hide::-webkit-scrollbar { display: none; }"}),g.map((u,f)=>e.jsx("div",{ref:c=>{k.current[f]=c},children:e.jsx(ge,{fixture:u,leagueNames:u.league_names,isActive:f===_})},`${u.gw}-${u.fixture_index}-${f}`))]}),e.jsxs("div",{className:"text-sm font-bold text-slate-800 mt-4 text-center",children:[g.length," ",g.length===1?"unicorn":"unicorns"," overall"]}),e.jsx(K,{isOpen:j,onClose:()=>m(!1),title:"Unicorns",description:`A unicorn is a unique correct prediction in a mini-league.

Only applies to mini-leagues with 3+ players.

Each card shows the fixture you correctly predicted, what you picked, and which mini-leagues you earned the unicorn in.`})]})}function be(){const{user:a}=ae(),[s,g]=F.useState(null),[l,x]=F.useState(!0),[b,_]=F.useState(!1);F.useEffect(()=>{a?P():x(!1)},[a]);async function P(){if(a){x(!0);try{console.log("[Stats] Fetching user stats for user:",a.id);const m=await me(a.id);console.log("[Stats] Fetched stats:",m),console.log("[Stats] Trophy cabinet:",m?.trophyCabinet),g(m)}catch(m){console.error("[Stats] Error loading stats:",m)}finally{x(!1)}}}if(!a)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsx("div",{className:"bg-white rounded-xl shadow-md p-6 text-center",children:e.jsx("p",{className:"text-slate-600",children:"Please sign in to view your stats."})})})});const j=s&&(s.lastCompletedGw!==null||s.overallPercentile!==null);return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 overflow-x-hidden",children:[e.jsx("style",{children:`
        @keyframes sparkle {
          0%, 100% {
            opacity: 1;
            transform: scale(1) rotate(0deg);
          }
          25% {
            opacity: 0.9;
            transform: scale(1.05) rotate(-3deg);
          }
          50% {
            opacity: 1;
            transform: scale(1.1) rotate(3deg);
          }
          75% {
            opacity: 0.9;
            transform: scale(1.05) rotate(-3deg);
          }
        }
        .sparkle-trophy {
          animation: sparkle 2s ease-in-out infinite;
          filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.6));
        }
      `}),e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs(oe,{to:"/profile",className:"inline-flex items-center gap-2 text-slate-600 hover:text-slate-800 mb-4 transition-colors",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),e.jsx("span",{children:"Back to Profile"})]}),e.jsx(ne,{title:"Stats",as:"h1",className:"mb-6"}),!j&&!l?e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-8 text-center",children:[e.jsx("p",{className:"text-slate-600 text-lg",children:"Not enough games yet — check back after a few Gameweeks."}),e.jsx("p",{className:"text-slate-500 text-sm mt-2",children:"The numbers will start to tell a story soon."})]}):e.jsxs("div",{className:"space-y-6",children:[s&&s.lastCompletedGw!==null&&s.lastCompletedGwPercentile!==null&&(()=>{const m=s.lastCompletedGwPercentile,v=Math.round(100-m),k=Math.round(m),d=m>=75;return e.jsx(B,{label:`Gameweek ${s.lastCompletedGw}`,value:d?`You were in the top ${v}% of players.`:`You were in the bottom ${k}% of players.`,loading:l})})(),s&&s.overallPercentile!==null&&(()=>{const m=s.overallPercentile,v=Math.round(100-m),k=Math.round(m),d=m>=75;return e.jsx(B,{label:"Overall",value:d?`You're in the top ${v}% of players.`:`You're in the bottom ${k}% of players.`,loading:l})})(),s&&s.mostCorrectTeam&&e.jsx(V,{label:"Most correctly predicted team",teamCode:s.mostCorrectTeam.code,teamName:s.mostCorrectTeam.name,percentage:s.mostCorrectTeam.percentage,isCorrect:!0,loading:l}),s&&s.mostIncorrectTeam&&e.jsx(V,{label:"Most incorrectly picked team",teamCode:s.mostIncorrectTeam.code,teamName:s.mostIncorrectTeam.name,percentage:s.mostIncorrectTeam.percentage,isCorrect:!1,loading:l}),s&&s.correctPredictionRate!==null&&e.jsx(B,{label:"Correct prediction rate",value:`${s.correctPredictionRate.toFixed(2)}%`,loading:l}),s&&s.trophyCabinet!==null&&e.jsx(de,{lastGw:s.trophyCabinet.lastGw,form5:s.trophyCabinet.form5,form10:s.trophyCabinet.form10,overall:s.trophyCabinet.overall,loading:l}),a&&e.jsx(he,{userId:a.id,loading:l}),s&&s.chaosIndex!==null&&e.jsx(B,{label:"Chaos Index",value:`${s.chaosIndex.toFixed(2)}%`,subcopy:"How often you pick an outcome that 25% or fewer players picked",loading:l}),s&&s.chaosTotalCount!==null&&s.chaosTotalCount>0&&s.chaosCorrectCount!==null&&e.jsx(B,{label:"Chaos Index Success Rate",value:`${(s.chaosCorrectCount/s.chaosTotalCount*100).toFixed(2)}%`,subcopy:"How often you're right when you pick an outcome that 25% or fewer players picked",loading:l}),s&&s.weeklyParData&&s.weeklyParData.length>0&&s.lastCompletedGw&&(()=>{const v=(s.weeklyParData.filter(k=>k.userPoints>k.averagePoints).length/s.weeklyParData.length*100).toFixed(0);return e.jsxs("div",{className:"bg-white rounded-l-xl shadow-md",style:{marginRight:"-100vw",paddingRight:"100vw",paddingTop:"1.5rem",paddingBottom:"1.5rem",paddingLeft:"1.5rem"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm font-medium text-slate-600",children:"Weekly Performance vs Average"}),e.jsx("div",{className:"pr-2",children:e.jsx(ue,{value:b,onChange:_,labels:{on:"Complex",off:"Simple"}})})]}),e.jsxs("div",{className:"overflow-x-auto scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch",overscrollBehaviorX:"contain",overscrollBehaviorY:"auto",touchAction:"pan-x",marginLeft:"-1.5rem",marginRight:"-1.5rem",paddingLeft:"1.5rem",paddingRight:"1.5rem",width:"calc(100% + 3rem)"},children:[e.jsx("style",{children:".scrollbar-hide::-webkit-scrollbar { display: none; }"}),e.jsx(ce,{weeklyData:s.weeklyParData,latestGw:s.lastCompletedGw,showInfo:b})]}),e.jsxs("div",{className:"text-sm font-bold text-slate-700 mt-2",children:["You perform above average ",v,"% of the time."]})]})})(),s&&s.weeklyParData&&s.weeklyParData.length>0&&(()=>{const m=s.weeklyParData.reduce((k,d)=>k+(d.userPoints-d.averagePoints),0),v=m>=0?`+${m.toFixed(1)}`:m.toFixed(1);return v==="0.0"?null:e.jsx(B,{label:"Total Swing",value:v,subcopy:"Your total points difference from the average across all gameweeks",loading:l})})(),s&&s.bestStreak>0&&s.bestStreakGwRange&&e.jsx(le,{label:"Most consecutive weeks in the top 25%",streakCount:s.bestStreak,gwRange:s.bestStreakGwRange,loading:l}),s&&s.avgPointsPerWeek!==null&&e.jsx(B,{label:"Avg points / week",value:s.avgPointsPerWeek.toFixed(2),loading:l}),s&&s.bestSingleGw&&e.jsx(B,{label:"Best single Gameweek",value:e.jsxs("span",{children:[e.jsx("span",{className:"text-2xl font-bold text-slate-800",children:s.bestSingleGw.points}),e.jsxs("span",{className:"text-sm text-slate-600 ml-2",children:["on GW",s.bestSingleGw.gw]})]}),loading:l}),s&&s.lowestSingleGw&&e.jsx(B,{label:"Lowest single Gameweek",value:e.jsxs("span",{children:[e.jsx("span",{className:"text-2xl font-bold text-slate-800",children:s.lowestSingleGw.points}),e.jsxs("span",{className:"text-sm text-slate-600 ml-2",children:["on GW",s.lowestSingleGw.gw]})]}),loading:l})]})]})]})}export{be as default};
