import{R as H,j as e,T as ie,r as R,I as re,s as k,x as ne,y as I,z as O,A as K,k as ce,b as J,B as de,u as le,E as me,F as X,m as Q,l as Z,G as ee,H as fe,J as ue,n as te,L as he,P as xe}from"./index-Cm3fkH8V.js";import{f as ge}from"./userLeagues-BHk0FFLQ.js";const D=H.memo(function({label:t,value:x,subcopy:v,loading:_=!1,className:$=""}){if(_)return e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${$}`,children:[e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:t}),e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]});const C=typeof x=="object"&&x!==null;return e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${$}`,children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-2",children:t}),e.jsx("div",{className:`mb-1 flex items-baseline ${C?"":"text-2xl font-bold text-slate-800"}`,children:x}),v&&e.jsx("div",{className:"text-sm text-slate-500 mt-2",children:v})]})}),pe=H.memo(function({label:t,streakCount:x,gwRange:v,subcopy:_,extraLine:$,loading:C=!1,className:S=""}){return C?e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${S}`,children:[e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:t}),e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]}):e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${S}`,children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-2",children:t}),e.jsxs("div",{className:"text-4xl font-bold text-slate-800 mb-2 flex items-baseline gap-2",children:[e.jsx("span",{children:x}),e.jsxs("span",{className:"text-base font-normal text-slate-600",children:["Top 25% from ",v]})]}),$&&e.jsxs("div",{className:"text-sm text-slate-500 italic mb-2",children:['"',$,'"']}),_&&e.jsxs("div",{className:"text-sm text-slate-500 mt-2 italic",children:['"',_,'"']})]})}),se=H.memo(function({label:t,teamCode:x,teamName:v,percentage:_,isCorrect:$,subcopy:C,loading:S=!1,className:G=""}){if(S)return e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${G}`,children:[e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:t}),e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]});const T=_%1===0?_.toFixed(0):_.toFixed(2);return e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${G}`,children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-3",children:t}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ie,{code:x,size:32}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-lg font-bold text-slate-800 truncate",children:v}),e.jsxs("div",{className:`text-base font-semibold ${$?"text-green-600":"text-red-600"}`,children:[T,"% ",$?"correct":"incorrect"]})]})]}),C&&e.jsxs("div",{className:"text-sm text-slate-500 mt-3 italic",children:['"',C,'"']})]})}),we=H.memo(function({weeklyData:t,latestGw:x,showInfo:v=!1}){const _=t.flatMap(h=>[h.userPoints,h.averagePoints]),$=_.length>0?Math.max(..._,10):10,C=0,S=$-C||1,G=120,T=48,M=8,L=12,a=4,g=v?48:16,b=Math.max(340,t.length*T+(t.length-1)*M+L*2+a*2+g);return e.jsx("div",{className:"flex-shrink-0 h-[168px] bg-white relative",style:{width:`${b}px`,minWidth:`${b}px`},children:e.jsxs("div",{className:"pt-3 pb-2 h-full flex flex-col",style:{paddingLeft:"0",paddingRight:"12px"},children:[e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"mb-1 relative",style:{height:"120px"},children:e.jsx("div",{className:"relative h-full",children:e.jsx("div",{className:"flex items-end gap-2 h-full",style:{paddingLeft:"0",paddingRight:"4px"},children:t.map(h=>{const{gw:N,userPoints:y,averagePoints:m}=h,E=N===x,w=y-m,d=w>0,s=w<0,r=(y-C)/S*G,l=(m-C)/S*G,i=Math.max(r,l);return e.jsxs("div",{className:"flex flex-col items-center justify-end relative",style:{minWidth:"48px",width:"48px",height:"100%"},children:[e.jsxs("div",{className:"w-full relative",style:{height:`${i}px`},children:[v&&e.jsx("div",{className:"absolute flex items-center justify-center",style:{bottom:`${i+4}px`,left:"0",right:"0",width:"100%",zIndex:10},children:e.jsx("div",{className:`text-xs font-bold leading-none ${E?"text-[#1C8376]":d?"text-green-600":s?"text-red-600":"text-slate-700"}`,children:y})}),d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute bottom-0 w-full bg-slate-300 opacity-60",style:{height:`${l}px`,minHeight:l>0?"2px":"0",borderTopLeftRadius:"2px",borderTopRightRadius:l===i?"2px":"0"},title:`Par: ${m.toFixed(1)}`}),e.jsx("div",{className:"absolute w-full transition-all bg-green-500",style:{bottom:`${l}px`,height:`${r-l}px`,minHeight:r-l>0?"2px":"0",borderTopLeftRadius:"2px",borderTopRightRadius:"2px"},title:`Your score: ${y}`})]}):s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute bottom-0 w-full transition-all bg-red-500",style:{height:`${r}px`,minHeight:r>0?"2px":"0",borderTopLeftRadius:r===i?"2px":"0",borderTopRightRadius:r===i?"2px":"0"},title:`Your score: ${y}`}),e.jsx("div",{className:"absolute w-full bg-slate-300 opacity-60",style:{bottom:`${r}px`,height:`${l-r}px`,minHeight:l-r>0?"2px":"0",borderTopLeftRadius:"2px",borderTopRightRadius:"2px"},title:`Par: ${m.toFixed(1)}`})]}):e.jsx("div",{className:"absolute bottom-0 w-full rounded-t bg-slate-400 transition-all",style:{height:`${r}px`,minHeight:r>0?"4px":"0",borderRadius:"2px 2px 0 0"},title:`Your score: ${y} (Par: ${m.toFixed(1)})`}),i>15&&e.jsx("div",{className:"absolute bottom-1 left-0 right-0 flex items-center justify-center",style:{height:"16px"},children:e.jsx("div",{className:`text-[13px] leading-none ${d?"text-green-600":"text-white"}`,style:{fontWeight:900},children:d?`+${w.toFixed(1)}`:s?`${w.toFixed(1)}`:"Par"})})]}),e.jsxs("div",{className:"flex flex-col items-center justify-start",style:{height:"28px",marginTop:"4px"},children:[e.jsxs("div",{className:`text-[10px] font-medium leading-tight ${E?"text-[#1C8376] font-bold":"text-slate-700"}`,children:["GW",N]}),e.jsxs("div",{className:"text-[9px] font-medium text-slate-400 leading-none",style:{visibility:v?"visible":"hidden",height:"12px"},children:["av. ",m.toFixed(1)]})]})]},N)})})})})]})})}),be=H.memo(function({lastGw:t,form5:x,form10:v,overall:_,loading:$=!1}){const[C,S]=R.useState(!1),G=[{label:"Gameweek",count:t},{label:"5-Week Form",count:x},{label:"10-Week Form",count:v},{label:"Overall",count:_}],T=t+x+v+_;return $?e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6",children:[e.jsx("div",{className:"text-sm text-slate-500 mb-4",children:"Leaderboard Trophy Cabinet"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[1,2,3,4].map(M=>e.jsx("div",{className:"h-24 bg-slate-200 rounded animate-pulse"},M))})]}):e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[e.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Leaderboard Trophy Cabinet"}),e.jsx("div",{className:"w-4 h-4 rounded-full border border-slate-400 flex items-center justify-center hover:bg-slate-50 transition-colors cursor-pointer",onClick:()=>S(!0),role:"button","aria-label":"Information about Trophy Cabinet",children:e.jsx("span",{className:"text-[10px] text-slate-500 font-bold",children:"i"})})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:G.map((M,L)=>e.jsxs("div",{className:"flex flex-col items-center justify-center p-4 bg-slate-50 rounded-lg border border-slate-200 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:`w-10 h-10 text-yellow-500 ${M.count>0?"sparkle-trophy":"opacity-40"}`,children:e.jsx("g",{children:e.jsx("path",{fill:"currentColor",d:"M16 3c1.1046 0 2 0.89543 2 2h2c1.1046 0 2 0.89543 2 2v1c0 2.695 -2.1323 4.89 -4.8018 4.9941 -0.8777 1.5207 -2.4019 2.6195 -4.1982 2.9209V19h3c0.5523 0 1 0.4477 1 1s-0.4477 1 -1 1H8c-0.55228 0 -1 -0.4477 -1 -1s0.44772 -1 1 -1h3v-3.085c-1.7965 -0.3015 -3.32148 -1.4 -4.19922 -2.9209C4.13175 12.8895 2 10.6947 2 8V7c0 -1.10457 0.89543 -2 2 -2h2c0 -1.10457 0.89543 -2 2 -2zm-8 7c0 2.2091 1.79086 4 4 4 2.2091 0 4 -1.7909 4 -4V5H8zM4 8c0 1.32848 0.86419 2.4532 2.06055 2.8477C6.02137 10.5707 6 10.2878 6 10V7H4zm14 2c0 0.2878 -0.0223 0.5706 -0.0615 0.8477C19.1353 10.4535 20 9.32881 20 8V7h-2z",strokeWidth:"1"})})}),M.count>0&&e.jsx("div",{className:"absolute -top-1 -right-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center border-2 border-white",children:M.count})]}),e.jsx("div",{className:"text-xs font-medium text-slate-600 text-center",children:M.label})]},L))}),T>0&&e.jsxs("div",{className:"mt-4 text-sm font-semibold text-slate-600 text-center",children:["You have ",T," ",T===1?"trophy":"trophies"]}),e.jsx(re,{isOpen:C,onClose:()=>S(!1),title:"Leaderboard Trophy Cabinet",description:`Earn trophies by finishing top (or joint top) of any leaderboard after a gameweek completes.

GAMEWEEK
Finish #1 in the weekly leaderboard for any completed gameweek.

5-WEEK FORM
Finish #1 in the 5-week form leaderboard after any gameweek. Requires 5+ completed gameweeks.

10-WEEK FORM
Finish #1 in the 10-week form leaderboard after any gameweek. Requires 10+ completed gameweeks.

OVERALL
Finish #1 in the overall season leaderboard after any gameweek.`})]})});function Y(o,t){if(t.length===0)return 50;const v=t.filter(_=>_<=o).length/t.length*100;return Math.round(v*100)/100}async function ve(o){const t={lastCompletedGw:null,lastCompletedGwPercentile:null,overallPercentile:null,correctPredictionRate:null,bestStreak:0,bestStreakGwRange:null,avgPointsPerWeek:null,bestSingleGw:null,lowestSingleGw:null,chaosIndex:null,chaosCorrectCount:null,chaosTotalCount:null,mostCorrectTeam:null,mostIncorrectTeam:null,weeklyParData:null,trophyCabinet:null};try{const{data:x}=await k.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),v=x?.gw||null;if(t.lastCompletedGw=v,!v)return t;if(v){const{data:a}=await k.from("app_v_gw_points").select("user_id, points").eq("gw",v);if(a&&a.length>0){const g=a.map(h=>h.points||0),b=a.find(h=>h.user_id===o)?.points||0;t.lastCompletedGwPercentile=Y(b,g)}}const{data:_}=await k.from("v_ocp_overall").select("user_id, ocp").order("ocp",{ascending:!1});if(_&&_.length>0){const a=_.map(b=>b.ocp||0),g=_.find(b=>b.user_id===o)?.ocp||0;t.overallPercentile=Y(g,a)}const[$,C]=await Promise.all([k.from("app_picks").select("gw, fixture_index, pick").eq("user_id",o),k.from("picks").select("gw, fixture_index, pick").eq("user_id",o)]),S=new Map;C.data&&C.data.forEach(a=>{const g=`${a.gw}:${a.fixture_index}`;S.set(g,a)}),$.data&&$.data.forEach(a=>{const g=`${a.gw}:${a.fixture_index}`;S.set(g,a)});const G=Array.from(S.values());console.log("[userStats] Picks from app_picks:",$.data?.length||0),console.log("[userStats] Picks from picks table:",C.data?.length||0),console.log("[userStats] Total unique picks (combined):",G.length),$.error&&console.error("[userStats] Error fetching app_picks:",$.error),C.error&&C.error.code!=="PGRST116"&&console.error("[userStats] Error fetching picks:",C.error);const{data:T,error:M}=await k.from("app_gw_results").select("gw, fixture_index, result");if(console.log("[userStats] Total results fetched:",T?.length||0),M&&console.error("[userStats] Error fetching results:",M),G&&T){const a=new Map;T.forEach(h=>{h.result&&a.set(`${h.gw}:${h.fixture_index}`,h.result)});let g=0,b=0;G.forEach(h=>{const N=a.get(`${h.gw}:${h.fixture_index}`);N&&(b++,h.pick===N&&g++)}),b>0&&(t.correctPredictionRate=g/b*100)}const{data:L}=await k.from("app_v_gw_points").select("gw, points").eq("user_id",o).order("gw",{ascending:!0});if(L&&L.length>0){const a=L.reduce((c,n)=>c+(n.points||0),0);t.avgPointsPerWeek=a/L.length;const g=new Set,{data:b}=await k.from("app_gw_results").select("gw").order("gw",{ascending:!0});b?.forEach(c=>{g.add(c.gw)});const{data:h}=await k.from("app_v_gw_points").select("gw, user_id, points").in("gw",Array.from(g)),N=new Map,y=new Map;h&&h.forEach(c=>{const n=c.gw;y.has(n)||y.set(n,[]),y.get(n).push({user_id:c.user_id,points:c.points||0})});for(const c of Array.from(g).sort((n,f)=>n-f)){const n=y.get(c);if(n&&n.length>0){const f=n.map(U=>U.points),u=n.find(U=>U.user_id===o)?.points||0,F=Y(u,f);N.set(c,F)}}let m=0,E=0,w=0,d=0,s=0;const r=Array.from(g).sort((c,n)=>c-n);console.log("[userStats] Calculating best streak. Completed GWs:",r),console.log("[userStats] User percentiles per GW:",Array.from(N.entries()).map(([c,n])=>({gw:c,percentile:n.toFixed(2),inTop25:n>=75})));for(const c of r){const n=N.get(c);n!==void 0&&n>=75?(m===0&&(s=c),m++,m>E&&(E=m,w=s,d=c)):(m>0&&console.log(`[userStats] Streak broken at GW${c} (percentile: ${n?.toFixed(2)||"N/A"}). Previous streak was ${m} games`),m=0)}t.bestStreak=E,E>0?(t.bestStreakGwRange=`GW${w}â€“GW${d}`,console.log(`[userStats] Best streak: ${E} games from ${t.bestStreakGwRange}`)):console.log("[userStats] No streak found (user never in top 25%)");let l={points:-1,gw:0},i={points:999,gw:0};L.forEach(c=>{const n=c.points||0;n>l.points&&(l={points:n,gw:c.gw}),n<i.points&&(i={points:n,gw:c.gw})}),l.points>=0&&(t.bestSingleGw=l),i.points<999&&(t.lowestSingleGw=i);const P=[],W=new Map;y.forEach((c,n)=>{const f=c.reduce((u,F)=>u+F.points,0)/c.length;W.set(n,f)}),L.forEach(c=>{const n=c.gw,f=c.points||0,u=W.get(n);u!==void 0&&P.push({gw:n,userPoints:f,averagePoints:u})}),P.sort((c,n)=>c.gw-n.gw),t.weeklyParData=P.length>0?P:null;let j={lastGw:0,form5:0,form10:0,overall:0};if(b&&h){console.log("[userStats] Calculating trophy cabinet...");const c=[...new Set(b.map(u=>u.gw))].sort((u,F)=>u-F),{data:n}=await k.from("app_v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0}),{data:f}=await k.from("app_v_ocp_overall").select("user_id, name, ocp");c.forEach(u=>{const F=ne(o,u,n||[]);if(F&&F.rank===1&&j.lastGw++,u>=5){const A=I(o,u-4,u,n||[],f||[]);A&&A.rank===1&&j.form5++}if(u>=10){const A=I(o,u-9,u,n||[],f||[]);A&&A.rank===1&&j.form10++}const U=new Set;(n||[]).forEach(A=>{A.gw<=u&&U.add(A.user_id)});const p=Array.from(U).map(A=>{const V=(n||[]).filter(z=>z.user_id===A&&z.gw<=u).reduce((z,oe)=>z+(oe.points||0),0),q=(f||[]).find(z=>z.user_id===A);return{user_id:A,name:q?.name||null,ocp:V}}),B=O(o,p);B&&B.rank===1&&j.overall++}),console.log("[userStats] Trophy cabinet calculated:",j)}else console.log("[userStats] Skipping trophy calculation - missing data:",{hasCompletedGwResults:!!b,hasAllGwPoints:!!h});t.trophyCabinet=j}else t.trophyCabinet={lastGw:0,form5:0,form10:0,overall:0};if(G&&G.length>0){const a=new Set;if(G.forEach(g=>{a.add(`${g.gw}:${g.fixture_index}`)}),a.size>0){const g=Array.from(a).map(l=>parseInt(l.split(":")[0])),b=new Set(g),[h,N]=await Promise.all([k.from("app_picks").select("gw, fixture_index, pick").in("gw",Array.from(b)),k.from("picks").select("gw, fixture_index, pick").in("gw",Array.from(b))]),y=new Map;N.data&&N.data.forEach(l=>{const i=`${l.gw}:${l.fixture_index}`;if(a.has(i)){y.has(i)||y.set(i,new Map);const P=y.get(i);P.set(l.pick,(P.get(l.pick)||0)+1)}}),h.data&&h.data.forEach(l=>{const i=`${l.gw}:${l.fixture_index}`;if(a.has(i)){y.has(i)||y.set(i,new Map);const P=y.get(i);P.set(l.pick,(P.get(l.pick)||0)+1)}});let m=0;y.forEach(l=>{m+=Array.from(l.values()).reduce((i,P)=>i+P,0)}),console.log(`[userStats] Chaos Index: Checking ${G.length} user picks across ${a.size} fixtures`),console.log(`[userStats] Chaos Index: Found ${m} total picks from all users across all fixtures`);let E=0,w=0,d=0;const s=new Map;T&&T.forEach(l=>{l.result&&s.set(`${l.gw}:${l.fixture_index}`,l.result)});let r=!1;G.forEach(l=>{const i=`${l.gw}:${l.fixture_index}`,P=y.get(i);if(P){const W=Array.from(P.values()).reduce((n,f)=>n+f,0),j=P.get(l.pick)||0,c=W>0?j/W*100:0;if(!r&&W>0){const n=P.get("H")||0,f=P.get("D")||0,u=P.get("A")||0;console.log(`[userStats] Chaos Index sample: GW${l.gw} fixture ${l.fixture_index}, user picked ${l.pick}, totals: H=${n}, D=${f}, A=${u}, total=${W}, userPickPercentage=${c.toFixed(2)}%`),r=!0}if(d++,c<=25){E++;const n=s.get(i);n&&l.pick===n&&w++}}else console.warn(`[userStats] Chaos Index: No pick counts found for ${i}`)}),d>0&&(t.chaosIndex=E/d*100,t.chaosCorrectCount=w,t.chaosTotalCount=E,console.log(`[userStats] Chaos Index: ${t.chaosIndex.toFixed(2)}% (${E} of ${d} picks, ${w} correct)`),console.log(`[userStats] Chaos Index breakdown: ${d} total picks, ${E} chaos picks`))}}if(G&&T){const a=new Map;T.forEach(b=>{b.result&&a.set(`${b.gw}:${b.fixture_index}`,b.result)});const{data:g}=await k.from("app_fixtures").select("gw, fixture_index, home_code, away_code, home_team, away_team, home_name, away_name");if(g){const b=new Map;g.forEach(s=>{b.set(`${s.gw}:${s.fixture_index}`,s)});const h=new Map,N=new Map;G.forEach(s=>{N.set(`${s.gw}:${s.fixture_index}`,s.pick)});const y=[];if(g.forEach(s=>{const r=a.get(`${s.gw}:${s.fixture_index}`),l=N.get(`${s.gw}:${s.fixture_index}`);if(!r||!l)return;const i=s.home_name||s.home_team||"",P=s.away_name||s.away_team||"",W={code:s.home_code,name:s.home_code?K(s.home_code):i},j={code:s.away_code,name:s.away_code?K(s.away_code):P},c=l===r;if(W.code){const n=W.code.toUpperCase(),f=h.get(n)||{correct:0,total:0,code:W.code,name:W.name};f.total++,c&&f.correct++,h.set(n,f),(n==="BUR"||W.code.toUpperCase()==="BUR")&&y.push({gw:s.gw,fixture_index:s.fixture_index,home:W.name,away:j.name,pick:l,result:r,isCorrect:c})}if(j.code){const n=j.code.toUpperCase(),f=h.get(n)||{correct:0,total:0,code:j.code,name:j.name};f.total++,c&&f.correct++,h.set(n,f),(n==="BUR"||j.code.toUpperCase()==="BUR")&&y.push({gw:s.gw,fixture_index:s.fixture_index,home:W.name,away:j.name,pick:l,result:r,isCorrect:c})}}),y.length>0){console.log("[userStats] Burnley picks breakdown:",JSON.stringify(y,null,2));const s=h.get("BUR");s&&console.log("[userStats] Burnley final stats:",{correct:s.correct,total:s.total,percentage:(s.correct/s.total*100).toFixed(2)+"%"})}const m=Array.from(h.entries()).map(([s,r])=>({code:s,name:r.name,correct:r.correct,total:r.total,percentage:(r.correct/r.total*100).toFixed(2)}));console.log("[userStats] All team prediction stats:",JSON.stringify(m,null,2)),console.log("[userStats] Teams with >= 3 picks:",JSON.stringify(m.filter(s=>s.total>=3),null,2));let E=0;h.forEach(s=>{E+=s.total}),console.log("[userStats] Total picks processed for team stats:",E),console.log("[userStats] Total picks with fixtures and results:",G.filter(s=>{const r=b.get(`${s.gw}:${s.fixture_index}`),l=a.get(`${s.gw}:${s.fixture_index}`);return r&&l}).length);let w=null,d=null;h.forEach((s,r)=>{if(s.total>=3){const l=s.correct/s.total*100,i=(s.total-s.correct)/s.total*100;(!w||l>w.percentage)&&(w={code:s.code,name:s.name,percentage:l}),(!d||i>d.percentage)&&(d={code:s.code,name:s.name,percentage:i})}}),t.mostCorrectTeam=w,t.mostIncorrectTeam=d}}}catch(x){console.error("Error fetching user stats:",x)}return t}function je({value:o,onChange:t,labels:x}){const v=x?.off||"ALL",_=x?.on||"LIVE";return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[10px] font-medium transition-colors ${o?"text-slate-400":"text-slate-700"}`,children:v}),e.jsx("button",{onClick:()=>t(!o),className:"relative inline-flex items-center rounded-full transition-colors focus:outline-none",style:{backgroundColor:o?"#dc2626":"#cbd5e1",width:"48px",height:"24px",border:"none"},"aria-label":o?`Show ${v}`:`Show ${_}`,children:e.jsx("span",{className:`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-200 ease-in-out ${o?"translate-x-6":"translate-x-0.5"}`})}),e.jsx("span",{className:`text-[10px] font-medium transition-colors ${o?"text-slate-700":"text-slate-400"}`,children:_})]})}async function _e(o){if(!o)return[];try{const t=await ge(o);if(t.length===0)return[];const x=t.map(s=>s.id),{data:v,error:_}=await k.from("league_members").select("league_id, user_id").in("league_id",x);if(_)throw _;const $=new Map;v?.forEach(s=>{const r=$.get(s.league_id)||[];r.push(s.user_id),$.set(s.league_id,r)});const{data:C,error:S}=await k.from("app_gw_results").select("gw, fixture_index, result").order("gw",{ascending:!1});if(S)throw S;const G=new Map;C?.forEach(s=>{s.result&&G.set(`${s.gw}:${s.fixture_index}`,s.result)});const T=Array.from(new Set(v?.map(s=>s.user_id)||[]));if(T.length===0)return[];const{data:M,error:L}=await k.from("app_picks").select("user_id, gw, fixture_index, pick").in("user_id",T);if(L)throw L;const a=Array.from(new Set(C?.map(s=>s.gw)||[]));if(a.length===0)return[];const{data:g}=await k.from("app_meta").select("current_gw").eq("id",1).maybeSingle(),b=g?.current_gw??Math.max(...a,0),{data:h,error:N}=await k.from("app_fixtures").select("gw, fixture_index, home_team, away_team, home_code, away_code, home_name, away_name, kickoff_time, api_match_id").in("gw",a).order("gw",{ascending:!1}).order("fixture_index",{ascending:!0});if(N)throw N;const y=new Map;h?.forEach(s=>{s.api_match_id||y.set(`${s.gw}:${s.fixture_index}`,s)});const m=[];console.log("[Unicorns] Starting calculation for user:",o),console.log("[Unicorns] User leagues:",t.map(s=>({name:s.name,id:s.id,members:$.get(s.id)?.length||0}))),console.log("[Unicorns] Total results available:",G.size),console.log("[Unicorns] Total picks available:",M?.length||0),console.log("[Unicorns] User picks count:",M?.filter(s=>s.user_id===o).length||0),console.log("[Unicorns] Total fixtures available:",y.size),console.log("[Unicorns] Current GW:",b);for(const s of t){if(s.name==="API Test"){console.log(`[Unicorns] Skipping "${s.name}" - test league`);continue}const r=$.get(s.id)||[];if(r.length<3){console.log(`[Unicorns] Skipping "${s.name}" - only ${r.length} members`);continue}const l=await ce(s,b);console.log(`[Unicorns] Processing "${s.name}" with ${r.length} members, start GW: ${l}`);const i=M?.filter(j=>r.includes(j.user_id)&&j.gw>=l)||[];console.log(`[Unicorns] "${s.name}" has ${i.length} picks total (filtered from start GW ${l})`);const P=new Map;i.forEach(j=>{const c=`${j.gw}:${j.fixture_index}`,n=P.get(c)||[];n.push({user_id:j.user_id,pick:j.pick}),P.set(c,n)});let W=0;P.forEach((j,c)=>{const[n,f]=c.split(":").map(Number);if(n<l)return;const u=G.get(c);if(!u)return;const F=j.find(p=>p.user_id===o);if(!F)return;const U=j.filter(p=>p.pick===u).map(p=>p.user_id);if(U.length===1&&U[0]===o&&r.length>=3){const p=y.get(c);p&&(W++,m.push({fixture_index:f,gw:n,home_team:p.home_team,away_team:p.away_team,home_code:p.home_code,away_code:p.away_code,home_name:p.home_name,away_name:p.away_name,kickoff_time:p.kickoff_time,pick:F.pick,league_id:s.id,league_name:s.name}))}}),W>0&&console.log(`[Unicorns] "${s.name}" found ${W} unicorns`)}console.log(`[Unicorns] Found ${m.length} total unicorns before grouping`);const E=new Map;m.forEach(s=>{const r=`${s.gw}:${s.fixture_index}`,l=E.get(r);l?l.league_names.includes(s.league_name)||l.league_names.push(s.league_name):E.set(r,{fixture_index:s.fixture_index,gw:s.gw,home_team:s.home_team,away_team:s.away_team,home_code:s.home_code,away_code:s.away_code,home_name:s.home_name,away_name:s.away_name,kickoff_time:s.kickoff_time,pick:s.pick,league_names:[s.league_name]})});const w=Array.from(E.values()),d=w.filter(s=>s.league_names.includes("Prem Predictions"));return console.log("[Unicorns] Prem Predictions unicorns:",d.map(s=>`GW${s.gw} fixture ${s.fixture_index} (leagues: ${s.league_names.join(", ")})`)),console.log(`[Unicorns] Found ${w.length} unique fixtures after grouping`),w.sort((s,r)=>s.gw!==r.gw?s.gw-r.gw:s.fixture_index-r.fixture_index),w}catch(t){return console.error("[Unicorns] Error fetching unicorns:",t),[]}}function ye({fixture:o,leagueNames:t,isActive:x=!1}){const v=o.home_code||o.home_name||o.home_team||"",_=o.away_code||o.away_name||o.away_team||"",$=J(v)||o.home_name||o.home_team||"Home",C=J(_)||o.away_name||o.away_name||"Away",S=o.pick==="H"?"Home Win":o.pick==="A"?"Away Win":"Draw",G={id:`${o.gw}-${o.fixture_index}`,fixture_index:o.fixture_index,home_team:$,away_team:C,home_code:o.home_code,away_code:o.away_code,home_name:$,away_name:C,kickoff_time:o.kickoff_time},T=x?1:.92,M=x?1:.75;return e.jsxs("div",{className:"flex-shrink-0 relative",style:{scrollSnapAlign:"center",transform:`scale(${T})`,opacity:M,width:"280px",willChange:"transform, opacity",transition:"transform 500ms cubic-bezier(0.4, 0, 0.2, 1), opacity 500ms cubic-bezier(0.4, 0, 0.2, 1)"},children:[e.jsx("style",{children:`
        .unicorn-card-wrapper {
          position: relative;
        }
        .unicorn-card-wrapper > div:first-child {
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
          position: relative;
        }
        .unicorn-card-wrapper > div:first-child > div:first-child {
          padding-top: 1.5rem !important;
        }
        .unicorn-card-wrapper .flex.items-center.gap-1\\.5.mt-3 {
          display: none !important;
        }
        .unicorn-card-wrapper > div.absolute {
          box-shadow: none !important;
        }
        .unicorn-card-wrapper::before {
          content: '';
          position: absolute;
          inset: 0;
          border-radius: 1.5rem;
          padding: 10px;
          background: linear-gradient(135deg, #fbbf24, #f97316, #ec4899, #9333ea, #fbbf24);
          background-size: 300% 300%;
          -webkit-mask: 
            linear-gradient(#fff 0 0) content-box, 
            linear-gradient(#fff 0 0);
          -webkit-mask-composite: xor;
          mask-composite: exclude;
          animation: gradient-shift 3s ease infinite;
          pointer-events: none;
          z-index: 100;
        }
        @keyframes gradient-shift {
          0%, 100% {
            background-position: 0% 50%;
          }
          50% {
            background-position: 100% 50%;
          }
        }
        .shiny-pick-badge {
          background: linear-gradient(135deg, #fbbf24, #f97316, #ec4899, #9333ea, #fbbf24);
          background-size: 300% 300%;
          animation: gradient-shift 3s ease infinite;
          color: white;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
      `}),e.jsxs("div",{className:"relative unicorn-card-wrapper",children:[e.jsx(de,{fixture:G,showSwipeHint:!1}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 pt-6 px-4 pb-8 rounded-b-3xl",style:{background:"linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.65) 25%, rgba(0, 0, 0, 0.45) 45%, rgba(0, 0, 0, 0.25) 65%, rgba(0, 0, 0, 0.1) 80%, transparent 100%)"},children:[e.jsx("div",{className:"text-white text-sm font-semibold text-center mb-2",children:e.jsx("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full shiny-pick-badge",children:S})}),e.jsx("div",{className:"text-white text-sm font-semibold text-center",children:t.length===1?t[0]:e.jsx("div",{className:"space-y-1",children:e.jsx("div",{children:t.join(", ")})})}),e.jsxs("div",{className:"text-white/80 text-xs text-center mt-1",children:["GW",o.gw]})]})]})]})}function ke({userId:o,loading:t}){const[x,v]=R.useState([]),[_,$]=R.useState(!0),[C,S]=R.useState(0),[G,T]=R.useState(!1),M=R.useRef(null),L=R.useRef([]);R.useEffect(()=>{if(!o){$(!1);return}let g=!0;async function b(){$(!0);try{const h=await _e(o);g&&(L.current=[],v(h),S(0))}catch(h){console.error("[UnicornCollection] Error loading unicorns:",h),g&&(v([]),S(0))}finally{g&&$(!1)}}return b(),()=>{g=!1}},[o]),R.useEffect(()=>{if(x.length===0||!M.current)return;const g=M.current;let b=null,h=!1;const N=()=>{if(!M.current)return;const r=M.current.getBoundingClientRect();if(r.width===0){setTimeout(N,50);return}if(!L.current.every((j,c)=>c>=x.length?!0:j!==null)){setTimeout(N,50);return}if(L.current[0]&&L.current[0].getBoundingClientRect().width===0){setTimeout(N,50);return}const i=r.left+r.width/2;let P=0,W=1/0;L.current.forEach((j,c)=>{if(j&&c<x.length){const n=j.getBoundingClientRect(),f=n.left+n.width/2,u=Math.abs(f-i);u<W&&(W=u,P=c)}}),S(P)},y=()=>{h||(b=requestAnimationFrame(()=>{N(),h=!1}),h=!0)};g.addEventListener("scroll",y,{passive:!0});const m=()=>{g.scrollLeft===0&&L.current[0],N()},E=setTimeout(()=>{m()},0),w=setTimeout(()=>{m()},100),d=setTimeout(()=>{m()},300),s=()=>{N()};return window.addEventListener("resize",s,{passive:!0}),()=>{clearTimeout(E),clearTimeout(w),clearTimeout(d),b!==null&&cancelAnimationFrame(b),g.removeEventListener("scroll",y),window.removeEventListener("resize",s)}},[x.length,x]);const a=t||_;return t?null:a?e.jsxs("div",{className:"bg-white rounded-xl p-6 desktop-constrained-unicorn",style:{marginRight:"-100vw",paddingRight:"100vw"},children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-4 flex items-center gap-2",children:e.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Your Unicorns"})}),e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]}):x.length===0?e.jsxs("div",{className:"bg-white rounded-xl p-6",children:[e.jsx("div",{className:"text-sm font-medium text-slate-600 mb-2",children:"Your Unicorns"}),e.jsxs("div",{className:"text-slate-500 text-sm",children:["You have ",e.jsx("span",{className:"font-semibold",children:"0 unicorns"})," overall. Keep predicting to earn your first unicorn!"]})]}):e.jsxs("div",{className:"bg-white rounded-xl p-6 desktop-constrained-unicorn",style:{marginRight:"-100vw",paddingRight:"100vw"},children:[e.jsxs("div",{className:"text-sm font-medium text-slate-600 mb-4 flex items-center gap-2",style:{paddingLeft:"1.5rem",marginLeft:"-1.5rem"},children:[e.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Your Unicorns"}),e.jsx("div",{className:"w-4 h-4 rounded-full border border-slate-400 flex items-center justify-center hover:bg-slate-50 transition-colors cursor-pointer",onClick:()=>T(!0),role:"button","aria-label":"Information about Unicorns",children:e.jsx("span",{className:"text-[10px] text-slate-500 font-bold",children:"i"})})]}),e.jsxs("div",{ref:M,className:"flex gap-0 overflow-x-auto pb-2 scrollbar-hide unicorn-scroll-container",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch",overscrollBehaviorX:"contain",scrollBehavior:"smooth",scrollSnapType:"x mandatory",marginLeft:"-1.5rem",marginRight:"-1.5rem",paddingLeft:"calc(50vw - 140px + 1.5rem)",paddingRight:"calc(50vw - 140px)",width:"calc(100% + 3rem)"},children:[e.jsx("style",{children:".scrollbar-hide::-webkit-scrollbar { display: none; }"}),x.map((g,b)=>e.jsx("div",{ref:h=>{L.current[b]=h},children:e.jsx(ye,{fixture:g,leagueNames:g.league_names,isActive:b===C})},`${g.gw}-${g.fixture_index}-${b}`))]}),e.jsxs("div",{className:"text-sm font-bold text-slate-800 mt-4 text-center",children:[x.length," ",x.length===1?"unicorn":"unicorns"," overall"]}),e.jsx(re,{isOpen:G,onClose:()=>T(!1),title:"Unicorns",description:`A unicorn is a unique correct prediction in a mini-league.

Only applies to mini-leagues with 3+ players.

Each card shows the fixture you correctly predicted, what you picked, and which mini-leagues you earned the unicorn in.`})]})}async function Ne(o,t){const{data:x,error:v}=await k.from("app_v_gw_points").select("user_id, points").eq("gw",t);if(v)throw new Error(`Failed to load GW points: ${v.message}`);const _=(x??[]).map(w=>({user_id:w.user_id,gw:t,points:w.points||0})),C=_.find(w=>w.user_id===o)?.points||0,S=ne(o,t,_),G=S?.rank||null,T=S?.total||null,{data:M}=await k.from("app_fixtures").select("id").eq("gw",t),L=M?.length||10,a={gw:!1,form5:!1,form10:!1,overall:!1};if(G===1&&(a.gw=!0),t>=5){const{data:w}=await k.from("app_v_gw_points").select("user_id, gw, points").gte("gw",t-4).lte("gw",t),{data:d}=await k.from("app_v_ocp_overall").select("user_id, name, ocp");w&&d&&I(o,t-4,t,w.map(r=>({user_id:r.user_id,gw:r.gw,points:r.points||0})),d.map(r=>({user_id:r.user_id,name:r.name,ocp:r.ocp||0})))?.rank===1&&(a.form5=!0)}if(t>=10){const{data:w}=await k.from("app_v_gw_points").select("user_id, gw, points").gte("gw",t-9).lte("gw",t),{data:d}=await k.from("app_v_ocp_overall").select("user_id, name, ocp");w&&d&&I(o,t-9,t,w.map(r=>({user_id:r.user_id,gw:r.gw,points:r.points||0})),d.map(r=>({user_id:r.user_id,name:r.name,ocp:r.ocp||0})))?.rank===1&&(a.form10=!0)}const{data:g}=await k.from("app_v_ocp_overall").select("user_id, name, ocp");g&&O(o,g.map(d=>({user_id:d.user_id,name:d.name,ocp:d.ocp||0})))?.rank===1&&(a.overall=!0);let b=0;const h=[],N=[],{data:y}=await k.from("league_members").select("league_id").eq("user_id",o);if(y&&y.length>0){const w=y.map(d=>d.league_id);for(const d of w){const{data:s}=await k.from("leagues").select("id, name, avatar").eq("id",d).maybeSingle(),r=s?.name||"Unknown League",l=s?.avatar||null,{data:i}=await k.from("league_members").select("user_id").eq("league_id",d);if(!i||i.length<2)continue;const P=i.map(n=>n.user_id),{data:W}=await k.from("app_v_gw_points").select("user_id, points").eq("gw",t).in("user_id",P);if(!W||W.length===0)continue;let j=new Map;if(i.length>=3){const{data:n}=await k.from("app_picks").select("fixture_index, pick, user_id").eq("gw",t).in("user_id",P),{data:f}=await k.from("app_gw_results").select("fixture_index, result").eq("gw",t);if(n&&f){const u=new Map;n.forEach(F=>{u.has(F.fixture_index)||u.set(F.fixture_index,new Map);const U=u.get(F.fixture_index);U.has(F.pick)||U.set(F.pick,[]),U.get(F.pick).push(F.user_id)}),f.forEach(F=>{const U=u.get(F.fixture_index);if(U){const p=U.get(F.result);if(p&&p.length===1){const B=p[0];j.set(B,(j.get(B)||0)+1)}}})}}const c=[...W].map(n=>({user_id:n.user_id,points:n.points||0,unicorns:j.get(n.user_id)||0})).sort((n,f)=>f.points!==n.points?f.points-n.points:f.unicorns-n.unicorns);c.length>0&&c[0].user_id===o&&(c.length>1&&c[0].points===c[1].points&&c[0].unicorns===c[1].unicorns||(b++,h.push(r),N.push({id:d,name:r,avatar:l})))}}const m={overall:{before:null,after:null,change:null},form5:{before:null,after:null,change:null},form10:{before:null,after:null,change:null}},{data:E}=await k.from("app_v_ocp_overall").select("user_id, name, ocp");if(E){const w=O(o,E.map(d=>({user_id:d.user_id,name:d.name,ocp:d.ocp||0})));if(m.overall.after=w?.rank||null,t>1){const{data:d}=await k.from("app_v_gw_points").select("user_id, gw, points").lt("gw",t);if(d){const s=new Set(d.map(i=>i.user_id)),r=Array.from(s).map(i=>{const P=d.filter(j=>j.user_id===i).reduce((j,c)=>j+(c.points||0),0),W=E.find(j=>j.user_id===i);return{user_id:i,name:W?.name||null,ocp:P}}),l=O(o,r);m.overall.before=l?.rank||null}}}if(t>=5){const{data:w}=await k.from("app_v_gw_points").select("user_id, gw, points").gte("gw",Math.max(1,t-4)).lte("gw",t),{data:d}=await k.from("app_v_ocp_overall").select("user_id, name, ocp");if(w&&d){const s=I(o,t-4,t,w.map(r=>({user_id:r.user_id,gw:r.gw,points:r.points||0})),d.map(r=>({user_id:r.user_id,name:r.name,ocp:r.ocp||0})));if(m.form5.after=s?.rank||null,t>5){const r=I(o,t-5,t-1,w.filter(l=>l.gw<t).map(l=>({user_id:l.user_id,gw:l.gw,points:l.points||0})),d.map(l=>({user_id:l.user_id,name:l.name,ocp:l.ocp||0})));m.form5.before=r?.rank||null}}}if(t>=10){const{data:w}=await k.from("app_v_gw_points").select("user_id, gw, points").gte("gw",Math.max(1,t-9)).lte("gw",t),{data:d}=await k.from("app_v_ocp_overall").select("user_id, name, ocp");if(w&&d){const s=I(o,t-9,t,w.map(r=>({user_id:r.user_id,gw:r.gw,points:r.points||0})),d.map(r=>({user_id:r.user_id,name:r.name,ocp:r.ocp||0})));if(m.form10.after=s?.rank||null,t>10){const r=I(o,t-10,t-1,w.filter(l=>l.gw<t).map(l=>({user_id:l.user_id,gw:l.gw,points:l.points||0})),d.map(l=>({user_id:l.user_id,name:l.name,ocp:l.ocp||0})));m.form10.before=r?.rank||null}}}return m.overall.before!==null&&m.overall.after!==null&&(m.overall.change=m.overall.before-m.overall.after),m.form5.before!==null&&m.form5.after!==null&&(m.form5.change=m.form5.before-m.form5.after),m.form10.before!==null&&m.form10.after!==null&&(m.form10.change=m.form10.before-m.form10.after),{score:C,totalFixtures:L,gwRank:G,gwRankTotal:T,trophies:a,mlVictories:b,mlVictoryNames:h,mlVictoryData:N,leaderboardChanges:m}}function ae(o){const t=o%10,x=o%100;return t===1&&x!==11?"st":t===2&&x!==12?"nd":t===3&&x!==13?"rd":"th"}function Ce({isOpen:o,onClose:t,gw:x,nextGw:v,mockResults:_,preloadedResults:$,onLoadingChange:C}){const{user:S}=le(),[G,T]=R.useState(!0),[M,L]=R.useState(null),[a,g]=R.useState(null),[b,h]=R.useState(!1),[N,y]=R.useState(!1),[m,E]=R.useState(null),[w,d]=R.useState(!1),s=R.useRef(null),r=R.useRef(null),[l,i]=R.useState("");R.useEffect(()=>{if(!o||!x){T(!1),g(null),L(null),C?.(!1);return}if(g(null),L(null),$!=null){g($),T(!1),C?.(!1);return}if(_!=null){const F={..._,mlVictoryData:_.mlVictoryData||_.mlVictoryNames?.map((U,p)=>({id:`mock-${p}`,name:U,avatar:null}))||[]};g(F),T(!1),C?.(!1);return}if(!S?.id){T(!1),C?.(!1);return}const n=S.id;let f=!0;async function u(){T(!0),C?.(!0),L(null);try{const F=await Ne(n,x);if(!f)return;g(F),T(!1),C?.(!1)}catch(F){f&&(L(F?.message||"Failed to load results"),T(!1),C?.(!1))}}return u(),()=>{f=!1}},[o,S?.id,x,_,$]);const P=async()=>{if(b||!a)return;const n=S?.user_metadata?.display_name||S?.email||"User";i(n),E(null),h(!0),y(!0),await new Promise(u=>setTimeout(u,100)),d(!0),await new Promise(u=>setTimeout(u,1500)),await new Promise(u=>requestAnimationFrame(()=>requestAnimationFrame(u))),await new Promise(u=>requestAnimationFrame(()=>requestAnimationFrame(u))),await new Promise(u=>requestAnimationFrame(()=>requestAnimationFrame(u))),await new Promise(u=>setTimeout(u,300));let f=0;for(;!r.current&&f<15;)await new Promise(u=>setTimeout(u,100)),f++;r.current&&(r.current.offsetHeight,r.current.offsetWidth,await new Promise(u=>requestAnimationFrame(u)),r.current.offsetHeight);try{if(!r.current)throw new Error("Capture element not found - ref was not set after retries");const u=r.current,F=u.querySelectorAll("img");await Promise.all(Array.from(F).map(p=>{const A=p.src.includes("Volley")||p.src.includes("volley")?5e3:3e3;return p.complete&&p.naturalWidth>0?Promise.resolve():new Promise(V=>{const q=setTimeout(()=>{p.style.display="none",p.style.visibility="hidden",p.style.opacity="0",V(null)},A);p.onload=()=>{clearTimeout(q),V(null)},p.onerror=()=>{clearTimeout(q),p.style.display="none",p.style.visibility="hidden",p.style.opacity="0",V(null)}})})),await new Promise(p=>setTimeout(p,200)),Array.from(F).forEach(p=>{(!p.complete||p.naturalWidth===0)&&(p.style.display="none",p.style.visibility="hidden",p.style.opacity="0")});const U=await ue(u,{backgroundColor:"#ffffff",pixelRatio:2,quality:.95,cacheBust:!0,filter:p=>{if(p instanceof HTMLImageElement){const B=window.getComputedStyle(p);if(B.display==="none"||B.visibility==="hidden"||B.opacity==="0"||!p.complete||p.naturalWidth===0)return!1}return!0}});E(U),h(!1),d(!1)}catch{h(!1),d(!1)}},W=()=>{y(!1),h(!1),d(!1),setTimeout(()=>{m&&(URL.revokeObjectURL(m),E(null)),t()},300)};if(R.useEffect(()=>{if(!o)return;const n=f=>{f.key==="Escape"&&t()};return document.addEventListener("keydown",n),()=>document.removeEventListener("keydown",n)},[o,t]),R.useEffect(()=>(o?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[o]),R.useEffect(()=>{o&&!G&&a!==null&&setTimeout(()=>{me()},300)},[o,G,a]),R.useEffect(()=>{o||C?.(!1)},[o]),!o&&!N)return null;if(G||!a)return N?e.jsx(e.Fragment,{children:N&&e.jsx("div",{style:{zIndex:1000002},children:e.jsx(X,{isOpen:N,onClose:W,imageUrl:m||"",fileName:`gw${x}-results.png`,gw:x,userName:l||S?.user_metadata?.display_name||S?.email||"User"})})}):null;const j=Object.values(a?.trophies||{}).filter(Boolean).length,c=e.jsxs(e.Fragment,{children:[!N&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm",onClick:t,"aria-hidden":"true",style:{animation:"fadeIn 200ms ease-out",zIndex:999999}}),!N&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center p-4",role:"dialog","aria-modal":"true","aria-labelledby":"gw-results-modal-title",style:{zIndex:1000001},onClick:n=>{n.target===n.currentTarget&&t()},children:e.jsxs("div",{ref:s,className:"relative max-w-lg w-full bg-white rounded-3xl shadow-2xl overflow-hidden",onClick:n=>n.stopPropagation(),children:[M?e.jsx("div",{className:"p-12 flex items-center justify-center",children:e.jsx("div",{className:"text-red-500",children:M})}):a?e.jsxs("div",{className:"p-6 sm:p-8",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-slate-800 mb-1",children:["Gameweek ",x," Results"]})}),e.jsx("div",{className:"relative mb-6",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"mb-2 flex items-center justify-center gap-1",children:[e.jsx("img",{src:"/assets/Volley/Volley-playing.png",alt:"Volley",className:"w-20 h-20 sm:w-24 sm:h-24 object-contain"}),e.jsxs("div",{className:"text-5xl sm:text-6xl font-bold text-emerald-600",children:[a.score,"/",a.totalFixtures]})]})})}),j>0&&e.jsx("div",{className:"mb-6 p-4 bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 rounded-xl shadow-2xl shadow-slate-600/50 relative overflow-hidden before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/40 before:to-transparent before:animate-[shimmer_2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/30 after:to-transparent after:animate-[shimmer_2.5s_ease-in-out_infinite_0.6s]",children:e.jsxs("div",{className:"text-center mb-3 relative z-10",children:[e.jsx("div",{className:"text-lg font-bold text-white mb-2",children:"Trophies Earned!"}),e.jsxs("div",{className:"flex items-center justify-center gap-3 flex-wrap",children:[a.trophies.gw&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:"/assets/Icons/Trophy--Streamline-Rounded-Material-Pro-Free.svg",alt:"GW Winner",className:"w-12 h-12"}),e.jsx("span",{className:"text-xs font-medium text-white mt-1",children:"GW Winner"})]}),a.trophies.form5&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:"/assets/5-week-form-badge.png",alt:"5-Week Form",className:"w-12 h-12"}),e.jsx("span",{className:"text-xs font-medium text-white mt-1",children:"5-Week Form"})]}),a.trophies.form10&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:"/assets/10-week-form-badge.png",alt:"10-Week Form",className:"w-12 h-12"}),e.jsx("span",{className:"text-xs font-medium text-white mt-1",children:"10-Week Form"})]}),a.trophies.overall&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:"/assets/season-rank-badge.png",alt:"Overall Leader",className:"w-12 h-12"}),e.jsx("span",{className:"text-xs font-medium text-white mt-1",children:"Overall Leader"})]})]})]})}),a.mlVictories>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"text-center mb-3",children:e.jsxs("div",{className:"text-lg font-semibold text-slate-700",children:["Won ",a.mlVictories," Mini-League",a.mlVictories!==1?"s":"","!"]})}),e.jsx("div",{className:"grid grid-cols-4 gap-2 justify-items-center",children:(a.mlVictoryData||a.mlVictoryNames?.map((n,f)=>({id:`fallback-${f}`,name:n,avatar:null}))||[]).map(n=>{const f=Q(n.id),u=Z(n);return e.jsxs("div",{className:"flex flex-col items-center bg-slate-50 rounded-lg p-2 min-w-[80px]",children:[e.jsx("img",{src:u,alt:`${n.name} avatar`,className:"w-12 h-12 rounded-full object-cover mb-1",onError:F=>{const U=F.target,p=`/assets/league-avatars/${f}`;U.src!==p&&(U.src=p)},onLoad:()=>{}}),e.jsx("div",{className:"text-xs text-slate-600 text-center truncate max-w-[80px]",children:n.name.length>8?`${n.name.substring(0,8)}...`:n.name})]},n.id)})})]}),a.gwRank!==null&&a.gwRankTotal!==null&&(()=>{const n=a.gwRank/a.gwRankTotal*100,f=ee(n);return e.jsx("div",{className:"mb-3 p-3 bg-slate-50 rounded-xl",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("span",{className:"text-slate-700 font-semibold text-xs mb-1 block",children:["Gameweek ",x," Leaderboard"]}),e.jsxs("div",{className:"flex items-end justify-center gap-3",children:[e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("span",{className:"text-slate-800 font-bold text-3xl",children:a.gwRank}),e.jsxs("span",{className:"text-slate-600 text-sm",children:[ae(a.gwRank)," of ",a.gwRankTotal]})]}),f&&e.jsx("span",{className:`text-2xl font-bold ${f.isTop?"text-emerald-700":"text-orange-600"}`,children:f.text})]})]})})})(),(a.leaderboardChanges.overall.after!==null||a.leaderboardChanges.form5.after!==null||a.leaderboardChanges.form10.after!==null)&&e.jsx("div",{className:"mb-4 p-2 bg-slate-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[a.leaderboardChanges.overall.after!==null&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-slate-600 text-xs",children:"Overall:"}),a.leaderboardChanges.overall.change!==null&&a.leaderboardChanges.overall.change!==0?e.jsx("span",{className:`font-bold text-xs flex items-center gap-0.5 ${a.leaderboardChanges.overall.change>0?"text-emerald-600":"text-red-600"}`,children:a.leaderboardChanges.overall.change>0?e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 4l-8 8h16l-8-8z"})}),e.jsx("span",{children:a.leaderboardChanges.overall.change})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 20l8-8H4l8 8z"})}),e.jsx("span",{children:Math.abs(a.leaderboardChanges.overall.change)})]})}):e.jsxs("span",{className:"text-slate-800 font-bold text-xs",children:["#",a.leaderboardChanges.overall.after]})]}),a.leaderboardChanges.form5.after!==null&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-slate-600 text-xs",children:"5W:"}),a.leaderboardChanges.form5.change!==null&&a.leaderboardChanges.form5.change!==0?e.jsx("span",{className:`font-bold text-xs flex items-center gap-0.5 ${a.leaderboardChanges.form5.change>0?"text-emerald-600":"text-red-600"}`,children:a.leaderboardChanges.form5.change>0?e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 4l-8 8h16l-8-8z"})}),e.jsx("span",{children:a.leaderboardChanges.form5.change})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 20l8-8H4l8 8z"})}),e.jsx("span",{children:Math.abs(a.leaderboardChanges.form5.change)})]})}):e.jsxs("span",{className:"text-slate-800 font-bold text-xs",children:["#",a.leaderboardChanges.form5.after]})]}),a.leaderboardChanges.form10.after!==null&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-slate-600 text-xs",children:"10W:"}),a.leaderboardChanges.form10.change!==null&&a.leaderboardChanges.form10.change!==0?e.jsx("span",{className:`font-bold text-xs flex items-center gap-0.5 ${a.leaderboardChanges.form10.change>0?"text-emerald-600":"text-red-600"}`,children:a.leaderboardChanges.form10.change>0?e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 4l-8 8h16l-8-8z"})}),e.jsx("span",{children:a.leaderboardChanges.form10.change})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 20l8-8H4l8 8z"})}),e.jsx("span",{children:Math.abs(a.leaderboardChanges.form10.change)})]})}):e.jsxs("span",{className:"text-slate-800 font-bold text-xs",children:["#",a.leaderboardChanges.form10.after]})]})]})}),e.jsx("div",{className:"flex flex-col gap-3",children:e.jsx("button",{onClick:P,disabled:b,className:"w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-colors disabled:opacity-50 flex items-center justify-center gap-2",children:b?"Generating...":e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"2",stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})}),"SHARE"]})})})]}):null,e.jsx("button",{onClick:t,className:"absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 transition-colors","aria-label":"Close",children:e.jsx("svg",{className:"w-6 h-6 text-slate-600 font-bold",fill:"none",stroke:"currentColor",strokeWidth:3,viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})}),w&&a&&e.jsx("div",{style:{position:"fixed",left:0,top:0,width:"100vw",height:"100vh",zIndex:999999,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",opacity:0,overflow:"hidden"},children:e.jsxs("div",{ref:r,style:{maxWidth:"512px",width:"100%"},className:"bg-white shadow-2xl overflow-hidden",children:[e.jsx("div",{style:{backgroundColor:"#1C8376",paddingTop:"12px",paddingBottom:"12px",paddingLeft:"16px",paddingRight:"16px",display:"flex",justifyContent:"center",alignItems:"center",position:"relative",minHeight:"80px"},children:e.jsx("img",{src:"/assets/badges/totl-logo1.svg",alt:"TOTL",style:{width:"70px",height:"70px",filter:"brightness(0) invert(1)",display:"block",position:"absolute",left:"50%",transform:"translateX(-50%)"},onError:()=>{}})}),e.jsxs("div",{className:"p-6 sm:p-8",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-slate-800 mb-1",children:["Gameweek ",x," Results"]})}),e.jsx("div",{className:"relative mb-6",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"mb-2 flex items-center justify-center gap-1",children:[e.jsx("img",{src:"/assets/Volley/Volley-playing.png",alt:"Volley",className:"w-20 h-20 sm:w-24 sm:h-24 object-contain"}),e.jsxs("div",{className:"text-5xl sm:text-6xl font-bold text-emerald-600",children:[a.score,"/",a.totalFixtures]})]})})}),j>0&&e.jsx("div",{className:"mb-6 p-4 bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 rounded-xl shadow-2xl shadow-slate-600/50 relative overflow-hidden before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/40 before:to-transparent before:animate-[shimmer_2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/30 after:to-transparent after:animate-[shimmer_2.5s_ease-in-out_infinite_0.6s]",children:e.jsxs("div",{className:"text-center mb-3 relative z-10",children:[e.jsx("div",{className:"text-lg font-bold text-white mb-2",children:"Trophies Earned!"}),e.jsxs("div",{className:"flex items-center justify-center gap-3 flex-wrap",children:[a.trophies.gw&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:"/assets/Icons/Trophy--Streamline-Rounded-Material-Pro-Free.svg",alt:"GW Winner",className:"w-12 h-12"}),e.jsx("span",{className:"text-xs font-medium text-white mt-1",children:"GW Winner"})]}),a.trophies.form5&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:"/assets/5-week-form-badge.png",alt:"5-Week Form",className:"w-12 h-12"}),e.jsx("span",{className:"text-xs font-medium text-white mt-1",children:"5-Week Form"})]}),a.trophies.form10&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:"/assets/10-week-form-badge.png",alt:"10-Week Form",className:"w-12 h-12"}),e.jsx("span",{className:"text-xs font-medium text-white mt-1",children:"10-Week Form"})]}),a.trophies.overall&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:"/assets/season-rank-badge.png",alt:"Overall Leader",className:"w-12 h-12"}),e.jsx("span",{className:"text-xs font-medium text-white mt-1",children:"Overall Leader"})]})]})]})}),a.mlVictories>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"text-center mb-3",children:e.jsxs("div",{className:"text-lg font-semibold text-slate-700",children:["Won ",a.mlVictories," Mini-League",a.mlVictories!==1?"s":"","!"]})}),e.jsx("div",{className:"grid grid-cols-4 gap-2 justify-items-center",children:(a.mlVictoryData||a.mlVictoryNames?.map((n,f)=>({id:`fallback-${f}`,name:n,avatar:null}))||[]).map(n=>{const f=Q(n.id),u=Z(n);return e.jsxs("div",{className:"flex flex-col items-center bg-slate-50 rounded-lg p-2 min-w-[80px]",children:[e.jsx("img",{src:u,alt:`${n.name} avatar`,className:"w-12 h-12 rounded-full object-cover mb-1",onError:F=>{const U=F.target,p=`/assets/league-avatars/${f}`;U.src!==p&&(U.src=p)},onLoad:()=>{}}),e.jsx("div",{className:"text-xs text-slate-600 text-center truncate max-w-[80px]",children:n.name.length>8?`${n.name.substring(0,8)}...`:n.name})]},n.id)})})]}),a.gwRank!==null&&a.gwRankTotal!==null&&(()=>{const n=a.gwRank/a.gwRankTotal*100,f=ee(n);return e.jsx("div",{className:"mb-3 p-3 bg-slate-50 rounded-xl",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("span",{className:"text-slate-700 font-semibold text-xs mb-1 block",children:["Gameweek ",x," Leaderboard"]}),e.jsxs("div",{className:"flex items-end justify-center gap-3",children:[e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("span",{className:"text-slate-800 font-bold text-3xl",children:a.gwRank}),e.jsxs("span",{className:"text-slate-600 text-sm",children:[ae(a.gwRank)," of ",a.gwRankTotal]})]}),f&&e.jsx("span",{className:`text-2xl font-bold ${f.isTop?"text-emerald-700":"text-orange-600"}`,children:f.text})]})]})})})(),(a.leaderboardChanges.overall.after!==null||a.leaderboardChanges.form5.after!==null||a.leaderboardChanges.form10.after!==null)&&e.jsx("div",{className:"mb-4 p-2 bg-slate-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[a.leaderboardChanges.overall.after!==null&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-slate-600 text-xs",children:"Overall:"}),a.leaderboardChanges.overall.change!==null&&a.leaderboardChanges.overall.change!==0?e.jsx("span",{className:`font-bold text-xs flex items-center gap-0.5 ${a.leaderboardChanges.overall.change>0?"text-emerald-600":"text-red-600"}`,children:a.leaderboardChanges.overall.change>0?e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 4l-8 8h16l-8-8z"})}),e.jsx("span",{children:a.leaderboardChanges.overall.change})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 20l8-8H4l8 8z"})}),e.jsx("span",{children:Math.abs(a.leaderboardChanges.overall.change)})]})}):e.jsxs("span",{className:"text-slate-800 font-bold text-xs",children:["#",a.leaderboardChanges.overall.after]})]}),a.leaderboardChanges.form5.after!==null&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-slate-600 text-xs",children:"5W:"}),a.leaderboardChanges.form5.change!==null&&a.leaderboardChanges.form5.change!==0?e.jsx("span",{className:`font-bold text-xs flex items-center gap-0.5 ${a.leaderboardChanges.form5.change>0?"text-emerald-600":"text-red-600"}`,children:a.leaderboardChanges.form5.change>0?e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 4l-8 8h16l-8-8z"})}),e.jsx("span",{children:a.leaderboardChanges.form5.change})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 20l8-8H4l8 8z"})}),e.jsx("span",{children:Math.abs(a.leaderboardChanges.form5.change)})]})}):e.jsxs("span",{className:"text-slate-800 font-bold text-xs",children:["#",a.leaderboardChanges.form5.after]})]}),a.leaderboardChanges.form10.after!==null&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-slate-600 text-xs",children:"10W:"}),a.leaderboardChanges.form10.change!==null&&a.leaderboardChanges.form10.change!==0?e.jsx("span",{className:`font-bold text-xs flex items-center gap-0.5 ${a.leaderboardChanges.form10.change>0?"text-emerald-600":"text-red-600"}`,children:a.leaderboardChanges.form10.change>0?e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 4l-8 8h16l-8-8z"})}),e.jsx("span",{children:a.leaderboardChanges.form10.change})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",className:"w-2.5 h-2.5","aria-hidden":"true",children:e.jsx("path",{d:"M12 20l8-8H4l8 8z"})}),e.jsx("span",{children:Math.abs(a.leaderboardChanges.form10.change)})]})}):e.jsxs("span",{className:"text-slate-800 font-bold text-xs",children:["#",a.leaderboardChanges.form10.after]})]})]})})]})]})}),N&&e.jsx("div",{style:{zIndex:1000002},children:e.jsx(X,{isOpen:N,onClose:W,imageUrl:m||"",fileName:`gw${x}-results.png`,gw:x,userName:l||S?.user_metadata?.display_name||S?.email||"User"})})]});return typeof document<"u"&&document.body?fe.createPortal(c,document.body):c}function Pe(){const{user:o}=le(),[t,x]=R.useState(null),[v,_]=R.useState(!0),[$,C]=R.useState(!1),[S,G]=R.useState(null),T=R.useRef(null),[M,L]=R.useState(!1),[a,g]=R.useState(null),[b,h]=R.useState(null),[N,y]=R.useState(!1);async function m(){if(o){_(!0);try{const s=await ve(o.id);x(s)}catch{}finally{_(!1)}}}R.useEffect(()=>{let s=!0;const r=async()=>{const{data:i}=await k.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(s&&i){const P=i?.current_gw??null;G(P)}};r();const l=k.channel("stats-app-meta").on("postgres_changes",{event:"*",schema:"public",table:"app_meta"},()=>{r()}).subscribe();return()=>{s=!1,k.removeChannel(l)}},[]);const{state:E}=te(S,o?.id),{state:w}=te(t?.lastCompletedGw??null,o?.id);if(R.useEffect(()=>{let s=!0;return(async()=>{const{data:l}=await k.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(s&&l){const i=l?.current_gw??null;h(i)}})(),()=>{s=!1}},[]),R.useEffect(()=>{o?m():_(!1)},[o]),R.useEffect(()=>{if(!o||!S||E===null)return;let s=!0;return(async()=>{if(E!=="LIVE"&&E==="RESULTS_PRE_GW"){const{data:l}=await k.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),i=l?.gw||null;i&&i!==T.current&&(T.current=i,s&&m());return}})(),()=>{s=!1}},[o,S,E]),!o)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6",children:e.jsx("div",{className:"max-w-4xl lg:max-w-[1024px] mx-auto px-4 lg:px-6",children:e.jsx("div",{className:"bg-white rounded-xl shadow-md p-6 text-center",children:e.jsx("p",{className:"text-slate-600",children:"Please sign in to view your stats."})})})});const d=t&&(t.lastCompletedGw!==null||t.overallPercentile!==null);return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 overflow-x-hidden",children:[e.jsx("style",{children:`
        @keyframes sparkle {
          0%, 100% {
            opacity: 1;
            transform: scale(1) rotate(0deg);
          }
          25% {
            opacity: 0.9;
            transform: scale(1.05) rotate(-3deg);
          }
          50% {
            opacity: 1;
            transform: scale(1.1) rotate(3deg);
          }
          75% {
            opacity: 0.9;
            transform: scale(1.05) rotate(-3deg);
          }
        }
        .sparkle-trophy {
          animation: sparkle 2s ease-in-out infinite;
          filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.6));
        }
        @media (min-width: 1024px) {
          .desktop-constrained-section {
            margin-right: 0 !important;
            padding-right: 1.5rem !important;
          }
          .desktop-constrained-unicorn {
            margin-right: 0 !important;
            padding-right: 1.5rem !important;
          }
          .unicorn-scroll-container {
            margin-left: 0 !important;
            margin-right: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            width: 100% !important;
          }
        }
      `}),e.jsxs("div",{className:"max-w-4xl lg:max-w-[1024px] mx-auto px-4 lg:px-6 py-6",children:[e.jsxs(he,{to:"/profile",className:"inline-flex items-center gap-2 text-slate-600 hover:text-slate-800 mb-4 transition-colors",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),e.jsx("span",{children:"Back to Profile"})]}),e.jsx(xe,{title:"Stats",as:"h1",className:"mb-6"}),t&&t.lastCompletedGw!==null&&(w!=="LIVE"&&w!=="GW_OPEN"&&w!=="GW_PREDICTED"?e.jsx("button",{onClick:()=>{g(t.lastCompletedGw),L(!0),y(!0)},className:"w-full mb-6 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-semibold py-3 px-4 rounded-xl shadow-md transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-75 disabled:cursor-not-allowed",disabled:N,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-lg whitespace-nowrap",children:["Your Gameweek ",t.lastCompletedGw," Results"]}),N?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white flex-shrink-0 ml-2"}):e.jsx("svg",{className:"w-5 h-5 flex-shrink-0 ml-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]})}):null),!d&&!v?e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-8 text-center",children:[e.jsx("p",{className:"text-slate-600 text-lg",children:"Not enough games yet â€” check back after a few Gameweeks."}),e.jsx("p",{className:"text-slate-500 text-sm mt-2",children:"The numbers will start to tell a story soon."})]}):e.jsxs("div",{className:"space-y-6 lg:grid lg:grid-cols-2 lg:gap-6 lg:space-y-0",children:[t&&t.lastCompletedGw!==null&&t.lastCompletedGwPercentile!==null&&(()=>{const s=t.lastCompletedGwPercentile,r=Math.round(100-s),l=Math.round(s),i=s>=75;return e.jsx(D,{label:`Gameweek ${t.lastCompletedGw}`,value:i?`You were in the top ${r}% of players.`:`You were in the bottom ${l}% of players.`,loading:v})})(),t&&t.overallPercentile!==null&&(()=>{const s=t.overallPercentile,r=Math.round(100-s),l=Math.round(s),i=s>=75;return e.jsx(D,{label:"Overall",value:i?`You're in the top ${r}% of players.`:`You're in the bottom ${l}% of players.`,loading:v})})(),t&&t.mostCorrectTeam&&e.jsx(se,{label:"Most correctly predicted team",teamCode:t.mostCorrectTeam.code,teamName:t.mostCorrectTeam.name,percentage:t.mostCorrectTeam.percentage,isCorrect:!0,loading:v}),t&&t.mostIncorrectTeam&&e.jsx(se,{label:"Most incorrectly picked team",teamCode:t.mostIncorrectTeam.code,teamName:t.mostIncorrectTeam.name,percentage:t.mostIncorrectTeam.percentage,isCorrect:!1,loading:v}),t&&t.correctPredictionRate!==null&&e.jsx(D,{label:"Correct prediction rate",value:`${t.correctPredictionRate.toFixed(2)}%`,loading:v}),t&&t.trophyCabinet!==null&&e.jsx("div",{className:"lg:col-span-2",children:e.jsx(be,{lastGw:t.trophyCabinet.lastGw,form5:t.trophyCabinet.form5,form10:t.trophyCabinet.form10,overall:t.trophyCabinet.overall,loading:v})}),o&&e.jsx("div",{className:"lg:col-span-2 lg:overflow-hidden lg:rounded-xl",children:e.jsx(ke,{userId:o.id,loading:v})}),t&&t.chaosIndex!==null&&e.jsx(D,{label:"Chaos Index",value:`${t.chaosIndex.toFixed(2)}%`,subcopy:"How often you pick an outcome that 25% or fewer players picked",loading:v}),t&&t.chaosTotalCount!==null&&t.chaosTotalCount>0&&t.chaosCorrectCount!==null&&e.jsx(D,{label:"Chaos Index Success Rate",value:`${(t.chaosCorrectCount/t.chaosTotalCount*100).toFixed(2)}%`,subcopy:"How often you're right when you pick an outcome that 25% or fewer players picked",loading:v}),t&&t.weeklyParData&&t.weeklyParData.length>0&&t.lastCompletedGw&&(()=>{const r=(t.weeklyParData.filter(l=>l.userPoints>l.averagePoints).length/t.weeklyParData.length*100).toFixed(0);return e.jsxs("div",{className:"lg:col-span-2 desktop-constrained-section bg-white rounded-l-xl lg:rounded-xl shadow-md lg:overflow-hidden",style:{marginRight:"-100vw",paddingRight:"100vw",paddingTop:"1.5rem",paddingBottom:"1.5rem",paddingLeft:"1.5rem"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm font-medium text-slate-600",children:"Weekly Performance vs Average"}),e.jsx("div",{className:"pr-2",children:e.jsx(je,{value:$,onChange:C,labels:{on:"Complex",off:"Simple"}})})]}),e.jsxs("div",{className:"overflow-x-auto scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch",overscrollBehaviorX:"contain",overscrollBehaviorY:"auto",touchAction:"pan-x",marginLeft:"-1.5rem",marginRight:"-1.5rem",paddingLeft:"1.5rem",paddingRight:"1.5rem",width:"calc(100% + 3rem)"},children:[e.jsx("style",{children:".scrollbar-hide::-webkit-scrollbar { display: none; }"}),e.jsx(we,{weeklyData:t.weeklyParData,latestGw:t.lastCompletedGw,showInfo:$})]}),e.jsxs("div",{className:"text-sm font-bold text-slate-700 mt-2",children:["You perform above average ",r,"% of the time."]})]})})(),t&&t.weeklyParData&&t.weeklyParData.length>0&&(()=>{const s=t.weeklyParData.reduce((l,i)=>l+(i.userPoints-i.averagePoints),0),r=s>=0?`+${s.toFixed(1)}`:s.toFixed(1);return r==="0.0"?null:e.jsx(D,{label:"Total Swing",value:r,subcopy:"Your total points difference from the average across all gameweeks",loading:v})})(),t&&t.bestStreak>0&&t.bestStreakGwRange&&e.jsx(pe,{label:"Most consecutive weeks in the top 25%",streakCount:t.bestStreak,gwRange:t.bestStreakGwRange,loading:v}),t&&t.avgPointsPerWeek!==null&&e.jsx(D,{label:"Avg points / week",value:t.avgPointsPerWeek.toFixed(2),loading:v}),t&&t.bestSingleGw&&e.jsx(D,{label:"Best single Gameweek",value:e.jsxs("span",{children:[e.jsx("span",{className:"text-2xl font-bold text-slate-800",children:t.bestSingleGw.points}),e.jsxs("span",{className:"text-sm text-slate-600 ml-2",children:["on GW",t.bestSingleGw.gw]})]}),loading:v}),t&&t.lowestSingleGw&&e.jsx(D,{label:"Lowest single Gameweek",value:e.jsxs("span",{children:[e.jsx("span",{className:"text-2xl font-bold text-slate-800",children:t.lowestSingleGw.points}),e.jsxs("span",{className:"text-sm text-slate-600 ml-2",children:["on GW",t.lowestSingleGw.gw]})]}),loading:v})]}),M&&a&&e.jsx(Ce,{isOpen:M,onClose:()=>{L(!1),g(null),y(!1)},gw:a,nextGw:b&&b>a?b:null,onLoadingChange:s=>{y(s)}})]})]})}export{Pe as default};
