import{u as P,r as d,s as u,j as e,L as k,P as v}from"./index-Bu25J0QH.js";import{N as j}from"./NotificationSection-CBi76uZB.js";function T(){const{user:a}=P(),[m,c]=d.useState([{id:"new-gameweek",label:"New Gameweek Published",description:"Email me when new fixtures are ready.",enabled:!1},{id:"results-published",label:"Results Published",description:"Email me when results and league tables are updated.",enabled:!1},{id:"news-updates",label:"TOTL News & Updates",description:"Occasional emails about new features and announcements.",enabled:!1}]),[x,f]=d.useState(!0),[g,p]=d.useState(!1),h={"new-gameweek":"new_gameweek","results-published":"results_published","news-updates":"news_updates"};d.useEffect(()=>{if(!a){f(!1);return}y()},[a]);async function b(s){if(a)try{const{data:{session:r}}=await u.auth.getSession();if(!r?.access_token){console.warn("[EmailPreferences] No session token, skipping MailerLite sync");return}const t=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"https://playtotl.com/.netlify/functions/syncEmailPreferences":"/.netlify/functions/syncEmailPreferences",n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`}});if(!n.ok){const i=await n.text();throw new Error(`MailerLite sync failed: ${n.status} ${i}`)}console.log("[EmailPreferences] Successfully synced preferences to MailerLite")}catch(r){console.error("[EmailPreferences] Error syncing to MailerLite:",r)}}async function y(){if(a)try{const{data:s,error:r}=await u.from("email_preferences").select("new_gameweek, results_published, news_updates").eq("user_id",a.id).maybeSingle();r&&r.code!=="PGRST116"&&console.error("Error fetching email preferences:",r),s&&c([{id:"new-gameweek",label:"New Gameweek Published",description:"Email me when new fixtures are ready.",enabled:s.new_gameweek??!1},{id:"results-published",label:"Results Published",description:"Email me when results and league tables are updated.",enabled:s.results_published??!1},{id:"news-updates",label:"TOTL News & Updates",description:"Occasional emails about new features and announcements.",enabled:s.news_updates??!1}])}catch(s){console.error("Error fetching email preferences:",s)}finally{f(!1)}}async function E(s,r){if(!a)return;if(c(t=>t.map(n=>n.id===s?{...n,enabled:r}:n)),!h[s]){console.error("Unknown preference ID:",s);return}p(!0);try{const t=m.reduce((o,l)=>{const w=h[l.id];return w&&(o[w]=l.id===s?r:l.enabled),o},{}),n={user_id:a.id,...t},{error:i}=await u.from("email_preferences").upsert(n,{onConflict:"user_id"});if(i){console.error("Error saving email preference:",i),c(o=>o.map(l=>l.id===s?{...l,enabled:!r}:l));return}b(t).catch(o=>{console.error("Error syncing to MailerLite:",o)})}catch(t){console.error("Error saving email preference:",t),c(n=>n.map(i=>i.id===s?{...i,enabled:!r}:i))}finally{p(!1)}}return a?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",children:e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs(k,{to:"/profile",className:"inline-flex items-center gap-2 text-slate-600 hover:text-slate-800 mb-4 transition-colors",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),e.jsx("span",{children:"Back to Profile"})]}),e.jsx(v,{title:"Email Preferences",as:"h1",className:"mb-6"}),e.jsxs("div",{className:"space-y-6",children:[x?e.jsx("div",{className:"bg-white rounded-xl shadow-md p-6 text-center",children:e.jsx("p",{className:"text-slate-600",children:"Loading preferences..."})}):e.jsx(j,{title:"Email Preferences",description:"Choose which emails you'd like to receive from TOTL",options:m,onToggle:E}),g&&e.jsx("div",{className:"text-sm text-slate-500 text-center",children:"Saving preferences..."})]})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsx("div",{className:"bg-white rounded-xl shadow-md p-6 text-center",children:e.jsx("p",{className:"text-slate-600",children:"Please sign in to view your email preferences."})})})})}export{T as default};
