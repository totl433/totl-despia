import{u as F,a as f,s as w,j as t}from"./index-DSeN78nc.js";const I=()=>{const x=typeof window<"u"?window.location.hostname:"",p=typeof window<"u"?window.location.origin:"";return x.includes("netlify.app")||x.includes("netlify.com")?`${p}/.netlify/functions/fetchFootballData`:x==="localhost"||x==="127.0.0.1"?"https://totl-staging.netlify.app/.netlify/functions/fetchFootballData":"/.netlify/functions/fetchFootballData"};function z(){const{user:x}=F(),p=x?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||x?.id==="36f31625-6d6c-4aa4-815a-1493a812841b",[r,E]=f.useState(null),[_,M]=f.useState([]),[u,y]=f.useState(new Map),[A,N]=f.useState(!1),[b,j]=f.useState(!1),[k,g]=f.useState(""),[S,T]=f.useState(""),[$,h]=f.useState(null),[C,D]=f.useState(!0);f.useEffect(()=>{if(!p)return;let a=!0;return(async()=>{try{const{data:e,error:l}=await w.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(l)throw l;if(a&&e){const o=(e.current_gw||13)+1;E(o);const{data:c}=await w.from("app_fixtures").select("*").eq("gw",o).order("fixture_index",{ascending:!0});if(c&&c.length>0){const m=new Map;c.forEach(n=>{m.set(n.fixture_index,{api_match_id:n.api_match_id||0,home_team:n.home_team||"",away_team:n.away_team||"",home_code:n.home_code||"",away_code:n.away_code||"",home_name:n.home_name||"",away_name:n.away_name||"",home_crest:n.home_crest||null,away_crest:n.away_crest||null,kickoff_time:n.kickoff_time||"",selected:!0})}),y(m)}}}catch(e){console.error("Error loading next GW:",e)}finally{a&&D(!1)}})(),()=>{a=!1}},[p]);const G=async a=>{if(!r)return h("Next GW not loaded yet."),null;try{const e=new Date,l=new Date(e);l.setDate(e.getDate()+7);const s=e.toISOString().split("T")[0],o=l.toISOString().split("T")[0],c=new URLSearchParams({competition:"PL",dateFrom:s,dateTo:o}),n=`${I()}?${c.toString()}`,d=await fetch(n,{signal:a});if(!d.ok){const v=await d.text();return d.status===429?(h("Rate limit reached. Please wait a moment."),null):(h(`Server error (${d.status}). ${v.substring(0,100)}`),null)}const i=await d.json();if(!i.success||!i.data)return h("Invalid API response format."),null;const L=(i.data.matches||[]).filter(v=>v.matchday===r);return h(null),L}catch(e){return e instanceof Error&&e.name==="AbortError"||(console.error("Error fetching matches:",e),h("Failed to fetch matches. Check your connection.")),null}},W=a=>{const e=new Map(u),l=Array.from(e.entries()).find(([s,o])=>o.api_match_id===a.id);if(l){const[s]=l;e.delete(s);const o=Array.from(e.entries()).sort(([m],[n])=>m-n),c=new Map;o.forEach(([m,n],d)=>{c.set(d,n)}),y(c)}else{const o=(e.size>0?Math.max(...Array.from(e.keys())):-1)+1,c={api_match_id:a.id,home_team:a.homeTeam.shortName,away_team:a.awayTeam.shortName,home_code:a.homeTeam.tla,away_code:a.awayTeam.tla,home_name:a.homeTeam.name,away_name:a.awayTeam.name,home_crest:a.homeTeam.crest||null,away_crest:a.awayTeam.crest||null,kickoff_time:a.utcDate,selected:!0};e.set(o,c),y(e)}},P=async()=>{if(!r){g("Next GW not loaded");return}if(u.size===0){g("Please select at least one fixture");return}const a=Array.from(u.values()).filter(e=>!e.api_match_id||e.api_match_id===0);if(a.length>0){g(`Cannot save: ${a.length} fixture${a.length===1?"":"s"} missing api_match_id. Please select fixtures from the API matches list.`);return}if(confirm(`Are you sure you want to save GW ${r} with ${u.size} fixture${u.size===1?"":"s"}? This will replace any existing fixtures for this game week.`)){N(!0),g(""),T("");try{const e=Array.from(u.entries()).map(([d,i])=>({gw:r,fixture_index:d,api_match_id:i.api_match_id,home_team:i.home_team,away_team:i.away_team,home_code:i.home_code,away_code:i.away_code,home_name:i.home_name,away_name:i.away_name,home_crest:i.home_crest||null,away_crest:i.away_crest||null,kickoff_time:i.kickoff_time}));console.log(`[ApiAdmin] Saving ${e.length} fixtures to app_fixtures for GW ${r}...`);const{data:l,error:s}=await w.from("app_fixtures").upsert(e,{onConflict:"gw,fixture_index",ignoreDuplicates:!1}).select();if(s)throw console.error("[ApiAdmin] ❌ Error upserting fixtures to app_fixtures:",s),console.error("[ApiAdmin] Error details:",JSON.stringify(s,null,2)),s;const o=l?.length||e.length;console.log(`[ApiAdmin] ✅ Successfully saved ${o} fixtures to app_fixtures for GW ${r}`);const{data:c,error:m}=await w.from("app_fixtures").select("fixture_index").eq("gw",r);m?console.warn("[ApiAdmin] ⚠️ Could not verify fixtures were saved:",m):(console.log(`[ApiAdmin] ✅ Verified: ${c?.length||0} fixtures exist in app_fixtures for GW ${r}`),(c?.length||0)!==o&&console.warn(`[ApiAdmin] ⚠️ Mismatch: Expected ${o} fixtures but found ${c?.length||0} in database`));const{error:n}=await w.from("app_meta").upsert({id:1,current_gw:r},{onConflict:"id"});n&&console.error("[ApiAdmin] Error updating app_meta:",n);try{const d=await fetch("/.netlify/functions/sendPushAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:`GAME WEEK ${r} - FIXTURES ARE OUT!`,message:"Make your predictions now!",data:{type:"fixtures_published",gw:r}})}),i=await d.json().catch(()=>({}));d.ok&&i.ok?console.log(`[ApiAdmin] Push notification sent to ${i.sentTo||0} users`):console.warn("[ApiAdmin] Push notification failed:",i)}catch(d){console.error("[ApiAdmin] Error sending push notification:",d)}T(`Game Week ${r} saved with ${u.size} Premier League fixtures!`)}catch(e){g(e.message??"Failed to save gameweek.")}finally{N(!1)}}};return p?C?t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-slate-600",children:"Loading..."})}):t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900 mb-2",children:"API Admin - Premier League"}),t.jsxs("p",{className:"text-sm text-slate-600 mb-6",children:["Select Premier League fixtures for Game Week ",r,". Check the feed for any cancelled or postponed games."]}),k&&t.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:k}),S&&t.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",children:S}),$&&t.jsxs("div",{className:"mb-4 p-4 bg-amber-50 border-2 border-amber-400 rounded-lg text-amber-800 text-sm font-medium shadow-md",children:["⚠️ ",$]}),t.jsx("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Next Game Week"}),t.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:["GW ",r]})]}),u.size>0&&t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Selected Fixtures"}),t.jsx("div",{className:"text-2xl font-bold text-[#1C8376]",children:u.size})]})]})}),t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:["Premier League Matches for GW ",r," (Matchday ",r,")"]}),t.jsxs("p",{className:"text-sm text-slate-500 mb-4",children:["Loading matches from the API that are tagged with Matchday ",r," (corresponds to GW ",r,")."]}),t.jsx("button",{onClick:()=>{if(b||!r)return;j(!0),h(null);const a=new AbortController;G(a.signal).then(e=>{if(e&&e.length>0){M(e),h(null);const l=new Map;e.forEach((s,o)=>{l.set(o,{api_match_id:s.id,home_team:s.homeTeam.shortName,away_team:s.awayTeam.shortName,home_code:s.homeTeam.tla,away_code:s.awayTeam.tla,home_name:s.homeTeam.name,away_name:s.awayTeam.name,home_crest:s.homeTeam.crest||null,away_crest:s.awayTeam.crest||null,kickoff_time:s.utcDate,selected:!0})}),y(l)}else e&&e.length===0&&h(`No Premier League matches found for Matchday ${r} (GW ${r}) in the next week.`)}).catch(e=>{e instanceof Error&&e.name!=="AbortError"&&h("Failed to fetch matches. Please try again.")}).finally(()=>{j(!1)})},disabled:b||!r,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",type:"button",children:b?"Loading...":`Load GW ${r} Matches (Matchday ${r})`})]}),_.length>0&&t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800",children:["Available Matches (",_.length,") - All Selected by Default"]}),t.jsx("button",{onClick:P,disabled:A||u.size===0,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 font-semibold",children:A?"Saving...":`Save GW ${r} (${u.size} fixtures)`})]}),t.jsx("div",{className:"space-y-2",children:_.map(a=>{const e=Array.from(u.values()).some(i=>i.api_match_id===a.id),l=new Date(a.utcDate),s=new Date;s.setHours(0,0,0,0);const o=new Date(s);o.setDate(s.getDate()+1);const c=new Date(l);c.setHours(0,0,0,0);let m="";c.getTime()===s.getTime()?m="TODAY":c.getTime()===o.getTime()?m="TOMORROW":m=l.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"});const n=`${String(l.getUTCHours()).padStart(2,"0")}:${String(l.getUTCMinutes()).padStart(2,"0")} UTC`,d=`${m} ${n}`;return t.jsx("div",{className:`p-3 border-2 rounded-lg transition-colors ${e?"bg-[#1C8376]/10 border-[#1C8376]":"bg-slate-50 border-slate-200"}`,children:t.jsxs("label",{className:"flex items-center gap-4 cursor-pointer",children:[t.jsxs("div",{className:"relative flex-shrink-0",children:[t.jsx("input",{type:"checkbox",checked:e,onChange:()=>W(a),className:"w-6 h-6 cursor-pointer appearance-none border-2 rounded transition-all",style:{minWidth:"24px",minHeight:"24px",borderColor:e?"#1C8376":"#94a3b8",backgroundColor:e?"#1C8376":"white"}}),e&&t.jsx("svg",{className:"absolute top-0 left-0 w-6 h-6 pointer-events-none",fill:"none",stroke:"white",strokeWidth:"3",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})]}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"font-medium text-slate-800",children:[a.homeTeam.shortName," vs ",a.awayTeam.shortName]}),t.jsxs("div",{className:"text-xs text-slate-500",children:[d," • ",a.status," • Matchday ",a.matchday]})]})]})},a.id)})})]})]})}):t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-red-600",children:"Access denied. Admin only."})})}export{z as default};
