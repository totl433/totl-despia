import{r as u,j as e,R as nt,L as qe,u as ft,s as I}from"./index-CKJVCyNd.js";import{S as rt}from"./Section-CR8ZMFvu.js";import{M as ht}from"./MiniLeagueCard-AYQq7IlE.js";import{L as xt}from"./leagueStart-bnJXG_AL.js";import{a as H,b as We}from"./teamNames-lueGeFt9.js";import{u as gt}from"./useLiveScores-gSaolhiG.js";function wt(){const[n,b]=u.useState(!1),o=u.useRef(null),Z=u.useRef(null);u.useEffect(()=>{const E=setTimeout(()=>{b(!0)},50);return()=>clearTimeout(E)},[]),u.useEffect(()=>{let E;const X=()=>{E=requestAnimationFrame(()=>{const _=window.scrollY;if(Z.current&&o.current){const te=Math.min(1,_/300)*180,C=Math.max(0,1-_/250),D=Math.max(.4,1-_/400),O=_<400;Z.current.style.height=O?"130px":"0px",_>0?(o.current.style.opacity=C.toString(),o.current.style.transform=`perspective(1000px) rotateY(${te}deg) scale(${D})`,o.current.style.transition="opacity 0.1s ease-out, transform 0.1s ease-out"):(o.current.style.opacity="1",o.current.style.transform="perspective(1000px) rotateY(0deg) scale(1)",o.current.style.transition="opacity 0.6s ease-out, transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)")}})};return window.addEventListener("scroll",X,{passive:!0}),()=>{window.removeEventListener("scroll",X),cancelAnimationFrame(E)}},[]);const ee=n?0:-360;return e.jsx("div",{ref:Z,className:"w-full flex justify-center items-start transition-all duration-200",style:{height:"130px",overflow:"hidden",paddingTop:"4px",paddingBottom:"0px",perspective:"1000px"},children:e.jsx("div",{ref:o,style:{opacity:n?1:0,transform:`perspective(1000px) rotateY(${ee}deg) scale(1)`,transformStyle:"preserve-3d",transition:"opacity 0.6s ease-out, transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)",willChange:"transform, opacity"},children:e.jsx("img",{src:"/assets/badges/totl-logo1.svg",alt:"TOTL",className:"h-[88px] sm:h-[110px]",style:{filter:"brightness(0)",backfaceVisibility:"hidden"}})})})}const Fe=nt.memo(function({title:b,badgeSrc:o,badgeAlt:Z,linkTo:ee,rank:E,total:X,score:_,gw:W,totalFixtures:te,subtitle:C,variant:D="default"}){const O=E&&X&&X>0?`TOP ${Math.round(E/X*100)}%`:"—";return D==="lastGw"?e.jsx(qe,{to:ee,className:"flex-shrink-0 w-[148px] h-[148px] rounded-xl border bg-white shadow-sm overflow-hidden cursor-pointer block hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-3 h-full flex flex-col relative",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("div",{className:"flex items-baseline gap-[3px]",style:{marginTop:"-4px"},children:_!==void 0&&te!==void 0?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-[#1C8376]",style:{fontSize:"38px",fontWeight:"normal",lineHeight:"1"},children:_}),e.jsxs("div",{className:"flex items-baseline gap-[4px]",children:[e.jsx("span",{className:"text-slate-500",style:{fontSize:"18px",fontWeight:"normal",lineHeight:"1"},children:"/"}),e.jsx("span",{className:"text-slate-500",style:{fontSize:"18px",fontWeight:"normal",lineHeight:"1"},children:te})]})]}):e.jsx("span",{className:"leading-none text-slate-900",children:"—"})}),e.jsx("svg",{className:"w-4 h-4 text-slate-400 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsxs("div",{className:"text-xs text-slate-500 mb-2",children:["GAME WEEK ",W??"—"]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"text-xs font-semibold text-slate-900",children:O})})]})]})}):e.jsx(qe,{to:ee,className:"flex-shrink-0 w-[148px] h-[148px] rounded-xl border bg-white shadow-sm overflow-hidden cursor-pointer block hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-3 h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[o&&e.jsx("img",{src:o,alt:Z||b,className:"w-[32px] h-[32px]"}),e.jsx("svg",{className:"w-4 h-4 text-slate-400 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-2",children:C||b}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"text-xs font-semibold text-slate-900",children:O})})]})]})})}),pt=nt.memo(function({streak:b,last10GwScores:o,latestGw:Z}){const ee=o,E=ee.filter(C=>C.score!==null),X=E.length>0?Math.max(...E.map(C=>C.score)):10,_=0,W=X-_||1,te=60;return e.jsx("div",{className:"flex-shrink-0 w-[340px] sm:w-[400px] h-[148px] rounded-xl border bg-white shadow-sm overflow-hidden hover:shadow-md transition-shadow relative",children:e.jsxs("div",{className:"p-3 h-full flex flex-col",children:[e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"mb-2 relative",style:{height:"70px"},children:e.jsx("div",{className:"relative h-full",children:e.jsx("div",{className:"flex items-end justify-between gap-1 h-full px-1",children:ee.map(C=>{const D=C.score!==null,O=C.gw===Z,$=C.score??0,F=D?($-_)/W*te:0;return e.jsxs("div",{className:"flex flex-col items-center justify-end gap-1 flex-1 relative min-w-0",children:[D&&e.jsx("div",{className:`text-xs font-bold mb-0.5 leading-none ${O?"text-[#1C8376]":"text-slate-700"}`,children:$}),e.jsx("div",{className:`w-full rounded-t transition-all ${D?O?"bg-[#1C8376]":"bg-slate-400":"bg-slate-200"}`,style:{height:`${F}px`,minHeight:D?"4px":"0"},title:D?`GW${C.gw}: ${$}`:`GW${C.gw}: Not played`}),e.jsxs("div",{className:`text-[10px] font-medium leading-tight ${D?O?"text-[#1C8376] font-bold":"text-slate-700":"text-slate-400"}`,children:["GW",C.gw]})]},C.gw)})})})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("svg",{className:"w-3 h-3 text-slate-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",strokeWidth:2}),e.jsx("circle",{cx:"12",cy:"12",r:"6",strokeWidth:2}),e.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor"})]}),e.jsxs("span",{className:"text-sm font-semibold text-slate-900",children:["Your Streak"," ",e.jsx("span",{className:"font-bold text-orange-500",children:b>0?`${b} ${b===1?"Week":"Weeks"}`:"Start your streak!"})]})]}),e.jsx("span",{className:"text-[10px] font-medium text-slate-400",children:"Last 10"})]})]})})});function bt(n,b,o=!1){if(n==="FINISHED")return"FT";if(n==="PAUSED")return"HT";if(n==="IN_PLAY"){if(b==null)return"LIVE";if(o)return`${b}'`;if(b>=1&&b<=45)return"First Half";if(b>45&&b<=50)return"45+";if(b>50)return"Second Half"}return"LIVE"}const _t=({fixture:n,pick:b,liveScore:o,isTestApi:Z=!1,showPickButtons:ee=!0})=>{const E=n.home_team||n.home_name||n.home_code||"",X=n.away_team||n.away_name||n.away_code||"",_=H(E),W=H(X),te=n.kickoff_time?(()=>{const d=new Date(n.kickoff_time),v=String(d.getUTCHours()).padStart(2,"0"),h=String(d.getUTCMinutes()).padStart(2,"0");return`${v}:${h}`})():"—",C=!!o,D=C&&o.status==="IN_PLAY",O=C&&(o.status==="PAUSED"||o.status==="HALF_TIME"||o.status==="HT"),$=C&&o.status==="FINISHED",F=D||O,De=D||O,be=C&&(F||$),he=!be,Se=C&&(F||$)&&!!o.goals,_e=C&&(F||$)&&!!o.red_cards,ze=ee&&(!Z||b!==void 0),Me=C&&(F||$)&&o.homeScore>o.awayScore,Be=C&&(F||$)&&o.awayScore>o.homeScore,ye=d=>{const v=b===d;let h=!1;return o&&(d==="H"&&o.homeScore>o.awayScore||d==="A"&&o.awayScore>o.homeScore||d==="D"&&o.homeScore===o.awayScore)&&(h=!0),{isPicked:v,isCorrectResult:h,isCorrect:v&&h,isWrong:v&&(F||$)&&!h}},Le=ye("H"),xe=ye("D"),ve=ye("A"),ne=d=>{const v="h-16 rounded-xl border text-sm font-medium transition-all flex items-center justify-center select-none";return D||F?d.isCorrect?`${v} bg-emerald-600 text-white border-emerald-600 animate-pulse shadow-lg shadow-emerald-500/50`:d.isWrong?`${v} bg-[#1C8376] text-white border-[#1C8376]`:d.isPicked?`${v} bg-[#1C8376] text-white border-[#1C8376]`:d.isCorrectResult&&!d.isPicked?`${v} bg-slate-50 text-slate-600 border-2 border-slate-300 animate-pulse`:`${v} bg-slate-50 text-slate-600 border-slate-200`:$?d.isCorrect?`${v} bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 text-white shadow-2xl shadow-yellow-400/40 transform scale-110 rotate-1 relative overflow-hidden before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/70 before:to-transparent before:animate-[shimmer_1.2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/50 after:to-transparent after:animate-[shimmer_1.8s_ease-in-out_infinite_0.4s]`:d.isWrong?`${v} bg-[#1C8376] text-white border-[#1C8376]`:d.isCorrectResult&&!d.isPicked?`${v} bg-slate-50 text-slate-600 border-4 border-emerald-600`:d.isPicked?`${v} bg-[#1C8376] text-white border-[#1C8376]`:`${v} bg-slate-50 text-slate-600 border-slate-200`:d.isPicked?`${v} bg-[#1C8376] text-white border-[#1C8376]`:`${v} bg-slate-50 text-slate-600 border-slate-200`},Ge=(d,v)=>{if(!_e)return 0;const h=o.red_cards||[];h.length>0&&console.log(`[FixtureCard] Red cards for ${d} (${v?"home":"away"}):`,{allRedCards:h,teamName:d,homeName:_,awayName:W,liveScoreHomeTeam:o.home_team,liveScoreAwayTeam:o.away_team});const A=h.filter(U=>{if(!U||!U.team)return!1;const R=U.team||"",S=H(R),oe=v?o.home_team?H(o.home_team):_:o.away_team?H(o.away_team):W,V=se(S),J=se(oe),ie=v?_:W,ge=se(ie),ae=(ce,q)=>{const de=ce.toLowerCase().trim(),me=q.toLowerCase().trim();return de===me||de.startsWith(me+" ")};return S===oe||S===d||ae(S,oe)||ae(S,d)||ae(S,ie)||ae(V,J)||ae(V,ge)||V===J||V===ge||S===H(v?n.home_team||"":n.away_team||"")||S===H(v?n.home_name||"":n.away_name||"")||R.toLowerCase()===d.toLowerCase()||R.toLowerCase()===ie.toLowerCase()||V&&J&&V.toLowerCase()===J.toLowerCase()});return A.length>0&&console.log(`[FixtureCard] Filtered red cards for ${d}:`,A),A.length},se=d=>d.replace(/^(Ca|Se|At|Es|Gr|Sc|Cr|Fc|Ac|Ad|Ap|Av|Bo|Br|Ce|Ch|Co|Cu|De|Ec|Fe|Fi|Fl|Fo|Fr|Fu|Ga|Go|Gu|He|Ho|Hu|In|It|Ja|Je|Ju|La|Le|Li|Lo|Lu|Ma|Me|Mi|Mo|Na|Ne|Ni|No|Nu|Ol|Os|Pa|Pe|Pi|Po|Pr|Pu|Qu|Ra|Re|Ri|Ro|Ru|Sa|Si|So|Su|Ta|Te|Ti|To|Tr|Tu|Un|Ur|Va|Ve|Vi|Vo|Vu|We|Wi|Wo|Wu|Xa|Xe|Xi|Xo|Xu|Ya|Ye|Yi|Yo|Yu|Za|Ze|Zi|Zo|Zu)\s+/i,"").trim(),Pe=(d,v)=>{if(!Se)return null;const h=o.goals||[],A=o.homeScore||0,U=o.awayScore||0,R=[],S=[],oe=[];h.forEach(f=>{if(!f||!f.team){oe.push(f);return}const G=f.team||"",k=H(G),z=G.toLowerCase().trim().replace(/[^a-z0-9]/g,""),t=o.home_team?H(o.home_team):_,a=o.away_team?H(o.away_team):W,r=t.toLowerCase().replace(/[^a-z0-9]/g,""),y=a.toLowerCase().replace(/[^a-z0-9]/g,""),x=se(k),j=se(t),w=se(a),l=(L,K)=>{const le=L.toLowerCase().trim(),Ee=K.toLowerCase().trim();return le===Ee||le.startsWith(Ee+" ")},m=[_,t,n.home_team||"",n.home_name||"",o.home_team||""].filter(Boolean),g=z===r||z.includes("parissaintgermain")&&r==="psg"||r.includes("parissaintgermain")&&z==="psg"||z.includes("parissaintgermain")&&r.includes("parissaintgermain"),c=z===y||z.includes("parissaintgermain")&&y==="psg"||y.includes("parissaintgermain")&&z==="psg"||z.includes("parissaintgermain")&&y.includes("parissaintgermain"),M=k===t||x===j||l(k,t)||l(x,j)||k===H(n.home_team||"")||k===H(n.home_name||"")||G.toLowerCase()===_.toLowerCase()||g||m.some(L=>G.toLowerCase()===L.toLowerCase()||We(G,L)||We(k,H(L))),Q=[W,a,n.away_team||"",n.away_name||"",o.away_team||""].filter(Boolean),B=k===a||x===w||l(k,a)||l(x,w)||k===H(n.away_team||"")||k===H(n.away_name||"")||G.toLowerCase()===W.toLowerCase()||c||Q.some(L=>G.toLowerCase()===L.toLowerCase()||We(G,L)||We(k,H(L)));M&&!B?R.push(f):B&&!M?S.push(f):oe.push(f)});const V=R.length,J=S.length,ie=oe.length,ge=A-V,ae=U-J;if(ie>0){let f=0,G=0;oe.forEach(k=>{f<ge&&ge>0?(R.push(k),f++):G<ae&&ae>0&&(S.push(k),G++)})}const ce=R.length,q=S.length,de=h.length;if(de!==A+U&&console.warn("[FixtureCard] Goal count mismatch:",{totalGoals:de,homeScore:A,awayScore:U,expectedTotal:A+U}),ce!==A||q!==U){console.log("[FixtureCard] Score-based correction needed:",{homeCount:ce,homeScore:A,awayCount:q,awayScore:U,totalGoals:de});const f=A-ce,G=U-q;if(f>0&&G<0){const k=Math.min(Math.abs(G),f),z=[...S].sort((t,a)=>(a.minute??0)-(t.minute??0));for(let t=0;t<k;t++){const a=z[t],r=S.indexOf(a);r>-1&&(S.splice(r,1),R.push(a),console.log("[FixtureCard] Moved goal from away to home:",a.scorer,a.minute))}}else if(G>0&&f<0){const k=Math.min(Math.abs(f),G),z=[...R].sort((t,a)=>(a.minute??0)-(t.minute??0));for(let t=0;t<k;t++){const a=z[t],r=R.indexOf(a);r>-1&&(R.splice(r,1),S.push(a),console.log("[FixtureCard] Moved goal from home to away:",a.scorer,a.minute))}}}(d.toLowerCase().includes("psg")||d.toLowerCase().includes("paris"))&&console.log("[FixtureCard] PSG goal matching debug:",{teamName:d,isHome:v,homeScore:A,awayScore:U,homeGoalCount:R.length,awayGoalCount:S.length,unmatchedCount:ie,allGoals:h.map(f=>({team:f.team,scorer:f.scorer,minute:f.minute,teamId:f.teamId})),homeGoals:R.map(f=>({team:f.team,scorer:f.scorer,minute:f.minute})),awayGoals:S.map(f=>({team:f.team,scorer:f.scorer,minute:f.minute}))});const me=v?R:S,re=new Map;return me.forEach(f=>{const G=f.scorer||"Unknown",k=f.minute;re.has(G)||re.set(G,[]),k!=null&&re.get(G).push(k)}),d==="Grêmio"&&me.length>0&&console.log("[FixtureCard] Grêmio goals debug:",{teamGoals:me,goalsByScorer:Array.from(re.entries()),goalsByScorerSize:re.size}),re.size===0?null:e.jsx("div",{className:`mt-3 mb-2 flex flex-col ${v?"items-end":"items-start"} gap-0.5`,children:Array.from(re.entries()).map(([f,G],k)=>{const z=G.sort((t,a)=>t-a);return e.jsxs("span",{className:"text-[11px] text-slate-600",children:[f," ",z.map(t=>`${t}'`).join(", ")]},k)})})};return e.jsxs("div",{className:"p-4 !bg-white relative z-0",children:[De&&e.jsxs("div",{className:"absolute top-3 left-3 flex items-center gap-2 z-10 pb-6",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs font-bold text-red-600",children:"LIVE"})]}),e.jsx("div",{className:`flex flex-col px-2 pb-3 ${F?"pt-4":"pt-1"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 flex flex-col items-end",children:[e.jsxs("div",{className:"flex items-center gap-1 relative",children:[e.jsx("div",{className:`break-words ${Me?"font-bold":"font-medium"}`,children:_}),e.jsx("div",{className:"relative flex flex-col items-center",children:e.jsx("img",{src:`/assets/badges/${(n.home_code||E).toUpperCase()}.png`,alt:_,className:"w-5 h-5",onError:d=>{d.currentTarget.style.opacity="0.35"}})})]}),Se&&Pe(_,!0)]}),e.jsx("div",{className:"px-4 flex flex-col items-center",children:be?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 relative",children:[e.jsxs("div",{className:"relative flex flex-col items-center",children:[_e&&Ge(_,!0)>0&&e.jsx("div",{className:"absolute -top-3 left-1/2 -translate-x-1/2 w-1.5 h-2.5 bg-red-600 rounded-sm z-10"}),e.jsx("span",{className:"font-bold text-base text-slate-900",children:o.homeScore})]}),e.jsx("span",{className:"font-bold text-base text-slate-900",children:"-"}),e.jsxs("div",{className:"relative flex flex-col items-center",children:[_e&&Ge(W,!1)>0&&e.jsx("div",{className:"absolute -top-3 left-1/2 -translate-x-1/2 w-1.5 h-2.5 bg-red-600 rounded-sm z-10"}),e.jsx("span",{className:"font-bold text-base text-slate-900",children:o.awayScore})]})]}),e.jsx("span",{className:`text-[10px] font-semibold mt-0.5 ${F?"text-red-600":"text-slate-500"}`,children:bt(o.status,o.minute,Z)})]}):he&&e.jsx("span",{className:"text-slate-500 text-sm",children:te})}),e.jsxs("div",{className:"flex-1 flex flex-col items-start",children:[e.jsxs("div",{className:"flex items-center gap-1 relative",children:[e.jsx("div",{className:"relative flex flex-col items-center",children:e.jsx("img",{src:`/assets/badges/${(n.away_code||X).toUpperCase()}.png`,alt:W,className:"w-5 h-5",onError:d=>{d.currentTarget.style.opacity="0.35"}})}),e.jsx("div",{className:`break-words ${Be?"font-bold":"font-medium"}`,children:W})]}),Se&&Pe(W,!1)]})]})}),ze&&e.jsxs("div",{className:"grid grid-cols-3 gap-3 relative",children:[e.jsx("div",{className:`${ne(Le)} flex items-center justify-center`,children:e.jsx("span",{className:`${Le.isCorrect?"font-bold":""} ${Le.isWrong&&$?"line-through decoration-2 decoration-white":""}`,children:"Home Win"})}),e.jsx("div",{className:`${ne(xe)} flex items-center justify-center`,children:e.jsx("span",{className:`${xe.isCorrect?"font-bold":""} ${xe.isWrong&&$?"line-through decoration-2 decoration-white":""}`,children:"Draw"})}),e.jsx("div",{className:`${ne(ve)} flex items-center justify-center`,children:e.jsx("span",{className:`${ve.isCorrect?"font-bold":""} ${ve.isWrong&&$?"line-through decoration-2 decoration-white":""}`,children:"Away Win"})})]})]})};function yt({value:n,onChange:b}){return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[10px] font-medium transition-colors ${n?"text-slate-400":"text-slate-700"}`,children:"ALL"}),e.jsx("button",{onClick:()=>b(!n),className:"relative inline-flex items-center rounded-full transition-colors focus:outline-none",style:{backgroundColor:n?"#dc2626":"#cbd5e1",width:"48px",height:"24px",border:"none"},"aria-label":n?"Show all games":"Show live games only",children:e.jsx("span",{className:`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-200 ease-in-out ${n?"translate-x-6":"translate-x-0.5"}`})}),e.jsx("span",{className:`text-[10px] font-medium transition-colors ${n?"text-slate-700":"text-slate-400"}`,children:"LIVE"})]})}function vt(n){return n.result==="H"||n.result==="D"||n.result==="A"?n.result:null}function Mt(){const{user:n}=ft(),[b,o]=u.useState([]),[Z,ee]=u.useState({}),[E,X]=u.useState(1),[_,W]=u.useState(null),[te,C]=u.useState([]),[D,O]=u.useState(!0),[$,F]=u.useState(!0),[De,be]=u.useState(!0),[he,Se]=u.useState(null),[_e,ze]=u.useState(null),[Me,Be]=u.useState(null),[ye,Le]=u.useState(null),[xe,ve]=u.useState([]),[ne,Ge]=u.useState([]),[se,Pe]=u.useState({}),[d,v]=u.useState({}),[h,A]=u.useState([]),[U,R]=u.useState(!0),[S,oe]=u.useState(!1),[V,J]=u.useState({}),[ie,ge]=u.useState(!1),ae=u.useMemo(()=>{if(!h?.length)return[];const t=[];for(const a of h)a.api_match_id&&t.push(a.api_match_id);return t},[h]),{liveScores:ce}=gt(void 0,ae.length>0?ae:void 0),q=u.useMemo(()=>{if(!h?.length||!ce.size)return{};const t={};for(const a of h)if(a.api_match_id){const r=ce.get(a.api_match_id);r&&(t[a.fixture_index]={homeScore:r.home_score??0,awayScore:r.away_score??0,status:r.status||"SCHEDULED",minute:r.minute??null,goals:r.goals??null,red_cards:r.red_cards??null,home_team:r.home_team??null,away_team:r.away_team??null})}return t},[ce,h]);u.useEffect(()=>{if(!n?.id){O(!1),be(!1),F(!1);return}let t=!0;return(async()=>{try{const[a,r,y,x,j]=await Promise.all([I.from("league_members").select("leagues(id, name, code, avatar, created_at)").eq("user_id",n.id),I.from("gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),I.from("meta").select("current_gw").eq("id",1).maybeSingle(),I.from("v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0}),I.from("v_ocp_overall").select("user_id, name, ocp")]);if(!t)return;if(a.error)o([]);else{const m=(a.data??[]).map(g=>g.leagues).filter(g=>g!==null);o(m),oe(m.some(g=>g.name==="API Test"))}const w=r.data?.gw??y.data?.current_gw??1,l=y.data?.current_gw??1;if(X(l),W(l),x.error)ve([]),C([]);else{const m=x.data??[];ve(m),C(m.filter(c=>c.user_id===n.id));const g=m.filter(c=>c.gw===w);if(g.length>0){const c=[...g].sort((L,K)=>K.points-L.points);let M=1;const Q=c.map((L,K)=>(K>0&&c[K-1].points!==L.points&&(M=K+1),{...L,rank:M})),B=Q.find(L=>L.user_id===n.id);if(B){const L=Q.filter(K=>K.rank===B.rank).length;Se({rank:B.rank,total:Q.length,score:B.points,gw:w,totalFixtures:10,isTied:L>1})}}}j.error?Ge([]):Ge(j.data??[]),O(!1),be(!1)}catch{t&&(O(!1),be(!1))}})(),()=>{t=!1}},[n?.id]),u.useEffect(()=>{if(!n?.id||!_||!xe.length||!ne.length)return;let t=!0;return(async()=>{try{const{data:a}=await I.from("gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),r=a?.gw??_,y=(x,j,w)=>{if(j<x)return;const l=xe.filter(c=>c.gw>=x&&c.gw<=j),m=new Map;ne.forEach(c=>{m.set(c.user_id,{user_id:c.user_id,name:c.name??"User",formPoints:0,weeksPlayed:new Set})}),l.forEach(c=>{const M=m.get(c.user_id);M&&(M.formPoints+=c.points??0,M.weeksPlayed.add(c.gw))});const g=Array.from(m.values()).filter(c=>{for(let M=x;M<=j;M++)if(!c.weeksPlayed.has(M))return!1;return!0}).sort((c,M)=>M.formPoints-c.formPoints||c.name.localeCompare(M.name));if(g.length>0&&t){let c=1;const M=g.map((B,L)=>(L>0&&g[L-1].formPoints!==B.formPoints&&(c=L+1),{...B,rank:c})),Q=M.find(B=>B.user_id===n.id);if(Q){const B=M.filter(L=>L.rank===Q.rank).length;w({rank:Q.rank,total:M.length,isTied:B>1})}}};if(r>=5&&y(r-4,r,ze),r>=10&&y(r-9,r,Be),ne.length>0&&t){const x=[...ne].sort((m,g)=>(g.ocp??0)-(m.ocp??0)||(m.name??"User").localeCompare(g.name??"User"));let j=1;const w=x.map((m,g)=>(g>0&&(x[g-1].ocp??0)!==(m.ocp??0)&&(j=g+1),{...m,rank:j})),l=w.find(m=>m.user_id===n.id);if(l){const m=w.filter(g=>g.rank===l.rank).length;Le({rank:l.rank,total:ne.length,isTied:m>1})}}}catch{}})(),()=>{t=!1}},[n?.id,_,xe,ne]),u.useEffect(()=>{if(!n?.id||!b.length||!E){F(!1);return}let t=!0;return(async()=>{try{v({}),F(!0);const a=b.map(s=>s.id),[r,y,x,j,w]=await Promise.all([I.from("league_members").select("league_id, user_id, users!inner(id, name)").in("league_id",a),I.from("league_message_reads").select("league_id, last_read_at").eq("user_id",n.id).in("league_id",a),I.from("gw_submissions").select("user_id").eq("gw",E),I.from("gw_results").select("gw, fixture_index, result"),I.from("fixtures").select("gw, kickoff_time").in("gw",Array.from({length:20},(s,N)=>N+1))]);if(!t)return;const l={};(r.data??[]).forEach(s=>{l[s.league_id]||(l[s.league_id]=[]),l[s.league_id].push({id:s.users.id,name:s.users.name})});const m=Array.from(new Set(Object.values(l).flat().map(s=>s.id))),g=new Set((x.data??[]).map(s=>s.user_id).filter(s=>m.includes(s))),c=new Map;(y.data??[]).forEach(s=>{c.set(s.league_id,s.last_read_at)});const M=b.map(async s=>{const N=(l[s.id]??[]).map(we=>we.id);if(N.length===0)return{leagueId:s.id,picks:[]};const{data:Y}=await I.from("picks").select("user_id, gw, fixture_index, pick").in("user_id",N);return{leagueId:s.id,picks:Y??[]}}),Q=a.map(async s=>{const N=c.get(s)??"1970-01-01T00:00:00Z",{count:Y}=await I.from("league_messages").select("id",{count:"exact",head:!0}).eq("league_id",s).gte("created_at",N).neq("user_id",n.id);return{leagueId:s,count:typeof Y=="number"?Y:0}}),[B,L]=await Promise.all([Promise.all(Q),Promise.all(M)]);if(!t)return;const K=new Map;(j.data??[]).forEach(s=>{const N=vt(s);N&&K.set(`${s.gw}:${s.fixture_index}`,N)});const le=[...new Set(Array.from(K.keys()).map(s=>parseInt(s.split(":")[0],10)))].sort((s,N)=>s-N),Ee=(w.data??[]).filter(s=>le.length>0?le.includes(s.gw):s.gw===1),Ke={};B.forEach(({leagueId:s,count:N})=>{Ke[s]=N}),Pe(Ke);const Xe=new Map;L.forEach(({leagueId:s,picks:N})=>{Xe.set(s,N)});const Re=new Map;Ee.forEach(s=>{if(s.kickoff_time&&s.gw){const N=new Date(s.kickoff_time),Y=new Date(N.getTime()-4500*1e3);(!Re.has(s.gw)||Y<Re.get(s.gw))&&Re.set(s.gw,Y)}});const je=new Map;b.forEach(s=>{const N=s.name&&xt[s.name];if(typeof N=="number"){je.set(s.id,N);return}if(s.start_gw!==null&&s.start_gw!==void 0){je.set(s.id,s.start_gw);return}if(s.created_at){const Y=new Date(s.created_at);for(const we of le){const Ne=Re.get(we);if(Ne&&Y<=Ne){je.set(s.id,we);return}}if(le.length>0){je.set(s.id,Math.max(...le)+1);return}}je.set(s.id,E)});const Ae={},Ze={};b.forEach(s=>{const N=l[s.id]??[],Y=N.map(i=>i.id),we=Y.filter(i=>g.has(i)).length,Ne=Y.length;if(Ze[s.id]={allSubmitted:we===Ne&&Ne>0,submittedCount:we,totalCount:Ne},K.size===0){const i=N.sort((p,T)=>p.name.localeCompare(T.name));Ae[s.id]={id:s.id,members:i,userPosition:null,positionChange:null,submittedMembers:Array.from(Y.filter(p=>g.has(p))),sortedMemberIds:i.map(p=>p.id),latestGwWinners:[],latestRelevantGw:null};return}const Je=je.get(s.id)??E,ue=Je===0?le:le.filter(i=>i>=Je);if(ue.length===0){const i=N.sort((p,T)=>p.name.localeCompare(T.name));Ae[s.id]={id:s.id,members:i,userPosition:null,positionChange:null,submittedMembers:Array.from(Y.filter(p=>g.has(p))),sortedMemberIds:i.map(p=>p.id),latestGwWinners:[],latestRelevantGw:null};return}const ot=Xe.get(s.id)??[],Qe=new Set(ue),it=ot.filter(i=>Qe.has(i.gw)),He=new Map;ue.forEach(i=>{He.set(i,new Map)}),K.forEach((i,p)=>{const[T,pe]=p.split(":"),Ce=parseInt(T,10),P=parseInt(pe,10);Qe.has(Ce)&&He.get(Ce)?.set(P,i)});const Oe=new Map,et=new Map;ue.forEach(i=>{const p=new Map;N.forEach(T=>p.set(T.id,{user_id:T.id,score:0,unicorns:0})),Oe.set(i,p)});const Ue=new Map;it.forEach(i=>{const p=`${i.gw}:${i.fixture_index}`,T=Ue.get(p)??[];T.push(i),Ue.set(p,T)});const lt=new Set(N.map(i=>i.id));ue.forEach(i=>{const p=He.get(i),T=Oe.get(i);p.forEach((pe,Ce)=>{const P=`${i}:${Ce}`,Ie=(Ue.get(P)??[]).filter(fe=>lt.has(fe.user_id)),Ve=[];if(Ie.forEach(fe=>{if(fe.pick===pe){const at=T.get(fe.user_id);at&&(at.score+=1,Ve.push(fe.user_id))}}),Ve.length===1&&N.length>=3){const fe=T.get(Ve[0]);fe&&(fe.unicorns+=1)}})});const ke=new Map,Te=new Map,$e=new Map;N.forEach(i=>{ke.set(i.id,0),Te.set(i.id,0),$e.set(i.id,0)}),ue.forEach(i=>{const p=Array.from(Oe.get(i).values());if(p.forEach(P=>{Te.set(P.user_id,(Te.get(P.user_id)??0)+P.score),$e.set(P.user_id,($e.get(P.user_id)??0)+P.unicorns)}),p.sort((P,Ie)=>Ie.score-P.score||Ie.unicorns-P.unicorns),p.length===0)return;const T=p[0],pe=p.filter(P=>P.score===T.score&&P.unicorns===T.unicorns),Ce=new Set(pe.map(P=>P.user_id));et.set(i,Ce),pe.length===1?ke.set(T.user_id,(ke.get(T.user_id)??0)+3):pe.forEach(P=>{ke.set(P.user_id,(ke.get(P.user_id)??0)+1)})});const tt=[...N.map(i=>({user_id:i.id,name:i.name,mltPts:ke.get(i.id)??0,unicorns:$e.get(i.id)??0,ocp:Te.get(i.id)??0}))].sort((i,p)=>p.mltPts-i.mltPts||p.unicorns-i.unicorns||p.ocp-i.ocp||i.name.localeCompare(p.name)),ct=tt.map(i=>i.user_id),st=tt.findIndex(i=>i.user_id===n.id),dt=st!==-1?st+1:null,Ye=ue.length?Math.max(...ue):null,mt=Ye!==null?et.get(Ye)??new Set:new Set,ut=N.sort((i,p)=>i.name.localeCompare(p.name));Ae[s.id]={id:s.id,members:ut,userPosition:dt,positionChange:null,submittedMembers:Array.from(Y.filter(i=>g.has(i))),sortedMemberIds:ct,latestGwWinners:Array.from(mt),latestRelevantGw:Ye}}),ee(Ze),v(Ae),F(!1)}catch{F(!1)}})(),()=>{t=!1}},[n?.id,b,E]),u.useEffect(()=>{if(!n?.id||!S){A([]),R(!1),J({});return}let t=!0;return(async()=>{try{const{data:a}=await I.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle();let r=a?.current_test_gw??1;if(r&&r!==1){const{data:j}=await I.from("test_api_fixtures").select("test_gw").eq("test_gw",r).limit(1).maybeSingle();if(!j){const{data:w}=await I.from("test_api_fixtures").select("test_gw").eq("test_gw",1).limit(1).maybeSingle();w&&(r=1)}}if(!r){A([]),R(!1),J({});return}const[y,x]=await Promise.all([I.from("test_api_fixtures").select("id, test_gw, fixture_index, api_match_id, home_code, away_code, home_team, away_team, home_name, away_name, home_crest, away_crest, kickoff_time").eq("test_gw",r).order("fixture_index",{ascending:!0}),I.from("test_api_picks").select("fixture_index, pick").eq("matchday",r).eq("user_id",n.id)]);if(!t)return;if(y.error?A([]):A((y.data??[]).map(j=>({...j,gw:j.test_gw}))),x.error)J({});else{const j={};(x.data??[]).forEach(w=>{j[w.fixture_index]=w.pick}),J(j)}R(!1)}catch{t&&(A([]),R(!1),J({}))}})(),()=>{t=!1}},[n?.id,S]);const de=u.useMemo(()=>{if(!S||!h.length)return null;const t=Object.keys(V).length>0;let a=0,r=0,y=0,x=!0,j=!1;for(const l of h){const m=q[l.fixture_index],g=V[l.fixture_index],c=m?.status;c==="IN_PLAY"||c==="PAUSED"||c==="FINISHED"?(j=!0,(c==="IN_PLAY"||c==="PAUSED")&&r++,c==="FINISHED"&&y++,c!=="FINISHED"&&(x=!1),g&&m&&(g==="H"&&m.homeScore>m.awayScore||g==="A"&&m.awayScore>m.homeScore||g==="D"&&m.homeScore===m.awayScore)&&a++):x=!1}if(!j&&!t)return null;const w=({score:l,label:m,bgColor:g,icon:c})=>e.jsxs("div",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-white ${g}`,children:[c,e.jsx("span",{className:"text-xs sm:text-sm font-medium opacity-90",children:m}),e.jsxs("span",{className:"flex items-baseline gap-0.5",children:[e.jsx("span",{className:"text-lg sm:text-xl font-extrabold",children:l}),e.jsx("span",{className:"text-sm sm:text-base font-medium opacity-90",children:"/"}),e.jsx("span",{className:"text-base sm:text-lg font-semibold opacity-80",children:h.length})]})]});return!j&&t?e.jsx(w,{score:"--",label:"Score",bgColor:"bg-amber-500 shadow-lg shadow-amber-500/30"}):r===0&&y>0&&!x?e.jsx("div",{className:"flex flex-col items-center gap-2",children:e.jsx(w,{score:a,label:"Score",bgColor:"bg-slate-600",icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})})}):e.jsx("div",{className:"flex flex-col items-center gap-2",children:e.jsx(w,{score:a,label:x?"Score":"Live",bgColor:x?"bg-slate-600":"bg-red-600",icon:x?e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})}):r>0?e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}):void 0})})},[S,h,q,V]),me=u.useMemo(()=>{if(!h.length)return!1;for(const t of h){const a=q[t.fixture_index];if(a&&(a.status==="IN_PLAY"||a.status==="PAUSED"))return!0}return!1},[h,q]),re=u.useMemo(()=>{if(!n?.id||!_)return null;const t=te.filter(w=>w.user_id===n.id).sort((w,l)=>l.gw-w.gw);if(t.length===0)return null;let a=0,r=_;const y=new Set(t.map(w=>w.gw));for(;r>=1&&y.has(r);)a++,r--;const x=[],j=Math.max(1,_-9);for(let w=_;w>=j;w--){const l=t.find(m=>m.gw===w);x.push({gw:w,score:l?l.points:null})}return{streak:a,last10GwScores:x.reverse()}},[n?.id,te,_]),f=u.useMemo(()=>b.length?[...b].sort((t,a)=>{const r=se?.[t.id]??0,y=se?.[a.id]??0;return r>0&&y===0?-1:r===0&&y>0?1:t.name.localeCompare(a.name)}):[],[b,se]),G=u.useMemo(()=>ie?h.filter(t=>{const a=q[t.fixture_index];return a&&(a.status==="IN_PLAY"||a.status==="PAUSED")}):h,[h,q,ie]),k=u.useMemo(()=>G.map(t=>{const a={id:t.id,gw:t.gw,fixture_index:t.fixture_index,home_code:t.home_code,away_code:t.away_code,home_team:t.home_team,away_team:t.away_team,home_name:t.home_name,away_name:t.away_name,kickoff_time:t.kickoff_time,api_match_id:t.api_match_id??null},r=q[t.fixture_index],y=r?{status:r.status,minute:r.minute??null,homeScore:r.homeScore,awayScore:r.awayScore,home_team:r.home_team??null,away_team:r.away_team??null,goals:r.goals??void 0,red_cards:r.red_cards??void 0}:null;return{fixture:a,liveScore:y,pick:V[t.fixture_index]}}),[G,q,V]),z=!D&&!De&&!$;return e.jsxs("div",{className:"max-w-6xl mx-auto px-4 pt-2 pb-4 min-h-screen relative",children:[e.jsx(wt,{}),z?e.jsxs(e.Fragment,{children:[e.jsx(rt,{title:"LEADERBOARDS - COMPONENT HP",children:e.jsxs("div",{className:"overflow-x-auto scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch",overscrollBehaviorX:"contain",touchAction:"pan-x pan-y pinch-zoom",marginLeft:"-1rem",marginRight:"-1rem",paddingLeft:"1rem",paddingRight:"1rem",width:"calc(100% + 3rem)"},children:[e.jsx("style",{children:".scrollbar-hide::-webkit-scrollbar { display: none; }"}),e.jsxs("div",{className:"flex gap-2",style:{width:"max-content",minWidth:"100%"},children:[e.jsx(Fe,{title:"Last GW",linkTo:"/global?tab=lastgw",rank:he?.rank??null,total:he?.total??null,score:he?.score,gw:he?.gw,totalFixtures:he?.totalFixtures,variant:"lastGw"}),e.jsx(Fe,{title:"5-WEEK FORM",badgeSrc:"/assets/5-week-form-badge.png",badgeAlt:"5-Week Form Badge",linkTo:"/global?tab=form5",rank:_e?.rank??null,total:_e?.total??null}),e.jsx(Fe,{title:"10-WEEK FORM",badgeSrc:"/assets/10-week-form-badge.png",badgeAlt:"10-Week Form Badge",linkTo:"/global?tab=form10",rank:Me?.rank??null,total:Me?.total??null}),e.jsx(Fe,{title:"SEASON RANK",badgeSrc:"/assets/season-rank-badge.png",badgeAlt:"Season Rank Badge",linkTo:"/global?tab=overall",rank:ye?.rank??null,total:ye?.total??null}),re&&e.jsx(pt,{streak:re.streak,last10GwScores:re.last10GwScores,latestGw:_??1})]})]})}),e.jsxs("section",{className:"mt-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-2 pt-5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-base font-medium text-slate-500 uppercase tracking-wide",children:"Mini Leagues"}),e.jsx("div",{className:"w-4 h-4 rounded-full border border-slate-400 flex items-center justify-center",children:e.jsx("span",{className:"text-[10px] text-slate-500 font-bold",children:"i"})})]})}),e.jsx("div",{children:!$&&b.length===0?e.jsxs("div",{className:"p-6 bg-white rounded-lg border border-slate-200 text-center",children:[e.jsx("div",{className:"text-slate-600 mb-3",children:"You don't have any mini leagues yet."}),e.jsx(qe,{to:"/create-league",className:"inline-block px-4 py-2 bg-[#1C8376] text-white font-semibold rounded-lg hover:bg-[#1C8376]/80 transition-colors no-underline",children:"Create one now!"})]}):f.length>0?e.jsxs("div",{className:"overflow-x-auto scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch",overscrollBehaviorX:"contain",overscrollBehaviorY:"auto",touchAction:"pan-x pan-y pinch-zoom",marginLeft:"-1rem",marginRight:"-1rem",paddingLeft:"1rem",paddingRight:"1rem",width:"calc(100% + 2rem)"},children:[e.jsx("style",{children:".scrollbar-hide::-webkit-scrollbar { display: none; }"}),e.jsx("div",{className:"flex gap-2",style:{width:"max-content",minWidth:"100%"},children:Array.from({length:Math.ceil(f.length/3)}).map((t,a)=>{const r=a*3,y=f.slice(r,r+3);return e.jsx("div",{className:"flex flex-col rounded-xl border bg-white overflow-hidden shadow-sm w-[320px]",children:y.map((x,j)=>{const w=se?.[x.id]??0,l=d[x.id],m=l?{id:l.id,members:l.members,userPosition:l.userPosition,positionChange:l.positionChange,submittedMembers:l.submittedMembers,sortedMemberIds:l.sortedMemberIds,latestGwWinners:l.latestGwWinners,latestRelevantGw:l.latestRelevantGw}:void 0;return e.jsxs("div",{className:j<y.length-1?"relative":"",children:[j<y.length-1&&e.jsx("div",{className:"absolute bottom-0 left-4 right-4 h-px bg-slate-200 z-30 pointer-events-none"}),e.jsx("div",{className:"[&>div]:border-0 [&>div]:shadow-none [&>div]:rounded-none [&>div]:bg-transparent relative z-20 [&>div>a]:!p-4",children:e.jsx(ht,{row:x,data:m,unread:w,submissions:Z[x.id],leagueDataLoading:$,currentGw:E,showRanking:!1})})]},x.id)})},a)})})]}):e.jsx("div",{className:"p-6 bg-white rounded-lg border border-slate-200 text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading leagues..."})})})]}),e.jsx(rt,{title:"Games",subtitle:S&&h.length>0?`GW T${h[0]?.test_gw??1}`:void 0,className:"mt-6",headerRight:e.jsxs("div",{className:"flex items-center gap-3",children:[me&&e.jsx(yt,{value:ie,onChange:ge}),de]}),children:U?e.jsx("div",{className:"p-4 text-slate-500",children:"Loading fixtures..."}):h.length===0?e.jsx("div",{className:"p-4 text-slate-500",children:"No fixtures yet."}):e.jsx("div",{className:"flex flex-col rounded-xl border bg-white overflow-hidden shadow-sm",children:k.map(({fixture:t,liveScore:a,pick:r},y)=>e.jsxs("div",{className:y<k.length-1?"relative":"",children:[y<k.length-1&&e.jsx("div",{className:"absolute bottom-0 left-4 right-4 h-px bg-slate-200 z-10"}),e.jsx(_t,{fixture:t,pick:r,liveScore:a,isTestApi:S,showPickButtons:!0})]},t.id))})}),e.jsx("div",{className:"h-20"})]}):e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#1C8376]"})})]})}export{Mt as default};
