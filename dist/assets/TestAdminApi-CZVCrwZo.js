import{u as H,a as m,s as h,j as t}from"./index-DSeN78nc.js";const Y=()=>{const p=typeof window<"u"?window.location.hostname:"",w=typeof window<"u"?window.location.origin:"";return p.includes("netlify.app")||p.includes("netlify.com")?`${w}/.netlify/functions/fetchFootballData`:p==="localhost"||p==="127.0.0.1"?"https://totl-staging.netlify.app/.netlify/functions/fetchFootballData":"/.netlify/functions/fetchFootballData"};function Q(){const{user:p}=H(),w=p?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||p?.id==="36f31625-6d6c-4aa4-815a-1493a812841b",[n,R]=m.useState(1),[T,E]=m.useState([]),[f,y]=m.useState(new Map),[M,D]=m.useState(!1),[k,F]=m.useState(!1),[P,x]=m.useState(""),[L,g]=m.useState(""),[N,S]=m.useState("BSA"),[v,o]=m.useState(null),[W,U]=m.useState(!1),[$,G]=m.useState(!1),z=async(e,s)=>{try{const r=new Date,a=new Date(r);a.setDate(r.getDate()+7);const l=r.toISOString().split("T")[0],i=a.toISOString().split("T")[0],u=new URLSearchParams({competition:e,dateFrom:l,dateTo:i}),A=`${Y()}?${u.toString()}`;console.log("[TestAdminApi] Fetching upcoming matches from:",A),console.log("[TestAdminApi] Date range:",{dateFrom:l,dateTo:i});const d=await fetch(A,{signal:s}),j=d.headers.get("content-type"),B=j&&j.includes("application/json");let c=null,_=null;if(!d.ok)try{if(c=await d.text(),B||c.trim().startsWith("{")||c.trim().startsWith("["))try{_=JSON.parse(c);const b=_.message||_.error||`API error: ${d.status}`;return d.status===429?(o("Rate limit reached. Please wait a moment."),null):(o(b),null)}catch{}return console.error("[TestAdminApi] Got error response:",c.substring(0,200)),d.status===404?o("Netlify function not found. Make sure 'fetchFootballData' is deployed."):o(`Server error (${d.status}). The function may not be deployed correctly.`),null}catch{return o(`Failed to read error response: ${d.status}`),null}try{c=await d.text(),console.log("[TestAdminApi] Response status:",d.status),console.log("[TestAdminApi] Response content-type:",j),console.log("[TestAdminApi] Response preview:",c.substring(0,100));try{_=JSON.parse(c),console.log("[TestAdminApi] Successfully parsed JSON")}catch(b){return console.error("[TestAdminApi] Failed to parse JSON. Parse error:",b),console.error("[TestAdminApi] Response text:",c.substring(0,500)),c.trim().startsWith("<!")||c.trim().startsWith("<html")?o("Server returned an HTML error page. The function may not be deployed correctly. Check browser console for details."):c.trim().startsWith("{")||c.trim().startsWith("[")?o("Server returned malformed JSON. Check browser console for details."):o("Server returned invalid response (not JSON). Check browser console for details."),null}}catch(b){return console.error("[TestAdminApi] Failed to read response:",b),o("Failed to read response from server."),null}const C=_;return!C.success||!C.data?(o("Invalid API response format. Make sure the function is working correctly."),null):(o(null),C.data.matches||[])}catch(r){if(r instanceof Error&&r.name==="AbortError")return console.log("Fetch aborted"),null;console.error("Error fetching API matches:",r);let a="Failed to fetch matches";return r instanceof TypeError&&r.message.includes("fetch")?a="Network error. Check your connection and make sure the Netlify function is deployed.":r instanceof Error&&(a=r.message),o(a),null}};if(m.useEffect(()=>{if(!w)return;let e=!0;return(async()=>{try{const{error:s}=await h.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle();s&&s.code!=="PGRST116"&&!s.message?.includes("404")&&console.warn("Error loading test_api_meta:",s.message);const{data:r,error:a}=await h.from("test_api_fixtures").select("*").eq("test_gw",n).order("fixture_index",{ascending:!0});if(a)a.code!=="PGRST116"&&!a.message?.includes("404")&&console.warn("Error loading test_api_fixtures:",a.message);else if(e&&r&&r.length>0){const l=new Map;r.forEach(i=>{l.set(i.fixture_index,{...i,selected:!0})}),y(l)}}catch{}})(),()=>{e=!1}},[w,n]),!w)return t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-red-600",children:"Access denied. Admin only."})});const I=e=>{const s=new Map(f),r=Array.from(s.values()).find(a=>a.api_match_id===e.id);if(r){s.delete(r.fixture_index);const a=Array.from(s.values()).sort((i,u)=>i.fixture_index-u.fixture_index),l=new Map;a.forEach((i,u)=>{l.set(u,{...i,fixture_index:u})}),y(l)}else{const l=(s.size>0?Math.max(...Array.from(s.keys())):-1)+1,i={test_gw:n,fixture_index:l,api_match_id:e.id,home_team:e.homeTeam.shortName,away_team:e.awayTeam.shortName,home_code:e.homeTeam.tla,away_code:e.awayTeam.tla,home_name:e.homeTeam.name,away_name:e.awayTeam.name,home_crest:e.homeTeam.crest||null,away_crest:e.awayTeam.crest||null,kickoff_time:e.utcDate,selected:!0};s.set(l,i),y(s)}},q=async()=>{if(confirm(`Clear all picks and submissions for Test GW ${n}? This will reset all users' predictions.`)){G(!0),x(""),g("");try{await h.from("test_api_picks").delete().eq("matchday",n),await h.from("test_api_submissions").delete().eq("matchday",n),g(`All picks and submissions cleared for Test GW ${n}! Users can now make fresh predictions.`)}catch(e){x(e.message??"Failed to clear picks.")}finally{G(!1)}}},J=async()=>{if(f.size===0){x("Please select at least one fixture");return}D(!0),x(""),g("");try{await h.from("test_api_fixtures").delete().eq("test_gw",n),await h.from("test_api_picks").delete().eq("matchday",n),await h.from("test_api_submissions").delete().eq("matchday",n);const e=Array.from(f.values()).map(r=>({test_gw:r.test_gw,fixture_index:r.fixture_index,api_match_id:r.api_match_id,home_team:r.home_team,away_team:r.away_team,home_code:r.home_code,away_code:r.away_code,home_name:r.home_name,away_name:r.away_name,home_crest:r.home_crest,away_crest:r.away_crest,kickoff_time:r.kickoff_time})),{error:s}=await h.from("test_api_fixtures").insert(e);if(s)throw s;await h.from("test_api_meta").upsert({id:1,current_test_gw:n},{onConflict:"id"}),g(`Test Gameweek ${n} saved with ${f.size} fixtures! All picks and submissions have been reset.`)}catch(e){x(e.message??"Failed to save test gameweek.")}finally{D(!1)}};return t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4",style:{pointerEvents:"auto"},children:t.jsxs("div",{className:"max-w-4xl mx-auto",style:{pointerEvents:"auto"},children:[t.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900 mb-2",children:"Test API Admin (STAGING ONLY)"}),t.jsx("p",{className:"text-sm text-slate-600 mb-6",children:"Select fixtures from the API to create test gameweeks. This is completely separate from the main game."}),P&&t.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:P}),L&&t.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",children:L}),v&&t.jsx("div",{"data-api-error":!0,className:"mb-4 p-4 bg-amber-50 border-2 border-amber-400 rounded-lg text-amber-800 text-sm font-medium shadow-md",children:v.startsWith("API Error:")?v:`⚠️ ${v}`}),t.jsx("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("label",{className:"font-medium text-slate-700",children:"Test Gameweek:"}),t.jsx("select",{value:n,onChange:e=>{const s=parseInt(e.target.value,10);R(s),y(new Map),g(""),x(""),S(s===2?"BSA":"PL")},className:"border rounded px-3 py-1 text-lg font-semibold",children:Array.from({length:10},(e,s)=>s+1).map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsx("button",{onClick:q,disabled:$,className:"px-3 py-1.5 text-sm bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors disabled:opacity-50",children:$?"Clearing...":"Clear All Picks"})]})}),t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:"Upcoming Matches (Next 7 Days)"}),t.jsxs("div",{className:"mb-4",children:[t.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Competition:"}),t.jsxs("select",{value:N,onChange:e=>{S(e.target.value),E([]),o(null)},className:"w-full border rounded px-3 py-2",children:[t.jsx("option",{value:"PL",children:"Premier League"}),t.jsx("option",{value:"BSA",children:"Brazilian Serie A"}),t.jsx("option",{value:"BL1",children:"Bundesliga"}),t.jsx("option",{value:"SA",children:"Serie A"}),t.jsx("option",{value:"FL1",children:"Ligue 1"}),t.jsx("option",{value:"PD",children:"La Liga"}),t.jsx("option",{value:"CL",children:"Champions League"})]})]}),W&&t.jsx("div",{className:"text-center py-4 text-slate-600",children:"Loading upcoming matches..."}),t.jsx("button",{onClick:()=>{if(k){console.log("[TestAdminApi] Already fetching, ignoring click");return}console.log("[TestAdminApi] Refreshing upcoming matches",{competition:N});const e=new AbortController;F(!0),o(null),z(N,e.signal).then(s=>{console.log("[TestAdminApi] Matches fetched",s?.length||0),s&&s.length>0?(E(s),o(null)):s&&s.length===0&&o("No upcoming matches found in the next week for this competition.")}).catch(s=>{console.error("[TestAdminApi] Error refreshing matches",s),s instanceof Error&&s.name!=="AbortError"&&o("Failed to fetch matches. Please try again.")}).finally(()=>{F(!1),U(!1)})},disabled:k,className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-transform relative z-10",type:"button",children:k?"Refreshing...":"Refresh Matches"})]}),T.length>0&&t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:["Available Matches (",T.length,")"]}),t.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:T.map(e=>{const s=Array.from(f.values()).some(d=>d.api_match_id===e.id),r=new Date(e.utcDate),a=new Date;a.setHours(0,0,0,0);const l=new Date(a);l.setDate(a.getDate()+1);const i=new Date(r);i.setHours(0,0,0,0);let u="";i.getTime()===a.getTime()?u="TODAY":i.getTime()===l.getTime()?u="TOMORROW":u=r.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"});const O=`${String(r.getUTCHours()).padStart(2,"0")}:${String(r.getUTCMinutes()).padStart(2,"0")} UTC`,A=`${u} ${O}`;return t.jsx("div",{className:`p-3 border rounded-lg cursor-pointer transition-colors ${s?"bg-purple-50 border-purple-300":"bg-slate-50 border-slate-200 hover:bg-slate-100"}`,onClick:()=>I(e),children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{type:"checkbox",checked:s,onChange:()=>I(e),className:"w-5 h-5"}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"font-medium text-slate-800",children:[e.homeTeam.shortName," vs ",e.awayTeam.shortName]}),t.jsxs("div",{className:"text-xs text-slate-500",children:[A," • ",e.status," • Matchday ",e.matchday]})]})]})},e.id)})})]}),f.size>0&&t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800",children:["Selected Fixtures for Test GW ",n," (",f.size,")"]}),t.jsx("button",{onClick:()=>{confirm("Clear all selected fixtures?")&&(y(new Map),g(""),x(""))},className:"px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors",children:"Clear All"})]}),t.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Array.from(f.values()).sort((e,s)=>e.fixture_index-s.fixture_index).map(e=>t.jsxs("div",{className:"p-2 bg-purple-50 border border-purple-200 rounded text-sm",children:[e.fixture_index+1,". ",e.home_team," vs ",e.away_team]},e.fixture_index))}),t.jsx("button",{onClick:J,disabled:M,className:"mt-4 w-full py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-semibold",children:M?"Saving...":`Save Test Gameweek ${n} (${f.size} fixtures)`})]})]})})}export{Q as default};
