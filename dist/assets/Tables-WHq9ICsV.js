import{u as $e,r as h,g as Ve,s as o,a as He,C as ze,i as Se,j as r}from"./index-KOZHjtGm.js";import{M as Ze}from"./MiniLeagueCard-BOWLYz6l.js";import{g as ye,L as Qe}from"./leagueStart-CU9BsDlb.js";function Xe(a){return a.result==="H"||a.result==="D"||a.result==="A"?a.result:null}function it(){const{user:a}=$e(),[p,f]=h.useState([]),[S,w]=h.useState(!0),[Me,P]=h.useState(!0),[ve,re]=h.useState(!1),[H,ie]=h.useState(""),[q,ne]=h.useState(""),[oe,R]=h.useState(""),[Ce,de]=h.useState({}),[Le,le]=h.useState({}),[je,ue]=h.useState({}),[ke,z]=h.useState(null);h.useEffect(()=>{if(!a?.id){w(!1),P(!1);return}let l=!0;const y=`tables:${a.id}`;try{const d=Ve(y);if(d&&d.rows&&Array.isArray(d.rows)&&d.rows.length>0){if(f(d.rows),z(d.currentGw),de(d.leagueSubmissions||{}),ue(d.unreadByLeague||{}),d.leagueData){const M={};for(const[k,c]of Object.entries(d.leagueData))M[k]={...c,submittedMembers:c.submittedMembers?Array.isArray(c.submittedMembers)?new Set(c.submittedMembers):new Set:void 0,latestGwWinners:c.latestGwWinners?Array.isArray(c.latestGwWinners)?new Set(c.latestGwWinners):new Set:void 0};le(M)}w(!1),P(!1)}}catch{}return(async()=>{try{const[d,M,k]=await Promise.all([o.from("league_members").select("league_id").eq("user_id",a.id),o.from("fixtures").select("gw").order("gw",{ascending:!1}).limit(1),o.from("meta").select("current_gw").eq("id",1).maybeSingle()]);if(d.error)throw d.error;if(!l)return;const c=(d.data??[]).map(e=>e.league_id);if(!c.length){f([]),z(null),w(!1),P(!1);return}const ce=M.data??[],W=ce.length?Math.max(...ce.map(e=>e.gw)):1,D=k.data?.current_gw??W;z(W);const[Z,Q,Re,Ae,De,Ie,Ne]=await Promise.all([o.from("leagues").select("id,name,code,created_at,avatar").in("id",c).order("created_at",{ascending:!0}),o.from("league_members").select("league_id,user_id").in("league_id",c).limit(1e4),o.from("league_message_reads").select("league_id,last_read_at").eq("user_id",a.id),o.from("gw_results").select("gw,fixture_index,result"),o.from("fixtures").select("gw,kickoff_time").order("gw",{ascending:!0}).order("kickoff_time",{ascending:!0}),o.from("league_members").select("league_id,user_id, users(id, name)").in("league_id",c).limit(1e4),o.from("leagues").select("id,name,created_at").in("id",c)]);if(Z.error)throw Z.error;if(Q.error)throw Q.error;if(!l)return;const U=Z.data??[];for(const e of U)e.avatar||(e.avatar=ye(e.id),o.from("leagues").update({avatar:e.avatar}).eq("id",e.id));const I=new Map;(Q.data??[]).forEach(e=>{const t=I.get(e.league_id)??[];t.push(e.user_id),I.set(e.league_id,t)});const me=Array.from(new Set(Array.from(I.values()).flat())),A=U.find(e=>e.name==="API Test"),T=A?I.get(A.id)??[]:[],Pe=new Set(T),ge=A?me.filter(e=>!Pe.has(e)):me,[fe,we]=await Promise.all([ge.length>0?o.from("gw_submissions").select("user_id").eq("gw",W).in("user_id",ge).limit(1e4):Promise.resolve({data:[],error:null}),A&&T.length>0?o.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle():Promise.resolve({data:null,error:null})]),Te=new Set((fe.data??[]).map(e=>e.user_id));let X=new Set;if(A&&T.length>0&&we.data){const e=we.data?.current_test_gw??1,[t,s,i]=await Promise.all([o.from("test_api_submissions").select("user_id,submitted_at").eq("matchday",e).in("user_id",T).not("submitted_at","is",null),o.from("test_api_picks").select("user_id,fixture_index").eq("matchday",e).in("user_id",T),o.from("test_api_fixtures").select("fixture_index").eq("test_gw",e).order("fixture_index",{ascending:!0})]);if(i.data&&s.data&&t.data){const m=new Set(i.data.map(u=>u.fixture_index)),g=m.size;t.data.forEach(u=>{const x=(s.data??[]).filter(L=>L.user_id===u.user_id).filter(L=>m.has(L.fixture_index)),b=x.length===g&&g>0,C=new Set(x.map(L=>L.fixture_index)).size===g;b&&C&&X.add(u.user_id)})}}const Y={};for(const e of U){const t=I.get(e.id)??[],s=t.length,i=e.id===A?.id?t.reduce((m,g)=>m+(X.has(g)?1:0),0):t.reduce((m,g)=>m+(Te.has(g)?1:0),0);Y[e.id]={allSubmitted:i===s&&s>0,submittedCount:i,totalCount:s}}de(Y);const F={};try{const e=new Map;if((Re.data??[]).forEach(t=>e.set(t.league_id,t.last_read_at)),c.length>0){const t=new Map;c.forEach(u=>{t.set(u,e.get(u)??"1970-01-01T00:00:00Z")});const s=Math.min(...Array.from(t.values()).map(u=>new Date(u).getTime())),i=new Date(s).toISOString(),{data:m}=await o.from("league_messages").select("id,league_id,created_at").in("league_id",c).gte("created_at",i),g=new Map;(m??[]).forEach(u=>{const _=g.get(u.league_id)??[];_.push(u),g.set(u.league_id,_)}),c.forEach(u=>{const _=t.get(u),x=new Date(_).getTime(),G=(g.get(u)??[]).filter(C=>new Date(C.created_at).getTime()>x).length;F[u]=G})}}catch{}ue(F);const E=U.map(e=>{const t=I.get(e.id)??[];return{id:e.id,name:e.name,code:e.code,memberCount:t.length,avatar:e.avatar,created_at:e.created_at,start_gw:e.start_gw}});if(E.sort((e,t)=>{const s=F[e.id]??0,i=F[t.id]??0;return s>0&&i===0?-1:s===0&&i>0?1:0}),!l)return;const Fe=Ae.data??[],ee=new Map;for(const e of Fe){const t=Xe(e);t&&ee.set(`${e.gw}:${e.fixture_index}`,t)}const Be=De.data??[],O=new Map;Be.forEach(e=>{const t=O.get(e.gw)??[];t.push(e.kickoff_time),O.set(e.gw,t)});const B=[...new Set(Array.from(ee.keys()).map(e=>parseInt(e.split(":")[0],10)))].sort((e,t)=>e-t),J=new Map;(Ie.data??[]).forEach(e=>{if(!e.users?.name)return;const t=J.get(e.league_id)??[];t.push({id:e.user_id,name:e.users.name}),J.set(e.league_id,t)});const qe=Ne.data??[],he=new Map;qe.forEach(e=>{he.set(e.id,e)});const K=new Map;for(const e of E){const t=he.get(e.id),s={id:e.id,name:t?.name??e.name,created_at:(t?.created_at??e.created_at)||null,start_gw:t?.start_gw??e.start_gw};let i=D;const m=s.name?Qe[s.name]:void 0;if(typeof m=="number")i=m;else if(s.start_gw!==null&&s.start_gw!==void 0)i=s.start_gw;else if(s.created_at&&B.length>0){const g=new Date(s.created_at),u=75;for(const _ of B){const x=O.get(_);if(x&&x.length>0){const b=new Date(x[0]),G=new Date(b.getTime()-u*60*1e3);if(g<=G){i=_;break}}}i===D&&B.length>0&&(i=Math.max(...B)+1)}K.set(e.id,i)}const te=new Set;E.forEach(e=>{const t=K.get(e.id)??D;B.filter(s=>s>=t).forEach(s=>te.add(s))});const We=E.map(e=>{const t=J.get(e.id)??[];if(t.length===0)return Promise.resolve({data:[],error:null});const s=K.get(e.id)??D,i=Array.from(te).filter(m=>m>=s);return i.length===0?Promise.resolve({data:[],error:null}):o.from("picks").select("user_id,gw,fixture_index,pick").in("user_id",t.map(m=>m.id)).in("gw",i).limit(1e4)}),Ue=await Promise.all(We);if(!l)return;const Oe=new Set((fe.data??[]).map(e=>e.user_id)),se={};for(let e=0;e<E.length;e++){const t=E[e],s=Ue[e],i=J.get(t.id)??[];if(i.length===0)continue;const m=K.get(t.id)??D,g=Array.from(te).filter(n=>n>=m),u=s.data??[],_=new Map;u.forEach(n=>{_.has(n.user_id)||_.set(n.user_id,new Map);const v=_.get(n.user_id);v.has(n.gw)||v.set(n.gw,new Map),v.get(n.gw).set(n.fixture_index,n.pick)});const x=new Map,b=new Map;g.forEach(n=>{const N=(O.get(n)??[]).length;N!==0&&i.forEach(j=>{const xe=_.get(j.id)?.get(n);if(!xe)return;let ae=0;for(let V=0;V<N;V++){const be=xe.get(V),pe=ee.get(`${n}:${V}`);be&&pe&&be===pe&&ae++}b.has(j.id)||b.set(j.id,new Map),b.get(j.id).set(n,ae);const Ke=x.get(j.id)??0;x.set(j.id,Ke+ae)})});const G=[...i].sort((n,v)=>{const N=x.get(n.id)??0,j=x.get(v.id)??0;return j!==N?j-N:n.name.localeCompare(v.name)}),C=G.findIndex(n=>n.id===a.id)+1,L=C>1?C-1:null,Je=L===null?null:C<L?"up":C>L?"down":"same",$=g.length>0?Math.max(...g):D,_e=[];if($&&b.has(a.id)){const n=b.get(a.id).get($)??0;G.forEach(v=>{(b.get(v.id)?.get($)??0)===n&&n>0&&_e.push(v.id)})}se[t.id]={id:t.id,members:i,userPosition:C||null,positionChange:Je,submittedMembers:t.id===A?.id?X:Oe,sortedMemberIds:G.map(n=>n.id),latestGwWinners:_e,latestRelevantGw:$}}if(l){f(E),le(se),w(!1),P(!1);try{const e={};for(const[t,s]of Object.entries(se))e[t]={...s,submittedMembers:s.submittedMembers?s.submittedMembers instanceof Set?Array.from(s.submittedMembers):s.submittedMembers:void 0,latestGwWinners:s.latestGwWinners?s.latestGwWinners instanceof Set?Array.from(s.latestGwWinners):s.latestGwWinners:void 0};He(y,{rows:E,currentGw:W,leagueSubmissions:Y,unreadByLeague:F,leagueData:e},ze.TABLES)}catch{}}}catch(d){l&&(R(d?.message??"Failed to load leagues."),w(!1),P(!1))}})(),()=>{l=!1}},[a?.id]);const Ee=h.useCallback(async()=>{if(!(!q.trim()||!a?.id)){re(!0),R("");try{const l=q.trim(),y=await tt(),{data:d,error:M}=await o.from("leagues").insert({name:l,code:y}).select("id,code").single();if(M)throw M;const k=ye(d.id);await o.from("leagues").update({avatar:k}).eq("id",d.id),await o.from("league_members").insert({league_id:d.id,user_id:a.id}),ne(""),a?.id&&Se(a.id),f([]),w(!0)}catch(l){R(l?.message??"Failed to create league.")}finally{re(!1)}}},[q,a?.id]),Ge=h.useCallback(async()=>{const l=H.trim().toUpperCase();if(!(!l||!a?.id)){R("");try{const{data:y,error:d}=await o.from("leagues").select("id").eq("code",l).maybeSingle();if(d)throw d;if(!y){R("League code not found.");return}const{data:M,error:k}=await o.from("league_members").select("user_id").eq("league_id",y.id);if(k)throw k;if(M&&M.length>=8){R("League is full (max 8 members).");return}await o.from("league_members").upsert({league_id:y.id,user_id:a.id},{onConflict:"league_id,user_id"}),ie(""),a?.id&&Se(a.id),f([]),w(!0)}catch(y){R(y?.message??"Failed to join league.")}}},[H,a?.id]);return r.jsx("div",{className:"min-h-screen bg-slate-50",children:r.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-4 pb-16",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900",children:"Mini Leagues"}),p.length>4&&r.jsxs("button",{onClick:()=>{const l=document.getElementById("create-join-section");l&&l.scrollIntoView({behavior:"smooth",block:"start"})},className:"text-[#1C8376] font-semibold text-sm hover:text-[#1C8376] no-underline flex items-center gap-1",children:["Create League",r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})]}),r.jsx("p",{className:"mt-2 mb-6 text-sm text-slate-600 w-full",children:"Create or join a private league and battle it out with your friends. - COMPONENTS VERSION"}),oe&&r.jsx("div",{className:"mt-4 rounded border border-rose-200 bg-rose-50 text-rose-700 px-3 py-2 text-sm",children:oe}),S||Me?r.jsx("div",{className:"mt-6 flex items-center justify-center py-12",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#1C8376]"})}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mt-6",children:p.length===0?r.jsx("div",{className:"px-4 py-4 text-sm",children:"No leagues yet."}):r.jsx("div",{className:"space-y-3",children:p.map(l=>r.jsx(Ze,{row:l,data:Le[l.id],unread:je?.[l.id]??0,submissions:Ce[l.id],leagueDataLoading:!1,currentGw:ke},l.id))})}),r.jsx("div",{id:"create-join-section",className:"mt-10 mb-3 text-xl font-extrabold text-slate-900",children:"Create or Join"}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[r.jsx(Ye,{leagueName:q,setLeagueName:ne,creating:ve,onCreate:Ee}),r.jsx(et,{joinCode:H,setJoinCode:ie,onJoin:Ge})]})]})]})})}function Ye({leagueName:a,setLeagueName:p,creating:f,onCreate:S}){return r.jsxs("div",{className:"border rounded-2xl p-4 bg-white",children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Create a league"}),r.jsx("input",{className:"border rounded px-3 py-2 w-full bg-white",placeholder:"League name",value:a,onChange:w=>p(w.target.value),onKeyDown:w=>{w.key==="Enter"&&!f&&a.trim()&&S()}}),r.jsx("button",{className:"mt-3 px-3 py-2 rounded bg-slate-900 text-white disabled:opacity-50",onClick:S,disabled:f||!a.trim(),children:f?"Creatingâ€¦":"Create"})]})}function et({joinCode:a,setJoinCode:p,onJoin:f}){return r.jsxs("div",{className:"border rounded-2xl p-4 bg-white",children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Join with code"}),r.jsx("input",{className:"border rounded px-3 py-2 w-full uppercase tracking-widest bg-white",placeholder:"ABCDE",value:a,onChange:S=>p(S.target.value),onKeyDown:S=>{S.key==="Enter"&&a.trim()&&f()}}),r.jsx("button",{className:"mt-3 px-3 py-2 rounded border",onClick:f,children:"Join"})]})}async function tt(){const a="ABCDEFGHJKLMPQRSTVWXYZ23456789";for(let p=0;p<6;p++){let f="";for(let w=0;w<5;w++)f+=a[Math.floor(Math.random()*a.length)];const{data:S}=await o.from("leagues").select("id").eq("code",f).maybeSingle();if(!S)return f}return Math.random().toString(36).slice(2,7).toUpperCase()}export{it as default};
