const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DQ877Kd7.js","assets/index-DjTelcoh.js","assets/index-CC0BY6hJ.css"])))=>i.map(i=>d[i]);
import{_ as f}from"./index-DjTelcoh.js";async function h(t){let n=null;try{n=(await f(()=>import("./index-DQ877Kd7.js").then(s=>s.i),__vite__mapDeps([0,1,2]))).default}catch{n=globalThis?.despia||(typeof window<"u"?window?.despia:null)}const l=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null),d=typeof window<"u"&&(window.navigator?.userAgent?.includes("Mozilla")||!window.navigator?.standalone),r=!!n||!!l;if(d&&!r)return console.warn("[Push] Despia not available - running in browser, not native app"),{ok:!1,reason:"api-not-available"};if(!r)return console.warn("[Push] Despia not available - not in native app?"),{ok:!1,reason:"api-not-available"};try{if(n&&typeof n=="function")try{const e=n("checkNativePushPermissions://",["nativePushEnabled"]);e&&typeof e=="object"&&"nativePushEnabled"in e&&(e.nativePushEnabled||console.warn("[Push] Push notifications not enabled in OS settings"))}catch{console.log("[Push] Could not check permission status, continuing...")}console.log("[Push] Waiting for OneSignal Player ID...");let o=null;const s=30,u=500;for(let e=0;e<s;e++){const i=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null);if(i&&typeof i=="string"&&i.trim().length>0){o=i.trim(),console.log(`[Push] Found Player ID via direct global property on attempt ${e+1}`);break}if(n){if(n.onesignalplayerid&&typeof n.onesignalplayerid=="string"&&n.onesignalplayerid.trim().length>0){o=n.onesignalplayerid.trim(),console.log(`[Push] Found Player ID via despia.onesignalplayerid on attempt ${e+1}`);break}else if(n.oneSignalPlayerId&&typeof n.oneSignalPlayerId=="string"&&n.oneSignalPlayerId.trim().length>0){o=n.oneSignalPlayerId.trim(),console.log(`[Push] Found Player ID via despia.oneSignalPlayerId on attempt ${e+1}`);break}}(e+1)%5===0&&console.log(`[Push] Still waiting for Player ID... (attempt ${e+1}/${s})`),e<s-1&&await new Promise(p=>setTimeout(p,u))}if(!o||o.length===0){console.warn("[Push] Player ID not available after polling",s,"times");const e={hasDespia:!!n,despiaKeys:n?Object.keys(n).slice(0,10):[],hasDirectPid:!!globalThis?.onesignalplayerid||!!(typeof window<"u"&&window?.onesignalplayerid),isBrowser:typeof window<"u",userAgent:typeof window<"u"?window.navigator?.userAgent?.substring(0,50):"N/A"};return console.warn("[Push] Debug info:",e),e.isBrowser&&!e.hasDespia&&!e.hasDirectPid?{ok:!1,reason:"api-not-available",error:"OneSignal is only available in the native app, not in a browser."}:{ok:!1,reason:"no-player-id",error:"OneSignal Player ID not available after 15 seconds. Try: 1) Close the app completely, 2) Reopen it, 3) Wait 10 seconds, 4) Try again."}}if(console.log(`[Push] ✅ Got Player ID: ${o.slice(0,8)}…`),!t?.access_token)return console.warn("[Push] No session token available"),{ok:!1,reason:"no-session"};const c=typeof window<"u"&&window.location.hostname==="localhost"?"https://totl-staging.netlify.app":"",a=await fetch(`${c}/.netlify/functions/registerPlayer`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`},body:JSON.stringify({playerId:o,platform:"ios"})});if(!a.ok){let e={};try{const i=await a.text();e=i?JSON.parse(i):{}}catch{e={error:`HTTP ${a.status}: ${a.statusText}`}}return console.error("[Push] ❌ Failed to register device:",{status:a.status,statusText:a.statusText,error:e,playerId:o?.slice(0,8)+"…"}),a.status===401?(console.error("[Push] ❌ Authentication failed - session may have expired"),{ok:!1,reason:"no-session",error:"Authentication failed"}):a.status===400&&e.error?.includes("playerId")?(console.error("[Push] ❌ Invalid Player ID provided"),{ok:!1,reason:"no-player-id",error:e.error}):(console.error("[Push] ❌ Unknown registration error:",e),{ok:!1,reason:"unknown",error:e.error||`Server error (${a.status})`})}return console.log("[Push] Successfully registered device"),{ok:!0,playerId:o}}catch(o){return console.error("[Push] Error in ensurePushSubscribed:",o),{ok:!1,reason:"unknown"}}}export{h as ensurePushSubscribed};
