const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-4DUR37wK.js","assets/index-ATngG3K-.css","assets/index-C9xi3gaN.js"])))=>i.map(i=>d[i]);
import{u as he,a as f,p as pe,s as F,j as e,q as ge,_ as R,L as U}from"./index-4DUR37wK.js";function be(){const{user:m,signOut:ne,session:N}=he(),[b,oe]=f.useState(null),[ae,re]=f.useState(!0),[L,M]=f.useState(!1),[I,h]=f.useState(null),[J,z]=f.useState(!1),[y,Y]=f.useState(null),[j,q]=f.useState(null),[v,le]=f.useState(null),[G,de]=f.useState(pe()),[C,ce]=f.useState(""),[T,H]=f.useState(""),[V,W]=f.useState(!1),[D,w]=f.useState(null),[K,B]=f.useState(!1),[_,S]=f.useState(null),[Q,X]=f.useState(!1),[O,$]=f.useState(null),[Z,ee]=f.useState(!1),[E,k]=f.useState(null),[te,se]=f.useState(!1),[A,P]=f.useState(null),ue=m?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||m?.id==="36f31625-6d6c-4aa4-815a-1493a812841b";f.useEffect(()=>{let t=0;const i=40,a=()=>{const s=[globalThis?.despia,typeof window<"u"?window?.despia:null,globalThis?.Despia,typeof window<"u"?window?.Despia:null,globalThis?.DESPIA,typeof window<"u"?window?.DESPIA:null,globalThis?.OneSignal,typeof window<"u"?window?.OneSignal:null,globalThis?.webkit?.messageHandlers?.despia,typeof window<"u"?window?.webkit?.messageHandlers?.despia:null].find(g=>g!=null)||null;let d=null;try{const g=typeof window<"u"?window:globalThis;for(const u in g)if(u.toLowerCase().includes("despia")||u.toLowerCase().includes("onesignal")){d={key:u,value:g[u]};break}}catch{}const r=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null)||globalThis?.oneSignalPlayerId||(typeof window<"u"?window?.oneSignalPlayerId:null);if(s||d||r){console.log("[Profile] Native API detected:",{despia:!!s,foundInGlobals:d,directPlayerId:r?String(r).slice(0,12)+"‚Ä¶":null,despiaKeys:s?Object.keys(s):[],hasOneSignalRequestPermission:s&&typeof s.oneSignalRequestPermission=="function",hasRequestPermission:s&&typeof s.requestPermission=="function",playerId:s?s.onesignalplayerid||s.oneSignalPlayerId:r}),q(!0);const g=s?s.onesignalplayerid||s.oneSignalPlayerId:r;return g&&le(String(g)),!0}return t++,t<i?setTimeout(a,500):(console.warn("[Profile] Native API not detected after",i,"attempts"),q(!1)),!1};a()},[]),f.useEffect(()=>{fe()},[m]);async function fe(){if(m)try{const{data:t,error:i}=await F.from("picks").select("*").eq("user_id",m.id);i&&console.error("Error fetching picks:",i);const{data:a,error:n}=await F.from("v_ocp_overall").select("user_id, name, ocp").order("ocp",{ascending:!1});n&&console.error("Error fetching standings:",n);const s=a?a.findIndex(c=>c.user_id===m.id)+1:0,d=a?.find(c=>c.user_id===m.id),{data:r,error:g}=await F.from("gw_results").select("gw, fixture_index, result");g&&console.error("Error fetching results:",g);let u=0;t&&r&&t.forEach(c=>{const o=r.find(p=>p.gw===c.gw&&p.fixture_index===c.fixture_index);o&&o.result===c.pick&&u++}),oe({totalPredictions:t?.length||0,correctPredictions:u,totalPoints:d?.ocp||0,globalRank:s,totalUsers:a?.length||0})}catch(t){console.error("Error fetching user stats:",t)}finally{re(!1)}}return m?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",children:e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsx("div",{className:"bg-white rounded-2xl shadow-lg p-6 sm:p-8 mb-6",children:e.jsxs("div",{className:"flex items-start gap-4 sm:gap-6",children:[e.jsx("div",{className:"w-14 h-14 sm:w-16 sm:h-16 bg-[#1C8376] rounded-full flex items-center justify-center text-white text-xl sm:text-2xl font-bold flex-shrink-0",children:(m.user_metadata?.display_name||m.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-slate-800 mb-2 truncate",children:m.user_metadata?.display_name||"User"}),e.jsx("p",{className:"text-slate-600 break-all text-sm sm:text-base",children:m.email}),e.jsxs("p",{className:"text-sm text-slate-500 mt-2",children:["Member since ",new Date(m.created_at||"").toLocaleDateString("en-GB",{month:"long",year:"numeric"})]})]})]})}),ae?e.jsx("div",{className:"text-center py-12 text-slate-600",children:"Loading stats..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6 flex flex-col items-center justify-center",children:[e.jsx("div",{className:"text-4xl font-bold text-[#1C8376] mb-2",children:b?.totalPoints||0}),e.jsx("div",{className:"text-sm text-slate-600 font-medium",children:"OCP"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6 text-center",children:[e.jsx("div",{className:"text-4xl font-bold text-blue-600 mb-2",children:b?.globalRank||0}),e.jsx("div",{className:"text-sm text-slate-600 font-medium",children:"Global Rank"}),e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["of ",b?.totalUsers||0,b&&b.globalRank>0&&b.totalUsers>0&&e.jsxs("span",{className:"block mt-1 text-[#1C8376] font-semibold",children:["Top ",Math.round(b.globalRank/b.totalUsers*100),"%"]})]})]})]}),b&&b.totalPredictions>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800 mb-4",children:"Prediction Accuracy"}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"text-slate-600",children:[e.jsx("span",{className:"text-3xl font-bold text-[#1C8376]",children:b.correctPredictions}),e.jsxs("span",{className:"text-slate-500",children:[" / ",b.totalPredictions]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-3xl font-bold text-[#1C8376]",children:[(b.correctPredictions/b.totalPredictions*100).toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-slate-500",children:"accuracy rate"})]})]}),e.jsx("div",{className:"overflow-hidden h-4 text-xs flex rounded-full bg-[#1C8376]/20",children:e.jsx("div",{style:{width:`${b.correctPredictions/b.totalPredictions*100}%`},className:"shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-[#1C8376] transition-all duration-500"})})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800 mb-4",children:"Account Settings"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between py-3 border-b border-slate-200",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-800",children:"Display Name"}),e.jsx("div",{className:"text-sm text-slate-600",children:m.user_metadata?.display_name||"Not set"})]})}),e.jsx("div",{className:"flex items-center justify-between py-3 border-b border-slate-200",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-slate-800",children:"Email"}),e.jsx("div",{className:"text-sm text-slate-600 break-all",children:m.email})]})}),e.jsx("div",{className:"flex items-center justify-between py-3 border-b border-slate-200",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-800",children:"User ID"}),e.jsx("div",{className:"text-xs text-slate-500 font-mono",children:m.id})]})})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-slate-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-3",children:"Data Loading"}),e.jsxs("div",{className:"flex items-center justify-between py-3 border-b border-slate-200",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-slate-800",children:"Load Everything First"}),e.jsx("div",{className:"text-sm text-slate-600 mt-1",children:G?"All data loads before app opens (slower start, no stale data)":"Data loads as you navigate (faster start, may show cached data)"})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer ml-4",children:[e.jsx("input",{type:"checkbox",checked:G,onChange:t=>{const i=t.target.checked;de(i),ge(i),alert(i?'"Load Everything First" mode enabled. The app will reload on next visit to apply the change.':'"Load Everything First" mode disabled. The app will reload on next visit to apply the change.')},className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#1C8376]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#1C8376]"})]})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-slate-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-3",children:"Advanced"}),e.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"Check and fix your notification settings to receive chat notifications in mini-leagues."}),e.jsx("div",{className:"mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-600 mb-1",children:"OS Permission:"}),e.jsx("div",{className:"font-semibold text-slate-800",children:j===null?"‚è≥ Checking...":j===!1?"‚ùì Unknown (not native app)":globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null)||v?'‚úÖ Native app (use "Enable Notifications" to check status)':"‚ùì Unknown (not native app)"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-600 mb-1",children:"OneSignal Status:"}),e.jsx("div",{className:"font-semibold text-slate-800",children:(()=>{if(j===null)return"‚è≥ Checking...";if(j===!1)return"‚ùå Not initialized";const t=globalThis?.despia||(typeof window<"u"?window?.despia:null),i=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null);return t?.onesignalplayerid||t?.oneSignalPlayerId||i||v?"‚úÖ Player ID found":"‚ùå Not initialized"})()})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-slate-600 mb-1",children:"Player ID:"}),e.jsx("div",{className:"font-mono text-xs text-slate-700 break-all",children:(()=>{if(j===null)return"Checking...";const t=globalThis?.despia||(typeof window<"u"?window?.despia:null),i=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null),a=t?.onesignalplayerid||t?.oneSignalPlayerId||i||v;if(!a)return"Not available";const n=String(a);return n.slice(0,8)+"‚Ä¶"+n.slice(-4)})()})]})]})}),e.jsxs("div",{className:"mb-4 p-3 bg-slate-100 rounded-lg border border-slate-300 text-xs",children:[e.jsx("div",{className:"font-semibold text-slate-700 mb-2",children:"üîç Debug Info:"}),e.jsxs("div",{className:"space-y-1 text-slate-600 font-mono break-all",children:[e.jsxs("div",{children:["User Agent: ",typeof navigator<"u"?navigator.userAgent.slice(0,50)+"‚Ä¶":"N/A"]}),e.jsxs("div",{children:["globalThis.despia: ",globalThis?.despia?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["window.despia: ",typeof window<"u"&&window?.despia?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["globalThis.Despia: ",globalThis?.Despia?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["window.Despia: ",typeof window<"u"&&window?.Despia?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["globalThis.OneSignal: ",globalThis?.OneSignal?"‚úÖ Found":"‚ùå Not found"]}),e.jsxs("div",{children:["window.OneSignal: ",typeof window<"u"&&window?.OneSignal?"‚úÖ Found":"‚ùå Not found"]}),(()=>{const i=[globalThis?.despia,typeof window<"u"?window?.despia:null,globalThis?.Despia,typeof window<"u"?window?.Despia:null,globalThis?.DESPIA,typeof window<"u"?window?.DESPIA:null].find(n=>n!=null)||null;let a=[];try{const n=typeof window<"u"?window:globalThis;for(const s in n)(s.toLowerCase().includes("despia")||s.toLowerCase().includes("onesignal"))&&a.push(s)}catch{}return a.length>0?e.jsxs("div",{className:"mt-2 text-green-600",children:["‚úÖ Found global properties: ",a.join(", ")]}):i?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-2 font-semibold",children:"Despia Object Found:"}),e.jsxs("div",{children:["Keys: ",Object.keys(i).slice(0,10).join(", "),Object.keys(i).length>10?"‚Ä¶":""]}),e.jsxs("div",{children:["oneSignalRequestPermission: ",typeof i.oneSignalRequestPermission=="function"?"‚úÖ Function":"‚ùå Not a function"]}),e.jsxs("div",{children:["requestPermission: ",typeof i.requestPermission=="function"?"‚úÖ Function":"‚ùå Not a function"]}),e.jsxs("div",{children:["onesignalplayerid: ",i.onesignalplayerid?"‚úÖ "+String(i.onesignalplayerid).slice(0,12)+"‚Ä¶":"‚ùå"]}),e.jsxs("div",{children:["oneSignalPlayerId: ",i.oneSignalPlayerId?"‚úÖ "+String(i.oneSignalPlayerId).slice(0,12)+"‚Ä¶":"‚ùå"]})]}):e.jsx("div",{className:"mt-2 text-red-600",children:"‚ùå No Despia object found in any location"})})(),e.jsxs("div",{className:"mt-2 text-xs text-slate-500",children:["Polling: ",j===null?"‚è≥ Checking...":j?"‚úÖ Detected":"‚ùå Not detected"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:async()=>{if(!N?.access_token){h("Error: Not signed in");return}M(!0),h(null);try{let t=v;if(!t){h("‚è≥ Waiting for OneSignal to initialize... (this may take up to 15 seconds)");const{ensurePushSubscribed:i}=await R(async()=>{const{ensurePushSubscribed:n}=await import("./index-4DUR37wK.js").then(s=>s.v);return{ensurePushSubscribed:n}},__vite__mapDeps([0,1])),a=await i(N);if(a.ok){h(`‚úÖ Successfully enabled notifications! Player ID: ${a.playerId?.slice(0,8)}‚Ä¶`),setTimeout(()=>h(null),5e3);return}else if(a.reason==="no-player-id")if(v)console.log("[Profile] Using Player ID from Profile page polling:",v.slice(0,8)),t=v;else{const n={"permission-denied":"Permission denied. Please enable notifications in iOS Settings.","no-player-id":a.error||"OneSignal not initialized. Try: 1) Close the app completely, 2) Reopen it, 3) Wait 10 seconds, 4) Try again.","api-not-available":"Not available in browser. Please use the native app.","no-session":"Not signed in. Please sign in and try again.",unknown:a.error||"Unknown error. Please try again or contact support."};h(`‚ö†Ô∏è ${n[a.reason||"unknown"]||"Failed to enable notifications"}`);return}else{const n={"permission-denied":"Permission denied. Please enable notifications in iOS Settings.","no-player-id":a.error||"OneSignal not initialized. Try: 1) Close the app completely, 2) Reopen it, 3) Wait 10 seconds, 4) Try again.","api-not-available":"Not available in browser. Please use the native app.","no-session":"Not signed in. Please sign in and try again.",unknown:a.error||"Unknown error. Please try again or contact support."};h(`‚ö†Ô∏è ${n[a.reason||"unknown"]||"Failed to enable notifications"}`);return}}if(t){h("‚è≥ Registering device...");const a=window.location.hostname==="localhost"?"https://totl-staging.netlify.app":"",n=await fetch(`${a}/.netlify/functions/registerPlayer`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${N.access_token}`},body:JSON.stringify({playerId:t,platform:"ios"})});if(!n.ok){let d={};try{const r=await n.text();d=r?JSON.parse(r):{}}catch{d={error:`HTTP ${n.status}: ${n.statusText}`}}h(`‚ùå Registration failed: ${d.error||"Unknown error"}`);return}const s=await n.json();s.ok?(h(`‚úÖ Successfully enabled notifications! Player ID: ${t.slice(0,8)}‚Ä¶`),setTimeout(()=>h(null),5e3)):h(`‚ö†Ô∏è ${s.warning||s.error||"Registration completed with warnings"}`)}}catch(t){console.error("[Profile] Registration error:",t),h(`‚ùå Error: ${t.message||"Failed to enable notifications"}`)}finally{M(!1)}},disabled:L||!N?.access_token,className:"w-full py-3 bg-white border border-slate-300 hover:bg-slate-50 disabled:bg-gray-100 disabled:opacity-50 text-slate-600 hover:text-slate-800 font-medium rounded-xl transition-colors",children:L?"Enabling...":"Enable Notifications"}),e.jsx("button",{onClick:async()=>{let t=null;try{t=(await R(()=>import("./index-C9xi3gaN.js").then(a=>a.i),__vite__mapDeps([2,0,1]))).default}catch{t=globalThis?.despia||(typeof window<"u"?window?.despia:null)}if(t&&typeof t=="function")try{t("settingsapp://")}catch{alert("Please go to iOS Settings ‚Üí TotL ‚Üí Notifications and enable notifications")}else alert("Please go to iOS Settings ‚Üí TotL ‚Üí Notifications and enable notifications")},className:"w-full py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-medium rounded-xl transition-colors text-sm hidden",children:"‚öôÔ∏è Open OS Settings"}),e.jsx("button",{onClick:async()=>{if(!N?.access_token){h("Error: Not signed in");return}z(!0),h(null),Y(null);try{const i=window.location.hostname==="localhost"?"https://totl-staging.netlify.app":"",n=await(await fetch(`${i}/.netlify/functions/checkMySubscription`,{headers:{Authorization:`Bearer ${N.access_token}`}})).json();if(Y(n),n.subscribed)h("‚úÖ Device is subscribed! Notifications should work.");else{const s=n.reasons||[],d=n.suggestion||"Enable notifications in iOS Settings";h(`‚ö†Ô∏è Not subscribed: ${s.join("; ")}. ${d}`)}}catch(t){h(`‚ùå Error checking subscription: ${t.message}`)}finally{z(!1)}},disabled:J||!N?.access_token,className:"w-full py-3 bg-white border border-slate-300 hover:bg-slate-50 disabled:bg-gray-100 disabled:opacity-50 text-slate-600 hover:text-slate-800 font-medium rounded-xl transition-colors",children:J?"Checking...":"Check Subscription Status"}),e.jsx("button",{onClick:async()=>{let t=null;try{const a=(await R(()=>import("./index-C9xi3gaN.js").then(n=>n.i),__vite__mapDeps([2,0,1]))).default;t=a?.onesignalplayerid||a?.oneSignalPlayerId||null}catch{t=globalThis?.onesignalplayerid||(typeof window<"u"?window?.onesignalplayerid:null)}t=t||v,t?(await navigator.clipboard.writeText(String(t)),h("‚úÖ Player ID copied to clipboard"),setTimeout(()=>h(null),2e3)):h("‚ö†Ô∏è Player ID not available")},className:"w-full py-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 hover:text-slate-800 font-medium rounded-xl transition-colors",children:"Copy Player ID"})]}),I&&e.jsx("div",{className:`mt-3 p-3 rounded-lg text-sm ${I.includes("‚úÖ")?"bg-green-50 text-green-800 border border-green-200":I.includes("‚ö†Ô∏è")?"bg-amber-50 text-amber-800 border border-amber-200":"bg-red-50 text-red-800 border border-red-200"}`,children:I}),y&&y.details&&e.jsxs("div",{className:"mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200 text-xs",children:[e.jsx("div",{className:"font-semibold text-slate-700 mb-2",children:"üìä OneSignal Status Details:"}),e.jsxs("div",{className:"space-y-1 text-slate-600 font-mono",children:[e.jsxs("div",{children:["Has Token: ",y.details.hasToken?"‚úÖ Yes":"‚ùå No"]}),e.jsxs("div",{children:["Invalid: ",y.details.invalid?"‚ùå Yes":"‚úÖ No"]}),e.jsxs("div",{children:["Notification Types: ",y.details.notificationTypes??"null"]}),e.jsxs("div",{children:["Device Type: ",y.details.deviceType||"N/A"]}),e.jsxs("div",{children:["Last Active: ",y.details.lastActive?new Date(y.details.lastActive).toLocaleString():"Never"]}),y.reasons&&y.reasons.length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-slate-300",children:[e.jsx("div",{className:"font-semibold text-red-600",children:"Issues Found:"}),y.reasons.map((t,i)=>e.jsxs("div",{className:"text-red-600",children:["‚Ä¢ ",t]},i))]})]})]})]}),ue&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-slate-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-3",children:"Admin"}),e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200",children:[e.jsx("h4",{className:"text-md font-semibold text-slate-800 mb-3",children:"Carl's Device Diagnostics"}),e.jsxs("p",{className:"text-sm text-slate-600 mb-3",children:["Carl's device has ",e.jsx("code",{className:"bg-white px-1 rounded",children:"notification_types: null"})," in OneSignal, which means OneSignal SDK hasn't properly initialized. This prevents notifications from being delivered even though OneSignal accepts the request."]}),e.jsxs("p",{className:"text-sm text-slate-600 mb-3",children:[e.jsx("strong",{children:"Issue:"})," Carl's ",e.jsx("code",{className:"bg-white px-1 rounded",children:"last_active"})," date is stuck on Nov 29, suggesting OneSignal SDK isn't communicating with OneSignal servers. This could be due to VPN, network restrictions, or SDK initialization failure."]}),e.jsxs("p",{className:"text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2 mb-3",children:[e.jsx("strong",{children:"Solution:"})," Carl needs to re-register his device properly:",e.jsxs("ol",{className:"list-decimal list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Delete the app completely"}),e.jsx("li",{children:"Reinstall from App Store"}),e.jsx("li",{children:"Open the app and wait 10-15 seconds"}),e.jsx("li",{children:"Go to Profile ‚Üí Enable Notifications"}),e.jsxs("li",{children:["Check that ",e.jsx("code",{children:"notification_types"})," becomes ",e.jsx("code",{children:"1"})," (not ",e.jsx("code",{children:"null"}),")"]})]})]}),_&&e.jsx("div",{className:`mb-3 rounded border px-3 py-2 text-sm ${_.includes("‚úÖ")?"border-emerald-200 bg-emerald-50 text-emerald-800":_.includes("‚ö†Ô∏è")?"border-amber-200 bg-amber-50 text-amber-800":"border-rose-200 bg-rose-50 text-rose-700"}`,children:_}),e.jsx("button",{onClick:async()=>{B(!0),S(null);try{const a=`${window.location.hostname==="localhost"?"https://totl-staging.netlify.app":""}/.netlify/functions/diagnoseCarlNotifications?update=true`;console.log("[Profile] Activating Carl devices, calling:",a);const n=await fetch(a,{method:"GET",mode:"cors"});if(!n.ok){const d=await n.text().catch(()=>"Unknown error");S(`‚ùå Server error (${n.status}): ${d||"Failed to activate devices"}`);return}const s=await n.json();if(s.error)S(`‚ùå ${s.error}`);else{const d=s.active_devices||0,r=s.subscribed_devices||0;d>0&&r>0?S(`‚úÖ Activated ${d} device(s) (${r} subscribed). Carl should receive notifications.`):r>0?S(`‚ö†Ô∏è Found ${r} subscribed device(s) but none are active. Check device status.`):S("‚ö†Ô∏è No subscribed devices found. Carl may need to enable notifications in iOS Settings.")}}catch(t){console.error("[Profile] Error activating Carl devices:",t);let i="Failed to activate devices";t.message?i=t.message:t.name==="TypeError"&&t.message?.includes("fetch")&&(i="Network error: Could not reach server. Check your connection or try again later."),S(`‚ùå Error: ${i}`)}finally{B(!1)}},disabled:K,className:"w-full py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:K?"Activating...":"Activate Carl's Devices"}),e.jsx("button",{onClick:async()=>{X(!0),$(null);try{const i=window.location.hostname==="localhost"?"https://totl-staging.netlify.app":"",a=await fetch(`${i}/.netlify/functions/forceCarlSubscription`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!a.ok){const s=await a.text().catch(()=>"Unknown error");$(`‚ùå Server error (${a.status}): ${s}`);return}const n=await a.json();if(n.ok){const s=n.before?.notification_types??"null",d=n.after?.notification_types??"null";$(d===1?`‚úÖ Successfully forced subscription! notification_types changed from ${s} to ${d}`:`‚ö†Ô∏è ${n.note||"Update attempted but notification_types is still "+d}. ${n.message||""}`)}else $(`‚ùå ${n.error||"Failed to force subscription"}`)}catch(t){$(`‚ùå Error: ${t.message||"Failed to force subscription"}`)}finally{X(!1)}},disabled:Q,className:"w-full py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed mt-2",children:Q?"Forcing...":"Force Carl's Subscription Status"}),O&&e.jsx("div",{className:`mt-2 rounded border px-3 py-2 text-sm ${O.includes("‚úÖ")?"border-emerald-200 bg-emerald-50 text-emerald-800":O.includes("‚ö†Ô∏è")?"border-amber-200 bg-amber-50 text-amber-800":"border-rose-200 bg-rose-50 text-rose-700"}`,children:O}),e.jsx("button",{onClick:async()=>{ee(!0),k(null);try{const i=window.location.hostname==="localhost"?"https://totl-staging.netlify.app":"",a=`${i}/.netlify/functions/diagnoseCarlNotifications?user=carl`;console.log("[Profile] Fetching Carl's Player ID from:",a);const n=await fetch(a,{method:"GET",mode:"cors"}).catch(o=>{throw new Error(`Network error fetching Carl's Player ID: ${o.message||"Failed to connect"}`)});if(!n.ok){const o=await n.text().catch(()=>"Unknown error");k(`‚ùå Failed to get Carl's Player ID (${n.status}): ${o}`);return}const s=await n.json().catch(o=>{throw new Error(`Failed to parse response: ${o.message}`)}),d=s.devices?.find(o=>o.is_active);if(!d?.player_id){k(`‚ùå Carl's active Player ID not found. Devices: ${JSON.stringify(s.devices?.map(o=>({is_active:o.is_active,player_id:o.player_id?.slice(0,20)})),null,2)}`);return}const r=d.player_id,g=`${i}/.netlify/functions/checkCarlPlayerId?playerId=${encodeURIComponent(r)}`;console.log("[Profile] Checking OneSignal API for Player ID:",r.slice(0,20)+"...","URL:",g);const u=await fetch(g,{method:"GET",mode:"cors"}).catch(o=>{throw new Error(`Network error checking OneSignal API: ${o.message||"Failed to connect"}`)});if(!u.ok){const o=await u.text().catch(()=>"Unknown error");k(`‚ùå OneSignal API Error (${u.status}): ${o}`);return}const c=await u.json().catch(o=>{throw new Error(`Failed to parse OneSignal API response: ${o.message}`)});if(c.ok){const o=c.player,p=c.interpretation;let l=`‚úÖ OneSignal API Response:

`;l+=`Player ID: ${c.playerId}
`,l+=`Notification Types: ${o.notification_types??"null"}
`,l+=`Last Active: ${o.last_active_date||"Never"}
`,l+=`Has Token: ${o.identifier==="present"?"Yes":"No"}
`,l+=`Invalid Token: ${o.invalid_identifier?"Yes":"No"}

`,l+=`Interpretation:
`,l+=`- Subscribed: ${p.subscribed?"‚úÖ":"‚ùå"}
`,l+=`- Unsubscribed: ${p.unsubscribed?"Yes":"No"}
`,l+=`- Disabled: ${p.disabled?"Yes":"No"}
`,l+=`- Not Initialized: ${p.not_initialized?"Yes":"No"}
`,l+=`- Has Valid Token: ${p.has_valid_token?"‚úÖ":"‚ùå"}
`,l+=`- Can Receive Notifications: ${p.can_receive_notifications?"‚úÖ":"‚ùå"}

`,l+=`Full API Response:
${JSON.stringify(c.player,null,2)}`,k(l)}else k(`‚ùå ${c.error||"Failed to check OneSignal API"}`)}catch(t){console.error("[Profile] Error checking OneSignal API:",t);const i=t.message||"Failed to check OneSignal API",n=i.includes("Network error")||i.includes("Failed to fetch")||i.includes("Failed to connect")?`

üí° Tip: Make sure you're connected to the internet and the function is deployed. Check browser console (F12) for more details.`:"";k(`‚ùå Error: ${i}${n}`)}finally{ee(!1)}},disabled:Z,className:"w-full mt-2 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:Z?"Checking...":"Check OneSignal API (Carl)"}),E&&e.jsx("div",{className:`mt-3 rounded border px-3 py-2 text-sm whitespace-pre-wrap break-words max-h-96 overflow-y-auto font-mono ${E.startsWith("‚úÖ")?"border-emerald-200 bg-emerald-50 text-emerald-800":"border-rose-200 bg-rose-50 text-rose-700"}`,children:E}),e.jsx("button",{onClick:async()=>{se(!0),P(null);try{const i=window.location.hostname==="localhost"?"https://totl-staging.netlify.app":"",a=`${i}/.netlify/functions/diagnoseCarlNotifications?user=jof`;console.log("[Profile] Fetching Jof's Player ID from:",a);const n=await fetch(a,{method:"GET",mode:"cors"}).catch(o=>{throw new Error(`Network error fetching Jof's Player ID: ${o.message||"Failed to connect"}`)});if(!n.ok){const o=await n.text().catch(()=>"Unknown error");P(`‚ùå Failed to get Jof's Player ID (${n.status}): ${o}`);return}const s=await n.json().catch(o=>{throw new Error(`Failed to parse response: ${o.message}`)}),d=s.devices?.find(o=>o.is_active);if(!d?.player_id){P(`‚ùå Jof's active Player ID not found. Devices: ${JSON.stringify(s.devices?.map(o=>({is_active:o.is_active,player_id:o.player_id?.slice(0,20)})),null,2)}`);return}const r=d.player_id,g=`${i}/.netlify/functions/checkCarlPlayerId?playerId=${encodeURIComponent(r)}`;console.log("[Profile] Checking OneSignal API for Player ID:",r.slice(0,20)+"...","URL:",g);const u=await fetch(g,{method:"GET",mode:"cors"}).catch(o=>{throw new Error(`Network error checking OneSignal API: ${o.message||"Failed to connect"}`)});if(!u.ok){const o=await u.text().catch(()=>"Unknown error");P(`‚ùå OneSignal API Error (${u.status}): ${o}`);return}const c=await u.json().catch(o=>{throw new Error(`Failed to parse OneSignal API response: ${o.message}`)});if(c.ok){const o=c.player,p=c.interpretation;let l=`‚úÖ OneSignal API Response:

`;l+=`Player ID: ${c.playerId}
`,l+=`Notification Types: ${o.notification_types??"null"}
`,l+=`Last Active: ${o.last_active_date||"Never"}
`,l+=`Has Token: ${o.identifier==="present"?"Yes":"No"}
`,l+=`Invalid Token: ${o.invalid_identifier?"Yes":"No"}

`,l+=`Interpretation:
`,l+=`- Subscribed: ${p.subscribed?"‚úÖ":"‚ùå"}
`,l+=`- Unsubscribed: ${p.unsubscribed?"Yes":"No"}
`,l+=`- Disabled: ${p.disabled?"Yes":"No"}
`,l+=`- Not Initialized: ${p.not_initialized?"Yes":"No"}
`,l+=`- Has Valid Token: ${p.has_valid_token?"‚úÖ":"‚ùå"}
`,l+=`- Can Receive Notifications: ${p.can_receive_notifications?"‚úÖ":"‚ùå"}

`,l+=`Full API Response:
${JSON.stringify(c.player,null,2)}`,P(l)}else P(`‚ùå ${c.error||"Failed to check OneSignal API"}`)}catch(t){console.error("[Profile] Error checking OneSignal API for Jof:",t);const i=t.message||"Failed to check OneSignal API",n=i.includes("Network error")||i.includes("Failed to fetch")||i.includes("Failed to connect")?`

üí° Tip: Make sure you're connected to the internet and the function is deployed. Check browser console (F12) for more details.`:"";P(`‚ùå Error: ${i}${n}`)}finally{se(!1)}},disabled:te,className:"w-full mt-2 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:te?"Checking...":"Check OneSignal API (Jof)"}),A&&e.jsx("div",{className:`mt-3 rounded border px-3 py-2 text-sm whitespace-pre-wrap break-words max-h-96 overflow-y-auto font-mono ${A.startsWith("‚úÖ")?"border-emerald-200 bg-emerald-50 text-emerald-800":"border-rose-200 bg-rose-50 text-rose-700"}`,children:A})]}),e.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200",children:[e.jsx("h4",{className:"text-md font-semibold text-slate-800 mb-3",children:"Send Notification to All Users"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700",children:"Title"}),e.jsx("input",{type:"text",value:C,onChange:t=>ce(t.target.value),placeholder:"Notification title",className:"w-full rounded border border-slate-300 px-3 py-2 text-sm focus:border-[#1C8376] focus:outline-none focus:ring-1 focus:ring-[#1C8376]"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700",children:"Message"}),e.jsx("textarea",{value:T,onChange:t=>H(t.target.value),placeholder:"Notification message",rows:3,className:"w-full rounded border border-slate-300 px-3 py-2 text-sm focus:border-[#1C8376] focus:outline-none focus:ring-1 focus:ring-[#1C8376]"})]}),D&&e.jsx("div",{className:`rounded border px-3 py-2 text-sm whitespace-pre-wrap break-words max-h-60 overflow-y-auto ${D.startsWith("‚úÖ")?"border-emerald-200 bg-emerald-50 text-emerald-800":D.startsWith("‚ö†Ô∏è")?"border-amber-200 bg-amber-50 text-amber-800":"border-rose-200 bg-rose-50 text-rose-700"}`,children:D}),e.jsx("button",{onClick:async()=>{if(!C.trim()||!T.trim()){w("‚ùå Please enter both title and message");return}W(!0),w(null);try{const a=`${window.location.hostname==="localhost"?"https://totl-staging.netlify.app":""}/.netlify/functions/sendPushAll`;console.log("[Profile] Sending notification to:",a);const n=await fetch(a,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:C.trim(),message:T.trim()})}).catch(r=>{throw console.error("[Profile] Fetch error:",r),new Error(`Network error: ${r.message||"Failed to connect to server. Make sure you're connected to the internet and the function is deployed."}`)});if(!n.ok){const r=await n.text().catch(()=>"Unknown error");w(`‚ùå Server error (${n.status}): ${r||"Failed to send notification"}`);return}let s;const d=await n.text();if(!d||d.trim()===""){w("‚ùå Empty response from server");return}try{s=JSON.parse(d)}catch(r){w(`‚ùå Invalid response from server: ${r.message||"Failed to parse response"}`);return}if(s.ok)if(s.warning)w(`‚ö†Ô∏è ${s.warning} (checked ${s.checked||0} device(s))`);else{const r=s.sentTo||0,g=s.oneSignalRecipients||0,u=s.expected||r,c=s.userCount||0,o=s.userNames||[],p=s.oneSignalErrors,l=s.hasNotificationId,ie=s.notificationId;let x="";l&&!p?(x=`‚úÖ Notification sent to ${u} device(s) (${c} users)`,ie&&(x+=`

Notification ID: ${ie}`,x+=`

üí° Tip: Check Netlify function logs to see OneSignal's full response, including invalid_player_ids.`)):p&&p.length>0?x=`‚ö†Ô∏è Sent to ${r} device(s) (${c} users, expected ${u}). OneSignal errors: ${p.join(", ")}`:r<u&&g===0?x=`‚úÖ Notification sent to ${u} device(s) (${c} users)`:r<u?x=`‚ö†Ô∏è Sent to ${r} device(s) (${c} users, expected ${u}). Some devices may not be subscribed.`:x=`‚úÖ Notification sent to ${r} device(s) (${c} users)`,o.length>0&&o.length<=5?x+=`

Users: ${o.join(", ")}`:o.length>5&&(x+=`

Users: ${o.slice(0,5).join(", ")} and ${o.length-5} more`),s.carlIncluded!==void 0&&(x+=`

Carl included: ${s.carlIncluded?"‚úÖ Yes":"‚ùå No"}`,s.carlPlayerId&&(x+=` (Player ID: ${s.carlPlayerId})`),s.carlInvalid&&(x+=`
‚ö†Ô∏è Carl's Player ID was marked as INVALID by OneSignal!`),s.invalidPlayerIds&&s.invalidPlayerIds.length>0&&(x+=`

Invalid Player IDs: ${s.invalidPlayerIds.length}`)),w(x),H("")}else w(`‚ùå Failed to send: ${s.error||"Unknown error"}`)}catch(t){console.error("[Profile] Error sending notification:",t);let i="Failed to send notification";t.message?i=t.message:t.name==="TypeError"&&t.message?.includes("fetch")&&(i="Network error: Could not reach server. Check your connection or try again later."),w(`‚ùå Error: ${i}`)}finally{W(!1)}},disabled:V||!C.trim()||!T.trim(),className:"w-full py-2 bg-[#1C8376] hover:bg-[#1a7569] text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:V?"Sending...":"Send to All Users"}),e.jsx("div",{className:"text-xs text-slate-500",children:"Sends a push notification to all users with active, subscribed devices."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{to:"/api-admin",className:"block w-full py-3 bg-[#1C8376] hover:bg-[#1C8376]/90 text-white font-semibold rounded-xl transition-colors text-center",children:"API Admin - Premier League"}),e.jsx(U,{to:"/test-fixtures",className:"block w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition-colors text-center",children:"Test Fixtures (Non-PL)"}),e.jsx(U,{to:"/admin",className:"block w-full py-3 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-xl transition-colors text-center",children:"Admin Panel (Web)"})]})]}),e.jsx("button",{onClick:async()=>{await ne()},className:"w-full mt-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-colors",children:"Sign Out"})]})]})}):e.jsx("div",{className:"p-6",children:"Please sign in to view your profile."})}export{be as default};
