import{u as Oe,r as f,s as o,j as s}from"./index-CKJVCyNd.js";import{M as We}from"./MiniLeagueCard-AYQq7IlE.js";import{g as _e,L as Ke}from"./leagueStart-bnJXG_AL.js";function Ve(a){return a.result==="H"||a.result==="D"||a.result==="A"?a.result:null}function Ye(){const{user:a}=Oe(),[_,c]=f.useState([]),[x,w]=f.useState(!0),[xe,A]=f.useState(!0),[pe,ee]=f.useState(!1),[V,te]=f.useState(""),[q,se]=f.useState(""),[ae,C]=f.useState(""),[be,Se]=f.useState({}),[ve,ye]=f.useState({}),[Me,ke]=f.useState({}),[Ce,re]=f.useState(null);f.useEffect(()=>{if(!a?.id){w(!1),A(!1);return}let l=!0;return(async()=>{try{const[h,k,j]=await Promise.all([o.from("league_members").select("league_id").eq("user_id",a.id),o.from("fixtures").select("gw").order("gw",{ascending:!1}).limit(1),o.from("meta").select("current_gw").eq("id",1).maybeSingle()]);if(h.error)throw h.error;if(!l)return;const m=(h.data??[]).map(e=>e.league_id);if(!m.length){c([]),re(null),w(!1),A(!1);return}const ie=k.data??[],$=ie.length?Math.max(...ie.map(e=>e.gw)):1,N=j.data?.current_gw??$;re($);const[z,H,Le,Re,Ne,Ie,De]=await Promise.all([o.from("leagues").select("id,name,code,created_at,avatar").in("id",m).order("created_at",{ascending:!0}),o.from("league_members").select("league_id,user_id").in("league_id",m).limit(1e4),o.from("league_message_reads").select("league_id,last_read_at").eq("user_id",a.id),o.from("gw_results").select("gw,fixture_index,result"),o.from("fixtures").select("gw,kickoff_time").order("gw",{ascending:!0}).order("kickoff_time",{ascending:!0}),o.from("league_members").select("league_id,user_id, users(id, name)").in("league_id",m).limit(1e4),o.from("leagues").select("id,name,created_at").in("id",m)]);if(z.error)throw z.error;if(H.error)throw H.error;if(!l)return;const T=z.data??[];for(const e of T)e.avatar||(e.avatar=_e(e.id),o.from("leagues").update({avatar:e.avatar}).eq("id",e.id));const I=new Map;(H.data??[]).forEach(e=>{const t=I.get(e.league_id)??[];t.push(e.user_id),I.set(e.league_id,t)});const ne=Array.from(new Set(Array.from(I.values()).flat())),E=T.find(e=>e.name==="API Test"),P=E?I.get(E.id)??[]:[],oe=E?ne.filter(e=>!P.includes(e)):ne,[le,de]=await Promise.all([oe.length>0?o.from("gw_submissions").select("user_id").eq("gw",$).in("user_id",oe).limit(1e4):Promise.resolve({data:[],error:null}),E&&P.length>0?o.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle():Promise.resolve({data:null,error:null})]),Ge=new Set((le.data??[]).map(e=>e.user_id));let Z=new Set;if(E&&P.length>0&&de.data){const e=de.data?.current_test_gw??1,[t,r,i]=await Promise.all([o.from("test_api_submissions").select("user_id,submitted_at").eq("matchday",e).in("user_id",P).not("submitted_at","is",null),o.from("test_api_picks").select("user_id,fixture_index").eq("matchday",e).in("user_id",P),o.from("test_api_fixtures").select("fixture_index").eq("test_gw",e).order("fixture_index",{ascending:!0})]);if(i.data&&r.data&&t.data){const u=new Set(i.data.map(p=>p.fixture_index)),d=u.size;t.data.forEach(p=>{const g=(r.data??[]).filter(y=>y.user_id===p.user_id).filter(y=>u.has(y.fixture_index)),S=g.length===d&&d>0,R=new Set(g.map(y=>y.fixture_index)).size===d;S&&R&&Z.add(p.user_id)})}}const ue={};for(const e of T){const t=I.get(e.id)??[],r=t.length,i=e.id===E?.id?t.filter(u=>Z.has(u)).length:t.filter(u=>Ge.has(u)).length;ue[e.id]={allSubmitted:i===r&&r>0,submittedCount:i,totalCount:r}}Se(ue);const B={};try{const e=new Map;if((Le.data??[]).forEach(t=>e.set(t.league_id,t.last_read_at)),m.length>0){const t=new Map;m.forEach(d=>{t.set(d,e.get(d)??"1970-01-01T00:00:00Z")});const r=Math.min(...Array.from(t.values()).map(d=>new Date(d).getTime())),i=new Date(r).toISOString(),{data:u}=await o.from("league_messages").select("id,league_id,created_at").in("league_id",m).gte("created_at",i);m.forEach(d=>{const p=t.get(d),b=(u??[]).filter(g=>g.league_id===d&&new Date(g.created_at)>new Date(p)).length;B[d]=b})}}catch{}ke(B);const L=T.map(e=>{const t=I.get(e.id)??[];return{id:e.id,name:e.name,code:e.code,memberCount:t.length,avatar:e.avatar,created_at:e.created_at,start_gw:e.start_gw}});if(L.sort((e,t)=>{const r=B[e.id]??0,i=B[t.id]??0;return r>0&&i===0?-1:r===0&&i>0?1:0}),!l)return;const Pe=Re.data??[],Q=new Map;for(const e of Pe){const t=Ve(e);t&&Q.set(`${e.gw}:${e.fixture_index}`,t)}const Fe=Ne.data??[],U=new Map;Fe.forEach(e=>{const t=U.get(e.gw)??[];t.push(e.kickoff_time),U.set(e.gw,t)});const F=[...new Set(Array.from(Q.keys()).map(e=>parseInt(e.split(":")[0],10)))].sort((e,t)=>e-t),J=new Map;(Ie.data??[]).forEach(e=>{if(!e.users?.name)return;const t=J.get(e.league_id)??[];t.push({id:e.user_id,name:e.users.name}),J.set(e.league_id,t)});const Ae=De.data??[],ce=new Map;Ae.forEach(e=>{ce.set(e.id,e)});const O=new Map;for(const e of L){const t=ce.get(e.id),r={id:e.id,name:t?.name??e.name,created_at:(t?.created_at??e.created_at)||null,start_gw:t?.start_gw??e.start_gw};let i=N;const u=r.name?Ke[r.name]:void 0;if(typeof u=="number")i=u;else if(r.start_gw!==null&&r.start_gw!==void 0)i=r.start_gw;else if(r.created_at&&F.length>0){const d=new Date(r.created_at),p=75;for(const b of F){const g=U.get(b);if(g&&g.length>0){const S=new Date(g[0]),D=new Date(S.getTime()-p*60*1e3);if(d<=D){i=b;break}}}i===N&&F.length>0&&(i=Math.max(...F)+1)}O.set(e.id,i)}const X=new Set;L.forEach(e=>{const t=O.get(e.id)??N;F.filter(r=>r>=t).forEach(r=>X.add(r))});const qe=L.map(e=>{const t=J.get(e.id)??[];if(t.length===0)return Promise.resolve({data:[],error:null});const r=O.get(e.id)??N,i=Array.from(X).filter(u=>u>=r);return i.length===0?Promise.resolve({data:[],error:null}):o.from("picks").select("user_id,gw,fixture_index,pick").in("user_id",t.map(u=>u.id)).in("gw",i).limit(1e4)}),Te=await Promise.all(qe);if(!l)return;const Be=new Set((le.data??[]).map(e=>e.user_id)),me={};for(let e=0;e<L.length;e++){const t=L[e],r=Te[e],i=J.get(t.id)??[];if(i.length===0)continue;const u=O.get(t.id)??N,d=Array.from(X).filter(n=>n>=u),p=r.data??[],b=new Map;p.forEach(n=>{b.has(n.user_id)||b.set(n.user_id,new Map);const v=b.get(n.user_id);v.has(n.gw)||v.set(n.gw,new Map),v.get(n.gw).set(n.fixture_index,n.pick)});const g=new Map,S=new Map;d.forEach(n=>{const G=(U.get(n)??[]).length;G!==0&&i.forEach(M=>{const fe=b.get(M.id)?.get(n);if(!fe)return;let Y=0;for(let K=0;K<G;K++){const we=fe.get(K),he=Q.get(`${n}:${K}`);we&&he&&we===he&&Y++}S.has(M.id)||S.set(M.id,new Map),S.get(M.id).set(n,Y);const Je=g.get(M.id)??0;g.set(M.id,Je+Y)})});const D=[...i].sort((n,v)=>{const G=g.get(n.id)??0,M=g.get(v.id)??0;return M!==G?M-G:n.name.localeCompare(v.name)}),R=D.findIndex(n=>n.id===a.id)+1,y=R>1?R-1:null,Ue=y===null?null:R<y?"up":R>y?"down":"same",W=d.length>0?Math.max(...d):N,ge=[];if(W&&S.has(a.id)){const n=S.get(a.id).get(W)??0;D.forEach(v=>{(S.get(v.id)?.get(W)??0)===n&&n>0&&ge.push(v.id)})}me[t.id]={id:t.id,members:i,userPosition:R||null,positionChange:Ue,submittedMembers:t.id===E?.id?Z:Be,sortedMemberIds:D.map(n=>n.id),latestGwWinners:ge,latestRelevantGw:W}}l&&(c(L),ye(me),w(!1),A(!1))}catch(h){l&&(C(h?.message??"Failed to load leagues."),w(!1),A(!1))}})(),()=>{l=!1}},[a?.id]);const je=f.useCallback(async()=>{if(!(!q.trim()||!a?.id)){ee(!0),C("");try{const l=q.trim(),h=await He(),{data:k,error:j}=await o.from("leagues").insert({name:l,code:h}).select("id,code").single();if(j)throw j;const m=_e(k.id);await o.from("leagues").update({avatar:m}).eq("id",k.id),await o.from("league_members").insert({league_id:k.id,user_id:a.id}),se(""),c([]),w(!0)}catch(l){C(l?.message??"Failed to create league.")}finally{ee(!1)}}},[q,a?.id]),Ee=f.useCallback(async()=>{const l=V.trim().toUpperCase();if(!(!l||!a?.id)){C("");try{const{data:h,error:k}=await o.from("leagues").select("id").eq("code",l).maybeSingle();if(k)throw k;if(!h){C("League code not found.");return}const{data:j,error:m}=await o.from("league_members").select("user_id").eq("league_id",h.id);if(m)throw m;if(j&&j.length>=8){C("League is full (max 8 members).");return}await o.from("league_members").upsert({league_id:h.id,user_id:a.id},{onConflict:"league_id,user_id"}),te(""),c([]),w(!0)}catch(h){C(h?.message??"Failed to join league.")}}},[V,a?.id]);return s.jsx("div",{className:"min-h-screen bg-slate-50",children:s.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-4 pb-16",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900",children:"Mini Leagues"}),_.length>4&&s.jsxs("button",{onClick:()=>{const l=document.getElementById("create-join-section");l&&l.scrollIntoView({behavior:"smooth",block:"start"})},className:"text-[#1C8376] font-semibold text-sm hover:text-[#1C8376] no-underline flex items-center gap-1",children:["Create League",s.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})]}),s.jsx("p",{className:"mt-2 mb-6 text-sm text-slate-600 w-full",children:"Create or join a private league and battle it out with your friends. - COMPONENTS VERSION"}),ae&&s.jsx("div",{className:"mt-4 rounded border border-rose-200 bg-rose-50 text-rose-700 px-3 py-2 text-sm",children:ae}),x||xe?s.jsx("div",{className:"mt-6 flex items-center justify-center py-12",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#1C8376]"})}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"mt-6",children:_.length===0?s.jsx("div",{className:"px-4 py-4 text-sm",children:"No leagues yet."}):s.jsx("div",{className:"space-y-3",children:_.map(l=>s.jsx(We,{row:l,data:ve[l.id],unread:Me?.[l.id]??0,submissions:be[l.id],leagueDataLoading:!1,currentGw:Ce},l.id))})}),s.jsx("div",{id:"create-join-section",className:"mt-10 mb-3 text-xl font-extrabold text-slate-900",children:"Create or Join"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsx($e,{leagueName:q,setLeagueName:se,creating:pe,onCreate:je}),s.jsx(ze,{joinCode:V,setJoinCode:te,onJoin:Ee})]})]})]})})}function $e({leagueName:a,setLeagueName:_,creating:c,onCreate:x}){return s.jsxs("div",{className:"border rounded-2xl p-4 bg-white",children:[s.jsx("div",{className:"text-sm font-medium mb-2",children:"Create a league"}),s.jsx("input",{className:"border rounded px-3 py-2 w-full bg-white",placeholder:"League name",value:a,onChange:w=>_(w.target.value),onKeyDown:w=>{w.key==="Enter"&&!c&&a.trim()&&x()}}),s.jsx("button",{className:"mt-3 px-3 py-2 rounded bg-slate-900 text-white disabled:opacity-50",onClick:x,disabled:c||!a.trim(),children:c?"Creatingâ€¦":"Create"})]})}function ze({joinCode:a,setJoinCode:_,onJoin:c}){return s.jsxs("div",{className:"border rounded-2xl p-4 bg-white",children:[s.jsx("div",{className:"text-sm font-medium mb-2",children:"Join with code"}),s.jsx("input",{className:"border rounded px-3 py-2 w-full uppercase tracking-widest bg-white",placeholder:"ABCDE",value:a,onChange:x=>_(x.target.value),onKeyDown:x=>{x.key==="Enter"&&a.trim()&&c()}}),s.jsx("button",{className:"mt-3 px-3 py-2 rounded border",onClick:c,children:"Join"})]})}async function He(){const a="ABCDEFGHJKLMPQRSTVWXYZ23456789";for(let _=0;_<6;_++){let c="";for(let w=0;w<5;w++)c+=a[Math.floor(Math.random()*a.length)];const{data:x}=await o.from("leagues").select("id").eq("code",c).maybeSingle();if(!x)return c}return Math.random().toString(36).slice(2,7).toUpperCase()}export{Ye as default};
