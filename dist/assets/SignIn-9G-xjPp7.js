import{r as n,h as _,u as B,j as e,s as i}from"./index-C8xiN6E0.js";function W(){const[r,c]=n.useState("signup"),[h,k]=n.useState(""),[d,C]=n.useState(""),[f,E]=n.useState(""),[p,I]=n.useState(""),[y,R]=n.useState(""),[g,l]=n.useState(null),[x,m]=n.useState(!1),[U,b]=n.useState(!1),[F,j]=n.useState(!1),[q,D]=n.useState(!1),w=_(),{user:v,loading:N}=B();n.useEffect(()=>{!N&&v&&r!=="password-reset"&&(console.log("[SignIn] User already signed in, redirecting to home"),w("/",{replace:!0}))},[v,N,r,w]),n.useEffect(()=>{(async()=>{console.log("SignIn page loaded, checking for password reset..."),console.log("Current URL:",window.location.href),console.log("Search params:",window.location.search),console.log("Hash:",window.location.hash);const t=new URLSearchParams(window.location.search),u=new URLSearchParams(window.location.hash.substring(1)),o=t.get("type")==="recovery"||u.get("type")==="recovery"||window.location.search.includes("type=recovery")||window.location.hash.includes("type=recovery");if(console.log("Is recovery detected:",o),o){console.log("Setting password reset mode"),c("password-reset");return}const{data:{session:a}}=await i.auth.getSession();if(console.log("Session:",a),a?.user){if(window.location.hash.includes("type=recovery")||window.location.search.includes("type=recovery")){console.log("Session-based recovery detected"),c("password-reset");return}if(a.user.app_metadata?.provider==="email"&&(a.user.app_metadata?.providers?.includes("email")||window.location.href.includes("recovery")||window.location.href.includes("reset"))){console.log("Password reset session detected"),c("password-reset");return}}})()},[]);async function T(){if(p!==y){l("Passwords do not match");return}if(p.length<6){l("Password must be at least 6 characters");return}l(null),m(!0);try{const{error:s}=await i.auth.updateUser({password:p});if(s)throw s;D(!0),setTimeout(()=>{w("/")},2e3)}catch(s){l(s.message||"Failed to update password")}finally{m(!1)}}async function S(s,t){s&&(t&&t.trim()?await i.from("users").upsert({id:s,name:t.trim()}):await i.from("users").upsert({id:s}))}async function A(){if(!d.trim()){l("Please enter your email address");return}l(null),m(!0);try{const{error:s}=await i.auth.resetPasswordForEmail(d.trim(),{redirectTo:`${window.location.origin}/auth`});if(s)throw s;j(!0)}catch(s){l(s?.message||"Failed to send reset email")}finally{m(!1)}}async function L(s){s.preventDefault(),l(null),m(!0);try{if(r==="signup"){const{data:t,error:u}=await i.from("users").select("name").eq("name",h.trim()).limit(1);if(u)throw u;if(t&&t.length>0)throw new Error("Username already taken. Please choose a different name.");const{data:o,error:a}=await i.auth.signUp({email:d.trim(),password:f,options:{data:{display_name:h.trim()},emailRedirectTo:window.location.origin}});if(a)throw a;const P=o.user??(await i.auth.getUser()).data.user;P&&await S(P.id,h),b(!0)}else{console.log("[SignIn] Attempting sign in with email:",d.trim());const{data:t,error:u}=await i.auth.signInWithPassword({email:d.trim(),password:f});if(u)throw console.error("[SignIn] Sign in error:",u),u;console.log("[SignIn] Sign in successful, data:",t);const o=t.user??t.session?.user;if(console.log("[SignIn] User:",o?.id),console.log("[SignIn] Session:",t.session?"has session":"no session"),t.session){console.log("[SignIn] Session available, storing and refreshing auth state");try{const{data:a}=await i.auth.getSession();console.log("[SignIn] Verified session after sign-in:",a.session?"OK":"missing")}catch(a){console.error("[SignIn] Error verifying session:",a)}}if(o)try{const a=o.user_metadata?.display_name;console.log("[SignIn] Upserting profile for user:",o.id,"name:",a),await S(o.id,a),console.log("[SignIn] Profile upserted successfully")}catch(a){console.error("[SignIn] Error upserting profile (non-fatal):",a)}console.log("[SignIn] Navigating to home page..."),w("/",{replace:!0}),console.log("[SignIn] Navigation called")}}catch(t){l(t?.message||"Something went wrong")}finally{m(!1)}}return U?e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold text-center",children:"Check Your Email"}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("p",{className:"text-slate-600",children:["We've sent you a confirmation link at ",e.jsx("strong",{children:d})]}),e.jsx("p",{className:"text-sm text-slate-500",children:"Click the link in your email to activate your account and start playing TOTL!"}),e.jsx("button",{onClick:()=>b(!1),className:"mt-4 px-4 py-2 text-sm text-emerald-600 hover:text-emerald-700 underline",children:"Back to signup"})]})]})}):F?e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold text-center",children:"Check Your Email"}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("p",{className:"text-slate-600",children:["We've sent a password reset link to ",e.jsx("strong",{children:d})]}),e.jsx("p",{className:"text-sm text-slate-500",children:"Click the link in your email to reset your password."}),e.jsx("button",{onClick:()=>{j(!1),c("signin")},className:"mt-4 px-4 py-2 text-sm text-emerald-600 hover:text-emerald-700 underline",children:"Back to sign in"})]})]})}):q?e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold text-center text-green-600",children:"Password Updated!"}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-slate-600",children:"Your password has been successfully updated."}),e.jsx("p",{className:"text-sm text-slate-500",children:"Redirecting to home page..."})]})]})}):r==="password-reset"?e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("form",{onSubmit:s=>{s.preventDefault(),T()},className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Set New Password"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"New Password"}),e.jsx("input",{type:"password",className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:p,onChange:s=>I(s.target.value),placeholder:"At least 6 characters",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Confirm Password"}),e.jsx("input",{type:"password",className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:y,onChange:s=>R(s.target.value),placeholder:"Confirm your new password",required:!0})]}),g&&e.jsx("div",{className:"text-sm text-red-600",children:g}),e.jsx("button",{type:"submit",disabled:x,className:"w-full rounded-xl px-4 py-2 font-semibold bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",children:x?"Updating...":"Update Password"})]})}):e.jsx("div",{className:"min-h-screen flex items-start justify-center bg-gray-50 p-6 pt-20",children:e.jsxs("form",{onSubmit:r==="reset"?s=>{s.preventDefault(),A()}:L,className:"w-full max-w-md rounded-2xl border bg-white p-6 shadow space-y-4",children:[e.jsx("h1",{className:"text-xl font-bold",children:r==="signup"?"Create your account":r==="reset"?"Reset your password":"Sign in"}),r==="signup"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Display name"}),e.jsx("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:h,onChange:s=>k(s.target.value),placeholder:"e.g. Thomas B",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Email"}),e.jsx("input",{type:"email",className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:d,onChange:s=>C(s.target.value),placeholder:"you@example.com",required:!0})]}),r!=="reset"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Password"}),e.jsx("input",{type:"password",className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:f,onChange:s=>E(s.target.value),placeholder:"At least 6 characters",required:!0})]}),g&&e.jsx("div",{className:"text-sm text-red-600",children:g}),e.jsx("button",{type:"submit",disabled:x,className:"w-full rounded-xl px-4 py-2 font-semibold bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",children:x?r==="signup"?"Creating…":r==="reset"?"Sending…":"Signing in…":r==="signup"?"Create account":r==="reset"?"Send reset link":"Sign in"}),e.jsx("div",{className:"text-xs text-slate-500",children:r==="signup"?e.jsxs(e.Fragment,{children:["Already have an account?"," ",e.jsx("button",{type:"button",onClick:()=>c("signin"),className:"underline",children:"Sign in"})]}):r==="reset"?e.jsxs(e.Fragment,{children:["Remember your password?"," ",e.jsx("button",{type:"button",onClick:()=>c("signin"),className:"underline",children:"Sign in"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:["New here?"," ",e.jsx("button",{type:"button",onClick:()=>c("signup"),className:"underline",children:"Create an account"})]}),e.jsxs("div",{children:["Forgot your password?"," ",e.jsx("button",{type:"button",onClick:()=>c("reset"),className:"underline",children:"Reset it"})]})]})})]})})}export{W as default};
