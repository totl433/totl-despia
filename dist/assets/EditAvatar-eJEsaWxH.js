import{z as G,u as H,r as l,o as O,J as Z,K as A,M as J,j as e,P as $,U as q,a as U}from"./index-C0WCEC5K.js";import{C as K}from"./index.module-COT8OCyg.js";function Y(){const c=G(),{user:a}=H(),[m,h]=l.useState(null),[E,P]=l.useState({x:0,y:0}),[k,y]=l.useState(1),[v,S]=l.useState(null),[n,j]=l.useState(null),[x,f]=l.useState(!1),[b,d]=l.useState(null),[I,p]=l.useState(!1),[L,u]=l.useState(null),R=l.useRef(null);l.useEffect(()=>{a?.id||c("/profile")},[a,c]),l.useEffect(()=>{(async()=>{if(a?.id)try{const{data:t,error:i}=await U.from("users").select("avatar_url").eq("id",a.id).maybeSingle();if(i){console.warn("[EditAvatar] Error checking avatar:",i),u(!1);return}if(!t?.avatar_url){u(!1);return}const o=t.avatar_url.match(/user-avatars\/([^\/]+)\/([^\/\?]+)/);if(!o){u(!1);return}const[,w,N]=o,{data:g,error:W}=await U.storage.from("user-avatars").list(w,{search:N});if(W||!g||g.length===0){u(!1);return}const D=!!localStorage.getItem(`avatar_uploaded_${a.id}`);u(D)}catch(t){console.warn("[EditAvatar] Error checking avatar:",t),u(!1)}})()},[a?.id]);const _=r=>new Promise((t,i)=>{const s=new Image;s.addEventListener("load",()=>t(s)),s.addEventListener("error",o=>i(o)),s.src=r}),C=async(r,t)=>{const i=await _(r),s=document.createElement("canvas"),o=s.getContext("2d");if(!o)throw new Error("No 2d context");return s.width=t.width,s.height=t.height,o.drawImage(i,t.x,t.y,t.width,t.height,0,0,t.width,t.height),new Promise((w,N)=>{s.toBlob(g=>{if(!g){N(new Error("Canvas is empty"));return}w(g)},"image/png",.9)})},F=l.useCallback(r=>{if(!a?.id){d("You must be logged in to upload an avatar.");return}if(!new Set(["image/png","image/jpeg","image/jpg","image/webp"]).has(r.type)){d("Please upload a PNG, JPG, or WebP image.");return}const i=20*1024*1024;if(r.size>i){d("Please choose an image smaller than 20MB.");return}if(d(null),p(!1),r.size>5*1024*1024)O(r,{maxSizeMB:2,maxWidthOrHeight:1024,useWebWorker:!0,initialQuality:.7}).then(s=>{const o=new FileReader;o.onload=()=>{h(o.result)},o.readAsDataURL(s)}).catch(()=>{d("Failed to process image. Please try a smaller file.")});else{const s=new FileReader;s.onload=()=>{h(s.result)},s.readAsDataURL(r)}},[a?.id]),M=l.useCallback(async(r,t)=>{if(S(t),m)try{const i=await C(m,t),s=URL.createObjectURL(i);j(s)}catch{}},[m]),z=l.useCallback(async()=>{if(!(!m||!v||!a?.id)){d(null),p(!1),f(!0);try{const r=await C(m,v),t=new File([r],"avatar.png",{type:"image/png"});await Z(a.id,t),A(a.id),localStorage.setItem(`avatar_uploaded_${a.id}`,Date.now().toString()),u(!0),p(!0),n&&URL.revokeObjectURL(n),setTimeout(()=>{c("/profile"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("userAvatarUpdated",{detail:{userId:a.id}}))},200)},1e3)}catch(r){d(r?.message??"Failed to upload avatar. Please try again.")}finally{f(!1)}}},[m,v,a?.id,n,c]),T=l.useCallback(async()=>{if(a?.id){d(null),p(!1),f(!0);try{await J(a.id),A(a.id),localStorage.removeItem(`avatar_uploaded_${a.id}`),u(!1),p(!0),setTimeout(()=>{c("/profile"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("userAvatarUpdated",{detail:{userId:a.id}}))},200)},1e3)}catch(r){d(r?.message??"Failed to remove avatar. Please try again.")}finally{f(!1)}}},[a?.id,c]),B=l.useCallback(()=>{n&&URL.revokeObjectURL(n),h(null),j(null),d(null),p(!1),c("/profile")},[n,c]);return a?.id?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-6",children:[e.jsx($,{title:"Edit Avatar",as:"h1",className:"mb-6"}),e.jsx("div",{className:"bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4 sm:p-6",children:m?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-xs text-slate-600 dark:text-slate-400",children:[e.jsx("p",{className:"font-medium",children:"Position your image"}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-500",children:"Drag to position, use slider to zoom"})]}),e.jsx("div",{className:"relative w-full",style:{height:"280px"},children:e.jsx(K,{image:m,crop:E,zoom:k,aspect:1,cropShape:"round",showGrid:!1,onCropChange:P,onZoomChange:y,onCropComplete:M,style:{containerStyle:{width:"100%",height:"100%",position:"relative"}}})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("label",{className:"block text-xs font-medium text-slate-700 dark:text-slate-300",children:["Zoom: ",Math.round(k*100),"%"]}),e.jsx("input",{type:"range",min:1,max:3,step:.1,value:k,onChange:r=>y(Number(r.target.value)),className:"w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-[#1C8376] dark:accent-emerald-500 touch-manipulation",style:{WebkitTapHighlightColor:"transparent"}})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-slate-300",children:"Preview:"}),e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-slate-100 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center flex-shrink-0",children:n?e.jsx("img",{src:n,alt:"Preview",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-slate-200 dark:bg-slate-600"})})]})]}),b&&e.jsx("div",{className:"p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-xs text-red-800 dark:text-red-300",children:b}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx("button",{onClick:()=>{h(null),n&&URL.revokeObjectURL(n),j(null),d(null)},disabled:x,className:"flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 font-medium disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:z,disabled:x||!v,className:"flex-1 px-4 py-2 bg-[#1C8376] text-white rounded-lg font-medium disabled:opacity-50",children:x?"Uploading...":"Save Avatar"})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-400 mb-2 font-medium",children:"Current Avatar:"}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("div",{className:"w-16 h-16 rounded-full overflow-hidden bg-slate-100 dark:bg-slate-700 flex items-center justify-center border-2 border-slate-200 dark:border-slate-600",children:e.jsx(q,{userId:a.id,name:a.user_metadata?.display_name||a.email||void 0,size:64})})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-700 dark:text-slate-300 mb-2",children:"Choose Image"}),e.jsx("input",{ref:R,type:"file",accept:"image/png,image/jpeg,image/jpg,image/webp",onChange:r=>{const t=r.target.files?.[0];t&&F(t)},disabled:x,className:"hidden",id:"avatar-upload-input"}),e.jsx("label",{htmlFor:"avatar-upload-input",className:"block w-full border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-6 text-center active:bg-slate-50 dark:active:bg-slate-700 active:border-[#1C8376] touch-manipulation cursor-pointer",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("svg",{className:"w-10 h-10 text-slate-400 dark:text-slate-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("div",{className:"text-sm",children:e.jsx("span",{className:"text-[#1C8376] dark:text-emerald-400 font-semibold",children:"Tap to choose image"})}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:"PNG, JPG, or WebP (up to 20MB - will be optimized automatically)"})]})})]}),x&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-400",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-[#1C8376] dark:border-emerald-400"}),e.jsx("span",{children:"Processing and uploading..."})]}),I&&e.jsx("div",{className:"p-2 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg text-xs text-emerald-800 dark:text-emerald-300",children:"âœ“ Avatar uploaded successfully!"}),b&&e.jsx("div",{className:"p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-xs text-red-800 dark:text-red-300",children:b})]}),e.jsxs("div",{className:"mt-6 flex gap-3",children:[e.jsx("button",{onClick:B,disabled:x,className:"flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 font-medium disabled:opacity-50",children:"Cancel"}),a&&L&&e.jsx("button",{onClick:T,disabled:x,className:"px-4 py-2 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg font-medium disabled:opacity-50",children:"Remove Avatar"})]})]})})]})}):null}export{Y as default};
