const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DjTelcoh.js","assets/index-CC0BY6hJ.css"])))=>i.map(i=>d[i]);
import{j as l,L as rt,u as It,r as g,E as Ct,q as D,n as Rt,s as S,F as H,h as Mt,t as F,C as B,H as oe,x as Ae,y as Z,z as Ne,J as Pt,k as Dt,_ as Lt,K as jt,M as At,S as Nt,N as $t,O as at}from"./index-DjTelcoh.js";function xe({to:a,rank:T,total:G,label:u,bgColor:ce,gw:I}){const ee=I?`GW${I}`:u,te=T&&G&&G>0?(G-T+1)/G*100:0,K=45,M=2*Math.PI*K,se=M-te/100*M,q=`circle-${Math.random().toString(36).substr(2,9)}`;return l.jsxs(rt,{to:a,className:"flex flex-col items-center",children:[l.jsx("style",{children:`
        @keyframes progress-${q} {
          from {
            stroke-dashoffset: ${M};
          }
          to {
            stroke-dashoffset: ${se};
          }
        }
        .progress-circle-${q} {
          animation: progress-${q} 1s ease-out forwards;
        }
      `}),l.jsxs("div",{className:"relative w-20 h-20 sm:w-24 sm:h-24 lg:w-28 lg:h-28 flex-shrink-0",children:[l.jsxs("svg",{className:"absolute inset-0 w-full h-full transform -rotate-90",viewBox:"0 0 100 100",xmlns:"http://www.w3.org/2000/svg",children:[l.jsx("circle",{cx:"50",cy:"50",r:K,fill:"none",stroke:"#e5e7eb",strokeWidth:"4"}),te>0&&l.jsx("circle",{cx:"50",cy:"50",r:K,fill:"none",stroke:"#10b981",strokeWidth:"4",strokeDasharray:M,strokeDashoffset:M,strokeLinecap:"round",className:`progress-circle-${q}`})]}),l.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-slate-900",children:l.jsx("div",{className:"flex items-baseline justify-center",children:T?l.jsxs(l.Fragment,{children:[l.jsx("span",{className:"text-2xl sm:text-3xl lg:text-4xl",children:T}),l.jsx("span",{className:"text-[10px] sm:text-xs lg:text-sm font-bold",children:T===1?"st":T===2?"nd":T===3?"rd":"th"})]}):l.jsx("span",{className:"text-2xl sm:text-3xl lg:text-4xl",children:"--"})})})]}),l.jsx("div",{className:"mt-1.5 sm:mt-2 text-xs sm:text-sm font-medium text-slate-700 text-center",children:ee})]})}function Ut(a){return a.result==="H"||a.result==="D"||a.result==="A"?a.result:null}function Wt(){const{user:a}=It(),G=(()=>{let t=a?.id;if(!t&&typeof window<"u")try{const s=localStorage.getItem("totl:user");s&&(t=JSON.parse(s).id)}catch{}if(typeof window>"u"||!t)return{gw:1,latestGw:null,gwPoints:[],allGwPoints:[],overall:[],lastGwRank:null,fiveGwRank:null,tenGwRank:null,seasonRank:null,fixtures:[],userPicks:{},leagueData:{},leagueSubmissions:{},hasCache:!1};try{const s=`home:basic:${t}`,e=D(s);if(e&&e.currentGw){let n=[],r={},d={};const c=`home:fixtures:${t}:${e.currentGw}`;try{const _=D(c);if(_?.fixtures?.length&&(n=_.fixtures,r=_.userPicks||{},_.liveScores?.length)){const v=new Map;_.fixtures.forEach(f=>{f.api_match_id&&v.set(f.api_match_id,f.fixture_index)}),_.liveScores.forEach(f=>{let m=f.fixture_index;!m&&f.api_match_id&&(m=v.get(f.api_match_id)),m!==void 0&&(d[m]={homeScore:f.home_score??0,awayScore:f.away_score??0,status:f.status||"SCHEDULED",minute:f.minute??null,goals:f.goals??null,red_cards:f.red_cards??null,home_team:f.home_team??null,away_team:f.away_team??null})})}}catch{}let x={},h={};const w=`home:leagueData:v2:${t}:${e.currentGw}`;try{const _=D(w);if(_?.leagueData&&Object.values(_.leagueData).every(f=>f.webUserIds!==void 0)){for(const[f,m]of Object.entries(_.leagueData))x[f]={...m,submittedMembers:m.submittedMembers?Array.isArray(m.submittedMembers)?new Set(m.submittedMembers):m.submittedMembers:void 0,latestGwWinners:m.latestGwWinners?Array.isArray(m.latestGwWinners)?new Set(m.latestGwWinners):m.latestGwWinners:void 0,webUserIds:m.webUserIds?Array.isArray(m.webUserIds)?new Set(m.webUserIds):m.webUserIds:void 0};h=_.leagueSubmissions||{}}}catch{}return{gw:e.currentGw,latestGw:e.latestGw,gwPoints:(e.allGwPoints||[]).filter(_=>_.user_id===t),allGwPoints:e.allGwPoints||[],overall:e.overall||[],lastGwRank:e.lastGwRank||null,fiveGwRank:e.fiveGwRank??null,tenGwRank:e.tenGwRank??null,seasonRank:e.seasonRank??null,fixtures:n,userPicks:r,liveScores:d,leagueData:x,leagueSubmissions:h,hasCache:!0}}}catch{}return{gw:1,latestGw:null,gwPoints:[],allGwPoints:[],overall:[],lastGwRank:null,fiveGwRank:null,tenGwRank:null,seasonRank:null,fixtures:[],userPicks:{},liveScores:{},leagueData:{},leagueSubmissions:{},hasCache:!1}})(),[u,ce]=g.useState(G.gw),[I,ee]=g.useState(G.latestGw),[te,K]=g.useState(G.gwPoints),[M,se]=g.useState(G.lastGwRank),[q,pe]=g.useState(G.fiveGwRank??null),[$e,_e]=g.useState(G.tenGwRank??null),[be,ye]=g.useState(G.seasonRank??null),[C,ae]=g.useState(G.fixtures),[Y,re]=g.useState(G.userPicks),[Ue]=g.useState(G.liveScores||{}),[nt,He]=g.useState(G.leagueData),[it,Te]=g.useState(G.leagueSubmissions),Se=g.useRef(null),[ve,ke]=g.useState(0),[ot,We]=g.useState(!G.hasCache),{leagues:N,unreadByLeague:ct,loading:lt,refresh:Oe}=Ct({pageName:"home"}),ut=g.useMemo(()=>{if(!u)return null;try{return D(`gameState:${u}`)}catch{return null}},[u]),{state:dt,loading:Ge}=Rt(u),$=ut??dt;g.useMemo(()=>{if(!M?.gw||M.gw===u)return $;try{return D(`gameState:${M.gw}`)}catch{return null}},[M?.gw,u,$]);const mt=ot||lt||Ge,Fe=g.useMemo(()=>N.some(t=>t.name==="API Test"),[N]);g.useEffect(()=>{const t=()=>Oe();return window.addEventListener("leagueBadgeUpdated",t),()=>window.removeEventListener("leagueBadgeUpdated",t)},[Oe]),g.useEffect(()=>{if(!a?.id)return;let t=!0;return(async()=>{try{const s=`home:basic:${a.id}`,n=D(s)?.currentGw??G.gw,{data:r,error:d}=await S.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(!t||d)return;const c=r?.current_gw??1,{data:x}=await S.from("user_notification_preferences").select("current_viewing_gw").eq("user_id",a.id).maybeSingle();if(!t)return;const h=x?.current_viewing_gw??(c>1?c-1:c),w=h<c?h:c;n!==w&&(H(s),n&&H(`home:fixtures:${a.id}:${n}`),ce(w))}catch(s){console.error("[Home] Error validating cached GW:",s)}})(),()=>{t=!1}},[a?.id,G.gw]),g.useEffect(()=>{const t=()=>{sessionStorage.getItem("showConfettiOnHome")==="true"&&(sessionStorage.removeItem("showConfettiOnHome"),window.scrollTo({top:0,behavior:"instant"}),setTimeout(()=>{if(Se.current){const n=Se.current.getBoundingClientRect(),r=(n.left+n.width/2)/window.innerWidth,d=(n.top+n.height/2)/window.innerHeight;at({x:r,y:d})}else at()},100))};t();const s=setTimeout(t,100);return()=>clearTimeout(s)},[]);const Be=g.useMemo(()=>C?.length?C.map(t=>t.api_match_id).filter(t=>t!=null):[],[C]),Ke=g.useMemo(()=>{if(!a?.id||!u)return new Map;try{const t=`home:fixtures:${a.id}:${u}`,s=D(t);if(s?.liveScores?.length){const e=new Map;return s.liveScores.forEach(n=>{n.api_match_id&&e.set(n.api_match_id,n)}),e}}catch{}return new Map},[a?.id,u]),{liveScores:Ee}=Mt(u,Be.length>0?Be:void 0),U=g.useMemo(()=>{const t=new Map(Ke);return Ee.size>0&&Ee.forEach((s,e)=>{t.set(e,s)}),t},[Ke,Ee]);g.useEffect(()=>{if(!a?.id||!C.length||!U.size||!u)return;const t=`home:fixtures:${a.id}:${u}`;try{const s=D(t);if(s){const e=[];U.forEach(n=>{e.push(n)}),F(t,{...s,liveScores:e.length>0?e:void 0},B.HOME)}}catch{}},[a?.id,C,U,u]);const[qe,le]=g.useState(()=>{if(!u)return{};try{const t=D(`home:gwResults:${u}`);if(t){const s={};return t.forEach(e=>{(e.result==="H"||e.result==="D"||e.result==="A")&&(s[e.fixture_index]=e.result)}),s}}catch{}return{}});g.useEffect(()=>{if(!u||!C.length){le({});return}if(!C.some(r=>!r.api_match_id)){le({});return}const s=`home:gwResults:${u}`,e=D(s);if(e){const r={};e.forEach(h=>{(h.result==="H"||h.result==="D"||h.result==="A")&&(r[h.fixture_index]=h.result)}),le(r);const d=oe(s);if(!((d?Date.now()-d:1/0)>300*1e3))return}let n=!0;return(async()=>{try{const{data:r,error:d}=await S.from("app_gw_results").select("fixture_index, result").eq("gw",u);if(!n)return;if(!d&&r){const c={},x=[];r.forEach(h=>{(h.result==="H"||h.result==="D"||h.result==="A")&&(c[h.fixture_index]=h.result,x.push({fixture_index:h.fixture_index,result:h.result}))}),le(c),F(s,x,B.HOME)}}catch{}})(),()=>{n=!1}},[u,C]);const V=g.useMemo(()=>{const t={...Ue};if(C?.length&&U.size>0)for(const s of C)if(s.api_match_id){const e=U.get(s.api_match_id);e&&(t[s.fixture_index]={homeScore:e.home_score??0,awayScore:e.away_score??0,status:e.status||"SCHEDULED",minute:e.minute??null,goals:e.goals??null,red_cards:e.red_cards??null,home_team:e.home_team??null,away_team:e.away_team??null})}else{const e=qe[s.fixture_index];e&&(t[s.fixture_index]={homeScore:e==="H"?1:0,awayScore:e==="A"?1:0,status:"FINISHED",minute:null,goals:null,red_cards:null,home_team:null,away_team:null,result:e})}return t},[Ue,U,C,qe]);g.useEffect(()=>{if(!a?.id||G.hasCache)return;let t=!0;const s=`home:basic:${a.id}`;return(async()=>{try{const e=new Promise((A,j)=>{setTimeout(()=>j(new Error("Data fetch timed out")),15e3)}),n=Promise.all([S.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),S.from("app_meta").select("current_gw").eq("id",1).maybeSingle(),S.from("app_v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0}),S.from("app_v_ocp_overall").select("user_id, name, ocp")]),[r,d,c,x]=await Promise.race([n,e]);if(!t)return;const h=d.data?.current_gw??1,w=r.data?.gw??h;ce(h),ee(w);let _=[],v=null;c.error||(_=c.data??[],K(_.filter(A=>A.user_id===a.id)),v=Ae(a.id,w,_),v&&se(v));let f=[];x.error||(f=x.data??[]);const m=w>=5?Z(a.id,w-4,w,_,f):null,k=w>=10?Z(a.id,w-9,w,_,f):null,E=Ne(a.id,f);t&&(pe(m),_e(k),ye(E));try{F(s,{currentGw:h,latestGw:w,allGwPoints:_,overall:f,lastGwRank:v,fiveGwRank:m,tenGwRank:k,seasonRank:E},B.HOME)}catch{}We(!1)}catch(e){console.error("[Home] Error fetching data:",e),t&&We(!1)}})(),()=>{t=!1}},[a?.id,G.hasCache]),g.useEffect(()=>{if(!a?.id||!G.hasCache)return;let t=!0;const s=`home:basic:${a.id}`,e=oe(s);if((e?Date.now()-e:1/0)>300*1e3)return(async()=>{try{const[d,c,x,h]=await Promise.all([S.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),S.from("app_meta").select("current_gw").eq("id",1).maybeSingle(),S.from("app_v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0}),S.from("app_v_ocp_overall").select("user_id, name, ocp")]);if(!t)return;const w=c.data?.current_gw??1,_=d.data?.gw??w,v=x.data??[],f=h.data??[],m=Ae(a.id,_,v),k=_>=5?Z(a.id,_-4,_,v,f):null,E=_>=10?Z(a.id,_-9,_,v,f):null,A=Ne(a.id,f);ee(_),K(v.filter(j=>j.user_id===a.id)),se(m),pe(k),_e(E),ye(A);try{F(s,{currentGw:w,latestGw:_,allGwPoints:v,overall:f,lastGwRank:m,fiveGwRank:k,tenGwRank:E,seasonRank:A},B.HOME)}catch{}}catch{}})(),()=>{t=!1}},[a?.id,G.hasCache]),g.useEffect(()=>{if(!a?.id)return;const t=S.channel("app_meta_changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"app_meta",filter:"id=eq.1"},s=>{const e=s.new?.current_gw;if(e&&typeof e=="number"){const n=u;ce(e);const r=`home:basic:${a.id}`;H(r),n&&H(`home:fixtures:${a.id}:${n}`),H(`home:fixtures:${a.id}:${e}`),ke(d=>d+1)}}).subscribe();return()=>{S.removeChannel(t)}},[a?.id,u]),g.useEffect(()=>{if(!a?.id||!u){ae([]),re({});return}let t=!0;const s=`home:fixtures:${a.id}:${u}`;return(async()=>{try{const e=D(s);if(e?.fixtures?.length){const x=oe(s),w=(x?Date.now()-x:1/0)>120*1e3;if(ae(e.fixtures),re(e.userPicks||{}),!w)return;const[_,v]=await Promise.all([S.from("app_fixtures").select("id, gw, fixture_index, api_match_id, home_code, away_code, home_team, away_team, home_name, away_name, kickoff_time").eq("gw",u).order("fixture_index",{ascending:!0}),S.from("app_picks").select("fixture_index, pick").eq("gw",u).eq("user_id",a.id)]);if(!t)return;const f=_.error?[]:_.data??[],m={};v.error||(v.data??[]).forEach(k=>{m[k.fixture_index]=k.pick}),ae(f),re(m);try{const k=[];U.forEach(E=>{k.push(E)}),F(s,{fixtures:f,userPicks:m,liveScores:k.length>0?k:void 0},B.HOME)}catch{}return}const[n,r]=await Promise.all([S.from("app_fixtures").select("id, gw, fixture_index, api_match_id, home_code, away_code, home_team, away_team, home_name, away_name, kickoff_time").eq("gw",u).order("fixture_index",{ascending:!0}),S.from("app_picks").select("fixture_index, pick").eq("gw",u).eq("user_id",a.id)]);if(!t)return;const d=n.error?[]:n.data??[],c={};r.error||(r.data??[]).forEach(x=>{c[x.fixture_index]=x.pick}),ae(d),re(c);try{const x=[];U.forEach(h=>{x.push(h)}),F(s,{fixtures:d,userPicks:c,liveScores:x.length>0?x:void 0},B.HOME)}catch{}}catch{t&&(ae([]),re({}))}})(),()=>{t=!1}},[a?.id,u,U]),g.useEffect(()=>{if(!a?.id||!N.length||!u)return;let t=!0;const s=`home:leagueData:v2:${a.id}:${u}`,e=D(s);if(e?.leagueData&&Object.keys(e.leagueData).length>0&&Object.values(e.leagueData).every(r=>r.webUserIds!==void 0)){const r={};for(const[h,w]of Object.entries(e.leagueData))r[h]={...w,submittedMembers:w.submittedMembers?Array.isArray(w.submittedMembers)?new Set(w.submittedMembers):w.submittedMembers:void 0,latestGwWinners:w.latestGwWinners?Array.isArray(w.latestGwWinners)?new Set(w.latestGwWinners):w.latestGwWinners:void 0,webUserIds:w.webUserIds?Array.isArray(w.webUserIds)?new Set(w.webUserIds):w.webUserIds:void 0};He(r),Te(e.leagueSubmissions||{});const d=oe(s);if(!((d?Date.now()-d:1/0)>300*1e3))return}return(async()=>{try{const n=N.map(o=>o.id),[r,,d,c,,x,h]=await Promise.all([S.from("league_members").select("league_id, user_id, users!inner(id, name)").in("league_id",n),S.from("league_message_reads").select("league_id, last_read_at").eq("user_id",a.id).in("league_id",n),S.from("app_gw_submissions").select("user_id").eq("gw",u),S.from("app_gw_results").select("gw, fixture_index, result"),S.from("app_fixtures").select("gw, fixture_index, home_team, away_team, home_name, away_name, kickoff_time").in("gw",Array.from({length:Math.min(20,I||20)},(o,b)=>b+1)),S.from("picks").select("user_id, gw, created_at").limit(1e4),S.from("app_picks").select("user_id, gw, created_at").limit(1e4)]);if(!t)return;const w={};(r.data??[]).forEach(o=>{w[o.league_id]||(w[o.league_id]=[]),w[o.league_id].push({id:o.users.id,name:o.users.name})});const _=new Set(Object.values(w).flat().map(o=>o.id)),v=new Set((d.data??[]).map(o=>o.user_id).filter(o=>_.has(o))),f=new Map;(x.data||[]).forEach(o=>{if(!o.created_at)return;const b=`${o.user_id}:${o.gw}`,y=new Date(o.created_at),L=f.get(b);(!L||y<L)&&f.set(b,y)});const m=new Map;(h.data||[]).forEach(o=>{if(!o.created_at)return;const b=`${o.user_id}:${o.gw}`,y=new Date(o.created_at),L=m.get(b);(!L||y<L)&&m.set(b,y)});const k=new Set(Pt),E=new Set;f.forEach((o,b)=>{const[y,L]=b.split(":");if(parseInt(L,10)!==u)return;const ie=m.get(b);ie&&o.getTime()-ie.getTime()<-500&&_.has(y)&&!k.has(y)&&E.add(y)});const A=N.map(async o=>{const b=(w[o.id]??[]).map(L=>L.id);if(b.length===0)return{leagueId:o.id,picks:[]};const{data:y}=await S.from("app_picks").select("user_id, gw, fixture_index, pick").in("user_id",b);return{leagueId:o.id,picks:y??[]}}),j=await Promise.all(A),me=new Map;(c.data??[]).forEach(o=>{const b=Ut(o);b&&me.set(`${o.gw}:${o.fixture_index}`,b)});const J=[...new Set(Array.from(me.keys()).map(o=>parseInt(o.split(":")[0],10)))].sort((o,b)=>o-b);u&&!J.includes(u)&&(c.data??[]).filter(b=>b.gw===u).length>0&&(J.push(u),J.sort((b,y)=>b-y));const ze=new Map;j.forEach(({leagueId:o,picks:b})=>{ze.set(o,b)});const Ye=new Map,gt=N.map(async o=>{const b=await Dt(o,u);return{leagueId:o.id,leagueStartGw:b}});(await Promise.all(gt)).forEach(({leagueId:o,leagueStartGw:b})=>{Ye.set(o,b)});const ne={},Ce={};if(N.forEach(o=>{const b=w[o.id]??[],y=b.map(i=>i.id),L=y.filter(i=>v.has(i)).length,fe=y.length;if(Ce[o.id]={allSubmitted:L===fe&&fe>0,submittedCount:L,totalCount:fe},me.size===0){const i=b.sort((p,P)=>p.name.localeCompare(P.name));ne[o.id]={id:o.id,members:i,userPosition:null,positionChange:null,submittedMembers:Array.from(y.filter(p=>v.has(p))),sortedMemberIds:i.map(p=>p.id),latestGwWinners:[],latestRelevantGw:null,webUserIds:Array.from(y.filter(p=>E.has(p))),seasonLeaderName:i.length>0?i[0].name:null};return}const ie=Ye.get(o.id)??u,xt=J.includes(u),Re=ie===0?J:J.filter(i=>i>=ie),W=xt&&!Re.includes(u)?[...Re,u].sort((i,p)=>i-p):Re;if(W.length===0){const i=b.sort((p,P)=>p.name.localeCompare(P.name));ne[o.id]={id:o.id,members:i,userPosition:null,positionChange:null,submittedMembers:Array.from(y.filter(p=>v.has(p))),sortedMemberIds:i.map(p=>p.id),latestGwWinners:[],latestRelevantGw:null,webUserIds:Array.from(y.filter(p=>E.has(p))),seasonLeaderName:i.length>0?i[0].name:null};return}const pt=ze.get(o.id)??[],Je=new Set(W),_t=pt.filter(i=>Je.has(i.gw)),Me=new Map;W.forEach(i=>{Me.set(i,new Map)}),me.forEach((i,p)=>{const[P,z]=p.split(":"),X=parseInt(P,10),R=parseInt(z,10);Je.has(X)&&Me.get(X)?.set(R,i)});const Pe=new Map,Qe=new Map;W.forEach(i=>{const p=new Map;b.forEach(P=>p.set(P.id,{user_id:P.id,score:0,unicorns:0})),Pe.set(i,p)});const De=new Map;_t.forEach(i=>{const p=`${i.gw}:${i.fixture_index}`,P=De.get(p)??[];P.push(i),De.set(p,P)});const bt=new Set(b.map(i=>i.id));W.forEach(i=>{const p=Me.get(i),P=Pe.get(i);p.forEach((z,X)=>{const R=`${i}:${X}`,ge=(De.get(R)??[]).filter(O=>bt.has(O.user_id)),je=[];if(ge.forEach(O=>{if(O.pick===z){const st=P.get(O.user_id);st&&(st.score+=1,je.push(O.user_id))}}),je.length===1&&b.length>=3){const O=P.get(je[0]);O&&(O.unicorns+=1)}})});const Q=new Map,he=new Map,we=new Map;b.forEach(i=>{Q.set(i.id,0),he.set(i.id,0),we.set(i.id,0)}),W.forEach(i=>{const p=Array.from(Pe.get(i).values());if(p.forEach(R=>{he.set(R.user_id,(he.get(R.user_id)??0)+R.score),we.set(R.user_id,(we.get(R.user_id)??0)+R.unicorns)}),p.sort((R,ge)=>ge.score-R.score||ge.unicorns-R.unicorns),p.length===0)return;const P=p[0],z=p.filter(R=>R.score===P.score&&R.unicorns===P.unicorns),X=new Set(z.map(R=>R.user_id));Qe.set(i,X),z.length===1?Q.set(P.user_id,(Q.get(P.user_id)??0)+3):z.forEach(R=>{Q.set(R.user_id,(Q.get(R.user_id)??0)+1)})});const Xe=b.map(i=>({user_id:i.id,name:i.name,mltPts:Q.get(i.id)??0,unicorns:we.get(i.id)??0,ocp:he.get(i.id)??0})),Ze=[...Xe].sort((i,p)=>p.mltPts-i.mltPts||p.unicorns-i.unicorns||p.ocp-i.ocp||i.name.localeCompare(p.name)),yt=Ze.map(i=>i.user_id),et=Ze.findIndex(i=>i.user_id===a.id),St=et!==-1?et+1:null,tt=[...Xe].sort((i,p)=>p.ocp-i.ocp||i.name.localeCompare(p.name)),vt=tt.length>0?tt[0].name:null,Le=W.length?Math.max(...W):null,kt=Le!==null?Qe.get(Le)??new Set:new Set,Gt=b.sort((i,p)=>i.name.localeCompare(p.name)),Et=Array.from(y.filter(i=>E.has(i)));ne[o.id]={id:o.id,members:Gt,userPosition:St,positionChange:null,submittedMembers:Array.from(y.filter(i=>v.has(i))),sortedMemberIds:yt,latestGwWinners:Array.from(kt),latestRelevantGw:Le,webUserIds:Et,seasonLeaderName:vt}}),t){Te(Ce),He(ne);try{const o={};for(const[b,y]of Object.entries(ne))o[b]={...y,submittedMembers:y.submittedMembers?y.submittedMembers instanceof Set?Array.from(y.submittedMembers):y.submittedMembers:void 0,latestGwWinners:y.latestGwWinners?y.latestGwWinners instanceof Set?Array.from(y.latestGwWinners):y.latestGwWinners:void 0,webUserIds:y.webUserIds?y.webUserIds instanceof Set?Array.from(y.webUserIds):y.webUserIds:void 0};F(s,{leagueData:o,leagueSubmissions:Ce},B.HOME)}catch{}}}catch{}})(),()=>{t=!1}},[a?.id,N,u,ve,I]),g.useEffect(()=>{if(!a?.id)return;const t=S.channel("home-gw-results-changes").on("postgres_changes",{event:"*",schema:"public",table:"app_gw_results"},e=>{const n=`home:basic:${a.id}`;try{H(n),H(`home:fixtures:${a.id}:${u}`)}catch(r){console.error("[Home] Cache clear failed:",r)}ke(r=>r+1)}).subscribe(),s=async()=>{if(!document.hidden&&a?.id)try{const{data:e}=await S.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),n=e?.gw??null;if(n!==null&&n!==I){try{H(`home:basic:${a.id}`),H(`home:fixtures:${a.id}:${u}`)}catch(r){console.error("[Home] Cache clear failed on visibility change:",r)}ke(r=>r+1)}}catch(e){console.error("[Home] Error checking GW on visibility change:",e)}};return document.addEventListener("visibilitychange",s),window.addEventListener("focus",s),()=>{S.removeChannel(t),document.removeEventListener("visibilitychange",s),window.removeEventListener("focus",s)}},[a?.id,u,I]),g.useEffect(()=>{if(!a?.id||ve===0)return;let t=!0;return(async()=>{try{const[s,e]=await Promise.all([S.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),S.from("app_v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0})]);if(!t)return;const n=s.data?.gw??null,r=e.data??[];n!==null&&n!==I&&ee(n),K(r.filter(m=>m.user_id===a.id));const{getCached:d}=await Lt(async()=>{const{getCached:m}=await import("./index-DjTelcoh.js").then(k=>k.Q);return{getCached:m}},__vite__mapDeps([0,1])),c=`home:basic:${a.id}`,h=d(c)?.overall||[],w=Ae(a.id,n||I||1,r),_=(n||I||1)>=5?Z(a.id,(n||I||1)-4,n||I||1,r,h):null,v=(n||I||1)>=10?Z(a.id,(n||I||1)-9,n||I||1,r,h):null,f=Ne(a.id,h);se(w),pe(_),_e(v),ye(f)}catch(s){console.error("[Home] Error refetching data after results change:",s)}})(),()=>{t=!1}},[ve,a?.id,I]);const[ue,Ie]=g.useState(()=>{if(!a?.id)return new Set;try{const t=D(`home:userSubmissions:${a.id}`);return t?new Set(t):new Set}catch{return new Set}});g.useEffect(()=>{if(!a?.id){Ie(new Set);return}const t=D(`home:userSubmissions:${a.id}`);t&&Ie(new Set(t));let s=!0;const e=async()=>{const{data:r}=await S.from("app_gw_submissions").select("gw").eq("user_id",a.id).order("gw",{ascending:!1});if(s&&r){const d=r.map(c=>c.gw);Ie(new Set(d)),F(`home:userSubmissions:${a.id}`,d,B.HOME)}};if(!t)e();else{const r=oe(`home:userSubmissions:${a.id}`);(r?Date.now()-r:1/0)>300*1e3&&e()}const n=()=>{s&&e()};return window.addEventListener("predictionsSubmitted",n),()=>{s=!1,window.removeEventListener("predictionsSubmitted",n)}},[a?.id,u]);const de=g.useMemo(()=>!a?.id||!u?!1:ue.has(u),[a?.id,u,ue]),ft=g.useMemo(()=>{if(!C.length)return null;const t=Object.keys(Y).length>0;let s=0,e=0,n=0,r=!0,d=!1,c=!1;const x=new Date,h=$==="LIVE";for(const f of C){const m=V[f.fixture_index],k=Y[f.fixture_index],E=m?.status,A=E==="IN_PLAY"||E==="PAUSED"||E==="FINISHED";if(f.kickoff_time&&!m&&new Date(f.kickoff_time)>x&&(c=!0),A){if(d=!0,(E==="IN_PLAY"||E==="PAUSED")&&e++,E==="FINISHED"&&n++,E!=="FINISHED"&&(r=!1),k&&m){let j=!1;m.result?j=m.result===k:j=k==="H"&&m.homeScore>m.awayScore||k==="A"&&m.awayScore>m.homeScore||k==="D"&&m.homeScore===m.awayScore,j&&s++}}else r=!1}if(Ge||!d&&!t&&!c&&!h)return null;const w=({score:f,label:m,bgColor:k,icon:E})=>l.jsxs("div",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-white ${k}`,children:[E,l.jsx("span",{className:"text-xs sm:text-sm font-medium opacity-90",children:m}),l.jsxs("span",{className:"flex items-baseline gap-0.5",children:[l.jsx("span",{className:"text-lg sm:text-xl font-extrabold",children:f}),l.jsx("span",{className:"text-sm sm:text-base font-medium opacity-90",children:"/"}),l.jsx("span",{className:"text-base sm:text-lg font-semibold opacity-80",children:C.length})]})]}),_=()=>l.jsxs("div",{className:"inline-flex items-center gap-1 px-3 py-1.5 min-h-[40px] rounded-full bg-amber-500 text-white shadow-md shadow-amber-500/30 self-start",children:[l.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:l.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),l.jsx("span",{className:"text-xs sm:text-sm font-medium",children:"Starting soon"})]}),v=()=>l.jsxs("div",{className:"flex items-center gap-1",children:[l.jsx("img",{src:"/assets/Animation/Volley-Pointing.gif",alt:"Volley pointing",className:"w-[57px] h-[57px] object-contain -mt-4",style:{imageRendering:"pixelated"}}),l.jsxs(rt,{to:"/predictions",className:"flex-shrink-0 px-4 py-2 bg-[#1C8376] text-white rounded-[20px] font-medium flex items-center gap-1",children:["Go",l.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:l.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 7l5 5m0 0l-5 5m5-5H6"})})]})]});if(!d&&c&&!h)return de?l.jsx(_,{}):l.jsx(v,{});if(h&&!d){const f=t?s:"--";return l.jsx("div",{className:"flex flex-col items-center gap-2",children:l.jsx(w,{score:f,label:"Live",bgColor:"bg-red-600",icon:l.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"})})})}return!d&&t&&!h?l.jsx(w,{score:"--",label:"Score",bgColor:"bg-amber-500 shadow-lg shadow-amber-500/30"}):e===0&&n>0&&!r&&!h?l.jsx("div",{className:"flex flex-col items-center gap-2",children:l.jsx(w,{score:s,label:"Score",bgColor:"bg-slate-600",icon:l.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:l.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})})}):l.jsx("div",{className:"flex flex-col items-center gap-2",children:l.jsx(w,{score:s,label:h?"Live":"Score",bgColor:h?"bg-red-600":"bg-slate-600",icon:h&&e>0?l.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}):void 0})})},[Fe,C,V,Y,de,$,Ge]),ht=g.useMemo(()=>{if(!C.length)return!1;for(const t of C){const s=V[t.fixture_index];if(s&&(s.status==="IN_PLAY"||s.status==="PAUSED"))return!0}return!1},[C,V]);g.useMemo(()=>{if(!a?.id||!I)return null;const t=te.filter(c=>c.user_id===a.id).sort((c,x)=>x.gw-c.gw);let s=0,e=I;const n=new Set(t.map(c=>c.gw));for(;e>=1;){const c=n.has(e),x=ue.has(e);if(c||x)s++,e--;else break}const r=[],d=Math.max(1,I-9);for(let c=I;c>=d;c--){const x=t.find(h=>h.gw===c);r.push({gw:c,score:x?x.points:null})}return{streak:s,last10GwScores:r.reverse()}},[a?.id,te,I,ue]),g.useMemo(()=>{if(!u||$!=="LIVE"||!a?.id)return null;try{const t=`home:fixtures:${a.id}:${u}`,s=D(t);if(s?.liveScores?.length&&s?.userPicks&&s?.fixtures?.length){const e=new Map;if(s.liveScores.forEach(r=>{if(r.gw===u&&(r.status==="IN_PLAY"||r.status==="PAUSED"||r.status==="FINISHED")){const d=r.fixture_index;if(d!==void 0&&r.home_score!==null&&r.away_score!==null){let c;r.home_score>r.away_score?c="H":r.home_score<r.away_score?c="A":c="D",e.set(d,c)}}}),e.size===0)return null;let n=0;return Object.entries(s.userPicks).forEach(([r,d])=>{const c=parseInt(r,10),x=e.get(c);x&&d===x&&n++}),{score:n,totalFixtures:s.fixtures.length}}}catch{}return null},[u,$,a?.id]),g.useMemo(()=>{if(!M?.gw||!M||$!=="LIVE"||!a?.id)return null;try{const t=`home:fixtures:${a.id}:${M.gw}`,s=D(t);if(s?.liveScores?.length&&s?.userPicks){const e=new Map;if(s.liveScores.forEach(r=>{if(r.gw===M.gw&&(r.status==="IN_PLAY"||r.status==="PAUSED"||r.status==="FINISHED")){const d=r.fixture_index;if(d!==void 0&&r.home_score!==null&&r.away_score!==null){let c;r.home_score>r.away_score?c="H":r.home_score<r.away_score?c="A":c="D",e.set(d,c)}}}),e.size===0)return null;let n=0;return Object.entries(s.userPicks).forEach(([r,d])=>{const c=parseInt(r,10),x=e.get(c);x&&d===x&&n++}),{score:n,totalFixtures:M.totalFixtures}}}catch{}return null},[M?.gw,M,$,a?.id]);const Ve=g.useMemo(()=>C,[C]),wt=g.useMemo(()=>Ve.map(t=>{const s={id:t.id,gw:t.gw,fixture_index:t.fixture_index,home_code:t.home_code,away_code:t.away_code,home_team:t.home_team,away_team:t.away_team,home_name:t.home_name,away_name:t.away_name,kickoff_time:t.kickoff_time,api_match_id:t.api_match_id??null},e=V[t.fixture_index],n=e?{status:e.status,minute:e.minute??null,homeScore:e.homeScore,awayScore:e.awayScore,home_team:e.home_team??null,away_team:e.away_team??null,goals:e.goals??void 0,red_cards:e.red_cards??void 0}:null;return{fixture:s,liveScore:n,pick:Y[t.fixture_index]}}),[Ve,V,Y]);return mt?l.jsx("div",{className:"max-w-6xl lg:max-w-[1024px] mx-auto px-4 lg:px-6 pt-2 pb-4 min-h-screen flex items-center justify-center",children:l.jsxs("div",{className:"text-center",children:[l.jsx("img",{src:"/assets/Animation/Volley-Keepy-Uppies.gif",alt:"Loading...",className:"w-20 h-20 mx-auto mb-4"}),l.jsx("div",{className:"text-slate-500 text-sm",children:"Loading..."})]})}):l.jsxs("div",{className:"max-w-6xl lg:max-w-[1024px] mx-auto px-4 lg:px-6 pt-2 pb-4 min-h-screen relative",children:[l.jsx("div",{ref:Se,className:"relative mb-4 lg:hidden",children:l.jsx(jt,{})}),l.jsx("div",{className:"mt-6",children:l.jsx(At,{leagues:N,leagueData:nt,leagueSubmissions:it,unreadByLeague:ct,leagueDataLoading:!1,currentGw:u,currentUserId:a?.id,gameState:$,hideLiveTables:!0,hidePlayerChips:!0,showSeasonLeader:!0})}),l.jsx(Nt,{title:"Leaderboards",className:"mt-6",infoTitle:"Leaderboards",infoDescription:`The leaderboards are where all TOTL players are ranked. Your position is based on OCP (Overall Correct Predictions).

Joined late? No stress — after 5 and 10 weeks you'll show up in the Form leaderboards.

How To Play →`,children:l.jsxs("div",{className:"flex flex-row gap-2 sm:gap-3 lg:gap-4 justify-between items-start w-full mt-4",children:[l.jsx(xe,{to:"/global?tab=lastgw",rank:M?.rank??null,total:M?.total??null,label:"GW",bgColor:"bg-blue-500",gw:M?.gw??null}),l.jsx(xe,{to:"/global?tab=form5",rank:q?.rank??null,total:q?.total??null,label:"5 Form",bgColor:"bg-emerald-500"}),l.jsx(xe,{to:"/global?tab=form10",rank:$e?.rank??null,total:$e?.total??null,label:"10 Form",bgColor:"bg-teal-500"}),l.jsx(xe,{to:"/global?tab=overall",rank:be?.rank??null,total:be?.total??null,label:"Overall",bgColor:"bg-[#1C8376]"})]})}),l.jsx("div",{className:"mt-6",children:l.jsx($t,{isInApiTestLeague:Fe,fixtures:C,fixtureCards:wt,hasLiveGames:ht,showLiveOnly:!1,onToggleLiveOnly:()=>{},scoreComponent:ft,fixturesLoading:!1,hasCheckedCache:!0,currentGw:u,showPickButtons:de,userPicks:Y,liveScores:V,userName:a?.user_metadata?.display_name||a?.email||"User",globalRank:be?.rank,hasSubmitted:de})}),l.jsx("div",{className:"h-20"})]})}export{Wt as default};
