import{u as O,r as h,s as x,j as t}from"./index-Cop16kzC.js";const C=()=>{const p=typeof window<"u"?window.location.hostname:"",y=typeof window<"u"?window.location.origin:"";return p.includes("netlify.app")||p.includes("netlify.com")?`${y}/.netlify/functions/fetchFootballData`:p==="localhost"||p==="127.0.0.1"?"https://totl-staging.netlify.app/.netlify/functions/fetchFootballData":"/.netlify/functions/fetchFootballData"};function R(){const{user:p}=O(),y=p?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||p?.id==="36f31625-6d6c-4aa4-815a-1493a812841b",[r,G]=h.useState(null),[A,D]=h.useState([]),[u,b]=h.useState(new Map),[j,k]=h.useState(!1),[v,S]=h.useState(!1),[T,g]=h.useState(""),[$,E]=h.useState(""),[M,f]=h.useState(null),[P,W]=h.useState(!0);h.useEffect(()=>{if(!y)return;let a=!0;return(async()=>{try{const{data:e,error:d}=await x.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(d)throw d;if(a&&e){const l=(e.current_gw||13)+1;G(l);const{data:c}=await x.from("app_fixtures").select("*").eq("gw",l).order("fixture_index",{ascending:!0});if(c&&c.length>0){const m=new Map;c.forEach(n=>{m.set(n.fixture_index,{api_match_id:n.api_match_id||0,home_team:n.home_team||"",away_team:n.away_team||"",home_code:n.home_code||"",away_code:n.away_code||"",home_name:n.home_name||"",away_name:n.away_name||"",home_crest:n.home_crest||null,away_crest:n.away_crest||null,kickoff_time:n.kickoff_time||"",selected:!0})}),b(m)}}}catch(e){console.error("Error loading next GW:",e)}finally{a&&W(!1)}})(),()=>{a=!1}},[y]);const F=async a=>{try{console.log(`[ApiAdmin] Fetching team forms for GW ${a}...`);const e=C(),d=new URLSearchParams({resource:"standings",competition:"PL"}),o=`${e}?${d.toString()}`,l=await fetch(o);if(!l.ok){console.warn(`[ApiAdmin] Failed to fetch team forms: ${l.status}`);return}const c=await l.json();if(!c.success||!c.data){console.warn("[ApiAdmin] Invalid standings API response");return}const m=new Map,n=c.data?.standings||c.data;if(n&&Array.isArray(n)){const i=n.find(s=>s.type==="TOTAL")||n[0];i&&i.table&&Array.isArray(i.table)&&i.table.forEach(s=>{const _=(s.team?.tla||s.team?.shortName||"").toUpperCase().trim(),w=(s.form||"").trim().toUpperCase();_&&w&&m.set(_,w)})}if(m.size>0){const i=Array.from(m.entries()).map(([_,w])=>({gw:a,team_code:_,form:w})),{error:s}=await x.from("app_team_forms").upsert(i,{onConflict:"gw,team_code",ignoreDuplicates:!1});s?console.error("[ApiAdmin] Error storing team forms:",s):console.log(`[ApiAdmin] ✅ Successfully stored ${m.size} team forms for GW ${a}`)}else console.warn("[ApiAdmin] ⚠️ No team forms found in API response")}catch(e){console.error("[ApiAdmin] Error fetching team forms:",e)}},L=async a=>{if(!r)return f("Next GW not loaded yet."),null;try{const e=new Date,d=new Date(e);d.setDate(e.getDate()+7);const o=e.toISOString().split("T")[0],l=d.toISOString().split("T")[0],c=new URLSearchParams({competition:"PL",dateFrom:o,dateTo:l}),n=`${C()}?${c.toString()}`,i=await fetch(n,{signal:a});if(!i.ok){const N=await i.text();return i.status===429?(f("Rate limit reached. Please wait a moment."),null):(f(`Server error (${i.status}). ${N.substring(0,100)}`),null)}const s=await i.json();if(!s.success||!s.data)return f("Invalid API response format."),null;const w=(s.data.matches||[]).filter(N=>N.matchday===r);return f(null),w}catch(e){return e instanceof Error&&e.name==="AbortError"||(console.error("Error fetching matches:",e),f("Failed to fetch matches. Check your connection.")),null}},I=a=>{const e=new Map(u),d=Array.from(e.entries()).find(([o,l])=>l.api_match_id===a.id);if(d){const[o]=d;e.delete(o);const l=Array.from(e.entries()).sort(([m],[n])=>m-n),c=new Map;l.forEach(([m,n],i)=>{c.set(i,n)}),b(c)}else{const l=(e.size>0?Math.max(...Array.from(e.keys())):-1)+1,c={api_match_id:a.id,home_team:a.homeTeam.shortName,away_team:a.awayTeam.shortName,home_code:a.homeTeam.tla,away_code:a.awayTeam.tla,home_name:a.homeTeam.name,away_name:a.awayTeam.name,home_crest:a.homeTeam.crest||null,away_crest:a.awayTeam.crest||null,kickoff_time:a.utcDate,selected:!0};e.set(l,c),b(e)}},U=async()=>{if(!r){g("Next GW not loaded");return}if(u.size===0){g("Please select at least one fixture");return}const a=Array.from(u.values()).filter(e=>!e.api_match_id||e.api_match_id===0);if(a.length>0){g(`Cannot save: ${a.length} fixture${a.length===1?"":"s"} missing api_match_id. Please select fixtures from the API matches list.`);return}if(confirm(`Are you sure you want to save GW ${r} with ${u.size} fixture${u.size===1?"":"s"}? This will replace any existing fixtures for this gameweek.`)){k(!0),g(""),E("");try{const e=Array.from(u.entries()).map(([i,s])=>({gw:r,fixture_index:i,api_match_id:s.api_match_id,home_team:s.home_team,away_team:s.away_team,home_code:s.home_code,away_code:s.away_code,home_name:s.home_name,away_name:s.away_name,home_crest:s.home_crest||null,away_crest:s.away_crest||null,kickoff_time:s.kickoff_time}));console.log(`[ApiAdmin] Saving ${e.length} fixtures to app_fixtures for GW ${r}...`);const{data:d,error:o}=await x.from("app_fixtures").upsert(e,{onConflict:"gw,fixture_index",ignoreDuplicates:!1}).select();if(o)throw console.error("[ApiAdmin] ❌ Error upserting fixtures to app_fixtures:",o),console.error("[ApiAdmin] Error details:",JSON.stringify(o,null,2)),o;const l=d?.length||e.length;console.log(`[ApiAdmin] ✅ Successfully saved ${l} fixtures to app_fixtures for GW ${r}`);const{data:c,error:m}=await x.from("app_fixtures").select("fixture_index").eq("gw",r);m?console.warn("[ApiAdmin] ⚠️ Could not verify fixtures were saved:",m):(console.log(`[ApiAdmin] ✅ Verified: ${c?.length||0} fixtures exist in app_fixtures for GW ${r}`),(c?.length||0)!==l&&console.warn(`[ApiAdmin] ⚠️ Mismatch: Expected ${l} fixtures but found ${c?.length||0} in database`)),console.log(`[ApiAdmin] Updating app_meta.current_gw to ${r}...`);const{error:n}=await x.from("app_meta").upsert({id:1,current_gw:r},{onConflict:"id"});if(n)console.error("[ApiAdmin] ❌ Error updating app_meta:",n),g(`Fixtures saved but failed to update current_gw: ${n.message}`);else{console.log(`[ApiAdmin] ✅ Successfully updated app_meta.current_gw to ${r}`);const{data:i,error:s}=await x.from("app_meta").select("current_gw").eq("id",1).single();s?console.warn("[ApiAdmin] ⚠️ Could not verify app_meta update:",s):console.log(`[ApiAdmin] ✅ Verified: app_meta.current_gw = ${i?.current_gw}`)}await F(r);try{const i=await fetch("/.netlify/functions/sendPushAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:`GAMEWEEK ${r} - FIXTURES ARE OUT!`,message:"Make your predictions now!",data:{type:"fixtures_published",gw:r}})}),s=await i.json().catch(()=>({}));i.ok&&s.ok?console.log(`[ApiAdmin] Push notification sent to ${s.sentTo||0} users`):console.warn("[ApiAdmin] Push notification failed:",s)}catch(i){console.error("[ApiAdmin] Error sending push notification:",i)}E(`Gameweek ${r} saved with ${u.size} Premier League fixtures!`)}catch(e){g(e.message??"Failed to save gameweek.")}finally{k(!1)}}};return y?P?t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-slate-600",children:"Loading..."})}):t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900 mb-2",children:"API Admin - Premier League"}),t.jsxs("p",{className:"text-sm text-slate-600 mb-6",children:["Select Premier League fixtures for Gameweek ",r,". Check the feed for any cancelled or postponed games."]}),T&&t.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:T}),$&&t.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",children:$}),M&&t.jsxs("div",{className:"mb-4 p-4 bg-amber-50 border-2 border-amber-400 rounded-lg text-amber-800 text-sm font-medium shadow-md",children:["⚠️ ",M]}),t.jsx("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Next Gameweek"}),t.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:["GW ",r]})]}),u.size>0&&t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Selected Fixtures"}),t.jsx("div",{className:"text-2xl font-bold text-[#1C8376]",children:u.size})]})]})}),t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:["Premier League Matches for GW ",r," (Matchday ",r,")"]}),t.jsxs("p",{className:"text-sm text-slate-500 mb-4",children:["Loading matches from the API that are tagged with Matchday ",r," (corresponds to GW ",r,")."]}),t.jsx("button",{onClick:()=>{if(v||!r)return;S(!0),f(null);const a=new AbortController;L(a.signal).then(e=>{if(e&&e.length>0){D(e),f(null);const d=new Map;e.forEach((o,l)=>{d.set(l,{api_match_id:o.id,home_team:o.homeTeam.shortName,away_team:o.awayTeam.shortName,home_code:o.homeTeam.tla,away_code:o.awayTeam.tla,home_name:o.homeTeam.name,away_name:o.awayTeam.name,home_crest:o.homeTeam.crest||null,away_crest:o.awayTeam.crest||null,kickoff_time:o.utcDate,selected:!0})}),b(d)}else e&&e.length===0&&f(`No Premier League matches found for Matchday ${r} (GW ${r}) in the next week.`)}).catch(e=>{e instanceof Error&&e.name!=="AbortError"&&f("Failed to fetch matches. Please try again.")}).finally(()=>{S(!1)})},disabled:v||!r,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",type:"button",children:v?"Loading...":`Load GW ${r} Matches (Matchday ${r})`})]}),A.length>0&&t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800",children:["Available Matches (",A.length,") - All Selected by Default"]}),t.jsx("button",{onClick:U,disabled:j||u.size===0,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 font-semibold",children:j?"Saving...":`Save GW ${r} (${u.size} fixtures)`})]}),t.jsx("div",{className:"space-y-2",children:A.map(a=>{const e=Array.from(u.values()).some(s=>s.api_match_id===a.id),d=new Date(a.utcDate),o=new Date;o.setHours(0,0,0,0);const l=new Date(o);l.setDate(o.getDate()+1);const c=new Date(d);c.setHours(0,0,0,0);let m="";c.getTime()===o.getTime()?m="TODAY":c.getTime()===l.getTime()?m="TOMORROW":m=d.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"});const n=`${String(d.getUTCHours()).padStart(2,"0")}:${String(d.getUTCMinutes()).padStart(2,"0")} UTC`,i=`${m} ${n}`;return t.jsx("div",{className:`p-3 border-2 rounded-lg transition-colors ${e?"bg-[#1C8376]/10 border-[#1C8376]":"bg-slate-50 border-slate-200"}`,children:t.jsxs("label",{className:"flex items-center gap-4 cursor-pointer",children:[t.jsxs("div",{className:"relative flex-shrink-0",children:[t.jsx("input",{type:"checkbox",checked:e,onChange:()=>I(a),className:"w-6 h-6 cursor-pointer appearance-none border-2 rounded transition-all",style:{minWidth:"24px",minHeight:"24px",borderColor:e?"#1C8376":"#94a3b8",backgroundColor:e?"#1C8376":"white"}}),e&&t.jsx("svg",{className:"absolute top-0 left-0 w-6 h-6 pointer-events-none",fill:"none",stroke:"white",strokeWidth:"3",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})]}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"font-medium text-slate-800",children:[a.homeTeam.shortName," vs ",a.awayTeam.shortName]}),t.jsxs("div",{className:"text-xs text-slate-500",children:[i," • ",a.status," • Matchday ",a.matchday]})]})]})},a.id)})})]})]})}):t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-red-600",children:"Access denied. Admin only."})})}export{R as default};
