import{u as Je,r as h,g as Ke,s as o,a as $e,C as Ve,i as be,j as r}from"./index-Biua6bUl.js";import{M as He}from"./MiniLeagueCard-A31v0ALP.js";import{g as Se,L as ze}from"./leagueStart-Cqug3ruV.js";function Ze(a){return a.result==="H"||a.result==="D"||a.result==="A"?a.result:null}function at(){const{user:a}=Je(),[b,f]=h.useState([]),[S,w]=h.useState(!0),[ye,P]=h.useState(!0),[Me,re]=h.useState(!1),[H,ie]=h.useState(""),[B,ne]=h.useState(""),[oe,R]=h.useState(""),[ve,de]=h.useState({}),[Ce,le]=h.useState({}),[Le,ue]=h.useState({}),[je,z]=h.useState(null);h.useEffect(()=>{if(!a?.id){w(!1),P(!1);return}let l=!0;const y=`tables:${a.id}`;try{const d=Ke(y);if(d&&d.rows&&Array.isArray(d.rows)&&d.rows.length>0){if(f(d.rows),z(d.currentGw),de(d.leagueSubmissions||{}),ue(d.unreadByLeague||{}),d.leagueData){const M={};for(const[k,c]of Object.entries(d.leagueData))M[k]={...c,submittedMembers:c.submittedMembers?Array.isArray(c.submittedMembers)?new Set(c.submittedMembers):new Set:void 0,latestGwWinners:c.latestGwWinners?Array.isArray(c.latestGwWinners)?new Set(c.latestGwWinners):new Set:void 0};le(M)}w(!1),P(!1)}}catch{}return(async()=>{try{const[d,M,k]=await Promise.all([o.from("league_members").select("league_id").eq("user_id",a.id),o.from("app_fixtures").select("gw").order("gw",{ascending:!1}).limit(1),o.from("app_meta").select("current_gw").eq("id",1).maybeSingle()]);if(d.error)throw d.error;if(!l)return;const c=(d.data??[]).map(e=>e.league_id);if(!c.length){f([]),z(null),w(!1),P(!1);return}const ce=M.data??[],q=ce.length?Math.max(...ce.map(e=>e.gw)):1,A=k.data?.current_gw??q;z(q);const[Z,Q,Ge,Re,Ae,De,Ne]=await Promise.all([o.from("leagues").select("id,name,code,created_at,avatar").in("id",c).order("created_at",{ascending:!0}),o.from("league_members").select("league_id,user_id").in("league_id",c).limit(1e4),o.from("league_message_reads").select("league_id,last_read_at").eq("user_id",a.id),o.from("app_gw_results").select("gw,fixture_index,result"),o.from("app_fixtures").select("gw,kickoff_time").order("gw",{ascending:!0}).order("kickoff_time",{ascending:!0}),o.from("league_members").select("league_id,user_id, users(id, name)").in("league_id",c).limit(1e4),o.from("leagues").select("id,name,created_at").in("id",c)]);if(Z.error)throw Z.error;if(Q.error)throw Q.error;if(!l)return;const W=Z.data??[];for(const e of W)e.avatar||(e.avatar=Se(e.id),o.from("leagues").update({avatar:e.avatar}).eq("id",e.id));const D=new Map;(Q.data??[]).forEach(e=>{const t=D.get(e.league_id)??[];t.push(e.user_id),D.set(e.league_id,t)});const me=Array.from(new Set(Array.from(D.values()).flat())),N=W.find(e=>e.name==="API Test"),U=N?D.get(N.id)??[]:[],[ge,fe]=await Promise.all([me.length>0?o.from("app_gw_submissions").select("user_id").eq("gw",q).in("user_id",me).limit(1e4):Promise.resolve({data:[],error:null}),N&&U.length>0?o.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle():Promise.resolve({data:null,error:null})]),Ie=new Set((ge.data??[]).map(e=>e.user_id));let X=new Set;if(N&&U.length>0&&fe.data){const e=fe.data?.current_test_gw??1,[t,s,i]=await Promise.all([o.from("app_gw_submissions").select("user_id,submitted_at").eq("gw",e).in("user_id",U).not("submitted_at","is",null),o.from("app_picks").select("user_id,fixture_index").eq("gw",e).in("user_id",U),o.from("app_fixtures").select("fixture_index").eq("gw",e).order("fixture_index",{ascending:!0})]);if(i.data&&s.data&&t.data){const m=new Set(i.data.map(u=>u.fixture_index)),g=m.size;t.data.forEach(u=>{const p=(s.data??[]).filter(L=>L.user_id===u.user_id).filter(L=>m.has(L.fixture_index)),x=p.length===g&&g>0,C=new Set(p.map(L=>L.fixture_index)).size===g;x&&C&&X.add(u.user_id)})}}const Y={};for(const e of W){const t=D.get(e.id)??[],s=t.length,i=e.id===N?.id?t.reduce((m,g)=>m+(X.has(g)?1:0),0):t.reduce((m,g)=>m+(Ie.has(g)?1:0),0);Y[e.id]={allSubmitted:i===s&&s>0,submittedCount:i,totalCount:s}}de(Y);const T={};try{const e=new Map;if((Ge.data??[]).forEach(t=>e.set(t.league_id,t.last_read_at)),c.length>0){const t=new Map;c.forEach(u=>{t.set(u,e.get(u)??"1970-01-01T00:00:00Z")});const s=Math.min(...Array.from(t.values()).map(u=>new Date(u).getTime())),i=new Date(s).toISOString(),{data:m}=await o.from("league_messages").select("id,league_id,created_at").in("league_id",c).gte("created_at",i),g=new Map;(m??[]).forEach(u=>{const _=g.get(u.league_id)??[];_.push(u),g.set(u.league_id,_)}),c.forEach(u=>{const _=t.get(u),p=new Date(_).getTime(),G=(g.get(u)??[]).filter(C=>new Date(C.created_at).getTime()>p).length;T[u]=G})}}catch{}ue(T);const E=W.map(e=>{const t=D.get(e.id)??[];return{id:e.id,name:e.name,code:e.code,memberCount:t.length,avatar:e.avatar,created_at:e.created_at,start_gw:e.start_gw}});if(E.sort((e,t)=>{const s=T[e.id]??0,i=T[t.id]??0;return s>0&&i===0?-1:s===0&&i>0?1:0}),!l)return;const Pe=Re.data??[],ee=new Map;for(const e of Pe){const t=Ze(e);t&&ee.set(`${e.gw}:${e.fixture_index}`,t)}const Te=Ae.data??[],O=new Map;Te.forEach(e=>{const t=O.get(e.gw)??[];t.push(e.kickoff_time),O.set(e.gw,t)});const F=[...new Set(Array.from(ee.keys()).map(e=>parseInt(e.split(":")[0],10)))].sort((e,t)=>e-t),J=new Map;(De.data??[]).forEach(e=>{if(!e.users?.name)return;const t=J.get(e.league_id)??[];t.push({id:e.user_id,name:e.users.name}),J.set(e.league_id,t)});const Fe=Ne.data??[],we=new Map;Fe.forEach(e=>{we.set(e.id,e)});const K=new Map;for(const e of E){const t=we.get(e.id),s={id:e.id,name:t?.name??e.name,created_at:(t?.created_at??e.created_at)||null,start_gw:t?.start_gw??e.start_gw};let i=A;const m=s.name?ze[s.name]:void 0;if(typeof m=="number")i=m;else if(s.start_gw!==null&&s.start_gw!==void 0)i=s.start_gw;else if(s.created_at&&F.length>0){const g=new Date(s.created_at),u=75;for(const _ of F){const p=O.get(_);if(p&&p.length>0){const x=new Date(p[0]),G=new Date(x.getTime()-u*60*1e3);if(g<=G){i=_;break}}}i===A&&F.length>0&&(i=Math.max(...F)+1)}K.set(e.id,i)}const te=new Set;E.forEach(e=>{const t=K.get(e.id)??A;F.filter(s=>s>=t).forEach(s=>te.add(s))});const Be=E.map(e=>{const t=J.get(e.id)??[];if(t.length===0)return Promise.resolve({data:[],error:null});const s=K.get(e.id)??A,i=Array.from(te).filter(m=>m>=s);return i.length===0?Promise.resolve({data:[],error:null}):o.from("app_picks").select("user_id,gw,fixture_index,pick").in("user_id",t.map(m=>m.id)).in("gw",i).limit(1e4)}),qe=await Promise.all(Be);if(!l)return;const We=new Set((ge.data??[]).map(e=>e.user_id)),se={};for(let e=0;e<E.length;e++){const t=E[e],s=qe[e],i=J.get(t.id)??[];if(i.length===0)continue;const m=K.get(t.id)??A,g=Array.from(te).filter(n=>n>=m),u=s.data??[],_=new Map;u.forEach(n=>{_.has(n.user_id)||_.set(n.user_id,new Map);const v=_.get(n.user_id);v.has(n.gw)||v.set(n.gw,new Map),v.get(n.gw).set(n.fixture_index,n.pick)});const p=new Map,x=new Map;g.forEach(n=>{const I=(O.get(n)??[]).length;I!==0&&i.forEach(j=>{const _e=_.get(j.id)?.get(n);if(!_e)return;let ae=0;for(let V=0;V<I;V++){const pe=_e.get(V),xe=ee.get(`${n}:${V}`);pe&&xe&&pe===xe&&ae++}x.has(j.id)||x.set(j.id,new Map),x.get(j.id).set(n,ae);const Oe=p.get(j.id)??0;p.set(j.id,Oe+ae)})});const G=[...i].sort((n,v)=>{const I=p.get(n.id)??0,j=p.get(v.id)??0;return j!==I?j-I:n.name.localeCompare(v.name)}),C=G.findIndex(n=>n.id===a.id)+1,L=C>1?C-1:null,Ue=L===null?null:C<L?"up":C>L?"down":"same",$=g.length>0?Math.max(...g):A,he=[];if($&&x.has(a.id)){const n=x.get(a.id).get($)??0;G.forEach(v=>{(x.get(v.id)?.get($)??0)===n&&n>0&&he.push(v.id)})}se[t.id]={id:t.id,members:i,userPosition:C||null,positionChange:Ue,submittedMembers:t.id===N?.id?X:We,sortedMemberIds:G.map(n=>n.id),latestGwWinners:he,latestRelevantGw:$}}if(l){f(E),le(se),w(!1),P(!1);try{const e={};for(const[t,s]of Object.entries(se))e[t]={...s,submittedMembers:s.submittedMembers?s.submittedMembers instanceof Set?Array.from(s.submittedMembers):s.submittedMembers:void 0,latestGwWinners:s.latestGwWinners?s.latestGwWinners instanceof Set?Array.from(s.latestGwWinners):s.latestGwWinners:void 0};$e(y,{rows:E,currentGw:q,leagueSubmissions:Y,unreadByLeague:T,leagueData:e},Ve.TABLES)}catch{}}}catch(d){l&&(R(d?.message??"Failed to load leagues."),w(!1),P(!1))}})(),()=>{l=!1}},[a?.id]);const ke=h.useCallback(async()=>{if(!(!B.trim()||!a?.id)){re(!0),R("");try{const l=B.trim(),y=await Ye(),{data:d,error:M}=await o.from("leagues").insert({name:l,code:y}).select("id,code").single();if(M)throw M;const k=Se(d.id);await o.from("leagues").update({avatar:k}).eq("id",d.id),await o.from("league_members").insert({league_id:d.id,user_id:a.id}),ne(""),a?.id&&be(a.id),f([]),w(!0)}catch(l){R(l?.message??"Failed to create league.")}finally{re(!1)}}},[B,a?.id]),Ee=h.useCallback(async()=>{const l=H.trim().toUpperCase();if(!(!l||!a?.id)){R("");try{const{data:y,error:d}=await o.from("leagues").select("id").eq("code",l).maybeSingle();if(d)throw d;if(!y){R("League code not found.");return}const{data:M,error:k}=await o.from("league_members").select("user_id").eq("league_id",y.id);if(k)throw k;if(M&&M.length>=8){R("League is full (max 8 members).");return}await o.from("league_members").upsert({league_id:y.id,user_id:a.id},{onConflict:"league_id,user_id"}),ie(""),a?.id&&be(a.id),f([]),w(!0)}catch(y){R(y?.message??"Failed to join league.")}}},[H,a?.id]);return r.jsx("div",{className:"min-h-screen bg-slate-50",children:r.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-4 pb-16",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900",children:"Mini Leagues"}),b.length>4&&r.jsxs("button",{onClick:()=>{const l=document.getElementById("create-join-section");l&&l.scrollIntoView({behavior:"smooth",block:"start"})},className:"text-[#1C8376] font-semibold text-sm hover:text-[#1C8376] no-underline flex items-center gap-1",children:["Create League",r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})]}),r.jsx("p",{className:"mt-2 mb-6 text-sm text-slate-600 w-full",children:"Create or join a private league and battle it out with your friends. - COMPONENTS VERSION"}),oe&&r.jsx("div",{className:"mt-4 rounded border border-rose-200 bg-rose-50 text-rose-700 px-3 py-2 text-sm",children:oe}),S||ye?r.jsx("div",{className:"mt-6 flex items-center justify-center py-12",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#1C8376]"})}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mt-6",children:b.length===0?r.jsx("div",{className:"px-4 py-4 text-sm",children:"No leagues yet."}):r.jsx("div",{className:"space-y-3",children:b.map(l=>r.jsx(He,{row:l,data:Ce[l.id],unread:Le?.[l.id]??0,submissions:ve[l.id],leagueDataLoading:!1,currentGw:je},l.id))})}),r.jsx("div",{id:"create-join-section",className:"mt-10 mb-3 text-xl font-extrabold text-slate-900",children:"Create or Join"}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[r.jsx(Qe,{leagueName:B,setLeagueName:ne,creating:Me,onCreate:ke}),r.jsx(Xe,{joinCode:H,setJoinCode:ie,onJoin:Ee})]})]})]})})}function Qe({leagueName:a,setLeagueName:b,creating:f,onCreate:S}){return r.jsxs("div",{className:"border rounded-2xl p-4 bg-white",children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Create a league"}),r.jsx("input",{className:"border rounded px-3 py-2 w-full bg-white",placeholder:"League name",value:a,onChange:w=>b(w.target.value),onKeyDown:w=>{w.key==="Enter"&&!f&&a.trim()&&S()}}),r.jsx("button",{className:"mt-3 px-3 py-2 rounded bg-slate-900 text-white disabled:opacity-50",onClick:S,disabled:f||!a.trim(),children:f?"Creatingâ€¦":"Create"})]})}function Xe({joinCode:a,setJoinCode:b,onJoin:f}){return r.jsxs("div",{className:"border rounded-2xl p-4 bg-white",children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Join with code"}),r.jsx("input",{className:"border rounded px-3 py-2 w-full uppercase tracking-widest bg-white",placeholder:"ABCDE",value:a,onChange:S=>b(S.target.value),onKeyDown:S=>{S.key==="Enter"&&a.trim()&&f()}}),r.jsx("button",{className:"mt-3 px-3 py-2 rounded border",onClick:f,children:"Join"})]})}async function Ye(){const a="ABCDEFGHJKLMPQRSTVWXYZ23456789";for(let b=0;b<6;b++){let f="";for(let w=0;w<5;w++)f+=a[Math.floor(Math.random()*a.length)];const{data:S}=await o.from("leagues").select("id").eq("code",f).maybeSingle();if(!S)return f}return Math.random().toString(36).slice(2,7).toUpperCase()}export{at as default};
