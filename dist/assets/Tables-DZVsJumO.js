import{u as Ae,r as b,s as o,j as r}from"./index-CTKCpAmM.js";import{M as qe}from"./MiniLeagueCard-BwFB9Lei.js";import{g as be,L as De}from"./leagueStart-BeI_tn-G.js";function Fe(n){return n.result==="H"||n.result==="D"||n.result==="A"?n.result:null}function Qe(){const{user:n}=Ae(),[w,_]=b.useState([]),[k,M]=b.useState(!0),[ve,$]=b.useState(!0),[Se,ce]=b.useState(!1),[re,ue]=b.useState(""),[Q,me]=b.useState(""),[ge,B]=b.useState(""),[Me,ye]=b.useState({}),[Ce,Ie]=b.useState({}),[je,ke]=b.useState({}),[ie,fe]=b.useState(null);b.useEffect(()=>{if(!n?.id){M(!1);return}let l=!0;return(async()=>{try{const[h,E]=await Promise.all([o.from("league_members").select("league_id").eq("user_id",n.id),o.from("fixtures").select("gw").order("gw",{ascending:!1}).limit(1)]);if(h.error)throw h.error;if(!l)return;const v=(h.data??[]).map(a=>a.league_id);if(!v.length){_([]),fe(null),M(!1);return}const P=E.data??[],X=P.length?Math.max(...P.map(a=>a.gw)):1;fe(X);const{data:U,error:N}=await o.from("leagues").select("id,name,code,created_at,avatar").in("id",v).order("created_at",{ascending:!0});if(N)throw N;if(!l)return;const L=U??[];for(const a of L)a.avatar||(a.avatar=be(a.id),o.from("leagues").update({avatar:a.avatar}).eq("id",a.id));const[y,ne]=await Promise.all([o.from("league_members").select("league_id,user_id").in("league_id",L.map(a=>a.id)),o.from("league_message_reads").select("league_id,last_read_at").eq("user_id",n.id)]);if(y.error)throw y.error;if(!l)return;const q=new Map;(y.data??[]).forEach(a=>{const f=q.get(a.league_id)??[];f.push(a.user_id),q.set(a.league_id,f)});const Y={},D=Array.from(new Set(Array.from(q.values()).flat())),F=L.find(a=>a.name==="API Test"),G=F?q.get(F.id)??[]:[],ee=F?D.filter(a=>!G.includes(a)):D,[H,W]=await Promise.all([ee.length>0?o.from("gw_submissions").select("user_id").eq("gw",X).in("user_id",ee):Promise.resolve({data:[],error:null}),F&&G.length>0?o.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle():Promise.resolve({data:null,error:null})]),te=new Set((H.data??[]).map(a=>a.user_id));let O=new Set;if(F&&G.length>0&&W.data){const a=W.data?.current_test_gw??1,[f,g,e]=await Promise.all([o.from("test_api_submissions").select("user_id,submitted_at").eq("matchday",a).in("user_id",G).not("submitted_at","is",null),o.from("test_api_picks").select("user_id,fixture_index").eq("matchday",a).in("user_id",G),o.from("test_api_fixtures").select("fixture_index").eq("test_gw",a).order("fixture_index",{ascending:!0})]);if(e.data&&g.data&&f.data){const s=new Set(e.data.map(c=>c.fixture_index)),m=s.size;f.data.forEach(c=>{const T=(g.data??[]).filter(I=>I.user_id===c.user_id).filter(I=>s.has(I.fixture_index)),R=T.length===m&&m>0,C=new Set(T.map(I=>I.fixture_index)).size===m;R&&C&&O.add(c.user_id)})}}for(const a of L){const f=q.get(a.id)??[],g=f.length,e=a.id===F?.id?f.filter(s=>O.has(s)).length:f.filter(s=>te.has(s)).length;Y[a.id]={allSubmitted:e===g&&g>0,submittedCount:e,totalCount:g}}ye(Y);const z={};try{const a=new Map;(ne.data??[]).forEach(g=>a.set(g.league_id,g.last_read_at));const f=L.map(g=>g.id);if(f.length>0){const g=new Map;f.forEach(c=>{g.set(c,a.get(c)??"1970-01-01T00:00:00Z")});const e=Math.min(...Array.from(g.values()).map(c=>new Date(c).getTime())),s=new Date(e).toISOString(),{data:m}=await o.from("league_messages").select("id,league_id,created_at").in("league_id",f).gte("created_at",s);f.forEach(c=>{const x=g.get(c),T=(m??[]).filter(R=>R.league_id===c&&new Date(R.created_at)>new Date(x)).length;z[c]=T})}}catch{}ke(z);const se=L.map(a=>{const f=q.get(a.id)??[];return{id:a.id,name:a.name,code:a.code,memberCount:f.length,avatar:a.avatar,created_at:a.created_at,start_gw:a.start_gw}});se.sort((a,f)=>{const g=z[a.id]??0,e=z[f.id]??0;return g>0&&e===0?-1:g===0&&e>0?1:0}),l&&(_(se),M(!1))}catch(h){l&&(B(h?.message??"Failed to load leagues."),M(!1))}})(),()=>{l=!1}},[n?.id]),b.useEffect(()=>{if(!w.length||!n?.id||!ie){$(!1);return}$(!0);let l=!0;return(async()=>{try{const[h,E]=await Promise.all([o.from("meta").select("current_gw").eq("id",1).maybeSingle(),o.from("gw_results").select("gw,fixture_index,result")]),v=h.data?.current_gw??1;if(!l)return;const{data:P}=E,X=P??[],U=new Map;for(const e of X){const s=Fe(e);s&&U.set(`${e.gw}:${e.fixture_index}`,s)}const N={},L=w.map(e=>e.id),y=[...new Set(Array.from(U.keys()).map(e=>parseInt(e.split(":")[0],10)))].sort((e,s)=>e-s),[ne,q,Y]=await Promise.all([o.from("league_members").select("league_id,user_id, users(id, name)").in("league_id",L).limit(1e4),o.from("leagues").select("id,name,created_at").in("id",L),y.length>0?o.from("fixtures").select("gw,kickoff_time").in("gw",y).order("gw",{ascending:!0}).order("kickoff_time",{ascending:!0}):Promise.resolve({data:[],error:null})]),D=new Map;(ne.data??[]).forEach(e=>{if(!e.users?.name)return;const s=D.get(e.league_id)??[];s.push({id:e.user_id,name:e.users.name}),D.set(e.league_id,s)});const F=q.data??[],G=new Map;F.forEach(e=>{G.set(e.id,e)});const ee=Y.data??[],H=new Map;ee.forEach(e=>{const s=H.get(e.gw)??[];s.push(e.kickoff_time),H.set(e.gw,s)});const W=new Map;for(const e of w){const s=G.get(e.id),m={id:e.id,name:s?.name??e.name,created_at:(s?.created_at??e.created_at)||null,start_gw:s?.start_gw??e.start_gw};let c=v;const x=m.name?De[m.name]:void 0;if(typeof x=="number")c=x;else if(m.start_gw!==null&&m.start_gw!==void 0)c=m.start_gw;else if(m.created_at&&y.length>0){const T=new Date(m.created_at),R=75;for(const J of y){const C=H.get(J);if(C&&C.length>0){const I=new Date(C[0]),K=new Date(I.getTime()-R*60*1e3);if(T<=K){c=J;break}}}c===v&&y.length>0&&(c=Math.max(...y)+1)}W.set(e.id,c)}const te=Array.from(new Set(Array.from(D.values()).flat().map(e=>e.id))),O=new Set;w.forEach(e=>{const s=W.get(e.id)??v;y.filter(m=>m>=s).forEach(m=>O.add(m))});const z=te.length>0?await o.from("gw_submissions").select("user_id").eq("gw",v).in("user_id",te).limit(1e4):{data:[],error:null},se=new Set((z.data??[]).map(e=>e.user_id)),a=w.map(async e=>{const m=(D.get(e.id)??[]).map(x=>x.id);if(m.length===0||O.size===0)return{leagueId:e.id,picks:[]};const{data:c}=await o.from("picks").select("user_id,gw,fixture_index,pick").in("user_id",m).in("gw",Array.from(O));return{leagueId:e.id,picks:c??[]}}),f=await Promise.all(a),g=new Map;f.forEach(({leagueId:e,picks:s})=>{g.set(e,s)});for(const e of w)try{const s=(D.get(e.id)??[]).filter(t=>t.name!=="Unknown"),m=G.get(e.id);if(e.name==="API Test"||m?.name==="API Test"){const t=s.sort((p,A)=>p.name.localeCompare(A.name)).map(p=>p.id),i=new Set,{data:d}=await o.from("test_api_meta").select("current_test_gw").eq("id",1).maybeSingle(),j=d?.current_test_gw??1,u=s.map(p=>p.id);if(u.length>0){const[p,A,S]=await Promise.all([o.from("test_api_submissions").select("user_id,submitted_at").eq("matchday",j).in("user_id",u).not("submitted_at","is",null),o.from("test_api_picks").select("user_id,fixture_index").eq("matchday",j).in("user_id",u),o.from("test_api_fixtures").select("fixture_index").eq("test_gw",j).order("fixture_index",{ascending:!0})]);if(S.data&&A.data&&p.data){const V=new Set(S.data.map(ae=>ae.fixture_index)),de=V.size;p.data.forEach(ae=>{const xe=(A.data??[]).filter(Z=>Z.user_id===ae.user_id).filter(Z=>V.has(Z.fixture_index)),Le=xe.length===de&&de>0,Ge=new Set(xe.map(Z=>Z.fixture_index)).size===de;Le&&Ge&&i.add(ae.user_id)})}}N[e.id]={id:e.id,members:s.sort((p,A)=>p.name.localeCompare(A.name)),userPosition:t.indexOf(n.id)+1||null,positionChange:null,sortedMemberIds:t,latestGwWinners:new Set,latestRelevantGw:null,submittedMembers:i};continue}if(s.length===0){N[e.id]={id:e.id,members:[],userPosition:null,positionChange:null,sortedMemberIds:[],latestGwWinners:new Set};continue}if(U.size===0){const t=s.sort((i,d)=>i.name.localeCompare(d.name)).map(i=>i.id);N[e.id]={id:e.id,members:s.sort((i,d)=>i.name.localeCompare(d.name)),userPosition:null,positionChange:null,sortedMemberIds:t,latestGwWinners:new Set};continue}const c=W.get(e.id)??v,x=y.filter(t=>t>=c);if(x.length===0){const t=s.sort((i,d)=>i.name.localeCompare(d.name)).map(i=>i.id);N[e.id]={id:e.id,members:s.sort((i,d)=>i.name.localeCompare(d.name)),userPosition:null,positionChange:null,sortedMemberIds:t,latestGwWinners:new Set};continue}const T=(g.get(e.id)??[]).filter(t=>x.includes(t.gw)),R=new Map,J=new Map;x.forEach(t=>{const i=new Map;s.forEach(d=>i.set(d.id,{user_id:d.id,score:0,unicorns:0})),R.set(t,i)}),x.forEach(t=>{Array.from(U.entries()).filter(([d])=>parseInt(d.split(":")[0],10)===t).map(([d,j])=>({idx:parseInt(d.split(":")[1],10),out:j})).forEach(({idx:d,out:j})=>{const u=T.filter(S=>S.gw===t&&S.fixture_index===d),p=u.filter(S=>S.pick===j).map(S=>S.user_id),A=R.get(t);if(u.forEach(S=>{if(S.pick===j){const V=A.get(S.user_id);V.score+=1}}),p.length===1&&s.length>=3){const S=p[0],V=A.get(S);V.unicorns+=1}})});const C=new Map,I=new Map,K=new Map;s.forEach(t=>{C.set(t.id,0),I.set(t.id,0),K.set(t.id,0)}),x.forEach(t=>{const i=Array.from(R.get(t).values());if(i.forEach(u=>{I.set(u.user_id,(I.get(u.user_id)??0)+u.score),K.set(u.user_id,(K.get(u.user_id)??0)+u.unicorns)}),i.sort((u,p)=>p.score-u.score||p.unicorns-u.unicorns),!i.length)return;const d=i[0],j=i.filter(u=>u.score===d.score&&u.unicorns===d.unicorns);J.set(t,new Set(j.map(u=>u.user_id))),j.length===1?C.set(d.user_id,(C.get(d.user_id)??0)+3):j.forEach(u=>{C.set(u.user_id,(C.get(u.user_id)??0)+1)})});const we=[...s.map(t=>({user_id:t.id,name:t.name,mltPts:C.get(t.id)??0,unicorns:K.get(t.id)??0,ocp:I.get(t.id)??0}))].sort((t,i)=>i.mltPts-t.mltPts||i.unicorns-t.unicorns||i.ocp-t.ocp||t.name.localeCompare(i.name)),oe=we.map(t=>t.user_id),he=we.findIndex(t=>t.user_id===n.id),Re=he!==-1?he+1:null,le=x.length?Math.max(...x):null,Pe=le!==null?J.get(le)??new Set:new Set,pe=new Set;s.map(t=>t.id).forEach(t=>{se.has(t)&&pe.add(t)});const _e=s.map(t=>t.id).filter(t=>!oe.includes(t));if(_e.length>0){const t=s.filter(i=>_e.includes(i.id)).sort((i,d)=>i.name.localeCompare(d.name)).map(i=>i.id);oe.push(...t)}N[e.id]={id:e.id,members:s.sort((t,i)=>t.name.localeCompare(i.name)),userPosition:Re,positionChange:null,submittedMembers:pe,sortedMemberIds:oe,latestGwWinners:Pe,latestRelevantGw:le}}catch{N[e.id]={id:e.id,members:[],userPosition:null,positionChange:null,sortedMemberIds:[],latestGwWinners:new Set,latestRelevantGw:null}}l&&(Ie(N),$(!1))}catch{l&&$(!1)}})(),()=>{l=!1}},[w,n?.id,ie]);const Ee=b.useCallback(async()=>{if(!(!Q.trim()||!n?.id)){ce(!0),B("");try{const l=Q.trim(),h=await We(),{data:E,error:v}=await o.from("leagues").insert({name:l,code:h}).select("id,code").single();if(v)throw v;const P=be(E.id);await o.from("leagues").update({avatar:P}).eq("id",E.id),await o.from("league_members").insert({league_id:E.id,user_id:n.id}),me(""),_([]),M(!0)}catch(l){B(l?.message??"Failed to create league.")}finally{ce(!1)}}},[Q,n?.id]),Ne=b.useCallback(async()=>{const l=re.trim().toUpperCase();if(!(!l||!n?.id)){B("");try{const{data:h,error:E}=await o.from("leagues").select("id").eq("code",l).maybeSingle();if(E)throw E;if(!h){B("League code not found.");return}const{data:v,error:P}=await o.from("league_members").select("user_id").eq("league_id",h.id);if(P)throw P;if(v&&v.length>=8){B("League is full (max 8 members).");return}await o.from("league_members").upsert({league_id:h.id,user_id:n.id},{onConflict:"league_id,user_id"}),ue(""),_([]),M(!0)}catch(h){B(h?.message??"Failed to join league.")}}},[re,n?.id]);return r.jsx("div",{className:"min-h-screen bg-slate-50",children:r.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-4 pb-16",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900",children:"Mini Leagues"}),w.length>4&&r.jsxs("button",{onClick:()=>{const l=document.getElementById("create-join-section");l&&l.scrollIntoView({behavior:"smooth",block:"start"})},className:"text-[#1C8376] font-semibold text-sm hover:text-[#1C8376] no-underline flex items-center gap-1",children:["Create League",r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})]}),r.jsx("p",{className:"mt-2 mb-6 text-sm text-slate-600 w-full",children:"Create or join a private league and battle it out with your friends. - COMPONENTS VERSION"}),ge&&r.jsx("div",{className:"mt-4 rounded border border-rose-200 bg-rose-50 text-rose-700 px-3 py-2 text-sm",children:ge}),r.jsx("div",{className:"mt-6",children:k||ve?r.jsx(Ue,{}):w.length===0?r.jsx("div",{className:"px-4 py-4 text-sm",children:"No leagues yet."}):r.jsx("div",{className:"space-y-3",children:w.map(l=>r.jsx(qe,{row:l,data:Ce[l.id],unread:je?.[l.id]??0,submissions:Me[l.id],leagueDataLoading:!1,currentGw:ie},l.id))})}),r.jsx("div",{id:"create-join-section",className:"mt-10 mb-3 text-xl font-extrabold text-slate-900",children:"Create or Join"}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[r.jsx(Te,{leagueName:Q,setLeagueName:me,creating:Se,onCreate:Ee}),r.jsx(Be,{joinCode:re,setJoinCode:ue,onJoin:Ne})]})]})})}function Te({leagueName:n,setLeagueName:w,creating:_,onCreate:k}){return r.jsxs("div",{className:"border rounded-2xl p-4 bg-white",children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Create a league"}),r.jsx("input",{className:"border rounded px-3 py-2 w-full bg-white",placeholder:"League name",value:n,onChange:M=>w(M.target.value),onKeyDown:M=>{M.key==="Enter"&&!_&&n.trim()&&k()}}),r.jsx("button",{className:"mt-3 px-3 py-2 rounded bg-slate-900 text-white disabled:opacity-50",onClick:k,disabled:_||!n.trim(),children:_?"Creatingâ€¦":"Create"})]})}function Be({joinCode:n,setJoinCode:w,onJoin:_}){return r.jsxs("div",{className:"border rounded-2xl p-4 bg-white",children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Join with code"}),r.jsx("input",{className:"border rounded px-3 py-2 w-full uppercase tracking-widest bg-white",placeholder:"ABCDE",value:n,onChange:k=>w(k.target.value),onKeyDown:k=>{k.key==="Enter"&&n.trim()&&_()}}),r.jsx("button",{className:"mt-3 px-3 py-2 rounded border",onClick:_,children:"Join"})]})}function Ue(){return r.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(n=>r.jsx("div",{className:"rounded-xl border bg-white overflow-hidden shadow-sm w-full animate-pulse",children:r.jsx("div",{className:"p-6 bg-white relative",children:r.jsxs("div",{className:"flex items-start gap-3 relative",children:[r.jsx("div",{className:"flex-shrink-0 w-14 h-14 rounded-full bg-slate-200"}),r.jsxs("div",{className:"flex-1 min-w-0 flex flex-col gap-1",children:[r.jsx("div",{className:"h-5 w-32 bg-slate-200 rounded"}),r.jsx("div",{className:"h-3 w-20 bg-slate-200 rounded"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"h-4 w-4 bg-slate-200 rounded"}),r.jsx("div",{className:"h-4 w-6 bg-slate-200 rounded"}),r.jsx("div",{className:"h-4 w-4 bg-slate-200 rounded"}),r.jsx("div",{className:"h-4 w-8 bg-slate-200 rounded"})]})]}),r.jsx("div",{className:"absolute top-4 right-4 flex flex-col items-end gap-1",children:r.jsx("div",{className:"h-6 w-6 rounded-full bg-slate-200"})})]})})},n))})}async function We(){const n="ABCDEFGHJKLMPQRSTVWXYZ23456789";for(let w=0;w<6;w++){let _="";for(let M=0;M<5;M++)_+=n[Math.floor(Math.random()*n.length)];const{data:k}=await o.from("leagues").select("id").eq("code",_).maybeSingle();if(!k)return _}return Math.random().toString(36).slice(2,7).toUpperCase()}export{Qe as default};
