import{r as o,u as Z,y as $,m as D,k as K,a as y,z as H,b as Q,j as t,P as U}from"./index-NKiev1v8.js";import{C as Y}from"./index.module-VIxakuXK.js";function ee(){const r=o.useRef(0);r.current=0;const{user:u}=Z();r.current++;const L=$();r.current++;const[h,M]=o.useState("");r.current++;const[p,C]=o.useState(!1);r.current++;const[N,x]=o.useState(null);r.current++;const[l,S]=o.useState(null);r.current++;const[A,J]=o.useState({x:0,y:0});r.current++;const[R,F]=o.useState(1);r.current++;const[w,O]=o.useState(null);r.current++;const[I,P]=o.useState(null);r.current++;const[f,j]=o.useState(!1);r.current++;const[T,g]=o.useState(null);r.current++;const v=o.useRef(null);r.current++;const d=o.useRef(!0);r.current++,o.useEffect(()=>{const a=Date.now();fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:after-all-hooks",message:"All hooks called",data:{mountTimestamp:a,hookCallCount:r.current,hasUser:!!u},timestamp:a,sessionId:"debug-session",runId:"run2",hypothesisId:"H1"})}).catch(()=>{})},[u]),o.useEffect(()=>{fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:state-creating",message:"creating state changed",data:{creating:p},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H2"})}).catch(()=>{})},[p]),o.useEffect(()=>{fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:state-uploadingAvatar",message:"uploadingAvatar state changed",data:{uploadingAvatar:f},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H2"})}).catch(()=>{})},[f]),o.useEffect(()=>{d.current=!0;const a=n=>{fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:window-error",message:"Uncaught error",data:{errorMessage:n.message,errorFilename:n.filename,errorLineno:n.lineno,errorColno:n.colno,errorStack:n.error?.stack},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H5"})}).catch(()=>{})};window.addEventListener("error",a);const s=n=>{fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:unhandled-rejection",message:"Unhandled promise rejection",data:{reason:n.reason,errorMessage:n.reason?.message,errorStack:n.reason?.stack},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H5"})}).catch(()=>{})};return window.addEventListener("unhandledrejection",s),()=>{d.current=!1;const n=Date.now();fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:useEffect-unmount",message:"Component unmounting",data:{unmountTimestamp:n,hookCallCount:r.current},timestamp:n,sessionId:"debug-session",runId:"run2",hypothesisId:"H1"})}).catch(()=>{}),window.removeEventListener("error",a),window.removeEventListener("unhandledrejection",s)}},[]);const _=a=>new Promise((s,n)=>{const e=new Image;e.addEventListener("load",()=>s(e)),e.addEventListener("error",i=>n(i)),e.src=a}),k=async(a,s)=>{const n=await _(a),e=document.createElement("canvas"),i=e.getContext("2d");if(!i)throw new Error("No 2d context");return e.width=s.width,e.height=s.height,i.drawImage(n,s.x,s.y,s.width,s.height,0,0,s.width,s.height),new Promise((c,b)=>{e.toBlob(m=>{if(!m){b(new Error("Canvas is empty"));return}c(m)},"image/jpeg",.9)})},G=o.useCallback(a=>{if(!new Set(["image/png","image/jpeg","image/jpg","image/webp"]).has(a.type)){g("Please upload a PNG, JPG, or WebP image.");return}const n=20*1024*1024;if(a.size>n){g("Please choose an image smaller than 20MB.");return}if(g(null),a.size>5*1024*1024)D(a,{maxSizeMB:2,maxWidthOrHeight:1024,useWebWorker:!0,initialQuality:.7}).then(e=>{const i=new FileReader;i.onload=()=>{S(i.result)},i.readAsDataURL(e)}).catch(()=>{g("Failed to process image. Please try a smaller file.")});else{const e=new FileReader;e.onload=()=>{S(e.result)},e.readAsDataURL(a)}},[]),B=o.useCallback(async(a,s)=>{if(O(s),l)try{const n=await k(l,s),e=URL.createObjectURL(n);P(e)}catch{}},[l]),W=async a=>{if(!l||!w)return null;try{const s=await k(l,w),n=new File([s],"avatar.jpg",{type:"image/jpeg"}),e=await D(n,{maxSizeMB:.02,maxWidthOrHeight:256,useWebWorker:!0,initialQuality:.8});if(e.size>20*1024)throw new Error("Compressed image is still larger than 20KB. Try a smaller image.");const i=`${a}-${Date.now()}.jpg`,{error:c}=await y.storage.from("league-avatars").upload(i,e,{cacheControl:"3600",upsert:!0,contentType:e.type});if(c)throw c;const{data:b}=y.storage.from("league-avatars").getPublicUrl(i);return b?.publicUrl||null}catch(s){return g(s?.message??"Failed to upload avatar. Please try again."),null}},E=o.useCallback(async()=>{if(fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-entry",message:"handleCreate called",data:{leagueName:h,hasUser:!!u,userId:u?.id,hasCropImage:!!l,hasCroppedArea:!!w,isMounted:d.current},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H2"})}).catch(()=>{}),!(!h.trim()||!u?.id)){if(!d.current){fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-unmounted",message:"Component already unmounted, aborting",data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H1"})}).catch(()=>{});return}C(!0),x(null),g(null);try{if((await K(u.id)).find(m=>m.name.toLowerCase()===h.trim().toLowerCase())){x("You're already in a mini-league with this name. Please choose a different name."),C(!1);return}const n=Math.random().toString(36).substring(2,7).toUpperCase(),{data:e,error:i}=await y.from("leagues").insert({name:h.trim(),code:n}).select("id, code").single();if(i)throw i;if(!e)throw new Error("Failed to create league");let c=null;if(l&&w){if(!d.current){fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-unmounted-before-avatar",message:"Component unmounted before avatar upload",data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H1"})}).catch(()=>{});return}j(!0),c=await W(e.id),d.current&&j(!1),c||(c=H(e.id))}else c=H(e.id);if(!d.current){fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-unmounted-before-updates",message:"Component unmounted before league updates",data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H1"})}).catch(()=>{});return}c&&await y.from("leagues").update({avatar:c}).eq("id",e.id);const{error:b}=await y.from("league_members").insert({league_id:e.id,user_id:u.id});if(b)throw b;if(!d.current){fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-unmounted-before-message",message:"Component unmounted before message insert",data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"H1"})}).catch(()=>{});return}try{const m=["Hello ðŸ‘‹ I'm Volley. I'll let you know who wins and when new Gameweeks are ready to play.","Hi â€” I'm Volley ðŸ¦„ I'll share results and let you know when new Gameweeks are ready.","I'm Volley. I'll handle the scoring and tell you when new Gameweeks are ready to play.","I'm Volley ðŸ¦„ I'll let you know who wins, plus when new Gameweeks are ready.","Hello, I'm Volley. I'll keep track of results and new Gameweeks for you."],V=m[Math.floor(Math.random()*m.length)];await y.from("league_messages").insert({league_id:e.id,user_id:Q,content:V})}catch(m){console.error("[CreateLeague] Failed to insert Volley welcome message:",m)}fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-before-reset",message:"About to reset state",data:{leagueCode:e.code,isMounted:d.current,creating:p,uploadingAvatar:f,hookCallCount:r.current},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H3"})}).catch(()=>{}),fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-before-setCreating",message:"About to call setCreating(false)",data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H3"})}).catch(()=>{}),C(!1),fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-after-setCreating",message:"Called setCreating(false)",data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H3"})}).catch(()=>{}),j(!1),x(null),g(null),fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-before-navigate",message:"About to navigate",data:{leagueCode:e.code,isMounted:d.current,hookCallCount:r.current},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H4"})}).catch(()=>{}),L(`/league/${e.code}`),fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-after-navigate",message:"Navigate called",data:{leagueCode:e.code,isMounted:d.current},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H4"})}).catch(()=>{})}catch(a){fetch("http://127.0.0.1:7242/ingest/8bc20b5f-9829-459c-9363-d6e04fa799c7",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"CreateLeague.tsx:handleCreate-error",message:"Error in handleCreate",data:{errorMessage:a?.message,errorStack:a?.stack,isMounted:d.current,hookCallCount:r.current},timestamp:Date.now(),sessionId:"debug-session",runId:"run2",hypothesisId:"H1"})}).catch(()=>{}),d.current&&(x(a?.message??"Failed to create league. Please try again."),C(!1),j(!1))}}},[h,u?.id,l,w,L]),z=()=>{S(null),O(null),I&&(URL.revokeObjectURL(I),P(null)),v.current&&(v.current.value="")};return u?t.jsx("div",{className:"min-h-screen bg-slate-50",children:t.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-10",children:[t.jsx(U,{title:"Create League",as:"h1"}),t.jsx("p",{className:"mt-2 mb-6 text-slate-600",children:"Choose a name and upload an avatar for your mini-league."}),N&&t.jsx("div",{className:"mb-4 rounded border border-red-200 bg-red-50 text-red-700 px-3 py-2 text-sm",children:N}),t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("label",{htmlFor:"league-name",className:"block text-sm font-medium text-slate-900 mb-2",children:"League Name"}),t.jsx("input",{id:"league-name",type:"text",className:"w-full border rounded-lg px-3 py-2 bg-white",placeholder:"Enter league name",value:h,onChange:a=>M(a.target.value),onKeyDown:a=>{a.key==="Enter"&&!p&&h.trim()&&!l&&E()},maxLength:20})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-900 mb-2",children:"League Avatar (Optional)"}),l?t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"relative w-full h-64 bg-slate-100 rounded-lg overflow-hidden",children:t.jsx(Y,{image:l,crop:A,zoom:R,aspect:1,onCropChange:J,onCropComplete:B,onZoomChange:F})}),I&&t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("div",{className:"w-20 h-20 rounded-full overflow-hidden border-2 border-slate-300",children:t.jsx("img",{src:I,alt:"Preview",className:"w-full h-full object-cover"})}),t.jsx("p",{className:"text-sm text-slate-600",children:"Preview"})]}),t.jsx("div",{className:"flex gap-2",children:t.jsx("button",{type:"button",onClick:z,className:"px-4 py-2 border border-slate-300 rounded-lg bg-white text-slate-900 font-medium hover:bg-slate-50 transition-colors",children:"Cancel"})})]}):t.jsxs("div",{children:[t.jsx("input",{ref:v,type:"file",accept:"image/png,image/jpeg,image/jpg,image/webp",onChange:a=>{const s=a.target.files?.[0];s&&G(s)},className:"hidden"}),t.jsx("button",{type:"button",onClick:()=>v.current?.click(),className:"px-4 py-2 border border-slate-300 rounded-lg bg-white text-slate-900 font-medium hover:bg-slate-50 transition-colors",children:"Choose Image"}),t.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"PNG, JPG, or WebP. Max 20MB. If you don't upload one, we'll assign a default avatar."})]}),T&&t.jsx("div",{className:"mt-2 text-sm text-red-600 bg-red-50 border border-red-200 rounded px-3 py-2",children:T})]}),t.jsx("div",{children:t.jsx("button",{onClick:E,disabled:p||f||!h.trim(),className:"w-full px-4 py-3 bg-slate-900 text-white font-semibold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-800 transition-colors",children:p||f?f?"Uploading avatar...":"Creating...":"Create League"})})]})]})}):t.jsx("div",{className:"min-h-screen bg-slate-50",children:t.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-10",children:[t.jsx(U,{title:"Create League",as:"h1"}),t.jsx("p",{className:"mt-4 text-slate-600",children:"Please sign in to create a league."})]})})}export{ee as default};
