import{u as F,a as u,s as g,j as t}from"./index-BfI3uEnF.js";const I=()=>{const f=typeof window<"u"?window.location.hostname:"",x=typeof window<"u"?window.location.origin:"";return f.includes("netlify.app")||f.includes("netlify.com")?`${x}/.netlify/functions/fetchFootballData`:f==="localhost"||f==="127.0.0.1"?"https://totl-staging.netlify.app/.netlify/functions/fetchFootballData":"/.netlify/functions/fetchFootballData"};function z(){const{user:f}=F(),x=f?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||f?.id==="36f31625-6d6c-4aa4-815a-1493a812841b",[n,E]=u.useState(null),[b,C]=u.useState([]),[c,p]=u.useState(new Map),[j,k]=u.useState(!1),[_,N]=u.useState(!1),[T,y]=u.useState(""),[A,S]=u.useState(""),[M,m]=u.useState(null),[$,D]=u.useState(!0);u.useEffect(()=>{if(!x)return;let a=!0;return(async()=>{try{const{data:e,error:o}=await g.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(o)throw o;if(a&&e){const r=(e.current_gw||13)+1;E(r);const{data:l}=await g.from("app_fixtures").select("*").eq("gw",r).order("fixture_index",{ascending:!0});if(l&&l.length>0){const d=new Map;l.forEach(i=>{d.set(i.fixture_index,{api_match_id:i.api_match_id||0,home_team:i.home_team||"",away_team:i.away_team||"",home_code:i.home_code||"",away_code:i.away_code||"",home_name:i.home_name||"",away_name:i.away_name||"",home_crest:i.home_crest||null,away_crest:i.away_crest||null,kickoff_time:i.kickoff_time||"",selected:!0})}),p(d)}}}catch(e){console.error("Error loading next GW:",e)}finally{a&&D(!1)}})(),()=>{a=!1}},[x]);const G=async a=>{if(!n)return m("Next GW not loaded yet."),null;try{const e=new Date,o=new Date(e);o.setDate(e.getDate()+7);const s=e.toISOString().split("T")[0],r=o.toISOString().split("T")[0],l=new URLSearchParams({competition:"PL",dateFrom:s,dateTo:r}),i=`${I()}?${l.toString()}`,h=await fetch(i,{signal:a});if(!h.ok){const v=await h.text();return h.status===429?(m("Rate limit reached. Please wait a moment."),null):(m(`Server error (${h.status}). ${v.substring(0,100)}`),null)}const w=await h.json();if(!w.success||!w.data)return m("Invalid API response format."),null;const P=(w.data.matches||[]).filter(v=>v.matchday===n);return m(null),P}catch(e){return e instanceof Error&&e.name==="AbortError"||(console.error("Error fetching matches:",e),m("Failed to fetch matches. Check your connection.")),null}},W=a=>{const e=new Map(c),o=Array.from(e.entries()).find(([s,r])=>r.api_match_id===a.id);if(o){const[s]=o;e.delete(s);const r=Array.from(e.entries()).sort(([d],[i])=>d-i),l=new Map;r.forEach(([d,i],h)=>{l.set(h,i)}),p(l)}else{const r=(e.size>0?Math.max(...Array.from(e.keys())):-1)+1,l={api_match_id:a.id,home_team:a.homeTeam.shortName,away_team:a.awayTeam.shortName,home_code:a.homeTeam.tla,away_code:a.awayTeam.tla,home_name:a.homeTeam.name,away_name:a.awayTeam.name,home_crest:a.homeTeam.crest||null,away_crest:a.awayTeam.crest||null,kickoff_time:a.utcDate,selected:!0};e.set(r,l),p(e)}},L=async()=>{if(!n){y("Next GW not loaded");return}if(c.size===0){y("Please select at least one fixture");return}if(confirm(`Are you sure you want to save GW ${n} with ${c.size} fixture${c.size===1?"":"s"}? This will replace any existing fixtures for this game week.`)){k(!0),y(""),S("");try{await g.from("app_fixtures").delete().eq("gw",n);const a=Array.from(c.entries()).map(([s,r])=>({gw:n,fixture_index:s,api_match_id:r.api_match_id,home_team:r.home_team,away_team:r.away_team,home_code:r.home_code,away_code:r.away_code,home_name:r.home_name,away_name:r.away_name,kickoff_time:r.kickoff_time})),{error:e}=await g.from("app_fixtures").insert(a);if(e)throw console.error("[ApiAdmin] Error inserting fixtures:",e),e;const{error:o}=await g.from("app_meta").upsert({id:1,current_gw:n},{onConflict:"id"});o&&console.error("[ApiAdmin] Error updating app_meta:",o);try{const s=await fetch("/.netlify/functions/sendPushAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:`GAME WEEK ${n} - FIXTURES ARE OUT!`,message:"Make your predictions now!",data:{type:"fixtures_published",gw:n}})}),r=await s.json().catch(()=>({}));s.ok&&r.ok?console.log(`[ApiAdmin] Push notification sent to ${r.sentTo||0} users`):console.warn("[ApiAdmin] Push notification failed:",r)}catch(s){console.error("[ApiAdmin] Error sending push notification:",s)}S(`Game Week ${n} saved with ${c.size} Premier League fixtures!`)}catch(a){y(a.message??"Failed to save gameweek.")}finally{k(!1)}}};return x?$?t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-slate-600",children:"Loading..."})}):t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900 mb-2",children:"API Admin - Premier League"}),t.jsxs("p",{className:"text-sm text-slate-600 mb-6",children:["Select Premier League fixtures for Game Week ",n,". Check the feed for any cancelled or postponed games."]}),T&&t.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:T}),A&&t.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",children:A}),M&&t.jsxs("div",{className:"mb-4 p-4 bg-amber-50 border-2 border-amber-400 rounded-lg text-amber-800 text-sm font-medium shadow-md",children:["⚠️ ",M]}),t.jsx("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Next Game Week"}),t.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:["GW ",n]})]}),c.size>0&&t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Selected Fixtures"}),t.jsx("div",{className:"text-2xl font-bold text-[#1C8376]",children:c.size})]})]})}),t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:["Premier League Matches for GW ",n," (Matchday ",n,")"]}),t.jsxs("p",{className:"text-sm text-slate-500 mb-4",children:["Loading matches from the API that are tagged with Matchday ",n," (corresponds to GW ",n,")."]}),t.jsx("button",{onClick:()=>{if(_||!n)return;N(!0),m(null);const a=new AbortController;G(a.signal).then(e=>{if(e&&e.length>0){C(e),m(null);const o=new Map;e.forEach((s,r)=>{o.set(r,{api_match_id:s.id,home_team:s.homeTeam.shortName,away_team:s.awayTeam.shortName,home_code:s.homeTeam.tla,away_code:s.awayTeam.tla,home_name:s.homeTeam.name,away_name:s.awayTeam.name,home_crest:s.homeTeam.crest||null,away_crest:s.awayTeam.crest||null,kickoff_time:s.utcDate,selected:!0})}),p(o)}else e&&e.length===0&&m(`No Premier League matches found for Matchday ${n} (GW ${n}) in the next week.`)}).catch(e=>{e instanceof Error&&e.name!=="AbortError"&&m("Failed to fetch matches. Please try again.")}).finally(()=>{N(!1)})},disabled:_||!n,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",type:"button",children:_?"Loading...":`Load GW ${n} Matches (Matchday ${n})`})]}),b.length>0&&t.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h3",{className:"text-lg font-semibold text-slate-800",children:["Available Matches (",b.length,") - All Selected by Default"]}),t.jsx("button",{onClick:L,disabled:j||c.size===0,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 font-semibold",children:j?"Saving...":`Save GW ${n} (${c.size} fixtures)`})]}),t.jsx("div",{className:"space-y-2",children:b.map(a=>{const e=Array.from(c.values()).some(w=>w.api_match_id===a.id),o=new Date(a.utcDate),s=new Date;s.setHours(0,0,0,0);const r=new Date(s);r.setDate(s.getDate()+1);const l=new Date(o);l.setHours(0,0,0,0);let d="";l.getTime()===s.getTime()?d="TODAY":l.getTime()===r.getTime()?d="TOMORROW":d=o.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"});const i=`${String(o.getUTCHours()).padStart(2,"0")}:${String(o.getUTCMinutes()).padStart(2,"0")} UTC`,h=`${d} ${i}`;return t.jsx("div",{className:`p-3 border-2 rounded-lg transition-colors ${e?"bg-[#1C8376]/10 border-[#1C8376]":"bg-slate-50 border-slate-200"}`,children:t.jsxs("label",{className:"flex items-center gap-4 cursor-pointer",children:[t.jsxs("div",{className:"relative flex-shrink-0",children:[t.jsx("input",{type:"checkbox",checked:e,onChange:()=>W(a),className:"w-6 h-6 cursor-pointer appearance-none border-2 rounded transition-all",style:{minWidth:"24px",minHeight:"24px",borderColor:e?"#1C8376":"#94a3b8",backgroundColor:e?"#1C8376":"white"}}),e&&t.jsx("svg",{className:"absolute top-0 left-0 w-6 h-6 pointer-events-none",fill:"none",stroke:"white",strokeWidth:"3",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})]}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"font-medium text-slate-800",children:[a.homeTeam.shortName," vs ",a.awayTeam.shortName]}),t.jsxs("div",{className:"text-xs text-slate-500",children:[h," • ",a.status," • Matchday ",a.matchday]})]})]})},a.id)})})]})]})}):t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:t.jsx("div",{className:"text-red-600",children:"Access denied. Admin only."})})}export{z as default};
