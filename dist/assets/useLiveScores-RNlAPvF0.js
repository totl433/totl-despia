import{r as h,s as L}from"./index-Biua6bUl.js";function T(f,i){const[w,E]=h.useState(new Map),[y,d]=h.useState(!0),[b,m]=h.useState(null);return h.useEffect(()=>{let S=null,n=!0,a=null,p=Date.now();async function v(){try{let t=L.from("live_scores").select("*");f!==void 0&&(t=t.eq("gw",f)),i&&i.length>0&&(t=t.in("api_match_id",i));const{data:g,error:s}=await t;if(s){console.error("[useLiveScores] Error fetching scores:",s),n&&(m(s.message),d(!1));return}console.log("[useLiveScores] Fetched live scores:",(g||[]).length,"records"),i&&i.length>0&&(console.log("[useLiveScores] Looking for api_match_ids:",i),console.log("[useLiveScores] Found api_match_ids in response:",(g||[]).map(r=>r.api_match_id)));const _=new Map;(g||[]).forEach(r=>{_.set(r.api_match_id,r)}),n&&(E(r=>{let l=!1;const u=new Map(r);return _.forEach((e,o)=>{const c=r.get(o);(!c||c.home_score!==e.home_score||c.away_score!==e.away_score||c.status!==e.status||c.minute!==e.minute||JSON.stringify(c.goals)!==JSON.stringify(e.goals)||JSON.stringify(c.red_cards)!==JSON.stringify(e.red_cards))&&(u.set(o,e),l=!0)}),r.forEach((e,o)=>{_.has(o)||(u.delete(o),l=!0)}),l?new Map(u):r}),d(!1),p=Date.now())}catch(t){console.error("[useLiveScores] Error fetching scores:",t),n&&(m(t?.message||"Failed to fetch live scores"),d(!1))}}async function N(){try{await v();const t=`live_scores_${f||"all"}_${i?.join("-")||"all"}_${Date.now()}`;S=L.channel(t).on("postgres_changes",{event:"*",schema:"public",table:"live_scores"},s=>{if(!n)return;const _=r=>!(!r||f!==void 0&&r.gw!==f||i&&i.length>0&&!i.includes(r.api_match_id));E(r=>{const l=new Map(r);let u=!1;if(s.eventType==="INSERT"||s.eventType==="UPDATE"){const e=s.new;if(console.log("[useLiveScores] Real-time update received:",s.eventType,e?.api_match_id),_(e)){const o=r.get(e.api_match_id);(!o||o.home_score!==e.home_score||o.away_score!==e.away_score||o.status!==e.status||o.minute!==e.minute||JSON.stringify(o.goals)!==JSON.stringify(e.goals)||JSON.stringify(o.red_cards)!==JSON.stringify(e.red_cards))&&(l.set(e.api_match_id,e),u=!0,p=Date.now(),console.log("[useLiveScores] Updated score for match",e.api_match_id,"minute:",e.minute))}}else if(s.eventType==="DELETE"){const e=s.old;_(e)&&(l.delete(e.api_match_id),u=!0)}return u?new Map(l):new Map(r)})}).subscribe(s=>{console.log("[useLiveScores] Subscription status:",s),s==="SUBSCRIBED"?console.log("[useLiveScores] Successfully subscribed to real-time updates"):(s==="CHANNEL_ERROR"||s==="TIMED_OUT")&&(console.error("[useLiveScores] Channel error:",s),n&&(m("Real-time subscription failed, using polling fallback"),a||(a=window.setInterval(()=>{n&&v()},5e3))))});const g=setInterval(()=>{Date.now()-p>3e4&&!a&&(console.warn("[useLiveScores] No real-time updates for 30s, starting polling fallback"),a=window.setInterval(()=>{n&&v()},5e3))},1e4);return()=>{clearInterval(g)}}catch(t){console.error("[useLiveScores] Error setting up subscription:",t),n&&(m(t?.message||"Failed to set up live scores subscription"),d(!1),a||(a=window.setInterval(()=>{n&&v()},5e3)))}}return N(),()=>{n=!1,S&&L.removeChannel(S),a&&clearInterval(a)}},[f,i?i.join(","):void 0]),{liveScores:w,loading:y,error:b}}export{T as u};
