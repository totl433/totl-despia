import{u as oe,r as l,s as b,j as e}from"./index-ByaaQl1E.js";import{g as Q}from"./teamNames-3Xw3rq3F.js";function V(m){return m?m.toUpperCase():"???"}function ce(m){if(!m)return null;let h=m.match(/^[A-Za-z]{3}\s+(\d{1,2}):(\d{2})\s+[A-Za-z]{3}\s+(\d{1,2})(?:st|nd|rd|th)?\s+([A-Za-z]{3})/);if(h){const[,a,g,v,N]=h,f={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"}[N];if(!f)return null;const p=new Date().getFullYear(),y=v.padStart(2,"0");return`${p}-${f}-${y}T${a}:${g}:00`}if(h=m.match(/^[A-Za-z]{3}\s+(\d{1,2})\s+([A-Za-z]{3})/),h){const[,a,g]=h,N={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"}[g];if(!N)return null;const u=new Date().getFullYear(),f=a.padStart(2,"0");return`${u}-${N}-${f}T15:00:00`}return null}function de(m){if(!m)return"";const h=new Date(m);if(isNaN(h.valueOf()))return"";const a=h.toLocaleDateString(void 0,{weekday:"short"}),g=String(h.getUTCHours()).padStart(2,"0"),v=String(h.getUTCMinutes()).padStart(2,"0");return`${a} ${g}:${v}`}function he(){const{user:m,session:h}=oe(),[a,g]=l.useState(1),[v,N]=l.useState(""),[u,f]=l.useState([]),[p,y]=l.useState({}),[w,x]=l.useState(!1),[R,o]=l.useState(""),[D,c]=l.useState(""),[T,O]=l.useState(!1),[C,W]=l.useState(null),[j,M]=l.useState(!1),[_,H]=l.useState("fixtures"),E=u.length>0,[k,P]=l.useState(null),[I,G]=l.useState(null),[J,U]=l.useState(!1),[q,B]=l.useState(!1),[F,S]=l.useState(null),X=m?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||m?.id==="36f31625-6d6c-4aa4-815a-1493a812841b";l.useEffect(()=>{let t=!0;return(async()=>{try{const{data:r,error:n}=await b.from("meta").select("current_gw").eq("id",1).single();if(n)return;const s=r?.current_gw;t&&Number.isFinite(s)&&(W(s??null),s&&g(s))}catch{}})(),()=>{t=!1}},[]),l.useEffect(()=>{let t=!0;return(async()=>{o(""),c("");const{data:r,error:n}=await b.from("fixtures").select("*").eq("gw",a).order("fixture_index",{ascending:!0});if(n){t&&o(n.message);return}if(!t)return;f(r??[]),M(!1);const{data:s,error:i}=await b.from("gw_results").select("fixture_index, result").eq("gw",a);i&&console.warn("[Admin] load gw_results error:",i);const d={};(s??[]).forEach($=>{d[Number($.fixture_index)]=$.result??null}),M((s??[]).length>0),t&&y(d)})(),()=>{t=!1}},[a]);const z=l.useMemo(()=>u.reduce((t,r)=>t+(p[r.fixture_index]?1:0),0),[u,p]),A=u.length>0&&z===u.length,Z=Math.max(0,u.length-z);async function ee(){x(!0),o(""),c("");try{const r=v.split(`
`).map(i=>i.trim()).filter(Boolean).map((i,d)=>{const[$,...ne]=i.split(/\s{2,}|\t/),Y=$.split(/\s+/),K=(Y[0]??"").toUpperCase(),L=(Y[2]??"").toUpperCase(),ie=ne.join(" ").trim(),le=ce(ie);return{gw:a,fixture_index:d,home_team:K,away_team:L,home_code:K,away_code:L,kickoff_time:le}}),{error:n}=await b.from("fixtures").upsert(r,{onConflict:"gw,fixture_index"});if(n)throw n;N("");const{data:s}=await b.from("fixtures").select("*").eq("gw",a).order("fixture_index");f(s??[]),s&&f(s),c("Fixtures saved!")}catch(t){o(t.message??"Failed to save fixtures.")}finally{x(!1)}}async function te(){if(!T){O(!0);return}x(!0),o(""),c("");try{const{error:t}=await b.from("meta").update({current_gw:a}).eq("id",1);if(t)throw t;c(`Gameweek ${a} activated successfully!`),W(a),window.dispatchEvent(new CustomEvent("fixturesPublished"));try{const r=await fetch("/.netlify/functions/sendPushAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:`GW${a} Published`,message:`Game Week ${a} fixtures are live. Make your predictions!`,data:{type:"fixtures_published",gw:a}})}),n=await r.json().catch(()=>({}));if(r.ok&&n.ok){const s=n.sentTo||0,i=n.checked||0;s>0?(console.log(`[Admin] Push notification sent to ${s} subscribed devices (checked ${i} total)`),c(`Gameweek ${a} activated! Push notification sent to ${s} devices.`)):n.warning&&(console.warn(`[Admin] Push notification warning: ${n.warning}`),c(`Gameweek ${a} activated! (No subscribed devices found for push notifications)`))}else{console.error("[Admin] Push notification failed:",n);const s=n.oneSignalErrors?`OneSignal Error: ${JSON.stringify(n.oneSignalErrors)}`:n.error||"Failed to send push notification";o(`Gameweek activated, but push notification failed: ${s}`)}}catch(r){console.error("[Admin] Push notification error:",r),o(`Gameweek activated, but push notification failed: ${r.message||"Network error"}`)}}catch(t){o(t.message??"Failed to activate gameweek.")}finally{x(!1),O(!1)}}async function se(){x(!0),o(""),c("");try{const{error:t}=await b.from("fixtures").delete().eq("gw",a);if(t)throw t;f([]),c(`Gameweek ${a} upload cancelled.`)}catch(t){o(t.message??"Failed to cancel gameweek.")}finally{x(!1)}}async function ae(){x(!0),o(""),c("");try{if(!window.confirm("⚠️ This will publish and score all results for this Gameweek. Are you sure?")){x(!1);return}if(!A)throw new Error("Please pick a result (H/D/A/Cancelled) for every fixture before publishing.");const r=u.map(s=>({gw:a,fixture_index:s.fixture_index,result:p[s.fixture_index],decided_at:new Date().toISOString()})),{error:n}=await b.from("gw_results").upsert(r,{onConflict:"gw,fixture_index"});if(n)throw n;c(`GW ${a} results published!`),window.dispatchEvent(new CustomEvent("resultsPublished",{detail:{gw:a}}));try{const s=await fetch("/.netlify/functions/sendPushAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:`GW${a} Results`,message:`Results for Game Week ${a} are published. See how you scored!`,data:{type:"results_published",gw:a}})}),i=await s.json().catch(()=>({}));if(s.ok&&i.ok){const d=i.sentTo||0,$=i.checked||0;d>0?(console.log(`[Admin] Push notification sent to ${d} subscribed devices (checked ${$} total)`),c(`GW ${a} results published! Push notification sent to ${d} devices.`)):i.warning&&(console.warn(`[Admin] Push notification warning: ${i.warning}`),c(`GW ${a} results published! (No subscribed devices found for push notifications)`))}else{console.error("[Admin] Push notification failed:",i);const d=i.oneSignalErrors?`OneSignal Error: ${JSON.stringify(i.oneSignalErrors)}`:i.error||"Failed to send push notification";o(`Results published, but push notification failed: ${d}`)}}catch(s){console.error("[Admin] Push notification error:",s),o(`Results published, but push notification failed: ${s.message||"Network error"}`)}}catch(t){o(t.message??"Failed to save results.")}finally{x(!1)}}async function re(){x(!0),o(""),c("");try{const{error:t}=await b.from("gw_results").delete().eq("gw",a);if(t)throw t;y({}),c(`GW ${a} results recalled (deleted).`)}catch(t){o(t.message??"Failed to recall results.")}finally{x(!1)}}return e.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-10",children:[e.jsx("h1",{className:"mb-6 text-2xl font-semibold",children:"⚙️ Admin"}),X&&e.jsx("div",{className:"mb-6 rounded border bg-white p-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"OneSignal Player ID (native)"}),e.jsx("div",{className:"text-sm text-slate-600",children:"Works only inside the Despia native wrapper"}),k&&e.jsx("div",{className:"mt-1 text-sm font-mono break-all",children:k}),I!=null&&e.jsxs("div",{className:"mt-1 text-xs text-slate-500",children:["nativePushEnabled: ",String(I)]}),F&&e.jsx("div",{className:`mt-1 text-xs ${F.includes("Success")?"text-green-600":"text-red-600"}`,children:F})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:async()=>{U(!0),P(null),G(null);try{const t=globalThis;if(t&&t.despia){const r=t.despia,n=r?.onesignalplayerid||null;P(n);try{const s=typeof r=="function"?r("checkNativePushPermissions://",["nativePushEnabled"]):null;s&&typeof s=="object"&&"nativePushEnabled"in s&&G(!!s.nativePushEnabled)}catch{}}else try{const s=(await import("despia-native"))?.default,i=s?.onesignalplayerid||null;P(i);try{const d=typeof s=="function"?s("checkNativePushPermissions://",["nativePushEnabled"]):null;d&&typeof d=="object"&&"nativePushEnabled"in d&&G(!!d.nativePushEnabled)}catch{}}catch{P(null)}}finally{U(!1)}},className:"rounded bg-slate-900 px-3 py-2 text-white disabled:opacity-50 text-sm",disabled:J,children:J?"Checking…":"Show Player ID"}),e.jsx("button",{onClick:async()=>{if(!k){S("Please check Player ID first");return}B(!0),S(null);try{if(!m||!h?.access_token){S("Error: Not signed in");return}const t=await fetch("/.netlify/functions/registerPlayer",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h.access_token}`},body:JSON.stringify({playerId:k,platform:"ios"})}),r=await t.json();t.ok?S(`Success! Registered ${k.slice(0,8)}…`):S(`Error: ${r.error||"Unknown error"}`)}catch(t){S(`Error: ${t.message||"Failed to register"}`)}finally{B(!1)}},className:"rounded bg-emerald-600 px-3 py-2 text-white disabled:opacity-50 text-sm",disabled:q||!k,children:q?"Registering…":"Register Device"})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"mr-2",children:"GW"}),e.jsx("select",{value:a,onChange:t=>g(parseInt(t.target.value,10)),className:"rounded border px-2 py-1",children:Array.from({length:38},(t,r)=>r+1).map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"inline-flex rounded-full bg-slate-100 p-1 text-sm",children:[e.jsx("button",{type:"button",onClick:()=>H("fixtures"),className:`px-3 py-1 rounded-full transition ${_==="fixtures"?"bg-white shadow font-semibold text-slate-900":"text-slate-600 hover:text-slate-900"}`,children:"Fixtures"}),e.jsx("button",{type:"button",onClick:()=>H("results"),className:`ml-1 px-3 py-1 rounded-full transition ${_==="results"?"bg-white shadow font-semibold text-slate-900":"text-slate-600 hover:text-slate-900"}`,children:"Results"})]})}),R&&e.jsx("div",{className:"mb-4 rounded border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700",children:R}),D&&e.jsx("div",{className:"mb-4 rounded border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm text-emerald-800",children:D}),_==="fixtures"&&e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"mb-2 text-lg font-semibold",children:"Review Fixtures"}),u.length===0?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"mb-3 text-slate-500",children:["No fixtures uploaded for GW ",a," yet."]}),e.jsx("h3",{className:"mb-2 text-base font-semibold",children:"Add Fixtures"}),e.jsx("textarea",{value:v,onChange:t=>N(t.target.value),rows:8,className:"w-full rounded border p-2 font-mono text-sm",placeholder:`BRE v MUN	Sat 12:30 Sat 28th Sep
CHE v BHA	Sat 15:00 Sat 28th Sep`}),e.jsx("button",{onClick:ee,disabled:w,className:"mt-2 rounded bg-slate-900 px-3 py-2 text-white disabled:opacity-50",children:w?"Saving…":"Save Fixtures"})]}):e.jsxs(e.Fragment,{children:[e.jsx("ul",{className:"mb-2",children:u.map(t=>e.jsxs("li",{className:"py-1",children:[e.jsx("span",{className:"font-semibold",children:Q(t.home_code||t.home_team||"HOME")})," ",e.jsx("span",{className:"text-slate-400",children:"v"})," ",e.jsx("span",{className:"font-semibold",children:Q(t.away_code||t.away_team||"AWAY")}),e.jsx("span",{className:"ml-2 text-slate-500",children:t.kickoff_time?de(t.kickoff_time):"TBD"})]},t.fixture_index))}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx("button",{onClick:te,disabled:w||!E||C===a,className:`rounded px-4 py-3 font-semibold text-white ${w||!E||C===a?"bg-emerald-300 cursor-not-allowed":"bg-emerald-700 hover:bg-emerald-800"}`,title:E?C===a?"This gameweek is already active":"Activate this gameweek":"Add fixtures first",children:T?"Are you sure? Click again to confirm.":`Activate Gameweek ${a}`}),e.jsx("button",{onClick:se,disabled:w,className:"rounded bg-rose-600 px-4 py-3 text-white font-semibold hover:bg-rose-700",children:"Cancel Upload"})]})]})]}),_==="results"&&e.jsxs("div",{children:[e.jsx("h2",{className:"mb-2 text-lg font-semibold",children:"Enter Results"}),u.length===0?e.jsxs("p",{className:"text-slate-500",children:["No fixtures yet for GW ",a,"."]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 text-xs text-slate-500",children:A?"All fixtures selected (H/D/A/Cancelled).":`Pick results for ${Z} more fixture${Z===1?"":"s"} (H/D/A/Cancelled).`}),e.jsxs("table",{className:"w-full border text-sm",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-1 text-left",children:"Fixture"}),e.jsx("th",{className:"px-2 py-1",children:"Home Win"}),e.jsx("th",{className:"px-2 py-1",children:"Draw"}),e.jsx("th",{className:"px-2 py-1",children:"Away Win"}),e.jsx("th",{className:"px-2 py-1",children:"Cancelled"})]})}),e.jsx("tbody",{children:u.map(t=>{const r=V(t.home_code||t.home_team),n=V(t.away_code||t.away_team);return e.jsxs("tr",{className:"border-t",children:[e.jsxs("td",{className:"px-2 py-1",children:[r," ",e.jsx("span",{className:"text-slate-400",children:"v"})," ",n]}),e.jsx("td",{className:"px-2 py-2 text-center",children:e.jsx("button",{type:"button",onClick:()=>y(s=>({...s,[t.fixture_index]:"H"})),className:`w-12 h-8 rounded-md font-semibold text-sm transition-colors ${(p[t.fixture_index]??null)==="H"?"bg-emerald-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:"H"})}),e.jsx("td",{className:"px-2 py-2 text-center",children:e.jsx("button",{type:"button",onClick:()=>y(s=>({...s,[t.fixture_index]:"D"})),className:`w-12 h-8 rounded-md font-semibold text-sm transition-colors ${(p[t.fixture_index]??null)==="D"?"bg-emerald-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:"D"})}),e.jsx("td",{className:"px-2 py-2 text-center",children:e.jsx("button",{type:"button",onClick:()=>y(s=>({...s,[t.fixture_index]:"A"})),className:`w-12 h-8 rounded-md font-semibold text-sm transition-colors ${(p[t.fixture_index]??null)==="A"?"bg-emerald-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:"A"})}),e.jsx("td",{className:"px-2 py-2 text-center",children:e.jsx("button",{type:"button",onClick:()=>y(s=>({...s,[t.fixture_index]:"N"})),className:`w-8 h-6 rounded text-xs transition-colors ${(p[t.fixture_index]??null)==="N"?"bg-red-500 text-white":"bg-gray-200 text-gray-600 hover:bg-gray-300"}`,children:"N"})})]},t.fixture_index)})})]}),e.jsxs("div",{className:"mt-3 flex gap-3",children:[e.jsx("button",{onClick:ae,disabled:w||!A||j,className:`rounded px-3 py-2 text-white ${j?"bg-gray-300 cursor-not-allowed text-gray-700":"bg-red-600"} disabled:opacity-50`,title:j?"Results already published for this GW":A?"Publish gameweek results":"Pick a result for every fixture",children:w?"Publishing…":"Publish GW"}),e.jsx("button",{onClick:re,disabled:w||!j,className:`rounded px-3 py-2 ${j?"bg-gray-300 text-gray-900 hover:bg-gray-400":"bg-gray-200 text-gray-500 cursor-not-allowed"}`,title:j?"Delete published results for this GW":"No published results to recall",children:"Recall GW"})]})]})]})]})}export{he as default};
