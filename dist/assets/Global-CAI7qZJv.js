import{u as Y,d as q,r as d,g as K,s as W,a as J,C as Q,j as e}from"./index-CpwqYQVG.js";function Z(){const{user:j}=Y(),[$,E]=q(),p=d.useRef(null),T=d.useRef(null),w=$.get("tab"),k=w==="form5"||w==="form10"||w==="lastgw"||w==="overall"?w:"lastgw",[S,F]=d.useState(!0),[M,H]=d.useState(""),[n,O]=d.useState(null),[g,z]=d.useState([]),[b,A]=d.useState([]),[V,G]=d.useState({}),[a,B]=d.useState(k);d.useEffect(()=>{w||E({tab:"lastgw"},{replace:!0}),k!==a&&B(k)},[k,w,a,E]);const C=t=>{B(t),E({tab:t})};d.useEffect(()=>{let t=!0;const l="global:leaderboard";let i=!1;try{const o=K(l);o&&o.gwPoints&&Array.isArray(o.gwPoints)&&o.gwPoints.length>0&&(O(o.latestGw),A(o.gwPoints),z(o.overall||[]),G(o.prevOcp||{}),F(!1),i=!0)}catch{}return(async()=>{try{i||F(!0),H("");const{data:o,error:s}=await W.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle();if(s)throw s;const r=o?.gw??1;t&&O(r);const{data:c,error:u}=await W.from("app_v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0});if(u)throw u;const{data:m,error:f}=await W.from("app_v_ocp_overall").select("user_id, name, ocp");if(f)throw f;if(!t)return;A(c??[]),z(m??[]);let h={};if(r&&r>1){const x=c?.filter(y=>y.gw<r)??[],v={};x.forEach(y=>{v[y.user_id]=(v[y.user_id]??0)+(y.points??0)}),h=v,t&&G(v)}else t&&G({});try{J(l,{latestGw:r,gwPoints:c??[],overall:m??[],prevOcp:h},Q.GLOBAL)}catch{}}catch(o){t&&H(o?.message??"Failed to load leaderboard.")}finally{t&&F(!1)}})(),()=>{t=!1}},[]);function U(t){const l=Object.keys(t);l.sort((o,s)=>(t[s]??0)-(t[o]??0)||o.localeCompare(s));const i={};return l.forEach((o,s)=>i[o]=s+1),i}const D=d.useMemo(()=>{const t={};return g.forEach(l=>{t[l.user_id]=l.ocp??0}),b.forEach(l=>{l.user_id in t||(t[l.user_id]=l.points??0)}),U(t)},[g,b]),I=d.useMemo(()=>U(V),[V]),N=d.useMemo(()=>t=>{if(!n||n<t)return[];const l=n-t+1,i=b.filter(r=>r.gw>=l&&r.gw<=n),o=new Map;return g.forEach(r=>{o.set(r.user_id,{user_id:r.user_id,name:r.name??"User",formPoints:0,weeksPlayed:new Set})}),i.forEach(r=>{const c=o.get(r.user_id);c?(c.formPoints+=r.points,c.weeksPlayed.add(r.gw)):o.set(r.user_id,{user_id:r.user_id,name:"User",formPoints:r.points,weeksPlayed:new Set([r.gw])})}),Array.from(o.values()).filter(r=>{for(let c=l;c<=n;c++)if(!r.weeksPlayed.has(c))return!1;return!0}).map(r=>({user_id:r.user_id,name:r.name,formPoints:r.formPoints,gamesPlayed:t})).sort((r,c)=>c.formPoints-r.formPoints||r.name.localeCompare(c.name))},[g,b,n]),_=d.useMemo(()=>N(5),[N]),L=d.useMemo(()=>N(10),[N]),R=d.useMemo(()=>{if(!n)return[];const t=b.filter(s=>s.gw===n),l=new Map(g.map(s=>[s.user_id,s.name??"User"])),i=t.map(s=>({user_id:s.user_id,name:l.get(s.user_id)??"User",points:s.points})).sort((s,r)=>r.points-s.points||s.name.localeCompare(r.name));let o=1;return i.map((s,r)=>(r>0&&i[r-1].points!==s.points&&(o=r+1),{...s,rank:o}))},[b,n,g]),P=d.useMemo(()=>{const t=b.filter(s=>s.gw===n),l=new Map;t.forEach(s=>l.set(s.user_id,s.points));const i=new Set,o=g.map(s=>(i.add(s.user_id),{user_id:s.user_id,name:s.name??"User",this_gw:l.get(s.user_id)??0,ocp:s.ocp??0}));return t.forEach(s=>{i.has(s.user_id)||(i.add(s.user_id),o.push({user_id:s.user_id,name:"User",this_gw:s.points,ocp:s.points}))}),o.sort((s,r)=>r.ocp-s.ocp||s.name.localeCompare(r.name)),o},[g,b,n]);return d.useEffect(()=>(document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",()=>{document.body.style.overflow="",document.documentElement.style.overflow=""}),[]),d.useEffect(()=>{p.current&&(p.current.scrollTop=0)},[a]),d.useEffect(()=>{const t=p.current;if(!t)return;const l=()=>{t.scrollTop<0&&(t.scrollTop=0),requestAnimationFrame(()=>{t.scrollTop<0&&(t.scrollTop=0)})};t.addEventListener("scroll",l,{passive:!1}),t.addEventListener("touchmove",l,{passive:!1});const i=s=>{t.scrollTop<=0&&s.deltaY<0&&(s.preventDefault(),s.stopPropagation(),t.scrollTop=0)};t.addEventListener("wheel",i,{passive:!1});const o=s=>{if(t.scrollTop<=0){const r=s.touches[0];if(r){const c=r.clientY,u=m=>{const f=m.touches[0];f&&f.clientY<c&&m.preventDefault()};t.addEventListener("touchmove",u,{passive:!1}),t.addEventListener("touchend",()=>{t.removeEventListener("touchmove",u)},{once:!0})}}};return t.addEventListener("touchstart",o,{passive:!1}),()=>{t.removeEventListener("scroll",l),t.removeEventListener("touchmove",l),t.removeEventListener("wheel",i),t.removeEventListener("touchstart",o)}},[]),d.useEffect(()=>{if(!S&&j?.id&&p.current&&T.current){const t=a==="overall"?P:a==="form5"?_:a==="form10"?L:R,l=t.findIndex(s=>s.user_id===j.id),i=l>=0?t[l].rank||l+1:null;if(i!==null&&i<=8)return;p.current&&(p.current.scrollTop=0);const o=setTimeout(()=>{const s=p.current,r=T.current;s&&r&&setTimeout(()=>{if(s&&r){const c=r.offsetTop,u=s.clientHeight,m=r.offsetHeight,f=c-u/2+m/2;s.style.scrollBehavior="smooth",s.scrollTop=f,setTimeout(()=>{s&&(s.style.scrollBehavior="auto")},1e3)}},500)},150);return()=>clearTimeout(o)}},[S,j?.id,a,P,_,L,R]),e.jsxs("div",{className:"fixed inset-0 bg-slate-50 overflow-hidden flex flex-col",children:[e.jsx("style",{children:`
        @keyframes sparkle {
          0%, 100% {
            opacity: 1;
            transform: scale(1) rotate(0deg);
          }
          25% {
            opacity: 0.8;
            transform: scale(1.1) rotate(-5deg);
          }
          50% {
            opacity: 1;
            transform: scale(1.15) rotate(5deg);
          }
          75% {
            opacity: 0.9;
            transform: scale(1.05) rotate(-3deg);
          }
        }
        .sparkle-trophy {
          animation: sparkle 2s ease-in-out infinite;
          filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.6));
        }
        .sparkle-trophy svg {
          filter: drop-shadow(0 0 2px rgba(251, 191, 36, 0.8));
        }
        @keyframes flash {
          0%, 100% {
            background-color: rgb(209, 250, 229);
          }
          25% {
            background-color: rgb(167, 243, 208);
          }
          50% {
            background-color: rgb(209, 250, 229);
          }
          75% {
            background-color: rgb(167, 243, 208);
          }
        }
        .flash-you-badge {
          animation: flash 1.5s ease-in-out 3;
        }
        .full-width-header-border::after {
          content: '';
          position: absolute;
          left: -1rem;
          right: -1rem;
          bottom: 0;
          height: 1px;
          background-color: #cbd5e1;
          z-index: 1;
        }
      `}),e.jsxs("div",{className:"max-w-6xl mx-auto px-4 pb-0 flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex-shrink-0 bg-slate-50 py-4",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900",children:"Leaderboard"}),e.jsx("p",{className:"mt-2 mb-6 text-sm text-slate-600 w-full",children:"See how you rank against every TotL player in the world."}),e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"flex rounded-full bg-slate-100 p-1.5 border border-slate-200 shadow-sm w-full max-w-md",children:[e.jsx("button",{onClick:()=>C("lastgw"),className:`flex-1 py-2.5 rounded-full text-base font-semibold transition-all ${a==="lastgw"?"bg-[#1C8376] text-white shadow-md":"text-slate-600 hover:text-slate-900 hover:bg-white/50"}`,children:"GW"}),e.jsx("button",{onClick:()=>C("form5"),className:`flex-1 py-2.5 rounded-full text-base font-semibold transition-all ${a==="form5"?"bg-[#1C8376] text-white shadow-md":"text-slate-600 hover:text-slate-900 hover:bg-white/50"}`,children:"5"}),e.jsx("button",{onClick:()=>C("form10"),className:`flex-1 py-2.5 rounded-full text-base font-semibold transition-all ${a==="form10"?"bg-[#1C8376] text-white shadow-md":"text-slate-600 hover:text-slate-900 hover:bg-white/50"}`,children:"10"}),e.jsx("button",{onClick:()=>C("overall"),className:`flex-1 py-2.5 rounded-full text-base font-semibold transition-all flex items-center justify-center ${a==="overall"?"bg-[#1C8376] text-white shadow-md":"text-slate-600 hover:text-slate-900 hover:bg-white/50"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"w-5 h-5",children:e.jsx("g",{children:e.jsx("path",{fill:"currentColor",d:"M16 3c1.1046 0 2 0.89543 2 2h2c1.1046 0 2 0.89543 2 2v1c0 2.695 -2.1323 4.89 -4.8018 4.9941 -0.8777 1.5207 -2.4019 2.6195 -4.1982 2.9209V19h3c0.5523 0 1 0.4477 1 1s-0.4477 1 -1 1H8c-0.55228 0 -1 -0.4477 -1 -1s0.44772 -1 1 -1h3v-3.085c-1.7965 -0.3015 -3.32148 -1.4 -4.19922 -2.9209C4.13175 12.8895 2 10.6947 2 8V7c0 -1.10457 0.89543 -2 2 -2h2c0 -1.10457 0.89543 -2 2 -2zm-8 7c0 2.2091 1.79086 4 4 4 2.2091 0 4 -1.7909 4 -4V5H8zM4 8c0 1.32848 0.86419 2.4532 2.06055 2.8477C6.02137 10.5707 6 10.2878 6 10V7H4zm14 2c0 0.2878 -0.0223 0.5706 -0.0615 0.8477C19.1353 10.4535 20 9.32881 20 8V7h-2z",strokeWidth:"1"})})})})]})}),a==="overall"&&e.jsx("div",{className:"text-center mb-2",children:e.jsx("div",{className:"text-sm text-slate-600",children:"All players overall"})}),a==="form5"&&e.jsx("div",{className:"text-center mb-2",children:n&&n>=5?e.jsx("div",{className:"text-sm text-slate-600",children:"Completed the last 5 Rounds"}):e.jsx("div",{className:"text-sm text-amber-600 font-medium",children:"⚠️ Watch this space! Complete 5 GW in a row to see the 5 Week Form Leaderboard."})}),a==="form10"&&e.jsx("div",{className:"text-center mb-2",children:n&&n>=10?e.jsx("div",{className:"text-sm text-slate-600",children:"Completed the last 10 Rounds"}):e.jsx("div",{className:"text-sm text-amber-600 font-medium",children:"⚠️ Watch this space! Complete 10 GW in a row to see the 10 Week Form Leaderboard."})}),a==="lastgw"&&e.jsx("div",{className:"text-center mb-2",children:e.jsxs("div",{className:"text-sm text-slate-600",children:["Players who completed GW",n]})})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden min-h-0",children:[M&&e.jsx("div",{className:"mb-6 rounded border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700 flex-shrink-0",children:M}),S?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#1C8376]"})}):a==="form5"&&n&&n<5?e.jsxs("div",{className:"rounded-2xl border border-slate-200 bg-white p-12 text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-slate-700 mb-2",children:"5 Week Form Leaderboard Coming Soon"}),e.jsx("div",{className:"text-slate-600",children:"Complete 5 game weeks in a row to unlock the 5 Week Form Leaderboard and see who's in the best form!"})]}):a==="form10"&&n&&n<10?e.jsxs("div",{className:"rounded-2xl border border-slate-200 bg-white p-12 text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-slate-700 mb-2",children:"10 Week Form Leaderboard Coming Soon"}),e.jsx("div",{className:"text-slate-600",children:"Complete 10 game weeks in a row to unlock the 10 Week Form Leaderboard and see who's in the best form!"})]}):(a==="overall"?P:a==="form5"?_:a==="form10"?L:R).length===0?e.jsx("div",{className:"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600",children:"No leaderboard data yet."}):e.jsx("div",{ref:p,className:"flex-1 overflow-y-auto overflow-x-hidden -mx-4 sm:mx-0 rounded-none sm:rounded-2xl border-x-0 sm:border-x border-b border-slate-200 bg-slate-50 shadow-sm",style:{overscrollBehavior:"contain",WebkitOverflowScrolling:"touch",minHeight:0,paddingBottom:"100px",paddingLeft:"1rem",paddingRight:"1rem",backgroundColor:"#f8fafc",touchAction:"pan-y"},children:e.jsxs("table",{className:"w-full text-sm border-collapse",style:{tableLayout:"fixed",backgroundColor:"#f8fafc"},children:[e.jsx("thead",{className:"sticky top-0 full-width-header-border",style:{position:"sticky",top:0,zIndex:25,backgroundColor:"#f8fafc",display:"table-header-group"},children:e.jsxs("tr",{style:{backgroundColor:"#f8fafc",borderBottom:"1px solid #cbd5e1"},children:[e.jsx("th",{className:"py-3 text-left font-normal",style:{backgroundColor:"#f8fafc",width:"45px",paddingLeft:"0.5rem",paddingRight:"0.5rem",color:"#64748b"},children:"#"}),e.jsx("th",{className:"px-4 py-3 text-left font-normal text-xs",style:{backgroundColor:"#f8fafc",color:"#64748b"},children:"Player"}),a==="overall"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-center font-semibold",style:{backgroundColor:"#f8fafc",width:"40px",borderTop:"none",paddingLeft:"0.5rem",paddingRight:"0.5rem"}}),e.jsxs("th",{className:"px-1 py-3 text-center font-normal",style:{backgroundColor:"#f8fafc",width:"55px",color:"#64748b",paddingLeft:"0.5rem",paddingRight:"0.5rem"},children:["GW",n||"?"]}),e.jsx("th",{className:"py-3 text-center font-normal",style:{backgroundColor:"#f8fafc",width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",color:"#64748b"},children:"OCP"})]}),(a==="form5"||a==="form10")&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-center font-semibold",style:{backgroundColor:"#f8fafc",width:"40px",borderTop:"none",paddingLeft:"0.5rem",paddingRight:"0.5rem"}}),e.jsx("th",{className:"py-3 text-center font-normal",style:{backgroundColor:"#f8fafc",width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",color:"#64748b"},children:"PTS"})]}),a==="lastgw"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-center font-semibold",style:{backgroundColor:"#f8fafc",width:"40px",borderTop:"none",paddingLeft:"0.5rem",paddingRight:"0.5rem"}}),e.jsxs("th",{className:"py-3 text-center font-normal",style:{backgroundColor:"#f8fafc",width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",color:"#64748b"},children:["GW",n||"?"]})]})]})}),e.jsx("tbody",{children:(a==="overall"?P:a==="form5"?_:a==="form10"?L:R).map((t,l,i)=>{const o=t.user_id===j?.id,s="rank"in t?t.rank:l+1,c=i.filter((h,x)=>("rank"in h?h.rank:x+1)===s).length>1,u=s===1;let m="",f="bg-gray-300";if(a==="overall"){const h=I[t.user_id],x=D[t.user_id];x&&h?x<h?(m="▲",f="bg-green-500 text-white"):x>h?(m="▼",f="bg-red-500 text-white"):(m="→",f="bg-gray-500 text-white"):x&&!h&&(m="",f="bg-gray-400")}return e.jsxs("tr",{ref:o?T:null,className:"",style:{...l>0?{borderTop:"1px solid #e2e8f0",position:"relative",backgroundColor:"#f8fafc"}:{position:"relative",backgroundColor:"#f8fafc"}},children:[e.jsx("td",{className:"py-3 text-left tabular-nums whitespace-nowrap relative",style:{width:"45px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:e.jsxs("span",{children:[s,c?"=":""]})}),e.jsx("td",{className:"px-4 py-3",style:{backgroundColor:"#f8fafc"},children:e.jsxs("div",{className:"flex items-center gap-2",children:[(m||f)&&a==="overall"&&e.jsx("span",{className:`inline-flex items-center justify-center w-4 h-4 rounded-full text-xs font-bold ${f} align-middle flex-shrink-0`,"aria-hidden":!0,children:m}),u&&e.jsx("span",{className:"inline-flex items-center sparkle-trophy flex-shrink-0",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"w-4 h-4 text-yellow-500",children:e.jsx("g",{children:e.jsx("path",{fill:"currentColor",d:"M16 3c1.1046 0 2 0.89543 2 2h2c1.1046 0 2 0.89543 2 2v1c0 2.695 -2.1323 4.89 -4.8018 4.9941 -0.8777 1.5207 -2.4019 2.6195 -4.1982 2.9209V19h3c0.5523 0 1 0.4477 1 1s-0.4477 1 -1 1H8c-0.55228 0 -1 -0.4477 -1 -1s0.44772 -1 1 -1h3v-3.085c-1.7965 -0.3015 -3.32148 -1.4 -4.19922 -2.9209C4.13175 12.8895 2 10.6947 2 8V7c0 -1.10457 0.89543 -2 2 -2h2c0 -1.10457 0.89543 -2 2 -2zm-8 7c0 2.2091 1.79086 4 4 4 2.2091 0 4 -1.7909 4 -4V5H8zM4 8c0 1.32848 0.86419 2.4532 2.06055 2.8477C6.02137 10.5707 6 10.2878 6 10V7H4zm14 2c0 0.2878 -0.0223 0.5706 -0.0615 0.8477C19.1353 10.4535 20 9.32881 20 8V7h-2z",strokeWidth:"1"})})})}),e.jsx("span",{className:"font-normal text-sm truncate min-w-0 whitespace-nowrap",style:{color:"rgb(0, 0, 0)",overflow:"hidden",textOverflow:"ellipsis"},children:t.name}),o&&e.jsx("span",{className:"ml-2 rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-semibold text-emerald-800 flex-shrink-0 flash-you-badge",children:"you"})]})}),a==="overall"&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-center tabular-nums font-bold",style:{width:"40px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"}}),e.jsx("td",{className:"px-1 py-3 text-center tabular-nums font-bold",style:{width:"55px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:"this_gw"in t?t.this_gw:0}),e.jsx("td",{className:"py-3 text-center tabular-nums font-bold",style:{width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:"ocp"in t?t.ocp:0})]}),(a==="form5"||a==="form10")&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-center tabular-nums font-bold",style:{width:"40px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"}}),e.jsx("td",{className:"py-3 text-center tabular-nums font-bold",style:{width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:"formPoints"in t?t.formPoints:0})]}),a==="lastgw"&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-center tabular-nums font-bold",style:{width:"40px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"}}),e.jsx("td",{className:"py-3 text-center tabular-nums font-bold",style:{width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:"points"in t?t.points:0})]})]},t.user_id)})})]})})]})]})]})}export{Z as default};
