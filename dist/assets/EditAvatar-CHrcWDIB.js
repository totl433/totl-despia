import{y as G,u as H,r as l,m as O,B as Z,E as U,F as $,j as e,P as J,U as q,a as k}from"./index-NKiev1v8.js";import{C as Q}from"./index.module-VIxakuXK.js";function K(){const c=G(),{user:a}=H(),[u,g]=l.useState(null),[E,P]=l.useState({x:0,y:0}),[j,C]=l.useState(1),[v,S]=l.useState(null),[d,w]=l.useState(null),[p,f]=l.useState(!1),[b,i]=l.useState(null),[I,x]=l.useState(!1),[L,m]=l.useState(null),R=l.useRef(null);l.useEffect(()=>{a?.id||c("/profile")},[a,c]),l.useEffect(()=>{(async()=>{if(a?.id)try{const{data:t,error:n}=await k.from("users").select("avatar_url").eq("id",a.id).maybeSingle();if(n){console.warn("[EditAvatar] Error checking avatar:",n),m(!1);return}if(!t?.avatar_url){m(!1);return}const o=t.avatar_url.match(/user-avatars\/([^\/]+)\/([^\/]+)/);if(!o){m(!1);return}const[,y,N]=o,{data:h,error:W}=await k.storage.from("user-avatars").list(y,{search:N});if(W||!h||h.length===0){m(!1);return}const D=!!localStorage.getItem(`avatar_uploaded_${a.id}`);m(D)}catch(t){console.warn("[EditAvatar] Error checking avatar:",t),m(!1)}})()},[a?.id]);const F=s=>new Promise((t,n)=>{const r=new Image;r.addEventListener("load",()=>t(r)),r.addEventListener("error",o=>n(o)),r.src=s}),A=async(s,t)=>{const n=await F(s),r=document.createElement("canvas"),o=r.getContext("2d");if(!o)throw new Error("No 2d context");return r.width=t.width,r.height=t.height,o.drawImage(n,t.x,t.y,t.width,t.height,0,0,t.width,t.height),new Promise((y,N)=>{r.toBlob(h=>{if(!h){N(new Error("Canvas is empty"));return}y(h)},"image/png",.9)})},_=l.useCallback(s=>{if(!a?.id){i("You must be logged in to upload an avatar.");return}if(!new Set(["image/png","image/jpeg","image/jpg","image/webp"]).has(s.type)){i("Please upload a PNG, JPG, or WebP image.");return}const n=20*1024*1024;if(s.size>n){i("Please choose an image smaller than 20MB.");return}if(i(null),x(!1),s.size>5*1024*1024)O(s,{maxSizeMB:2,maxWidthOrHeight:1024,useWebWorker:!0,initialQuality:.7}).then(r=>{const o=new FileReader;o.onload=()=>{g(o.result)},o.readAsDataURL(r)}).catch(()=>{i("Failed to process image. Please try a smaller file.")});else{const r=new FileReader;r.onload=()=>{g(r.result)},r.readAsDataURL(s)}},[a?.id]),M=l.useCallback(async(s,t)=>{if(S(t),u)try{const n=await A(u,t),r=URL.createObjectURL(n);w(r)}catch{}},[u]),z=l.useCallback(async()=>{if(!(!u||!v||!a?.id)){i(null),x(!1),f(!0);try{const s=await A(u,v),t=new File([s],"avatar.png",{type:"image/png"});await Z(a.id,t),U(a.id),localStorage.setItem(`avatar_uploaded_${a.id}`,Date.now().toString()),m(!0),x(!0),d&&URL.revokeObjectURL(d),setTimeout(()=>{c("/profile"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("userAvatarUpdated",{detail:{userId:a.id}}))},200)},1e3)}catch(s){i(s?.message??"Failed to upload avatar. Please try again.")}finally{f(!1)}}},[u,v,a?.id,d,c]),B=l.useCallback(async()=>{if(a?.id){i(null),x(!1),f(!0);try{await $(a.id),U(a.id),localStorage.removeItem(`avatar_uploaded_${a.id}`),m(!1),x(!0),setTimeout(()=>{c("/profile"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("userAvatarUpdated",{detail:{userId:a.id}}))},200)},1e3)}catch(s){i(s?.message??"Failed to remove avatar. Please try again.")}finally{f(!1)}}},[a?.id,c]),T=l.useCallback(()=>{d&&URL.revokeObjectURL(d),g(null),w(null),i(null),x(!1),c("/profile")},[d,c]);return a?.id?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-6",children:[e.jsx(J,{title:"Edit Avatar",as:"h1",className:"mb-6"}),e.jsx("div",{className:"bg-white rounded-2xl shadow-lg p-4 sm:p-6",children:u?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-xs text-slate-600",children:[e.jsx("p",{className:"font-medium",children:"Position your image"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Drag to position, use slider to zoom"})]}),e.jsx("div",{className:"relative w-full",style:{height:"280px"},children:e.jsx(Q,{image:u,crop:E,zoom:j,aspect:1,cropShape:"round",showGrid:!1,onCropChange:P,onZoomChange:C,onCropComplete:M,style:{containerStyle:{width:"100%",height:"100%",position:"relative"}}})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("label",{className:"block text-xs font-medium text-slate-700",children:["Zoom: ",Math.round(j*100),"%"]}),e.jsx("input",{type:"range",min:1,max:3,step:.1,value:j,onChange:s=>C(Number(s.target.value)),className:"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-[#1C8376] touch-manipulation",style:{WebkitTapHighlightColor:"transparent"}})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700",children:"Preview:"}),e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-slate-100 border-2 border-slate-300 flex items-center justify-center flex-shrink-0",children:d?e.jsx("img",{src:d,alt:"Preview",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-slate-200"})})]})]}),b&&e.jsx("div",{className:"p-2 bg-red-50 border border-red-200 rounded-lg text-xs text-red-800",children:b}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx("button",{onClick:()=>{g(null),d&&URL.revokeObjectURL(d),w(null),i(null)},disabled:p,className:"flex-1 px-4 py-2 border border-slate-300 rounded-lg text-slate-700 font-medium disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:z,disabled:p||!v,className:"flex-1 px-4 py-2 bg-[#1C8376] text-white rounded-lg font-medium disabled:opacity-50",children:p?"Uploading...":"Save Avatar"})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"text-xs text-slate-600 mb-2 font-medium",children:"Current Avatar:"}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("div",{className:"w-16 h-16 rounded-full overflow-hidden bg-slate-100 flex items-center justify-center border-2 border-slate-200",children:e.jsx(q,{userId:a.id,name:a.user_metadata?.display_name||a.email||void 0,size:64})})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-700 mb-2",children:"Choose Image"}),e.jsx("input",{ref:R,type:"file",accept:"image/png,image/jpeg,image/jpg,image/webp",onChange:s=>{const t=s.target.files?.[0];t&&_(t)},disabled:p,className:"hidden",id:"avatar-upload-input"}),e.jsx("label",{htmlFor:"avatar-upload-input",className:"block w-full border-2 border-dashed border-slate-300 rounded-lg p-6 text-center active:bg-slate-50 active:border-[#1C8376] touch-manipulation cursor-pointer",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("svg",{className:"w-10 h-10 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("div",{className:"text-sm",children:e.jsx("span",{className:"text-[#1C8376] font-semibold",children:"Tap to choose image"})}),e.jsx("p",{className:"text-xs text-slate-500",children:"PNG, JPG, or WebP (up to 20MB - will be optimized automatically)"})]})})]}),p&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-[#1C8376]"}),e.jsx("span",{children:"Processing and uploading..."})]}),I&&e.jsx("div",{className:"p-2 bg-emerald-50 border border-emerald-200 rounded-lg text-xs text-emerald-800",children:"âœ“ Avatar uploaded successfully!"}),b&&e.jsx("div",{className:"p-2 bg-red-50 border border-red-200 rounded-lg text-xs text-red-800",children:b})]}),e.jsxs("div",{className:"mt-6 flex gap-3",children:[e.jsx("button",{onClick:T,disabled:p,className:"flex-1 px-4 py-2 border border-slate-300 rounded-lg text-slate-700 font-medium disabled:opacity-50",children:"Cancel"}),a&&L&&e.jsx("button",{onClick:B,disabled:p,className:"px-4 py-2 bg-red-100 text-red-700 rounded-lg font-medium disabled:opacity-50",children:"Remove Avatar"})]})]})})]})}):null}export{K as default};
