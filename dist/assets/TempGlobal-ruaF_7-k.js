import{r as n,j as e,u as q,c as J,n as $,s as A,o as Q,C as X}from"./index-S46OBmsK.js";const D=n.forwardRef(({row:l,index:u,array:j,activeTab:f,isCurrentUser:L,prevRanks:x,currRanks:k,onUserClick:g},v)=>{const b="rank"in l?l.rank:u+1,i=j.filter((m,y)=>("rank"in m?m.rank:y+1)===b).length>1,N=b===1;let p="",w="bg-gray-300";if(f==="overall"){const m=x[l.user_id],y=k[l.user_id];y&&m?y<m?(p="▲",w="bg-green-500 text-white"):y>m?(p="▼",w="bg-red-500 text-white"):(p="→",w="bg-gray-500 text-white"):y&&!m&&(p="",w="bg-gray-400")}return e.jsxs("tr",{ref:v,onClick:()=>g?.(l.user_id,l.name),style:{...u>0?{borderTop:"1px solid #e2e8f0",position:"relative",backgroundColor:"#f8fafc",cursor:g?"pointer":"default"}:{position:"relative",backgroundColor:"#f8fafc",cursor:g?"pointer":"default"}},className:g?"hover:bg-slate-100 transition-colors":"",children:[e.jsx("td",{className:"py-3 text-left tabular-nums whitespace-nowrap relative",style:{width:"45px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:e.jsxs("span",{children:[b,i?"=":""]})}),e.jsx("td",{className:"px-4 py-3",style:{backgroundColor:"#f8fafc"},children:e.jsxs("div",{className:"flex items-center gap-2",children:[(p||w)&&f==="overall"&&e.jsx("span",{className:`inline-flex items-center justify-center w-4 h-4 rounded-full text-xs font-bold ${w} align-middle flex-shrink-0`,"aria-hidden":!0,children:p}),N&&e.jsx("span",{className:"inline-flex items-center sparkle-trophy flex-shrink-0",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"w-4 h-4 text-yellow-500",children:e.jsx("g",{children:e.jsx("path",{fill:"currentColor",d:"M16 3c1.1046 0 2 0.89543 2 2h2c1.1046 0 2 0.89543 2 2v1c0 2.695 -2.1323 4.89 -4.8018 4.9941 -0.8777 1.5207 -2.4019 2.6195 -4.1982 2.9209V19h3c0.5523 0 1 0.4477 1 1s-0.4477 1 -1 1H8c-0.55228 0 -1 -0.4477 -1 -1s0.44772 -1 1 -1h3v-3.085c-1.7965 -0.3015 -3.32148 -1.4 -4.19922 -2.9209C4.13175 12.8895 2 10.6947 2 8V7c0 -1.10457 0.89543 -2 2 -2h2c0 -1.10457 0.89543 -2 2 -2zm-8 7c0 2.2091 1.79086 4 4 4 2.2091 0 4 -1.7909 4 -4V5H8zM4 8c0 1.32848 0.86419 2.4532 2.06055 2.8477C6.02137 10.5707 6 10.2878 6 10V7H4zm14 2c0 0.2878 -0.0223 0.5706 -0.0615 0.8477C19.1353 10.4535 20 9.32881 20 8V7h-2z",strokeWidth:"1"})})})}),e.jsx("span",{className:"font-normal text-sm truncate min-w-0 whitespace-nowrap",style:{color:"rgb(0, 0, 0)",overflow:"hidden",textOverflow:"ellipsis"},children:l.name}),L&&e.jsx("span",{className:"ml-2 rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-semibold text-emerald-800 flex-shrink-0 flash-you-badge",children:"you"})]})}),f==="overall"&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-center tabular-nums font-bold",style:{width:"40px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"}}),e.jsx("td",{className:"px-1 py-3 text-center tabular-nums font-bold",style:{width:"55px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:"this_gw"in l?l.this_gw:0}),e.jsx("td",{className:"py-3 text-center tabular-nums font-bold",style:{width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:"ocp"in l?l.ocp:0})]}),(f==="form5"||f==="form10")&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-center tabular-nums font-bold",style:{width:"40px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"}}),e.jsx("td",{className:"py-3 text-center tabular-nums font-bold",style:{width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:"formPoints"in l?l.formPoints:0})]}),f==="lastgw"&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-center tabular-nums font-bold",style:{width:"40px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"}}),e.jsx("td",{className:"py-3 text-center tabular-nums font-bold",style:{width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",backgroundColor:"#f8fafc"},children:"points"in l?l.points:0})]})]})});D.displayName="LeaderboardRow";const U=n.forwardRef(({rows:l,activeTab:u,currentUserId:j,prevRanks:f,currRanks:L,latestGw:x,userRowRef:k,onUserClick:g},v)=>e.jsx("div",{ref:v,className:"flex-1 overflow-y-auto overflow-x-hidden -mx-4 sm:mx-0 rounded-none sm:rounded-2xl border-x-0 sm:border-x border-b border-slate-200 bg-slate-50 shadow-sm",style:{overscrollBehavior:"contain",WebkitOverflowScrolling:"touch",paddingTop:"0",paddingBottom:"100px",paddingLeft:"1rem",paddingRight:"1rem",backgroundColor:"#f8fafc",touchAction:"pan-y"},children:e.jsxs("table",{className:"w-full text-sm border-collapse",style:{tableLayout:"fixed",backgroundColor:"#f8fafc"},children:[e.jsx("thead",{className:"sticky top-0 full-width-header-border",style:{position:"sticky",top:0,zIndex:25,backgroundColor:"#f8fafc",display:"table-header-group"},children:e.jsxs("tr",{style:{backgroundColor:"#f8fafc",borderBottom:"1px solid #cbd5e1"},children:[e.jsx("th",{className:"py-3 text-left font-normal",style:{backgroundColor:"#f8fafc",width:"45px",paddingLeft:"0.5rem",paddingRight:"0.5rem",color:"#64748b"},children:"#"}),e.jsx("th",{className:"px-4 py-3 text-left font-normal text-xs",style:{backgroundColor:"#f8fafc",color:"#64748b"},children:"Player"}),u==="overall"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-center font-semibold",style:{backgroundColor:"#f8fafc",width:"40px",borderTop:"none",paddingLeft:"0.5rem",paddingRight:"0.5rem"}}),e.jsxs("th",{className:"px-1 py-3 text-center font-normal",style:{backgroundColor:"#f8fafc",width:"55px",color:"#64748b",paddingLeft:"0.5rem",paddingRight:"0.5rem"},children:["GW",x||"?"]}),e.jsx("th",{className:"py-3 text-center font-normal",style:{backgroundColor:"#f8fafc",width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",color:"#64748b"},children:"OCP"})]}),(u==="form5"||u==="form10")&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-center font-semibold",style:{backgroundColor:"#f8fafc",width:"40px",borderTop:"none",paddingLeft:"0.5rem",paddingRight:"0.5rem"}}),e.jsx("th",{className:"py-3 text-center font-normal",style:{backgroundColor:"#f8fafc",width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem",color:"#64748b"},children:"PTS"})]}),u==="lastgw"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-center font-semibold",style:{backgroundColor:"#f8fafc",width:"40px",borderTop:"none",paddingLeft:"0.5rem",paddingRight:"0.5rem"}}),e.jsxs("th",{className:"py-3 text-center font-semibold",style:{backgroundColor:"#f8fafc",width:"60px",paddingLeft:"0.5rem",paddingRight:"0.5rem"},children:["GW",x||"?"]})]})]})}),e.jsx("tbody",{children:l.map((b,_,i)=>{const N=b.user_id===j;return e.jsx(D,{ref:N?k:null,row:b,index:_,array:i,activeTab:u,isCurrentUser:N,prevRanks:f,currRanks:L,onUserClick:g},b.user_id)})})]})}));U.displayName="LeaderboardTable";function Z({activeTab:l,onTabChange:u}){return e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"flex rounded-full bg-slate-100 p-1.5 border border-slate-200 shadow-sm w-full max-w-md",children:[e.jsx("button",{onClick:()=>u("lastgw"),className:`flex-1 py-2.5 rounded-full text-base font-semibold transition-all ${l==="lastgw"?"bg-[#1C8376] text-white shadow-md":"text-slate-600 hover:text-slate-900 hover:bg-white/50"}`,children:"GW"}),e.jsx("button",{onClick:()=>u("form5"),className:`flex-1 py-2.5 rounded-full text-base font-semibold transition-all ${l==="form5"?"bg-[#1C8376] text-white shadow-md":"text-slate-600 hover:text-slate-900 hover:bg-white/50"}`,children:"5"}),e.jsx("button",{onClick:()=>u("form10"),className:`flex-1 py-2.5 rounded-full text-base font-semibold transition-all ${l==="form10"?"bg-[#1C8376] text-white shadow-md":"text-slate-600 hover:text-slate-900 hover:bg-white/50"}`,children:"10"}),e.jsx("button",{onClick:()=>u("overall"),className:`flex-1 py-2.5 rounded-full text-base font-semibold transition-all flex items-center justify-center ${l==="overall"?"bg-[#1C8376] text-white shadow-md":"text-slate-600 hover:text-slate-900 hover:bg-white/50"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"w-5 h-5",children:e.jsx("g",{children:e.jsx("path",{fill:"currentColor",d:"M16 3c1.1046 0 2 0.89543 2 2h2c1.1046 0 2 0.89543 2 2v1c0 2.695 -2.1323 4.89 -4.8018 4.9941 -0.8777 1.5207 -2.4019 2.6195 -4.1982 2.9209V19h3c0.5523 0 1 0.4477 1 1s-0.4477 1 -1 1H8c-0.55228 0 -1 -0.4477 -1 -1s0.44772 -1 1 -1h3v-3.085c-1.7965 -0.3015 -3.32148 -1.4 -4.19922 -2.9209C4.13175 12.8895 2 10.6947 2 8V7c0 -1.10457 0.89543 -2 2 -2h2c0 -1.10457 0.89543 -2 2 -2zm-8 7c0 2.2091 1.79086 4 4 4 2.2091 0 4 -1.7909 4 -4V5H8zM4 8c0 1.32848 0.86419 2.4532 2.06055 2.8477C6.02137 10.5707 6 10.2878 6 10V7H4zm14 2c0 0.2878 -0.0223 0.5706 -0.0615 0.8477C19.1353 10.4535 20 9.32881 20 8V7h-2z",strokeWidth:"1"})})})})]})})}function te(){const{user:l}=q(),[u,j]=J(),f=n.useRef(null),L=n.useRef(null),x=u.get("tab"),k=x==="form5"||x==="form10"||x==="lastgw"||x==="overall"?x:"lastgw",[g,v]=n.useState(!0),[b,_]=n.useState(""),[i,N]=n.useState(null),[p,w]=n.useState([]),[m,y]=n.useState([]),[F,M]=n.useState({}),[h,O]=n.useState(k);n.useEffect(()=>{x||j({tab:"lastgw"},{replace:!0}),k!==h&&O(k)},[k,x,h,j]);const I=n.useCallback(r=>{O(r),j({tab:r})},[j]);n.useLayoutEffect(()=>{if(!l?.id)return;const r=`global:${l.id}`;try{const s=$(r);s&&s.gwPoints&&Array.isArray(s.gwPoints)&&s.overall&&Array.isArray(s.overall)&&s.gwPoints.length>0&&(console.log("[Global] ✅ Loading from cache (sync):",s.gwPoints.length,"gwPoints"),N(s.latestGw),y(s.gwPoints),w(s.overall),M(s.prevOcp||{}),v(!1))}catch(s){console.warn("[Global] Error loading from cache (sync):",s)}},[l?.id]),n.useEffect(()=>{if(!l?.id){v(!1);return}let r=!0;const s=`global:${l.id}`;let d=!1;try{const t=$(s);t&&t.gwPoints&&Array.isArray(t.gwPoints)&&t.overall&&Array.isArray(t.overall)&&t.gwPoints.length>0?(console.log("[Global] ✅ Loading from cache:",t.gwPoints.length,"gwPoints"),N(t.latestGw),y(t.gwPoints),w(t.overall),M(t.prevOcp||{}),v(!1),d=!0):console.log("[Global] ⚠️ No valid cache found, will fetch fresh data")}catch(t){console.warn("[Global] Error loading from cache, fetching fresh data:",t)}return(async()=>{try{d||v(!0),_("");const[t,o,a]=await Promise.all([A.from("gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),A.from("v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0}),A.from("v_ocp_overall").select("user_id, name, ocp")]);if(t.error)throw t.error;if(o.error)throw o.error;if(a.error)throw a.error;const c=t.data?.gw??1;if(!r)return;const C=o.data??[],P=a.data??[];N(c),y(C),w(P);let R={};if(c&&c>1){const W=C.filter(T=>T.gw<c);for(const T of W)R[T.user_id]=(R[T.user_id]??0)+(T.points??0)}r&&M(R);try{Q(s,{latestGw:c,gwPoints:C,overall:P,prevOcp:R},X.HOME),console.log("[Global] ✅ Cached data for next time")}catch(W){console.warn("[Global] Failed to cache data:",W)}}catch(t){r&&_(t?.message??"Failed to load leaderboard.")}finally{r&&v(!1)}})(),()=>{r=!1}},[l?.id]);const G=n.useCallback(r=>{const s=Object.keys(r);s.sort((t,o)=>(r[o]??0)-(r[t]??0)||t.localeCompare(o));const d={};return s.forEach((t,o)=>d[t]=o+1),d},[]),Y=n.useMemo(()=>{const r={};for(const s of p)r[s.user_id]=s.ocp??0;for(const s of m)s.user_id in r||(r[s.user_id]=s.points??0);return G(r)},[p,m,G]),K=n.useMemo(()=>G(F),[F,G]),S=n.useMemo(()=>r=>{if(!i||i<r)return[];const s=i-r+1,d=m.filter(a=>a.gw>=s&&a.gw<=i),t=new Map;for(const a of p)t.set(a.user_id,{user_id:a.user_id,name:a.name??"User",formPoints:0,weeksPlayed:new Set});for(const a of d){const c=t.get(a.user_id);c?(c.formPoints+=a.points,c.weeksPlayed.add(a.gw)):t.set(a.user_id,{user_id:a.user_id,name:"User",formPoints:a.points,weeksPlayed:new Set([a.gw])})}return Array.from(t.values()).filter(a=>{for(let c=s;c<=i;c++)if(!a.weeksPlayed.has(c))return!1;return!0}).map(a=>({user_id:a.user_id,name:a.name,formPoints:a.formPoints,gamesPlayed:r})).sort((a,c)=>c.formPoints-a.formPoints||a.name.localeCompare(c.name))},[p,m,i]),H=n.useMemo(()=>S(5),[S]),V=n.useMemo(()=>S(10),[S]),z=n.useMemo(()=>{if(!i)return[];const r=m.filter(o=>o.gw===i),s=new Map(p.map(o=>[o.user_id,o.name??"User"])),d=r.map(o=>({user_id:o.user_id,name:s.get(o.user_id)??"User",points:o.points})).sort((o,a)=>a.points-o.points||o.name.localeCompare(a.name));let t=1;return d.map((o,a)=>(a>0&&d[a-1].points!==o.points&&(t=a+1),{...o,rank:t}))},[m,i,p]),B=n.useMemo(()=>{const r=m.filter(t=>t.gw===i),s=new Map;for(const t of r)s.set(t.user_id,t.points);const d=p.map(t=>({user_id:t.user_id,name:t.name??"User",this_gw:s.get(t.user_id)??0,ocp:t.ocp??0}));for(const t of r)d.find(o=>o.user_id===t.user_id)||d.push({user_id:t.user_id,name:"User",this_gw:t.points,ocp:t.points});return d.sort((t,o)=>o.ocp-t.ocp||t.name.localeCompare(o.name)),d},[p,m,i]),E=n.useMemo(()=>h==="overall"?B:h==="form5"?H:h==="form10"?V:z,[h,B,H,V,z]);return n.useEffect(()=>(document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",()=>{document.body.style.overflow="",document.documentElement.style.overflow=""}),[]),n.useEffect(()=>{f.current&&(f.current.scrollTop=0)},[h]),n.useEffect(()=>{const r=f.current;if(!r)return;const s=()=>{r.scrollTop<0&&(r.scrollTop=0),requestAnimationFrame(()=>{r.scrollTop<0&&(r.scrollTop=0)})};r.addEventListener("scroll",s,{passive:!1}),r.addEventListener("touchmove",s,{passive:!1});const d=o=>{r.scrollTop<=0&&o.deltaY<0&&(o.preventDefault(),o.stopPropagation(),r.scrollTop=0)};r.addEventListener("wheel",d,{passive:!1});const t=o=>{if(r.scrollTop<=0){const a=o.touches[0];if(a){const c=a.clientY,C=P=>{const R=P.touches[0];R&&R.clientY<c&&P.preventDefault()};r.addEventListener("touchmove",C,{passive:!1}),r.addEventListener("touchend",()=>{r.removeEventListener("touchmove",C)},{once:!0})}}};return r.addEventListener("touchstart",t,{passive:!1}),()=>{r.removeEventListener("scroll",s),r.removeEventListener("touchmove",s),r.removeEventListener("wheel",d),r.removeEventListener("touchstart",t)}},[]),n.useEffect(()=>{if(!g&&l?.id&&f.current&&L.current){const r=E.findIndex(t=>t.user_id===l.id),s=r>=0?E[r].rank||r+1:null;if(s!==null&&s<=8)return;f.current&&(f.current.scrollTop=0);const d=setTimeout(()=>{const t=f.current,o=L.current;t&&o&&setTimeout(()=>{if(t&&o){const a=o.offsetTop,c=t.clientHeight,C=o.offsetHeight,P=a-c/2+C/2;t.style.scrollBehavior="smooth",t.scrollTop=P,setTimeout(()=>{t&&(t.style.scrollBehavior="auto")},1e3)}},500)},150);return()=>clearTimeout(d)}},[g,l?.id,h,E]),e.jsxs("div",{className:"fixed inset-0 bg-slate-50 overflow-hidden flex flex-col",children:[e.jsx("style",{children:`
        @keyframes sparkle {
          0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
          25% { opacity: 0.8; transform: scale(1.1) rotate(-5deg); }
          50% { opacity: 1; transform: scale(1.15) rotate(5deg); }
          75% { opacity: 0.9; transform: scale(1.05) rotate(-3deg); }
        }
        .sparkle-trophy {
          animation: sparkle 2s ease-in-out infinite;
          filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.6));
        }
        .sparkle-trophy svg {
          filter: drop-shadow(0 0 2px rgba(251, 191, 36, 0.8));
        }
        @keyframes flash {
          0%, 100% { background-color: rgb(209, 250, 229); }
          25% { background-color: rgb(167, 243, 208); }
          50% { background-color: rgb(209, 250, 229); }
          75% { background-color: rgb(167, 243, 208); }
        }
        .flash-you-badge {
          animation: flash 1.5s ease-in-out 3;
        }
        .full-width-header-border::after {
          content: '';
          position: absolute;
          left: -1rem;
          right: -1rem;
          bottom: 0;
          height: 1px;
          background-color: #cbd5e1;
          z-index: 1;
        }
      `}),e.jsxs("div",{className:"max-w-6xl mx-auto px-4 pb-0 flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex-shrink-0 bg-slate-50 py-4",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900",children:"Leaderboard"}),e.jsx("p",{className:"mt-2 mb-6 text-sm text-slate-600 w-full",children:"See how you rank against every TotL player in the world. - COMPONENT VERSION"}),e.jsx(Z,{activeTab:h,onTabChange:I}),h==="overall"&&e.jsx("div",{className:"text-center mb-2",children:e.jsx("div",{className:"text-sm text-slate-600",children:"All players overall"})}),h==="form5"&&e.jsx("div",{className:"text-center mb-2",children:i&&i>=5?e.jsx("div",{className:"text-sm text-slate-600",children:"Completed the last 5 Rounds"}):e.jsx("div",{className:"text-sm text-amber-600 font-medium",children:"⚠️ Watch this space! Complete 5 GW in a row to see the 5 Week Form Leaderboard."})}),h==="form10"&&e.jsx("div",{className:"text-center mb-2",children:i&&i>=10?e.jsx("div",{className:"text-sm text-slate-600",children:"Completed the last 10 Rounds"}):e.jsx("div",{className:"text-sm text-amber-600 font-medium",children:"⚠️ Watch this space! Complete 10 GW in a row to see the 10 Week Form Leaderboard."})}),h==="lastgw"&&e.jsx("div",{className:"text-center mb-2",children:e.jsxs("div",{className:"text-sm text-slate-600",children:["Players who completed GW",i]})})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden min-h-0",children:[b&&e.jsx("div",{className:"mb-6 rounded border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700 flex-shrink-0",children:b}),g?e.jsx("div",{className:"text-slate-500",children:"Loading…"}):h==="form5"&&i&&i<5?e.jsxs("div",{className:"rounded-2xl border border-slate-200 bg-white p-12 text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-slate-700 mb-2",children:"5 Week Form Leaderboard Coming Soon"}),e.jsx("div",{className:"text-slate-600",children:"Complete 5 gameweeks in a row to unlock the 5 Week Form Leaderboard and see who's in the best form!"})]}):h==="form10"&&i&&i<10?e.jsxs("div",{className:"rounded-2xl border border-slate-200 bg-white p-12 text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-slate-700 mb-2",children:"10 Week Form Leaderboard Coming Soon"}),e.jsx("div",{className:"text-slate-600",children:"Complete 10 gameweeks in a row to unlock the 10 Week Form Leaderboard and see who's in the best form!"})]}):E.length===0?e.jsx("div",{className:"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600",children:"No leaderboard data yet."}):e.jsx(U,{ref:f,rows:E,activeTab:h,currentUserId:l?.id,prevRanks:K,currRanks:Y,latestGw:i,userRowRef:L})]})]})]})}export{te as default};
