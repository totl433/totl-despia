import{r as m,j as e,R as yt,L as mt,u as Mt,g as Te,a as Oe,C as ze,s as q}from"./index-Biua6bUl.js";import{S as _t}from"./Section-TdnfMnoU.js";import{M as Pt}from"./MiniLeagueCard-A31v0ALP.js";import{a as Q,b as Qe}from"./teamNames-lueGeFt9.js";import{L as At}from"./leagueStart-Cqug3ruV.js";import{u as Et}from"./useLiveScores-RNlAPvF0.js";function Rt(){const[t,g]=m.useState(!1),a=m.useRef(null),G=m.useRef(null);m.useEffect(()=>{const F=setTimeout(()=>{g(!0)},50);return()=>clearTimeout(F)},[]),m.useEffect(()=>{let F;const J=()=>{F=requestAnimationFrame(()=>{const d=window.scrollY;if(G.current&&a.current){const M=Math.min(1,d/300)*180,p=Math.max(0,1-d/250),E=Math.max(.4,1-d/400),K=d<400;G.current.style.height=K?"130px":"0px",d>0?(a.current.style.opacity=p.toString(),a.current.style.transform=`perspective(1000px) rotateY(${M}deg) scale(${E})`,a.current.style.transition="opacity 0.1s ease-out, transform 0.1s ease-out"):(a.current.style.opacity="1",a.current.style.transform="perspective(1000px) rotateY(0deg) scale(1)",a.current.style.transition="opacity 0.6s ease-out, transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)")}})};return window.addEventListener("scroll",J,{passive:!0}),()=>{window.removeEventListener("scroll",J),cancelAnimationFrame(F)}},[]);const D=t?0:-360;return e.jsx("div",{ref:G,className:"w-full flex justify-center items-start transition-all duration-200",style:{height:"130px",overflow:"hidden",paddingTop:"4px",paddingBottom:"0px",perspective:"1000px"},children:e.jsx("div",{ref:a,style:{opacity:t?1:0,transform:`perspective(1000px) rotateY(${D}deg) scale(1)`,transformStyle:"preserve-3d",transition:"opacity 0.6s ease-out, transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)",willChange:"transform, opacity"},children:e.jsx("img",{src:"/assets/badges/totl-logo1.svg",alt:"TOTL",className:"h-[88px] sm:h-[110px]",style:{filter:"brightness(0)",backfaceVisibility:"hidden"}})})})}const et=yt.memo(function({title:g,badgeSrc:a,badgeAlt:G,linkTo:D,rank:F,total:J,score:d,gw:I,totalFixtures:M,subtitle:p,variant:E="default"}){const K=F&&J&&J>0?`TOP ${Math.round(F/J*100)}%`:"—";return E==="lastGw"?e.jsx(mt,{to:D,className:"flex-shrink-0 w-[148px] h-[148px] rounded-xl border bg-white shadow-sm overflow-hidden cursor-pointer block hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-3 h-full flex flex-col relative",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("div",{className:"flex items-baseline gap-[3px]",style:{marginTop:"-4px"},children:d!==void 0&&M!==void 0?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-[#1C8376]",style:{fontSize:"38px",fontWeight:"normal",lineHeight:"1"},children:d}),e.jsxs("div",{className:"flex items-baseline gap-[4px]",children:[e.jsx("span",{className:"text-slate-500",style:{fontSize:"18px",fontWeight:"normal",lineHeight:"1"},children:"/"}),e.jsx("span",{className:"text-slate-500",style:{fontSize:"18px",fontWeight:"normal",lineHeight:"1"},children:M})]})]}):e.jsx("span",{className:"leading-none text-slate-900",children:"—"})}),e.jsx("svg",{className:"w-4 h-4 text-slate-400 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsxs("div",{className:"text-xs text-slate-500 mb-2",children:["GAME WEEK ",I??"—"]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"text-xs font-semibold text-slate-900",children:K})})]})]})}):e.jsx(mt,{to:D,className:"flex-shrink-0 w-[148px] h-[148px] rounded-xl border bg-white shadow-sm overflow-hidden cursor-pointer block hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-3 h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[a&&e.jsx("img",{src:a,alt:G||g,className:"w-[32px] h-[32px]"}),e.jsx("svg",{className:"w-4 h-4 text-slate-400 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-2",children:p||g}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"text-xs font-semibold text-slate-900",children:K})})]})]})})}),Tt=yt.memo(function({streak:g,last10GwScores:a,latestGw:G}){const D=a,F=D.filter(p=>p.score!==null),J=F.length>0?Math.max(...F.map(p=>p.score)):10,d=0,I=J-d||1,M=60;return e.jsx("div",{className:"flex-shrink-0 w-[340px] sm:w-[400px] h-[148px] rounded-xl border bg-white shadow-sm overflow-hidden hover:shadow-md transition-shadow relative",children:e.jsxs("div",{className:"p-3 h-full flex flex-col",children:[e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"mb-2 relative",style:{height:"70px"},children:e.jsx("div",{className:"relative h-full",children:e.jsx("div",{className:"flex items-end justify-between gap-1 h-full px-1",children:D.map(p=>{const E=p.score!==null,K=p.gw===G,C=p.score??0,H=E?(C-d)/I*M:0;return e.jsxs("div",{className:"flex flex-col items-center justify-end gap-1 flex-1 relative min-w-0",children:[E&&e.jsx("div",{className:`text-xs font-bold mb-0.5 leading-none ${K?"text-[#1C8376]":"text-slate-700"}`,children:C}),e.jsx("div",{className:`w-full rounded-t transition-all ${E?K?"bg-[#1C8376]":"bg-slate-400":"bg-slate-200"}`,style:{height:`${H}px`,minHeight:E?"4px":"0"},title:E?`GW${p.gw}: ${C}`:`GW${p.gw}: Not played`}),e.jsxs("div",{className:`text-[10px] font-medium leading-tight ${E?K?"text-[#1C8376] font-bold":"text-slate-700":"text-slate-400"}`,children:["GW",p.gw]})]},p.gw)})})})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("svg",{className:"w-3 h-3 text-slate-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",strokeWidth:2}),e.jsx("circle",{cx:"12",cy:"12",r:"6",strokeWidth:2}),e.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor"})]}),e.jsxs("span",{className:"text-sm font-semibold text-slate-900",children:["Your Streak"," ",e.jsx("span",{className:"font-bold text-orange-500",children:g>0?`${g} ${g===1?"Week":"Weeks"}`:"Start your streak!"})]})]}),e.jsx("span",{className:"text-[10px] font-medium text-slate-400",children:"Last 10"})]})]})})});function vt({children:t,className:g=""}){return e.jsxs("div",{className:`overflow-x-auto scrollbar-hide ${g}`,style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch",overscrollBehaviorX:"contain",overscrollBehaviorY:"auto",touchAction:"pan-x pan-y pinch-zoom",marginLeft:"-1rem",marginRight:"-1rem",paddingLeft:"1rem",paddingRight:"1rem",width:"calc(100% + 2rem)"},children:[e.jsx("style",{children:".scrollbar-hide::-webkit-scrollbar { display: none; }"}),e.jsx("div",{className:"flex gap-2",style:{width:"max-content",minWidth:"100%"},children:t})]})}function $t({lastGwRank:t,fiveGwRank:g,tenGwRank:a,seasonRank:G,userStreakData:D,latestGw:F}){return e.jsx(_t,{title:"LEADERBOARDS - COMPONENT HP",children:e.jsxs(vt,{children:[e.jsx(et,{title:"Last GW",linkTo:"/global?tab=lastgw",rank:t?.rank??null,total:t?.total??null,score:t?.score,gw:t?.gw,totalFixtures:t?.totalFixtures,variant:"lastGw"}),e.jsx(et,{title:"5-WEEK FORM",badgeSrc:"/assets/5-week-form-badge.png",badgeAlt:"5-Week Form Badge",linkTo:"/global?tab=form5",rank:g?.rank??null,total:g?.total??null}),e.jsx(et,{title:"10-WEEK FORM",badgeSrc:"/assets/10-week-form-badge.png",badgeAlt:"10-Week Form Badge",linkTo:"/global?tab=form10",rank:a?.rank??null,total:a?.total??null}),e.jsx(et,{title:"SEASON RANK",badgeSrc:"/assets/season-rank-badge.png",badgeAlt:"Season Rank Badge",linkTo:"/global?tab=overall",rank:G?.rank??null,total:G?.total??null}),D&&e.jsx(Tt,{streak:D.streak,last10GwScores:D.last10GwScores,latestGw:F??1})]})})}function It({leagues:t,leagueData:g,leagueSubmissions:a,unreadByLeague:G,leagueDataLoading:D,currentGw:F}){return!D&&t.length===0?e.jsxs("section",{className:"mt-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-2 pt-5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-base font-medium text-slate-500 uppercase tracking-wide",children:"Mini Leagues"}),e.jsx("div",{className:"w-4 h-4 rounded-full border border-slate-400 flex items-center justify-center",children:e.jsx("span",{className:"text-[10px] text-slate-500 font-bold",children:"i"})})]})}),e.jsxs("div",{className:"p-6 bg-white rounded-lg border border-slate-200 text-center",children:[e.jsx("div",{className:"text-slate-600 mb-3",children:"You don't have any mini leagues yet."}),e.jsx(mt,{to:"/create-league",className:"inline-block px-4 py-2 bg-[#1C8376] text-white font-semibold rounded-lg hover:bg-[#1C8376]/80 transition-colors no-underline",children:"Create one now!"})]})]}):t.length===0?e.jsxs("section",{className:"mt-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-2 pt-5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-base font-medium text-slate-500 uppercase tracking-wide",children:"Mini Leagues"}),e.jsx("div",{className:"w-4 h-4 rounded-full border border-slate-400 flex items-center justify-center",children:e.jsx("span",{className:"text-[10px] text-slate-500 font-bold",children:"i"})})]})}),e.jsx("div",{className:"p-6 bg-white rounded-lg border border-slate-200 text-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading leagues..."})})]}):e.jsxs("section",{className:"mt-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-2 pt-5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-base font-medium text-slate-500 uppercase tracking-wide",children:"Mini Leagues"}),e.jsx("div",{className:"w-4 h-4 rounded-full border border-slate-400 flex items-center justify-center",children:e.jsx("span",{className:"text-[10px] text-slate-500 font-bold",children:"i"})})]})}),e.jsx("div",{children:e.jsx(vt,{children:Array.from({length:Math.ceil(t.length/3)}).map((J,d)=>{const I=d*3,M=t.slice(I,I+3);return e.jsx("div",{className:"flex flex-col rounded-xl border bg-white overflow-hidden shadow-sm w-[320px]",children:M.map((p,E)=>{const K=G?.[p.id]??0,C=g[p.id],H=C?{id:C.id,members:C.members,userPosition:C.userPosition,positionChange:C.positionChange,submittedMembers:C.submittedMembers,sortedMemberIds:C.sortedMemberIds,latestGwWinners:C.latestGwWinners,latestRelevantGw:C.latestRelevantGw}:void 0;return e.jsxs("div",{className:E<M.length-1?"relative":"",children:[E<M.length-1&&e.jsx("div",{className:"absolute bottom-0 left-4 right-4 h-px bg-slate-200 z-30 pointer-events-none"}),e.jsx("div",{className:"[&>div]:border-0 [&>div]:shadow-none [&>div]:rounded-none [&>div]:bg-transparent relative z-20 [&>div>a]:!p-4",children:e.jsx(Pt,{row:p,data:H,unread:K,submissions:a[p.id],leagueDataLoading:D,currentGw:F,showRanking:!1})})]},p.id)})},d)})})})]})}function Wt(t,g,a=!1){if(t==="FINISHED")return"FT";if(t==="PAUSED")return"HT";if(t==="IN_PLAY"){if(g==null)return"LIVE";if(a)return`${g}'`;if(g>=1&&g<=45)return"First Half";if(g>45&&g<=50)return"45+";if(g>50)return"Second Half"}return"LIVE"}const Dt=({fixture:t,pick:g,liveScore:a,isTestApi:G=!1,showPickButtons:D=!0})=>{const F=t.home_team||t.home_name||t.home_code||"",J=t.away_team||t.away_name||t.away_code||"",d=Q(F),I=Q(J),M=t.kickoff_time?(()=>{const f=new Date(t.kickoff_time),j=String(f.getUTCHours()).padStart(2,"0"),U=String(f.getUTCMinutes()).padStart(2,"0");return`${j}:${U}`})():"—",p=!!a,E=p&&a.status==="IN_PLAY",K=p&&(a.status==="PAUSED"||a.status==="HALF_TIME"||a.status==="HT"),C=p&&a.status==="FINISHED",H=E||K,Be=E||K,ue=p&&(H||C),tt=!ue,we=p&&(H||C)&&!!a.goals,$e=p&&(H||C)&&!!a.red_cards,st=D&&(!G||g!==void 0),at=p&&(H||C)&&a.homeScore>a.awayScore,Ue=p&&(H||C)&&a.awayScore>a.homeScore,Ie=f=>{const j=g===f;let U=!1;return a&&(a.result?U=a.result===f:(f==="H"&&a.homeScore>a.awayScore||f==="A"&&a.awayScore>a.homeScore||f==="D"&&a.homeScore===a.awayScore)&&(U=!0)),{isPicked:j,isCorrectResult:U,isCorrect:j&&U,isWrong:j&&(H||C)&&!U}},Le=Ie("H"),We=Ie("D"),pe=Ie("A"),be=f=>{const j="h-16 rounded-xl border text-sm font-medium transition-all flex items-center justify-center select-none";return E||H?f.isCorrect?`${j} bg-emerald-600 text-white border-emerald-600 animate-pulse shadow-lg shadow-emerald-500/50`:f.isWrong?`${j} bg-[#1C8376] text-white border-[#1C8376]`:f.isPicked?`${j} bg-[#1C8376] text-white border-[#1C8376]`:f.isCorrectResult&&!f.isPicked?`${j} bg-slate-50 text-slate-600 border-2 border-slate-300 animate-pulse`:`${j} bg-slate-50 text-slate-600 border-slate-200`:C?f.isCorrect?`${j} bg-gradient-to-br from-yellow-400 via-orange-500 via-pink-500 to-purple-600 text-white shadow-2xl shadow-yellow-400/40 transform scale-110 rotate-1 relative overflow-hidden before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/70 before:to-transparent before:animate-[shimmer_1.2s_ease-in-out_infinite] after:absolute after:inset-0 after:bg-gradient-to-r after:from-transparent after:via-yellow-200/50 after:to-transparent after:animate-[shimmer_1.8s_ease-in-out_infinite_0.4s]`:f.isWrong?`${j} bg-[#1C8376] text-white border-[#1C8376]`:f.isCorrectResult&&!f.isPicked?`${j} bg-slate-50 text-slate-600 border-4 border-emerald-600`:f.isPicked?`${j} bg-[#1C8376] text-white border-[#1C8376]`:`${j} bg-slate-50 text-slate-600 border-slate-200`:f.isPicked?`${j} bg-[#1C8376] text-white border-[#1C8376]`:`${j} bg-slate-50 text-slate-600 border-slate-200`},De=(f,j)=>{if(!$e)return 0;const U=a.red_cards||[];U.length>0&&console.log(`[FixtureCard] Red cards for ${f} (${j?"home":"away"}):`,{allRedCards:U,teamName:f,homeName:d,awayName:I,liveScoreHomeTeam:a.home_team,liveScoreAwayTeam:a.away_team});const X=U.filter(h=>{if(!h||!h.team)return!1;const O=h.team||"",W=Q(O),se=j?a.home_team?Q(a.home_team):d:a.away_team?Q(a.away_team):I,le=te(W),ye=te(se),ne=j?d:I,ce=te(ne),oe=(Ne,de)=>{const ae=Ne.toLowerCase().trim(),ge=de.toLowerCase().trim();return ae===ge||ae.startsWith(ge+" ")};return W===se||W===f||oe(W,se)||oe(W,f)||oe(W,ne)||oe(le,ye)||oe(le,ce)||le===ye||le===ce||W===Q(j?t.home_team||"":t.away_team||"")||W===Q(j?t.home_name||"":t.away_name||"")||O.toLowerCase()===f.toLowerCase()||O.toLowerCase()===ne.toLowerCase()||le&&ye&&le.toLowerCase()===ye.toLowerCase()});return X.length>0&&console.log(`[FixtureCard] Filtered red cards for ${f}:`,X),X.length},te=f=>f.replace(/^(Ca|Se|At|Es|Gr|Sc|Cr|Fc|Ac|Ad|Ap|Av|Bo|Br|Ce|Ch|Co|Cu|De|Ec|Fe|Fi|Fl|Fo|Fr|Fu|Ga|Go|Gu|He|Ho|Hu|In|It|Ja|Je|Ju|La|Le|Li|Lo|Lu|Ma|Me|Mi|Mo|Na|Ne|Ni|No|Nu|Ol|Os|Pa|Pe|Pi|Po|Pr|Pu|Qu|Ra|Re|Ri|Ro|Ru|Sa|Si|So|Su|Ta|Te|Ti|To|Tr|Tu|Un|Ur|Va|Ve|Vi|Vo|Vu|We|Wi|Wo|Wu|Xa|Xe|Xi|Xo|Xu|Ya|Ye|Yi|Yo|Yu|Za|Ze|Zi|Zo|Zu)\s+/i,"").trim(),Fe=(f,j)=>{if(!we)return null;const U=a.goals||[],X=a.homeScore||0,h=a.awayScore||0,O=[],W=[],se=[];U.forEach(w=>{if(!w||!w.team){se.push(w);return}const N=w.team||"",P=Q(N),V=N.toLowerCase().trim().replace(/[^a-z0-9]/g,""),k=a.home_team?Q(a.home_team):d,R=a.away_team?Q(a.away_team):I,re=k.toLowerCase().replace(/[^a-z0-9]/g,""),ke=R.toLowerCase().replace(/[^a-z0-9]/g,""),Ge=te(P),Ye=te(k),Ke=te(R),Me=(i,x)=>{const b=i.toLowerCase().trim(),u=x.toLowerCase().trim();return b===u||b.startsWith(u+" ")},Ve=[d,k,t.home_team||"",t.home_name||"",a.home_team||""].filter(Boolean),rt=V===re||V.includes("parissaintgermain")&&re==="psg"||re.includes("parissaintgermain")&&V==="psg"||V.includes("parissaintgermain")&&re.includes("parissaintgermain"),nt=V===ke||V.includes("parissaintgermain")&&ke==="psg"||ke.includes("parissaintgermain")&&V==="psg"||V.includes("parissaintgermain")&&ke.includes("parissaintgermain"),n=P===k||Ge===Ye||Me(P,k)||Me(Ge,Ye)||P===Q(t.home_team||"")||P===Q(t.home_name||"")||N.toLowerCase()===d.toLowerCase()||rt||Ve.some(i=>N.toLowerCase()===i.toLowerCase()||Qe(N,i)||Qe(P,Q(i))),o=[I,R,t.away_team||"",t.away_name||"",a.away_team||""].filter(Boolean),s=P===R||Ge===Ke||Me(P,R)||Me(Ge,Ke)||P===Q(t.away_team||"")||P===Q(t.away_name||"")||N.toLowerCase()===I.toLowerCase()||nt||o.some(i=>N.toLowerCase()===i.toLowerCase()||Qe(N,i)||Qe(P,Q(i)));n&&!s?O.push(w):s&&!n?W.push(w):se.push(w)});const le=O.length,ye=W.length,ne=se.length,ce=X-le,oe=h-ye;if(ne>0){let w=0,N=0;se.forEach(P=>{w<ce&&ce>0?(O.push(P),w++):N<oe&&oe>0&&(W.push(P),N++)})}const Ne=O.length,de=W.length,ae=U.length;if(ae!==X+h&&console.warn("[FixtureCard] Goal count mismatch:",{totalGoals:ae,homeScore:X,awayScore:h,expectedTotal:X+h}),Ne!==X||de!==h){console.log("[FixtureCard] Score-based correction needed:",{homeCount:Ne,homeScore:X,awayCount:de,awayScore:h,totalGoals:ae});const w=X-Ne,N=h-de;if(w>0&&N<0){const P=Math.min(Math.abs(N),w),V=[...W].sort((k,R)=>(R.minute??0)-(k.minute??0));for(let k=0;k<P;k++){const R=V[k],re=W.indexOf(R);re>-1&&(W.splice(re,1),O.push(R),console.log("[FixtureCard] Moved goal from away to home:",R.scorer,R.minute))}}else if(N>0&&w<0){const P=Math.min(Math.abs(w),N),V=[...O].sort((k,R)=>(R.minute??0)-(k.minute??0));for(let k=0;k<P;k++){const R=V[k],re=O.indexOf(R);re>-1&&(O.splice(re,1),W.push(R),console.log("[FixtureCard] Moved goal from home to away:",R.scorer,R.minute))}}}(f.toLowerCase().includes("psg")||f.toLowerCase().includes("paris"))&&console.log("[FixtureCard] PSG goal matching debug:",{teamName:f,isHome:j,homeScore:X,awayScore:h,homeGoalCount:O.length,awayGoalCount:W.length,unmatchedCount:ne,allGoals:U.map(w=>({team:w.team,scorer:w.scorer,minute:w.minute,teamId:w.teamId})),homeGoals:O.map(w=>({team:w.team,scorer:w.scorer,minute:w.minute})),awayGoals:W.map(w=>({team:w.team,scorer:w.scorer,minute:w.minute}))});const ge=j?O:W,me=new Map;return ge.forEach(w=>{const N=w.scorer||"Unknown",P=w.minute;me.has(N)||me.set(N,[]),P!=null&&me.get(N).push(P)}),f==="Grêmio"&&ge.length>0&&console.log("[FixtureCard] Grêmio goals debug:",{teamGoals:ge,goalsByScorer:Array.from(me.entries()),goalsByScorerSize:me.size}),me.size===0?null:e.jsx("div",{className:`mt-3 mb-2 flex flex-col ${j?"items-end":"items-start"} gap-0.5`,children:Array.from(me.entries()).map(([w,N],P)=>{const V=N.sort((k,R)=>k-R);return e.jsxs("span",{className:"text-[11px] text-slate-600",children:[w," ",V.map(k=>`${k}'`).join(", ")]},P)})})};return e.jsxs("div",{className:"p-4 !bg-white relative z-0",children:[Be&&e.jsxs("div",{className:"absolute top-3 left-3 flex items-center gap-2 z-10 pb-6",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs font-bold text-red-600",children:"LIVE"})]}),e.jsx("div",{className:`flex flex-col px-2 pb-3 ${H?"pt-4":"pt-1"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 flex flex-col items-end",children:[e.jsxs("div",{className:"flex items-center gap-1 relative",children:[e.jsx("div",{className:`break-words ${at?"font-bold":"font-medium"}`,children:d}),e.jsx("div",{className:"relative flex flex-col items-center",children:e.jsx("img",{src:`/assets/badges/${(t.home_code||F).toUpperCase()}.png`,alt:d,className:"w-5 h-5",onError:f=>{f.currentTarget.style.opacity="0.35"}})})]}),we&&Fe(d,!0)]}),e.jsx("div",{className:"px-4 flex flex-col items-center",children:ue?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 relative",children:[e.jsxs("div",{className:"relative flex flex-col items-center",children:[$e&&De(d,!0)>0&&e.jsx("div",{className:"absolute -top-3 left-1/2 -translate-x-1/2 w-1.5 h-2.5 bg-red-600 rounded-sm z-10"}),e.jsx("span",{className:"font-bold text-base text-slate-900",children:a.homeScore})]}),e.jsx("span",{className:"font-bold text-base text-slate-900",children:"-"}),e.jsxs("div",{className:"relative flex flex-col items-center",children:[$e&&De(I,!1)>0&&e.jsx("div",{className:"absolute -top-3 left-1/2 -translate-x-1/2 w-1.5 h-2.5 bg-red-600 rounded-sm z-10"}),e.jsx("span",{className:"font-bold text-base text-slate-900",children:a.awayScore})]})]}),e.jsx("span",{className:`text-[10px] font-semibold mt-0.5 ${H?"text-red-600":"text-slate-500"}`,children:Wt(a.status,a.minute,G)})]}):tt&&e.jsx("span",{className:"text-slate-500 text-sm",children:M})}),e.jsxs("div",{className:"flex-1 flex flex-col items-start",children:[e.jsxs("div",{className:"flex items-center gap-1 relative",children:[e.jsx("div",{className:"relative flex flex-col items-center",children:e.jsx("img",{src:`/assets/badges/${(t.away_code||J).toUpperCase()}.png`,alt:I,className:"w-5 h-5",onError:f=>{f.currentTarget.style.opacity="0.35"}})}),e.jsx("div",{className:`break-words ${Ue?"font-bold":"font-medium"}`,children:I})]}),we&&Fe(I,!1)]})]})}),st&&e.jsxs("div",{className:"grid grid-cols-3 gap-3 relative",children:[e.jsx("div",{className:`${be(Le)} flex items-center justify-center`,children:e.jsx("span",{className:`${Le.isCorrect?"font-bold":""} ${Le.isWrong&&C?"line-through decoration-2 decoration-white":""}`,children:"Home Win"})}),e.jsx("div",{className:`${be(We)} flex items-center justify-center`,children:e.jsx("span",{className:`${We.isCorrect?"font-bold":""} ${We.isWrong&&C?"line-through decoration-2 decoration-white":""}`,children:"Draw"})}),e.jsx("div",{className:`${be(pe)} flex items-center justify-center`,children:e.jsx("span",{className:`${pe.isCorrect?"font-bold":""} ${pe.isWrong&&C?"line-through decoration-2 decoration-white":""}`,children:"Away Win"})})]})]})};function Ft({value:t,onChange:g}){return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[10px] font-medium transition-colors ${t?"text-slate-400":"text-slate-700"}`,children:"ALL"}),e.jsx("button",{onClick:()=>g(!t),className:"relative inline-flex items-center rounded-full transition-colors focus:outline-none",style:{backgroundColor:t?"#dc2626":"#cbd5e1",width:"48px",height:"24px",border:"none"},"aria-label":t?"Show all games":"Show live games only",children:e.jsx("span",{className:`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-200 ease-in-out ${t?"translate-x-6":"translate-x-0.5"}`})}),e.jsx("span",{className:`text-[10px] font-medium transition-colors ${t?"text-slate-700":"text-slate-400"}`,children:"LIVE"})]})}function Ht({isInApiTestLeague:t,fixtures:g,fixtureCards:a,hasLiveGames:G,showLiveOnly:D,onToggleLiveOnly:F,scoreComponent:J,fixturesLoading:d,hasCheckedCache:I,currentGw:M}){const p=m.useMemo(()=>g.length===0?void 0:`Game Week ${M??g[0]?.gw??1}`,[g,M]);return e.jsx(_t,{title:"Games",subtitle:p,className:"mt-6",headerRight:e.jsxs("div",{className:"flex items-center gap-3",children:[G&&e.jsx(Ft,{value:D,onChange:F}),J]}),children:!I||d?e.jsx("div",{className:"p-4 text-slate-500",children:"Loading fixtures..."}):g.length===0?e.jsx("div",{className:"p-4 text-slate-500",children:"No fixtures yet."}):g.length>0?e.jsx("div",{className:"flex flex-col rounded-xl border bg-white overflow-hidden shadow-sm",children:a.map(({fixture:E,liveScore:K,pick:C},H)=>e.jsxs("div",{className:H<a.length-1?"relative":"",children:[H<a.length-1&&e.jsx("div",{className:"absolute bottom-0 left-4 right-4 h-px bg-slate-200 z-10"}),e.jsx(Dt,{fixture:E,pick:C,liveScore:K,isTestApi:t,showPickButtons:!0})]},E.id))}):null})}function Ot(t){return t.result==="H"||t.result==="D"||t.result==="A"?t.result:null}function Jt(){const{user:t}=Mt(),a=(()=>{let n=t?.id;if(!n&&typeof window<"u")try{const o=localStorage.getItem("totl:user");o&&(n=JSON.parse(o).id)}catch{}if(typeof window>"u"||!n)return{leagues:[],gw:1,latestGw:null,gwPoints:[],allGwPoints:[],overall:[],lastGwRank:null,isInApiTestLeague:!1,fixtures:[],userPicks:{},fixturesLoading:!0,loading:!0,leagueDataLoading:!0,leaderboardDataLoading:!0};try{if(!n)return{leagues:[],gw:1,latestGw:null,gwPoints:[],allGwPoints:[],overall:[],lastGwRank:null,isInApiTestLeague:!1,fixtures:[],userPicks:{},fixturesLoading:!0,loading:!0,leagueDataLoading:!0,leaderboardDataLoading:!0};const o=`home:basic:${n}`,s=Te(o);if(s&&s.leagues&&Array.isArray(s.leagues)&&s.leagues.length>0){let i=[],x={},b=!0;if(s.currentGw){const u=`home:fixtures:${n}:${s.currentGw}`;try{const c=Te(u);c&&c.fixtures&&Array.isArray(c.fixtures)&&c.fixtures.length>0&&(i=c.fixtures,x=c.userPicks||{},b=!1,de.current=!0),ae.current=!0}catch{}}return{leagues:s.leagues,gw:s.currentGw,latestGw:s.latestGw,gwPoints:(s.allGwPoints||[]).filter(u=>u.user_id===n),allGwPoints:s.allGwPoints||[],overall:s.overall||[],lastGwRank:s.lastGwRank||null,isInApiTestLeague:s.isInApiTestLeague||!1,fixtures:i,userPicks:x,fixturesLoading:b,loading:!1,leagueDataLoading:!1,leaderboardDataLoading:!1}}}catch{}return{leagues:[],gw:1,latestGw:null,gwPoints:[],allGwPoints:[],overall:[],lastGwRank:null,isInApiTestLeague:!1,fixtures:[],userPicks:{},fixturesLoading:!0,loading:!0,leagueDataLoading:!0,leaderboardDataLoading:!0}})(),[G,D]=m.useState(a.leagues),[F,J]=m.useState({}),[d,I]=m.useState(a.gw),[M,p]=m.useState(a.latestGw),[E,K]=m.useState(a.gwPoints),[C,H]=m.useState(a.loading),[Be,ue]=m.useState(a.leagueDataLoading),[tt,we]=m.useState(a.leaderboardDataLoading),[$e,st]=m.useState(a.lastGwRank),[at,Ue]=m.useState(null),[Ie,Le]=m.useState(null),[We,pe]=m.useState(null),[be,De]=m.useState(a.allGwPoints),[te,Fe]=m.useState(a.overall),[f,j]=m.useState({}),[U,X]=m.useState({}),[h,O]=m.useState(a.fixtures),[W,se]=m.useState(a.fixturesLoading),[le,ye]=m.useState(a.isInApiTestLeague),[ne,ce]=m.useState(a.userPicks),[oe,Ne]=m.useState(!1),de=m.useRef(a.fixtures.length>0),ae=m.useRef(a.fixtures.length>0||a.isInApiTestLeague),ge=m.useMemo(()=>{if(!h?.length)return[];const n=[];for(const o of h)o.api_match_id&&n.push(o.api_match_id);return n},[h]),me=m.useMemo(()=>{if(!h?.length||!t?.id)return new Map;try{if(!d)return new Map;const n=`home:fixtures:${t.id}:${d}`,o=Te(n);if(o?.liveScores&&Array.isArray(o.liveScores)){const s=new Map;return o.liveScores.forEach(i=>{i.api_match_id&&s.set(i.api_match_id,i)}),s}}catch{}return new Map},[h,t?.id]),{liveScores:w}=Et(void 0,ge.length>0?ge:void 0),N=m.useMemo(()=>{const n=new Map(me);return w.forEach((o,s)=>{n.set(s,o)}),n},[me,w]);m.useEffect(()=>{if(!t?.id||!h.length||!N.size||!d)return;const n=`home:fixtures:${t.id}:${d}`;try{const o=Te(n);if(o){const s=[];N.forEach(i=>{s.push(i)}),Oe(n,{...o,liveScores:s.length>0?s:void 0},ze.HOME)}}catch{}},[t?.id,h,N]);const[P,V]=m.useState({});m.useEffect(()=>{if(!d||!h.length){V({});return}if(!h.some(s=>!s.api_match_id)){V({});return}let o=!0;return(async()=>{try{const{data:s,error:i}=await q.from("app_gw_results").select("fixture_index, result").eq("gw",d);if(!o)return;if(!i&&s){const x={};s.forEach(b=>{(b.result==="H"||b.result==="D"||b.result==="A")&&(x[b.fixture_index]=b.result)}),V(x)}}catch{}})(),()=>{o=!1}},[d,h]);const k=m.useMemo(()=>{const n={};if(!h?.length)return n;for(const o of h)if(o.api_match_id){const s=N.get(o.api_match_id);s&&(n[o.fixture_index]={homeScore:s.home_score??0,awayScore:s.away_score??0,status:s.status||"SCHEDULED",minute:s.minute??null,goals:s.goals??null,red_cards:s.red_cards??null,home_team:s.home_team??null,away_team:s.away_team??null})}else{const s=P[o.fixture_index];s&&(n[o.fixture_index]={homeScore:s==="H"?1:0,awayScore:s==="A"?1:0,status:"FINISHED",minute:null,goals:null,red_cards:null,home_team:null,away_team:null,result:s})}return n},[N,h,P]);m.useEffect(()=>{if(!t?.id){H(!1),we(!1),ue(!1);return}let n=!0;const o=`home:basic:${t.id}`;return G.length>0&&!C||(H(!0),we(!0),ue(!0)),(async()=>{try{const[i,x,b,u,c]=await Promise.all([q.from("league_members").select("leagues(id, name, code, avatar, created_at)").eq("user_id",t.id),q.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),q.from("app_meta").select("current_gw").eq("id",1).maybeSingle(),q.from("app_v_gw_points").select("user_id, gw, points").order("gw",{ascending:!0}),q.from("app_v_ocp_overall").select("user_id, name, ocp")]);if(!n)return;let _=[];i.error?D([]):(_=(i.data??[]).map(Z=>Z.leagues).filter(Z=>Z!==null),D(_),ye(_.some(Z=>Z.name==="API Test")));const $=x.data?.gw??b.data?.current_gw??1,S=b.data?.current_gw??1;I(S),p(S);let T=[],L=null;if(u.error)De([]),K([]);else{T=u.data??[],De(T),K(T.filter(ee=>ee.user_id===t.id));const Z=T.filter(ee=>ee.gw===$);if(Z.length>0){const ee=[...Z].sort((he,xe)=>xe.points-he.points);let fe=1;const _e=ee.map((he,xe)=>(xe>0&&ee[xe-1].points!==he.points&&(fe=xe+1),{...he,rank:fe})),ie=_e.find(he=>he.user_id===t.id);if(ie){const he=_e.filter(xe=>xe.rank===ie.rank).length;L={rank:ie.rank,total:_e.length,score:ie.points,gw:$,totalFixtures:10,isTied:he>1},st(L)}}}let B=[];c.error?Fe([]):(B=c.data??[],Fe(B));try{Oe(o,{leagues:_,currentGw:S,latestGw:S,allGwPoints:T,overall:B,lastGwRank:L,isInApiTestLeague:_.some(Z=>Z.name==="API Test")},ze.HOME)}catch{}H(!1),we(!1)}catch{n&&(H(!1),we(!1))}})(),()=>{n=!1}},[t?.id]);const R=m.useRef(""),re=m.useRef(""),ke=m.useRef(null);m.useEffect(()=>{if(!t?.id||!M)return;if(!be.length||!te.length){Ue(null),Le(null),pe(null);return}const n=JSON.stringify(be.slice(0,10)),o=JSON.stringify(te.slice(0,10));if(R.current===n&&re.current===o&&ke.current===M)return;R.current=n,re.current=o,ke.current=M;let s=!0;return(async()=>{try{const{data:i}=await q.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),x=i?.gw??M,b=(u,c,_)=>{if(c<u)return;const $=be.filter(L=>L.gw>=u&&L.gw<=c),S=new Map;te.forEach(L=>{S.set(L.user_id,{user_id:L.user_id,name:L.name??"User",formPoints:0,weeksPlayed:new Set})}),$.forEach(L=>{const B=S.get(L.user_id);B&&(B.formPoints+=L.points??0,B.weeksPlayed.add(L.gw))});const T=Array.from(S.values()).filter(L=>{for(let B=u;B<=c;B++)if(!L.weeksPlayed.has(B))return!1;return!0}).sort((L,B)=>B.formPoints-L.formPoints||L.name.localeCompare(B.name));if(T.length>0&&s){let L=1;const B=T.map((ee,fe)=>(fe>0&&T[fe-1].formPoints!==ee.formPoints&&(L=fe+1),{...ee,rank:L})),Z=B.find(ee=>ee.user_id===t.id);if(Z){const ee=B.filter(fe=>fe.rank===Z.rank).length;_({rank:Z.rank,total:B.length,isTied:ee>1})}else _(null)}else _(null)};if(x>=5&&b(x-4,x,Ue),x>=10&&b(x-9,x,Le),te.length>0&&s){const u=[...te].sort((S,T)=>(T.ocp??0)-(S.ocp??0)||(S.name??"User").localeCompare(T.name??"User"));let c=1;const _=u.map((S,T)=>(T>0&&(u[T-1].ocp??0)!==(S.ocp??0)&&(c=T+1),{...S,rank:c})),$=_.find(S=>S.user_id===t.id);if($){const S=_.filter(T=>T.rank===$.rank).length;pe({rank:$.rank,total:te.length,isTied:S>1})}else pe(null)}else pe(null)}catch{}})(),()=>{s=!1}},[t?.id,M,be,te]),m.useEffect(()=>{if(!t?.id||!G.length||!d){ue(!1);return}let n=!0;const o=`home:leagueData:${t.id}:${d}`;let s=!1;try{const i=Te(o);if(i&&i.leagueData&&Object.keys(i.leagueData).length>0){const x={};for(const[b,u]of Object.entries(i.leagueData))x[b]={...u,submittedMembers:u.submittedMembers?Array.isArray(u.submittedMembers)?new Set(u.submittedMembers):u.submittedMembers:void 0,latestGwWinners:u.latestGwWinners?Array.isArray(u.latestGwWinners)?new Set(u.latestGwWinners):u.latestGwWinners:void 0};X(x),J(i.leagueSubmissions||{}),ue(!1),s=!0}}catch{}return(async()=>{try{if(!n)return;s||(X({}),ue(!0));const i=G.map(r=>r.id),[x,b,u,c,_]=await Promise.all([q.from("league_members").select("league_id, user_id, users!inner(id, name)").in("league_id",i),q.from("league_message_reads").select("league_id, last_read_at").eq("user_id",t.id).in("league_id",i),q.from("app_gw_submissions").select("user_id").eq("gw",d),q.from("app_gw_results").select("gw, fixture_index, result"),q.from("app_fixtures").select("gw, kickoff_time").in("gw",Array.from({length:Math.min(20,M||20)},(r,v)=>v+1))]);if(!n)return;const $={};(x.data??[]).forEach(r=>{$[r.league_id]||($[r.league_id]=[]),$[r.league_id].push({id:r.users.id,name:r.users.name})});const S=new Set(Object.values($).flat().map(r=>r.id)),T=new Set((u.data??[]).map(r=>r.user_id).filter(r=>S.has(r))),L=new Map;(b.data??[]).forEach(r=>{L.set(r.league_id,r.last_read_at)});const B=G.map(async r=>{const v=($[r.id]??[]).map(Se=>Se.id);if(v.length===0)return{leagueId:r.id,picks:[]};const{data:A}=await q.from("app_picks").select("user_id, gw, fixture_index, pick").in("user_id",v);return{leagueId:r.id,picks:A??[]}}),Z=i.map(async r=>{const v=L.get(r)??"1970-01-01T00:00:00Z",{count:A}=await q.from("league_messages").select("id",{count:"exact",head:!0}).eq("league_id",r).gte("created_at",v).neq("user_id",t.id);return{leagueId:r,count:typeof A=="number"?A:0}}),[ee,fe]=await Promise.all([Promise.all(Z),Promise.all(B)]);if(!n)return;const _e=new Map;(c.data??[]).forEach(r=>{const v=Ot(r);v&&_e.set(`${r.gw}:${r.fixture_index}`,v)});const ie=[...new Set(Array.from(_e.keys()).map(r=>parseInt(r.split(":")[0],10)))].sort((r,v)=>r-v),he=(_.data??[]).filter(r=>ie.length>0?ie.includes(r.gw):r.gw===1),xe={};ee.forEach(({leagueId:r,count:v})=>{xe[r]=v}),j(xe);const ft=new Map;fe.forEach(({leagueId:r,picks:v})=>{ft.set(r,v)});const qe=new Map;he.forEach(r=>{if(r.kickoff_time&&r.gw){const v=new Date(r.kickoff_time),A=new Date(v.getTime()-4500*1e3);(!qe.has(r.gw)||A<qe.get(r.gw))&&qe.set(r.gw,A)}});const Pe=new Map;G.forEach(r=>{const v=r.name&&At[r.name];if(typeof v=="number"){Pe.set(r.id,v);return}if(r.start_gw!==null&&r.start_gw!==void 0){Pe.set(r.id,r.start_gw);return}if(r.created_at){const A=new Date(r.created_at);for(const Se of ie){const Ae=qe.get(Se);if(Ae&&A<=Ae){Pe.set(r.id,Se);return}}if(ie.length>0){Pe.set(r.id,Math.max(...ie)+1);return}}Pe.set(r.id,d)});const He={},ot={};G.forEach(r=>{const v=$[r.id]??[],A=v.map(l=>l.id),Se=A.filter(l=>T.has(l)).length,Ae=A.length;if(ot[r.id]={allSubmitted:Se===Ae&&Ae>0,submittedCount:Se,totalCount:Ae},_e.size===0){const l=v.sort((y,Y)=>y.name.localeCompare(Y.name));He[r.id]={id:r.id,members:l,userPosition:null,positionChange:null,submittedMembers:Array.from(A.filter(y=>T.has(y))),sortedMemberIds:l.map(y=>y.id),latestGwWinners:[],latestRelevantGw:null};return}const ht=Pe.get(r.id)??d,ve=ht===0?ie:ie.filter(l=>l>=ht);if(ve.length===0){const l=v.sort((y,Y)=>y.name.localeCompare(Y.name));He[r.id]={id:r.id,members:l,userPosition:null,positionChange:null,submittedMembers:Array.from(A.filter(y=>T.has(y))),sortedMemberIds:l.map(y=>y.id),latestGwWinners:[],latestRelevantGw:null};return}const jt=ft.get(r.id)??[],xt=new Set(ve),Nt=jt.filter(l=>xt.has(l.gw)),it=new Map;ve.forEach(l=>{it.set(l,new Map)}),_e.forEach((l,y)=>{const[Y,Ce]=y.split(":"),Re=parseInt(Y,10),z=parseInt(Ce,10);xt.has(Re)&&it.get(Re)?.set(z,l)});const lt=new Map,gt=new Map;ve.forEach(l=>{const y=new Map;v.forEach(Y=>y.set(Y.id,{user_id:Y.id,score:0,unicorns:0})),lt.set(l,y)});const ct=new Map;Nt.forEach(l=>{const y=`${l.gw}:${l.fixture_index}`,Y=ct.get(y)??[];Y.push(l),ct.set(y,Y)});const kt=new Set(v.map(l=>l.id));ve.forEach(l=>{const y=it.get(l),Y=lt.get(l);y.forEach((Ce,Re)=>{const z=`${l}:${Re}`,Ze=(ct.get(z)??[]).filter(je=>kt.has(je.user_id)),ut=[];if(Ze.forEach(je=>{if(je.pick===Ce){const bt=Y.get(je.user_id);bt&&(bt.score+=1,ut.push(je.user_id))}}),ut.length===1&&v.length>=3){const je=Y.get(ut[0]);je&&(je.unicorns+=1)}})});const Ee=new Map,Je=new Map,Xe=new Map;v.forEach(l=>{Ee.set(l.id,0),Je.set(l.id,0),Xe.set(l.id,0)}),ve.forEach(l=>{const y=Array.from(lt.get(l).values());if(y.forEach(z=>{Je.set(z.user_id,(Je.get(z.user_id)??0)+z.score),Xe.set(z.user_id,(Xe.get(z.user_id)??0)+z.unicorns)}),y.sort((z,Ze)=>Ze.score-z.score||Ze.unicorns-z.unicorns),y.length===0)return;const Y=y[0],Ce=y.filter(z=>z.score===Y.score&&z.unicorns===Y.unicorns),Re=new Set(Ce.map(z=>z.user_id));gt.set(l,Re),Ce.length===1?Ee.set(Y.user_id,(Ee.get(Y.user_id)??0)+3):Ce.forEach(z=>{Ee.set(z.user_id,(Ee.get(z.user_id)??0)+1)})});const wt=[...v.map(l=>({user_id:l.id,name:l.name,mltPts:Ee.get(l.id)??0,unicorns:Xe.get(l.id)??0,ocp:Je.get(l.id)??0}))].sort((l,y)=>y.mltPts-l.mltPts||y.unicorns-l.unicorns||y.ocp-l.ocp||l.name.localeCompare(y.name)),St=wt.map(l=>l.user_id),pt=wt.findIndex(l=>l.user_id===t.id),Ct=pt!==-1?pt+1:null,dt=ve.length?Math.max(...ve):null,Lt=dt!==null?gt.get(dt)??new Set:new Set,Gt=v.sort((l,y)=>l.name.localeCompare(y.name));He[r.id]={id:r.id,members:Gt,userPosition:Ct,positionChange:null,submittedMembers:Array.from(A.filter(l=>T.has(l))),sortedMemberIds:St,latestGwWinners:Array.from(Lt),latestRelevantGw:dt}}),J(ot),X(He),ue(!1);try{const r={};for(const[v,A]of Object.entries(He))r[v]={...A,submittedMembers:A.submittedMembers?A.submittedMembers instanceof Set?Array.from(A.submittedMembers):A.submittedMembers:void 0,latestGwWinners:A.latestGwWinners?A.latestGwWinners instanceof Set?Array.from(A.latestGwWinners):A.latestGwWinners:void 0};Oe(o,{leagueData:r,leagueSubmissions:ot},ze.HOME)}catch{}}catch{ue(!1)}})(),()=>{n=!1}},[t?.id,G,d]),m.useEffect(()=>{if(!t?.id||!d){O([]),se(!1),ce({}),de.current=!1;return}if(de.current&&h.length>0){(async()=>{try{const[s,i]=await Promise.all([q.from("app_fixtures").select("id, gw, fixture_index, api_match_id, home_code, away_code, home_team, away_team, home_name, away_name, kickoff_time").eq("gw",d).order("fixture_index",{ascending:!0}),q.from("app_picks").select("fixture_index, pick").eq("gw",d).eq("user_id",t.id)]),x=s.error?[]:s.data??[],b={};i.error||(i.data??[]).forEach(c=>{b[c.fixture_index]=c.pick}),O(x),ce(b);const u=`home:fixtures:${t.id}:${d}`;try{const c=[];N.forEach(_=>{c.push(_)}),Oe(u,{fixtures:x,userPicks:b,liveScores:c.length>0?c:void 0},ze.HOME)}catch{}}catch{}})();return}let n=!0,o=!1;return(async()=>{try{const s=`home:fixtures:${t.id}:${d}`;try{const c=Te(s);c&&c.fixtures&&Array.isArray(c.fixtures)&&c.fixtures.length>0&&(O(c.fixtures),ce(c.userPicks||{}),se(!1),o=!0,de.current=!0),ae.current=!0}catch{}o||se(!0);const[i,x]=await Promise.all([q.from("app_fixtures").select("id, gw, fixture_index, api_match_id, home_code, away_code, home_team, away_team, home_name, away_name, kickoff_time").eq("gw",d).order("fixture_index",{ascending:!0}),q.from("app_picks").select("fixture_index, pick").eq("gw",d).eq("user_id",t.id)]);if(!n)return;const b=i.error?[]:i.data??[],u={};x.error||(x.data??[]).forEach(c=>{u[c.fixture_index]=c.pick}),O(b),ce(u),se(!1),de.current=!1,ae.current=!0;try{const c=[];N.forEach(_=>{c.push(_)}),Oe(s,{fixtures:b,userPicks:u,liveScores:c.length>0?c:void 0},ze.HOME)}catch{}}catch{n&&(O([]),se(!1),ce({}),ae.current=!0)}})(),()=>{n=!1}},[t?.id,d]);const Ge=m.useMemo(()=>{if(!h.length)return null;const n=Object.keys(ne).length>0;let o=0,s=0,i=0,x=!0,b=!1;for(const c of h){const _=k[c.fixture_index],$=ne[c.fixture_index],S=_?.status;if(S==="IN_PLAY"||S==="PAUSED"||S==="FINISHED"){if(b=!0,(S==="IN_PLAY"||S==="PAUSED")&&s++,S==="FINISHED"&&i++,S!=="FINISHED"&&(x=!1),$&&_){let L=!1;_.result?L=_.result===$:L=$==="H"&&_.homeScore>_.awayScore||$==="A"&&_.awayScore>_.homeScore||$==="D"&&_.homeScore===_.awayScore,L&&o++}}else x=!1}if(!b&&!n)return null;const u=({score:c,label:_,bgColor:$,icon:S})=>e.jsxs("div",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-white ${$}`,children:[S,e.jsx("span",{className:"text-xs sm:text-sm font-medium opacity-90",children:_}),e.jsxs("span",{className:"flex items-baseline gap-0.5",children:[e.jsx("span",{className:"text-lg sm:text-xl font-extrabold",children:c}),e.jsx("span",{className:"text-sm sm:text-base font-medium opacity-90",children:"/"}),e.jsx("span",{className:"text-base sm:text-lg font-semibold opacity-80",children:h.length})]})]});return!b&&n?e.jsx(u,{score:"--",label:"Score",bgColor:"bg-amber-500 shadow-lg shadow-amber-500/30"}):s===0&&i>0&&!x?e.jsx("div",{className:"flex flex-col items-center gap-2",children:e.jsx(u,{score:o,label:"Score",bgColor:"bg-slate-600",icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})})}):e.jsx("div",{className:"flex flex-col items-center gap-2",children:e.jsx(u,{score:o,label:x?"Score":"Live",bgColor:x?"bg-slate-600":"bg-red-600",icon:x?e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})}):s>0?e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}):void 0})})},[le,h,k,ne]),Ye=m.useMemo(()=>{if(!h.length)return!1;for(const n of h){const o=k[n.fixture_index];if(o&&(o.status==="IN_PLAY"||o.status==="PAUSED"))return!0}return!1},[h,k]),Ke=m.useMemo(()=>{if(!t?.id||!M)return null;const n=E.filter(u=>u.user_id===t.id).sort((u,c)=>c.gw-u.gw);if(n.length===0)return null;let o=0,s=M;const i=new Set(n.map(u=>u.gw));for(;s>=1&&i.has(s);)o++,s--;const x=[],b=Math.max(1,M-9);for(let u=M;u>=b;u--){const c=n.find(_=>_.gw===u);x.push({gw:u,score:c?c.points:null})}return{streak:o,last10GwScores:x.reverse()}},[t?.id,E,M]),Me=m.useMemo(()=>G.length?[...G].filter(n=>n.name!=="API Test").sort((n,o)=>{const s=f?.[n.id]??0,i=f?.[o.id]??0;return s>0&&i===0?-1:s===0&&i>0?1:n.name.localeCompare(o.name)}):[],[G,f]),Ve=m.useMemo(()=>oe?h.filter(n=>{const o=k[n.fixture_index];return o&&(o.status==="IN_PLAY"||o.status==="PAUSED")}):h,[h,k,oe]),rt=m.useMemo(()=>Ve.map(n=>{const o={id:n.id,gw:n.gw,fixture_index:n.fixture_index,home_code:n.home_code,away_code:n.away_code,home_team:n.home_team,away_team:n.away_team,home_name:n.home_name,away_name:n.away_name,kickoff_time:n.kickoff_time,api_match_id:n.api_match_id??null},s=k[n.fixture_index],i=s?{status:s.status,minute:s.minute??null,homeScore:s.homeScore,awayScore:s.awayScore,home_team:s.home_team??null,away_team:s.away_team??null,goals:s.goals??void 0,red_cards:s.red_cards??void 0}:null;return{fixture:o,liveScore:i,pick:ne[n.fixture_index]}}),[Ve,k,ne]),nt=!C&&!tt&&!Be;return e.jsxs("div",{className:"max-w-6xl mx-auto px-4 pt-2 pb-4 min-h-screen relative",children:[e.jsx(Rt,{}),nt?e.jsxs(e.Fragment,{children:[e.jsx($t,{lastGwRank:$e,fiveGwRank:at,tenGwRank:Ie,seasonRank:We,userStreakData:Ke,latestGw:M}),e.jsx(It,{leagues:Me,leagueData:U,leagueSubmissions:F,unreadByLeague:f,leagueDataLoading:Be,currentGw:d}),e.jsx(Ht,{isInApiTestLeague:le,fixtures:h,fixtureCards:rt,hasLiveGames:Ye,showLiveOnly:oe,onToggleLiveOnly:Ne,scoreComponent:Ge,fixturesLoading:W,hasCheckedCache:ae.current,currentGw:d}),e.jsx("div",{className:"h-20"})]}):e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#1C8376]"})})]})}export{Jt as default};
