import{o as I,j as s,s as j,q as W,u as L,r as R,L as H,P as U}from"./index-Cop16kzC.js";import{T as B}from"./TeamBadge-DgFcCB14.js";const E=I.memo(function({label:e,value:v,subcopy:c,loading:f=!1,className:w=""}){return f?s.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${w}`,children:[s.jsx("div",{className:"text-sm text-slate-500 mb-2",children:e}),s.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]}):s.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${w}`,children:[s.jsx("div",{className:"text-sm font-medium text-slate-600 mb-2",children:e}),s.jsx("div",{className:"text-2xl font-bold text-slate-800 mb-1",children:v}),c&&s.jsx("div",{className:"text-sm text-slate-500 mt-2",children:c})]})}),O=I.memo(function({label:e,streakCount:v,gwRange:c,subcopy:f,extraLine:w,loading:$=!1,className:u=""}){return $?s.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${u}`,children:[s.jsx("div",{className:"text-sm text-slate-500 mb-2",children:e}),s.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]}):s.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${u}`,children:[s.jsx("div",{className:"text-sm font-medium text-slate-600 mb-2",children:e}),s.jsxs("div",{className:"text-4xl font-bold text-slate-800 mb-2 flex items-baseline gap-2",children:[s.jsx("span",{children:v}),s.jsxs("span",{className:"text-base font-normal text-slate-600",children:["Top 25% from ",c]})]}),w&&s.jsxs("div",{className:"text-sm text-slate-500 italic mb-2",children:['"',w,'"']}),f&&s.jsxs("div",{className:"text-sm text-slate-500 mt-2 italic",children:['"',f,'"']})]})}),D=I.memo(function({label:e,teamCode:v,teamName:c,percentage:f,isCorrect:w,subcopy:$,loading:u=!1,className:x=""}){if(u)return s.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${x}`,children:[s.jsx("div",{className:"text-sm text-slate-500 mb-2",children:e}),s.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"})]});const _=f%1===0?f.toFixed(0):f.toFixed(2);return s.jsxs("div",{className:`bg-white rounded-xl shadow-md p-6 ${x}`,children:[s.jsx("div",{className:"text-sm font-medium text-slate-600 mb-3",children:e}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(B,{code:v,size:32}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"text-lg font-bold text-slate-800 truncate",children:c}),s.jsxs("div",{className:`text-base font-semibold ${w?"text-green-600":"text-red-600"}`,children:[_,"% ",w?"correct":"incorrect"]})]})]}),$&&s.jsxs("div",{className:"text-sm text-slate-500 mt-3 italic",children:['"',$,'"']})]})});function F(p,e){if(e.length===0)return 50;const c=e.filter(f=>f<=p).length/e.length*100;return Math.round(c*100)/100}async function Y(p){const e={lastCompletedGw:null,lastCompletedGwPercentile:null,overallPercentile:null,correctPredictionRate:null,bestStreak:0,bestStreakGwRange:null,avgPointsPerWeek:null,bestSingleGw:null,lowestSingleGw:null,chaosIndex:null,chaosCorrectCount:null,chaosTotalCount:null,mostCorrectTeam:null,mostIncorrectTeam:null};try{const{data:v}=await j.from("app_gw_results").select("gw").order("gw",{ascending:!1}).limit(1).maybeSingle(),c=v?.gw||null;if(e.lastCompletedGw=c,!c)return e;if(c){const{data:n}=await j.from("app_v_gw_points").select("user_id, points").eq("gw",c);if(n&&n.length>0){const i=n.map(l=>l.points||0),d=n.find(l=>l.user_id===p)?.points||0;e.lastCompletedGwPercentile=F(d,i)}}const{data:f}=await j.from("v_ocp_overall").select("user_id, ocp").order("ocp",{ascending:!1});if(f&&f.length>0){const n=f.map(d=>d.ocp||0),i=f.find(d=>d.user_id===p)?.ocp||0;e.overallPercentile=F(i,n)}const[w,$]=await Promise.all([j.from("app_picks").select("gw, fixture_index, pick").eq("user_id",p),j.from("picks").select("gw, fixture_index, pick").eq("user_id",p)]),u=new Map;$.data&&$.data.forEach(n=>{const i=`${n.gw}:${n.fixture_index}`;u.set(i,n)}),w.data&&w.data.forEach(n=>{const i=`${n.gw}:${n.fixture_index}`;u.set(i,n)});const x=Array.from(u.values());console.log("[userStats] Picks from app_picks:",w.data?.length||0),console.log("[userStats] Picks from picks table:",$.data?.length||0),console.log("[userStats] Total unique picks (combined):",x.length),w.error&&console.error("[userStats] Error fetching app_picks:",w.error),$.error&&$.error.code!=="PGRST116"&&console.error("[userStats] Error fetching picks:",$.error);const{data:_,error:M}=await j.from("app_gw_results").select("gw, fixture_index, result");if(console.log("[userStats] Total results fetched:",_?.length||0),M&&console.error("[userStats] Error fetching results:",M),x&&_){const n=new Map;_.forEach(l=>{l.result&&n.set(`${l.gw}:${l.fixture_index}`,l.result)});let i=0,d=0;x.forEach(l=>{const P=n.get(`${l.gw}:${l.fixture_index}`);P&&(d++,l.pick===P&&i++)}),d>0&&(e.correctPredictionRate=i/d*100)}const{data:A}=await j.from("app_v_gw_points").select("gw, points").eq("user_id",p).order("gw",{ascending:!0});if(A&&A.length>0){const n=A.reduce((o,r)=>o+(r.points||0),0);e.avgPointsPerWeek=n/A.length;const i=new Set,{data:d}=await j.from("app_gw_results").select("gw").order("gw",{ascending:!0});d?.forEach(o=>{i.add(o.gw)});const{data:l}=await j.from("app_v_gw_points").select("gw, user_id, points").in("gw",Array.from(i)),P=new Map,h=new Map;l&&l.forEach(o=>{const r=o.gw;h.has(r)||h.set(r,[]),h.get(r).push({user_id:o.user_id,points:o.points||0})});for(const o of Array.from(i).sort((r,G)=>r-G)){const r=h.get(o);if(r&&r.length>0){const G=r.map(T=>T.points),C=r.find(T=>T.user_id===p)?.points||0,N=F(C,G);P.set(o,N)}}let b=0,k=0,y=0,t=0,g=0;const S=Array.from(i).sort((o,r)=>o-r);console.log("[userStats] Calculating best streak. Completed GWs:",S),console.log("[userStats] User percentiles per GW:",Array.from(P.entries()).map(([o,r])=>({gw:o,percentile:r.toFixed(2),inTop25:r>=75})));for(const o of S){const r=P.get(o);r!==void 0&&r>=75?(b===0&&(g=o),b++,b>k&&(k=b,y=g,t=o)):(b>0&&console.log(`[userStats] Streak broken at GW${o} (percentile: ${r?.toFixed(2)||"N/A"}). Previous streak was ${b} games`),b=0)}e.bestStreak=k,k>0?(e.bestStreakGwRange=`GW${y}–GW${t}`,console.log(`[userStats] Best streak: ${k} games from ${e.bestStreakGwRange}`)):console.log("[userStats] No streak found (user never in top 25%)");let a={points:-1,gw:0},m={points:999,gw:0};A.forEach(o=>{const r=o.points||0;r>a.points&&(a={points:r,gw:o.gw}),r<m.points&&(m={points:r,gw:o.gw})}),a.points>=0&&(e.bestSingleGw=a),m.points<999&&(e.lowestSingleGw=m)}if(x&&x.length>0){const n=new Set;if(x.forEach(i=>{n.add(`${i.gw}:${i.fixture_index}`)}),n.size>0){const i=Array.from(n).map(a=>parseInt(a.split(":")[0])),d=new Set(i),[l,P]=await Promise.all([j.from("app_picks").select("gw, fixture_index, pick").in("gw",Array.from(d)),j.from("picks").select("gw, fixture_index, pick").in("gw",Array.from(d))]),h=new Map;P.data&&P.data.forEach(a=>{const m=`${a.gw}:${a.fixture_index}`;if(n.has(m)){h.has(m)||h.set(m,new Map);const o=h.get(m);o.set(a.pick,(o.get(a.pick)||0)+1)}}),l.data&&l.data.forEach(a=>{const m=`${a.gw}:${a.fixture_index}`;if(n.has(m)){h.has(m)||h.set(m,new Map);const o=h.get(m);o.set(a.pick,(o.get(a.pick)||0)+1)}});let b=0;h.forEach(a=>{b+=Array.from(a.values()).reduce((m,o)=>m+o,0)}),console.log(`[userStats] Chaos Index: Checking ${x.length} user picks across ${n.size} fixtures`),console.log(`[userStats] Chaos Index: Found ${b} total picks from all users across all fixtures`);let k=0,y=0,t=0;const g=new Map;_&&_.forEach(a=>{a.result&&g.set(`${a.gw}:${a.fixture_index}`,a.result)});let S=!1;x.forEach(a=>{const m=`${a.gw}:${a.fixture_index}`,o=h.get(m);if(o){const r=Array.from(o.values()).reduce((N,T)=>N+T,0),G=o.get(a.pick)||0,C=r>0?G/r*100:0;if(!S&&r>0){const N=o.get("H")||0,T=o.get("D")||0,q=o.get("A")||0;console.log(`[userStats] Chaos Index sample: GW${a.gw} fixture ${a.fixture_index}, user picked ${a.pick}, totals: H=${N}, D=${T}, A=${q}, total=${r}, userPickPercentage=${C.toFixed(2)}%`),S=!0}if(t++,C<=25){k++;const N=g.get(m);N&&a.pick===N&&y++}}else console.warn(`[userStats] Chaos Index: No pick counts found for ${m}`)}),t>0&&(e.chaosIndex=k/t*100,e.chaosCorrectCount=y,e.chaosTotalCount=k,console.log(`[userStats] Chaos Index: ${e.chaosIndex.toFixed(2)}% (${k} of ${t} picks, ${y} correct)`),console.log(`[userStats] Chaos Index breakdown: ${t} total picks, ${k} chaos picks`))}}if(x&&_){const n=new Map;_.forEach(d=>{d.result&&n.set(`${d.gw}:${d.fixture_index}`,d.result)});const{data:i}=await j.from("app_fixtures").select("gw, fixture_index, home_code, away_code, home_team, away_team, home_name, away_name");if(i){const d=new Map;i.forEach(t=>{d.set(`${t.gw}:${t.fixture_index}`,t)});const l=new Map,P=new Map;x.forEach(t=>{P.set(`${t.gw}:${t.fixture_index}`,t.pick)}),i.forEach(t=>{const g=n.get(`${t.gw}:${t.fixture_index}`),S=P.get(`${t.gw}:${t.fixture_index}`);if(!g||!S)return;const a=t.home_name||t.home_team||"",m=t.away_name||t.away_team||"",o={code:t.home_code,name:t.home_code?W(t.home_code):a},r={code:t.away_code,name:t.away_code?W(t.away_code):m};if(o.code){const G=o.code.toUpperCase(),C=l.get(G)||{correct:0,total:0,code:o.code,name:o.name};C.total++,(S==="H"&&g==="H"||S==="D"&&g==="D")&&C.correct++,l.set(G,C)}if(r.code){const G=r.code.toUpperCase(),C=l.get(G)||{correct:0,total:0,code:r.code,name:r.name};C.total++,(S==="A"&&g==="A"||S==="D"&&g==="D")&&C.correct++,l.set(G,C)}});const h=Array.from(l.entries()).map(([t,g])=>({code:t,name:g.name,correct:g.correct,total:g.total,percentage:(g.correct/g.total*100).toFixed(2)}));console.log("[userStats] All team prediction stats:",JSON.stringify(h,null,2)),console.log("[userStats] Teams with >= 3 picks:",JSON.stringify(h.filter(t=>t.total>=3),null,2));let b=0;l.forEach(t=>{b+=t.total}),console.log("[userStats] Total picks processed for team stats:",b),console.log("[userStats] Total picks with fixtures and results:",x.filter(t=>{const g=d.get(`${t.gw}:${t.fixture_index}`),S=n.get(`${t.gw}:${t.fixture_index}`);return g&&S}).length);let k=null,y=null;l.forEach((t,g)=>{if(t.total>=3){const S=t.correct/t.total*100,a=(t.total-t.correct)/t.total*100;(!k||S>k.percentage)&&(k={code:t.code,name:t.name,percentage:S}),(!y||a>y.percentage)&&(y={code:t.code,name:t.name,percentage:a})}}),e.mostCorrectTeam=k,e.mostIncorrectTeam=y}}}catch(v){console.error("Error fetching user stats:",v)}return e}function K(){const{user:p}=L(),[e,v]=R.useState(null),[c,f]=R.useState(!0);R.useEffect(()=>{p?w():f(!1)},[p]);async function w(){if(p){f(!0);try{console.log("[Stats] Fetching user stats for user:",p.id);const u=await Y(p.id);console.log("[Stats] Fetched stats:",u),v(u)}catch(u){console.error("[Stats] Error loading stats:",u)}finally{f(!1)}}}if(!p)return s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6",children:s.jsx("div",{className:"max-w-4xl mx-auto",children:s.jsx("div",{className:"bg-white rounded-xl shadow-md p-6 text-center",children:s.jsx("p",{className:"text-slate-600",children:"Please sign in to view your stats."})})})});const $=e&&(e.lastCompletedGw!==null||e.overallPercentile!==null);return s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",children:s.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[s.jsxs(H,{to:"/profile",className:"inline-flex items-center gap-2 text-slate-600 hover:text-slate-800 mb-4 transition-colors",children:[s.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),s.jsx("span",{children:"Back to Profile"})]}),s.jsx(U,{title:"Stats",as:"h1",className:"mb-6"}),!$&&!c?s.jsxs("div",{className:"bg-white rounded-xl shadow-md p-8 text-center",children:[s.jsx("p",{className:"text-slate-600 text-lg",children:"Not enough games yet — check back after a few Gameweeks."}),s.jsx("p",{className:"text-slate-500 text-sm mt-2",children:"The numbers will start to tell a story soon."})]}):s.jsxs("div",{className:"space-y-6",children:[e&&e.lastCompletedGw!==null&&e.lastCompletedGwPercentile!==null&&(()=>{const u=e.lastCompletedGwPercentile,x=Math.round(100-u),_=Math.round(u),M=u>=75;return s.jsx(E,{label:`Gameweek ${e.lastCompletedGw}`,value:M?`You were in the top ${x}% of players.`:`You were in the bottom ${_}% of players.`,loading:c})})(),e&&e.overallPercentile!==null&&(()=>{const u=e.overallPercentile,x=Math.round(100-u),_=Math.round(u),M=u>=75;return s.jsx(E,{label:"Overall",value:M?`You're in the top ${x}% of players.`:`You're in the bottom ${_}% of players.`,loading:c})})(),e&&e.mostCorrectTeam&&s.jsx(D,{label:"Most correctly predicted team",teamCode:e.mostCorrectTeam.code,teamName:e.mostCorrectTeam.name,percentage:e.mostCorrectTeam.percentage,isCorrect:!0,loading:c}),e&&e.mostIncorrectTeam&&s.jsx(D,{label:"Most incorrectly picked team",teamCode:e.mostIncorrectTeam.code,teamName:e.mostIncorrectTeam.name,percentage:e.mostIncorrectTeam.percentage,isCorrect:!1,loading:c}),e&&e.correctPredictionRate!==null&&s.jsx(E,{label:"Correct prediction rate",value:`${e.correctPredictionRate.toFixed(2)}%`,loading:c}),e&&e.chaosIndex!==null&&s.jsx(E,{label:"Chaos Index",value:`${e.chaosIndex.toFixed(2)}%`,subcopy:"How often you pick an outcome that 25% or fewer players picked",loading:c}),e&&e.bestStreak>0&&e.bestStreakGwRange&&s.jsx(O,{label:"Most consecutive weeks in the top 25%",streakCount:e.bestStreak,gwRange:e.bestStreakGwRange,loading:c}),e&&e.avgPointsPerWeek!==null&&s.jsx(E,{label:"Avg points / week",value:e.avgPointsPerWeek.toFixed(2),loading:c}),e&&e.bestSingleGw&&s.jsx(E,{label:"Best single Gameweek",value:`${e.bestSingleGw.points} on GW${e.bestSingleGw.gw}`,loading:c}),e&&e.lowestSingleGw&&s.jsx(E,{label:"Lowest single Gameweek",value:`${e.lowestSingleGw.points} on GW${e.lowestSingleGw.gw}`,loading:c})]})]})})}export{K as default};
