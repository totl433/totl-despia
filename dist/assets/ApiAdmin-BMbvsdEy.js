import{u as ae,r as u,s as y,v as H,j as e}from"./index-B6F0oxuZ.js";const V=()=>{const _=typeof window<"u"?window.location.hostname:"",j=typeof window<"u"?window.location.origin:"";return _.includes("netlify.app")||_.includes("netlify.com")?`${j}/.netlify/functions/fetchFootballData`:_==="localhost"||_==="127.0.0.1"?"https://totl-staging.netlify.app/.netlify/functions/fetchFootballData":"/.netlify/functions/fetchFootballData"};function ne(){const{user:_}=ae(),j=_?.id==="4542c037-5b38-40d0-b189-847b8f17c222"||_?.id==="36f31625-6d6c-4aa4-815a-1493a812841b",[t,B]=u.useState(null),[m,$]=u.useState(null),[E,q]=u.useState([]),[f,v]=u.useState(new Map),[N,P]=u.useState(!1),[T,M]=u.useState(!1),[D,g]=u.useState(""),[F,k]=u.useState(""),[I,x]=u.useState(null),[J,Y]=u.useState(!0),[K,W]=u.useState(!1),[R,U]=u.useState(!1),[S,O]=u.useState(null),[L,C]=u.useState(!1);u.useEffect(()=>{if(!j)return;let s=!0;return(async()=>{try{const{data:r,error:o}=await y.from("app_meta").select("current_gw").eq("id",1).maybeSingle();if(o)throw o;if(s&&r){const n=r.current_gw||13;$(n);const l=n+1;B(l),C(!0);const d=await H(n);s&&(O(d),C(!1));const{data:c}=await y.from("app_fixtures").select("*").eq("gw",l).order("fixture_index",{ascending:!0});if(c&&c.length>0){const i=new Map;c.forEach(a=>{i.set(a.fixture_index,{api_match_id:a.api_match_id||0,home_team:a.home_team||"",away_team:a.away_team||"",home_code:a.home_code||"",away_code:a.away_code||"",home_name:a.home_name||"",away_name:a.away_name||"",home_crest:a.home_crest||null,away_crest:a.away_crest||null,kickoff_time:a.kickoff_time||"",selected:!0})}),v(i)}}}catch(r){console.error("Error loading next GW:",r)}finally{s&&Y(!1)}})(),()=>{s=!1}},[j]);const X=async s=>{try{console.log(`[ApiAdmin] Fetching team forms for GW ${s}...`);const r=V(),o=new Date().toISOString().split("T")[0],n=new URLSearchParams({resource:"standings",competition:"PL",date:o}),l=`${r}?${n.toString()}`,d=await fetch(l);if(!d.ok){console.warn(`[ApiAdmin] Failed to fetch team forms: ${d.status}`);return}const c=await d.json();if(!c.success||!c.data){console.warn("[ApiAdmin] Invalid standings API response");return}const i=new Map,a=c.data?.standings||c.data;if(a&&Array.isArray(a)){const h=a.find(b=>b.type==="TOTAL")||a[0];h&&h.table&&Array.isArray(h.table)&&h.table.forEach(b=>{const A=(b.team?.tla||b.team?.shortName||"").toUpperCase().trim(),w=(b.form||"").trim().toUpperCase().replace(/,/g,""),z=w?w.split("").reverse().join(""):"";A&&z&&i.set(A,z)})}if(i.size>0){const h=Array.from(i.entries()).map(([A,w])=>({gw:s,team_code:A,form:w})),{error:b}=await y.from("app_team_forms").upsert(h,{onConflict:"gw,team_code",ignoreDuplicates:!1});b?console.error("[ApiAdmin] Error storing team forms:",b):console.log(`[ApiAdmin] âœ… Successfully stored ${i.size} team forms for GW ${s}`)}else console.warn("[ApiAdmin] âš ï¸ No team forms found in API response")}catch(r){console.error("[ApiAdmin] Error fetching team forms:",r)}},Q=async s=>{if(!t)return x("Next GW not loaded yet."),null;try{const r=new Date,o=new Date(r);o.setDate(r.getDate()+7);const n=r.toISOString().split("T")[0],l=o.toISOString().split("T")[0],d=new URLSearchParams({competition:"PL",dateFrom:n,dateTo:l}),i=`${V()}?${d.toString()}`,a=await fetch(i,{signal:s});if(!a.ok){const w=await a.text();return a.status===429?(x("Rate limit reached. Please wait a moment."),null):(x(`Server error (${a.status}). ${w.substring(0,100)}`),null)}const h=await a.json();if(!h.success||!h.data)return x("Invalid API response format."),null;const A=(h.data.matches||[]).filter(w=>w.matchday===t);return x(null),A}catch(r){return r instanceof Error&&r.name==="AbortError"||(console.error("Error fetching matches:",r),x("Failed to fetch matches. Check your connection.")),null}},Z=s=>{const r=new Map(f),o=Array.from(r.entries()).find(([n,l])=>l.api_match_id===s.id);if(o){const[n]=o;r.delete(n);const l=Array.from(r.entries()).sort(([c],[i])=>c-i),d=new Map;l.forEach(([c,i],a)=>{d.set(a,i)}),v(d)}else{const l=(r.size>0?Math.max(...Array.from(r.keys())):-1)+1,d={api_match_id:s.id,home_team:s.homeTeam.shortName,away_team:s.awayTeam.shortName,home_code:s.homeTeam.tla,away_code:s.awayTeam.tla,home_name:s.homeTeam.name,away_name:s.awayTeam.name,home_crest:s.homeTeam.crest||null,away_crest:s.awayTeam.crest||null,kickoff_time:s.utcDate,selected:!0};r.set(l,d),v(r)}},p=m!==null&&t!==null&&m>=t,G=S===!0,ee=async()=>{if(!t){g("Next GW not loaded");return}if(!G){g(`Cannot publish GW ${t}: GW ${m} is not finished yet. All fixtures must have results before publishing the next gameweek.`);return}if(f.size===0){g("Please select at least one fixture");return}const s=Array.from(f.values()).filter(r=>!r.api_match_id||r.api_match_id===0);if(s.length>0){g(`Cannot publish: ${s.length} fixture${s.length===1?"":"s"} missing api_match_id. Please select fixtures from the API matches list.`);return}W(!0)},te=async()=>{if(t){W(!1),P(!0),g(""),k("");try{const s=Array.from(f.entries()).map(([i,a])=>({gw:t,fixture_index:i,api_match_id:a.api_match_id,home_team:a.home_team,away_team:a.away_team,home_code:a.home_code,away_code:a.away_code,home_name:a.home_name,away_name:a.away_name,home_crest:a.home_crest||null,away_crest:a.away_crest||null,kickoff_time:a.kickoff_time}));console.log(`[ApiAdmin] Saving ${s.length} fixtures to app_fixtures for GW ${t}...`);const{data:r,error:o}=await y.from("app_fixtures").upsert(s,{onConflict:"gw,fixture_index",ignoreDuplicates:!1}).select();if(o)throw console.error("[ApiAdmin] âŒ Error upserting fixtures to app_fixtures:",o),console.error("[ApiAdmin] Error details:",JSON.stringify(o,null,2)),o;const n=r?.length||s.length;console.log(`[ApiAdmin] âœ… Successfully saved ${n} fixtures to app_fixtures for GW ${t}`);const{data:l,error:d}=await y.from("app_fixtures").select("fixture_index").eq("gw",t);d?console.warn("[ApiAdmin] âš ï¸ Could not verify fixtures were saved:",d):(console.log(`[ApiAdmin] âœ… Verified: ${l?.length||0} fixtures exist in app_fixtures for GW ${t}`),(l?.length||0)!==n&&console.warn(`[ApiAdmin] âš ï¸ Mismatch: Expected ${n} fixtures but found ${l?.length||0} in database`)),console.log(`[ApiAdmin] âš ï¸ PUBLISHING: Updating app_meta.current_gw to ${t}...`);const{error:c}=await y.from("app_meta").upsert({id:1,current_gw:t},{onConflict:"id"});if(c)throw console.error("[ApiAdmin] âŒ CRITICAL ERROR updating app_meta:",c),new Error(`Failed to publish: Could not update current_gw to ${t}. ${c.message}`);{console.log(`[ApiAdmin] âœ… Successfully published: app_meta.current_gw = ${t}`),$(t);const{data:i,error:a}=await y.from("app_meta").select("current_gw").eq("id",1).single();a?console.warn("[ApiAdmin] âš ï¸ Could not verify app_meta update:",a):console.log(`[ApiAdmin] âœ… Verified: app_meta.current_gw = ${i?.current_gw}`)}console.log(`[ApiAdmin] ðŸ”„ Automatically fetching team forms for GW ${t}...`);try{await X(t),console.log(`[ApiAdmin] âœ… Team forms fetch completed for GW ${t}`)}catch(i){console.error("[ApiAdmin] âš ï¸ Team forms fetch failed (non-critical):",i)}try{const i=await fetch("/.netlify/functions/sendPushAllV2",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:`GAMEWEEK ${t} - FIXTURES ARE OUT!`,message:"Make your predictions now!",data:{type:"fixtures_published",gw:t}})}),a=await i.json().catch(()=>({}));i.ok&&a.ok?console.log(`[ApiAdmin] Push notification sent to ${a.sentTo||0} users (out of ${a.userCount||0} subscribed)`):console.warn("[ApiAdmin] Push notification failed:",a)}catch(i){console.error("[ApiAdmin] Error sending push notification:",i)}try{const i=await fetch("/.netlify/functions/sendVolleyGwReady",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gameweek:t})}),a=await i.json().catch(()=>({}));i.ok&&a.ok?console.log(`[ApiAdmin] Volley messages sent to ${a.totalLeagues||0} leagues`):console.warn("[ApiAdmin] Volley message failed:",a)}catch(i){console.error("[ApiAdmin] Error sending Volley messages:",i)}k(`âœ… Gameweek ${t} PUBLISHED with ${f.size} Premier League fixtures! Notification sent to all users.`)}catch(s){g(s.message??"Failed to publish gameweek.")}finally{P(!1)}}},se=async()=>{if(!(!t||!m)){if(m!==t){g(`Cannot recall: GW ${t} is not the current published gameweek (current is GW ${m})`);return}if(confirm(`âš ï¸ Are you sure you want to RECALL GW ${t}?

This will:
- Set current_gw back to ${m-1}
- Users will no longer see GW ${t} fixtures
- You can edit and republish later`)){U(!0),g(""),k("");try{const s=m-1;console.log(`[ApiAdmin] Recalling GW ${t}, setting current_gw to ${s}...`);const{error:r}=await y.from("app_meta").upsert({id:1,current_gw:s},{onConflict:"id"});if(r)throw new Error(`Failed to recall: ${r.message}`);$(s),k(`âœ… GW ${t} recalled. Current gameweek is now GW ${s}.`)}catch(s){g(s.message??"Failed to recall gameweek.")}finally{U(!1)}}}};return j?J?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading..."})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"bg-white border-2 border-slate-300 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Current Gameweek"}),e.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:["GW ",m??"..."]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Next Gameweek"}),e.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:["GW ",t??"..."]})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:L?e.jsx("span",{className:"text-sm text-slate-500",children:"Checking status..."}):S===!0?e.jsxs("span",{className:"text-sm font-medium text-green-700",children:["âœ… GW ",m," finished - Ready to publish GW ",t]}):S===!1?e.jsxs("span",{className:"text-sm font-medium text-amber-700",children:["â³ GW ",m," still in progress - Cannot publish GW ",t," yet"]}):e.jsx("span",{className:"text-sm text-slate-500",children:"Loading status..."})}),m!==null&&e.jsx("button",{onClick:async()=>{C(!0);const s=await H(m);O(s),C(!1)},disabled:L,className:"px-3 py-1 text-sm bg-slate-100 hover:bg-slate-200 rounded border border-slate-300 disabled:opacity-50",children:L?"Checking...":"Refresh Status"})]})})]}),e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900 mb-2",children:"API Admin - Premier League"}),e.jsxs("p",{className:"text-sm text-slate-600 mb-6",children:["Select Premier League fixtures for Gameweek ",t,". Check the feed for any cancelled or postponed games."]}),D&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:D}),!G&&m!==null&&S===!1&&e.jsxs("div",{className:"mb-4 p-4 bg-amber-50 border-2 border-amber-400 rounded-lg text-amber-800",children:[e.jsxs("div",{className:"font-semibold mb-2",children:["âš ï¸ Cannot publish GW ",t," yet"]}),e.jsxs("div",{className:"text-sm",children:["GW ",m," is still in progress. All fixtures must be finished (have results) before you can publish the next gameweek."]})]}),F&&e.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",children:F}),I&&e.jsxs("div",{className:"mb-4 p-4 bg-amber-50 border-2 border-amber-400 rounded-lg text-amber-800 text-sm font-medium shadow-md",children:["âš ï¸ ",I]}),e.jsx("div",{className:"bg-white rounded-xl shadow-md p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Next Gameweek"}),e.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:["GW ",t]}),p&&e.jsx("div",{className:"mt-2 inline-block px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full",children:"âœ… PUBLISHED (Current GW)"})]}),e.jsxs("div",{className:"text-right",children:[f.size>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-slate-600 mb-1",children:"Selected Fixtures"}),e.jsx("div",{className:"text-2xl font-bold text-[#1C8376]",children:f.size})]}),p&&e.jsx("button",{onClick:se,disabled:R,className:"mt-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 font-semibold text-sm",children:R?"Recalling...":`RECALL GW ${t}`})]})]})}),e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-4 mb-6 ${p?"opacity-60":""}`,children:[e.jsxs("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:["Premier League Matches for GW ",t," (Matchday ",t,")"]}),p&&e.jsx("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 text-sm",children:"âš ï¸ This gameweek is published and cannot be edited. Use RECALL to make changes."}),e.jsxs("p",{className:"text-sm text-slate-500 mb-4",children:["Loading matches from the API that are tagged with Matchday ",t," (corresponds to GW ",t,")."]}),e.jsx("button",{onClick:()=>{if(p||T||!t)return;M(!0),x(null);const s=new AbortController;Q(s.signal).then(r=>{if(r&&r.length>0){q(r),x(null);const o=new Map;r.forEach((n,l)=>{o.set(l,{api_match_id:n.id,home_team:n.homeTeam.shortName,away_team:n.awayTeam.shortName,home_code:n.homeTeam.tla,away_code:n.awayTeam.tla,home_name:n.homeTeam.name,away_name:n.awayTeam.name,home_crest:n.homeTeam.crest||null,away_crest:n.awayTeam.crest||null,kickoff_time:n.utcDate,selected:!0})}),v(o)}else r&&r.length===0&&x(`No Premier League matches found for Matchday ${t} (GW ${t}) in the next week.`)}).catch(r=>{r instanceof Error&&r.name!=="AbortError"&&x("Failed to fetch matches. Please try again.")}).finally(()=>{M(!1)})},disabled:T||!t||p,className:"px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",type:"button",children:T?"Loading...":`Load GW ${t} Matches (Matchday ${t})`})]}),E.length>0&&e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-4 mb-6 ${p?"opacity-60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-slate-800",children:["Available Matches (",E.length,") - All Selected by Default"]}),!p&&e.jsx("button",{onClick:ee,disabled:N||f.size===0||!G,className:"px-6 py-3 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 disabled:cursor-not-allowed font-bold text-lg shadow-lg",title:G?"":`GW ${m} must be finished before publishing GW ${t}`,children:N?"Publishing...":`PUBLISH GW ${t}`})]}),e.jsx("div",{className:"space-y-2",children:E.map(s=>{const r=Array.from(f.values()).some(h=>h.api_match_id===s.id),o=new Date(s.utcDate),n=new Date;n.setHours(0,0,0,0);const l=new Date(n);l.setDate(n.getDate()+1);const d=new Date(o);d.setHours(0,0,0,0);let c="";d.getTime()===n.getTime()?c="TODAY":d.getTime()===l.getTime()?c="TOMORROW":c=o.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"});const i=`${String(o.getUTCHours()).padStart(2,"0")}:${String(o.getUTCMinutes()).padStart(2,"0")} UTC`,a=`${c} ${i}`;return e.jsx("div",{className:`p-3 border-2 rounded-lg transition-colors ${r?"bg-[#1C8376]/10 border-[#1C8376]":"bg-slate-50 border-slate-200"}`,children:e.jsxs("label",{className:"flex items-center gap-4 cursor-pointer",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("input",{type:"checkbox",checked:r,onChange:()=>!p&&Z(s),disabled:p,className:"w-6 h-6 cursor-pointer appearance-none border-2 rounded transition-all disabled:opacity-50 disabled:cursor-not-allowed",style:{minWidth:"24px",minHeight:"24px",borderColor:r?"#1C8376":"#94a3b8",backgroundColor:r?"#1C8376":"white"}}),r&&e.jsx("svg",{className:"absolute top-0 left-0 w-6 h-6 pointer-events-none",fill:"none",stroke:"white",strokeWidth:"3",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-slate-800",children:[s.homeTeam.shortName," vs ",s.awayTeam.shortName]}),e.jsxs("div",{className:"text-xs text-slate-500",children:[a," â€¢ ",s.status," â€¢ Matchday ",s.matchday]})]})]})},s.id)})})]}),K&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full p-6",children:[e.jsxs("h3",{className:"text-2xl font-bold text-slate-900 mb-4",children:["âš ï¸ PUBLISH GAMEWEEK ",t,"?"]}),e.jsxs("div",{className:"mb-6 space-y-3 text-sm text-slate-700",children:[e.jsx("p",{className:"font-semibold",children:"This will:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-2 ml-2",children:[e.jsxs("li",{children:["Save ",f.size," fixture",f.size===1?"":"s"," to the database"]}),e.jsxs("li",{children:[e.jsxs("strong",{className:"text-red-600",children:["Set current_gw to ",t]})," (makes it live)"]}),e.jsx("li",{children:e.jsx("strong",{className:"text-red-600",children:"Send push notification to ALL users"})}),e.jsx("li",{children:"Make this gameweek visible to all users"}),e.jsx("li",{children:"Lock editing (you'll need to RECALL to make changes)"})]}),e.jsxs("p",{className:"mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800",children:[e.jsx("strong",{children:"Are you sure?"})," Once published, users will receive notifications and can start making predictions."]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>W(!1),className:"flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold",children:"Cancel"}),e.jsx("button",{onClick:te,disabled:N,className:"flex-1 px-4 py-2 bg-[#1C8376] text-white rounded-lg hover:bg-[#1C8376]/90 disabled:opacity-50 font-bold",children:N?"Publishing...":"YES, PUBLISH GW "+t})]})]})})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:e.jsx("div",{className:"text-red-600",children:"Access denied. Admin only."})})}export{ne as default};
